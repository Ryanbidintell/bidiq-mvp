<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BidIntell - Decision Intelligence for Construction Bidding</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script src="lib/contractRiskDetection.js"></script>
    <script src="lib/buildingTypeExtraction.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPxYsWrlpVgYW4xBdXg82Zcp5Ll0_icd0&libraries=places&callback=initGoogleMaps" async defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Brand Colors - Matching Logo */
            --brand-primary: #F7931E;
            --brand-secondary: #2F80ED;
            --brand-gradient: linear-gradient(135deg, #F7931E 0%, #2F80ED 100%);
            --brand-gradient-subtle: linear-gradient(135deg, #FFF4E6 0%, #E3F2FD 100%);

            /* Score Colors */
            --score-go: #059669;
            --score-go-bg: #ECFDF5;
            --score-review: #D97706;
            --score-review-bg: #FFFBEB;
            --score-pass: #DC2626;
            --score-pass-bg: #FEF2F2;

            /* Neutrals - Light Theme */
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --text-muted: #9CA3AF;
            --bg-page: #F9FAFB;
            --bg-primary: #F9FAFB;
            --bg-secondary: #FFFFFF;
            --bg-card: #FFFFFF;
            --bg-hover: #F3F4F6;
            --bg-input: #FFFFFF;
            --border: #E5E7EB;
            --border-light: #D1D5DB;
            --border-focus: #F7931E;

            /* Aliases for compatibility */
            --accent: #F7931E;
            --accent-hover: #E8831B;
            --accent-dim: rgba(247, 147, 30, 0.1);
            --success: #059669;
            --success-bg: #ECFDF5;
            --warning: #D97706;
            --warning-bg: #FFFBEB;
            --danger: #DC2626;
            --danger-bg: #FEF2F2;
            --info: #2F80ED;
            --info-bg: #E3F2FD;

            /* Spacing */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;
            --space-3xl: 64px;

            /* Radius */
            --radius: 8px;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --radius-full: 9999px;

            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -4px rgba(0, 0, 0, 0.04);
            --shadow-score: 0 8px 24px rgba(247, 147, 30, 0.15);

            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-base: 250ms ease;
            --transition-slow: 400ms cubic-bezier(0.16, 1, 0.3, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-page); color: var(--text-primary); min-height: 100vh; line-height: 1.5; }
        .app { display: flex; min-height: 100vh; }

        /* Auth Screen */
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--brand-gradient-subtle); }
        .auth-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 40px; width: 100%; max-width: 400px; box-shadow: var(--shadow-lg); }
        .auth-logo { text-align: center; margin-bottom: 32px; }
        .auth-logo img { height: 56px; width: auto; margin-bottom: 12px; }
        .auth-logo .tagline { font-family: 'Space Mono', monospace; color: var(--brand-primary); font-size: 11px; letter-spacing: 1px; margin-top: 12px; text-transform: uppercase; }
        .auth-logo .tagline-sub { color: var(--text-muted); font-size: 14px; margin-top: 4px; }
        .auth-tabs { display: flex; gap: 8px; margin-bottom: 24px; }
        .auth-tab { flex: 1; padding: 10px; text-align: center; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; font-weight: 500; color: var(--text-secondary); transition: all 0.2s; }
        .auth-tab.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .auth-error { background: var(--danger-bg); border: 1px solid rgba(239,68,68,0.3); color: var(--danger); padding: 12px; border-radius: var(--radius); margin-bottom: 16px; font-size: 13px; display: none; }
        .auth-success { background: var(--success-bg); border: 1px solid rgba(16,185,129,0.3); color: var(--success); padding: 12px; border-radius: var(--radius); margin-bottom: 16px; font-size: 13px; display: none; }
        .user-info { font-size: 12px; color: var(--text-muted); padding: 8px 10px; display: flex; align-items: center; justify-content: space-between; margin-top: 8px; }
        .user-info span { max-width: 140px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .logout-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 11px; padding: 4px 8px; border-radius: 4px; }
        .logout-btn:hover { background: var(--danger-bg); color: var(--danger); }
        
        /* Sidebar */
        .sidebar { width: 240px; background: var(--bg-card); border-right: 1px solid var(--border); position: fixed; height: 100vh; display: flex; flex-direction: column; box-shadow: var(--shadow-sm); }
        .logo { padding: 20px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; }
        .logo img { height: 40px; width: auto; }
        .logo p { font-family: 'Space Mono', monospace; font-size: 9px; color: var(--brand-primary); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 8px; }
        .nav { flex: 1; padding: 12px 8px; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border-radius: var(--radius); color: var(--text-secondary); cursor: pointer; margin-bottom: 4px; font-weight: 500; font-size: 14px; transition: all 0.2s; }
        .nav-item:hover { background: var(--bg-card); color: var(--text-primary); }
        .nav-item.active { background: var(--accent-dim); color: var(--accent); }
        .nav-item svg { width: 18px; height: 18px; }
        .sidebar-footer { padding: 12px; border-top: 1px solid var(--border); }
        .capacity-box { background: var(--bg-card); border-radius: var(--radius); padding: 10px; }
        .capacity-label { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 6px; }
        .capacity-value { font-weight: 600; display: flex; align-items: center; gap: 6px; }
        .capacity-dot { width: 8px; height: 8px; border-radius: 50%; }
        .capacity-hungry .capacity-dot { background: var(--danger); }
        .capacity-steady .capacity-dot { background: var(--success); }
        .capacity-maxed .capacity-dot { background: var(--warning); }
        
        /* Main */
        .main { flex: 1; margin-left: 240px; }
        .page-header { padding: 20px 24px; border-bottom: 1px solid var(--border); background: var(--bg-card); }
        .page-title { font-size: 28px; font-weight: 800; letter-spacing: -0.02em; }
        .page-subtitle { color: var(--text-muted); font-size: 14px; margin-top: 4px; }
        .page-content { padding: 24px; max-width: 1200px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Stats - Improved Scannability */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 20px;
            position: relative;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-base);
        }
        .stat-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .stat-card.accent { border-left: 4px solid var(--brand-primary); background: linear-gradient(135deg, rgba(79, 70, 229, 0.03) 0%, transparent 100%); }
        .stat-card.success { border-left: 4px solid var(--score-go); background: linear-gradient(135deg, rgba(5, 150, 105, 0.03) 0%, transparent 100%); }
        .stat-card.info { border-left: 4px solid var(--brand-primary); background: linear-gradient(135deg, rgba(79, 70, 229, 0.03) 0%, transparent 100%); }
        .stat-card.warning { border-left: 4px solid var(--score-review); background: linear-gradient(135deg, rgba(217, 119, 6, 0.03) 0%, transparent 100%); }
        .stat-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }
        .stat-value {
            font-size: 32px;
            font-weight: 800;
            font-family: 'Space Mono', monospace;
            line-height: 1;
        }

        /* Cards - Improved Hierarchy */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-base);
        }
        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
        }
        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-page);
        }
        .card-title {
            font-weight: 700;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card-body { padding: var(--space-lg); }
        
        /* Help text */
        .help-text { font-size: 13px; color: var(--text-muted); margin-bottom: 16px; padding: 12px; background: var(--bg-input); border-radius: var(--radius); border-left: 3px solid var(--info); }
        .help-text strong { color: var(--text-secondary); }
        
        /* Tooltips */
        .tooltip-trigger { cursor: help; display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; background: var(--bg-input); border-radius: 50%; font-size: 10px; color: var(--text-muted); margin-left: 4px; }
        .tooltip-trigger:hover { background: var(--border); color: var(--text-primary); }
        
        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 8px 14px; border-radius: var(--radius-sm); font-weight: 600; font-size: 13px; cursor: pointer; transition: all var(--transition-fast); border: none; font-family: inherit; }
        .btn-primary { background: var(--brand-gradient); color: white; }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--bg-hover); border-color: var(--brand-primary); }
        .btn-sm { padding: 6px 10px; font-size: 12px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-success { background: var(--score-go); color: white; }
        .btn-success:hover { opacity: 0.9; }
        
        /* Forms */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }
        .form-hint { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        .form-input, .form-select { width: 100%; padding: 10px 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text-primary); font-size: 13px; font-family: inherit; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent); background: var(--bg-secondary); }
        .form-input::placeholder { color: var(--text-muted); }
        .form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        .form-row-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        
        /* Section headers */
        .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .section-title { font-size: 16px; font-weight: 600; }
        .section-description { font-size: 13px; color: var(--text-muted); margin-top: 4px; }
        
        /* Upload */
        .upload-zone { border: 2px dashed var(--border); border-radius: var(--radius-lg); padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s; background: var(--bg-input); }
        .upload-zone:hover { border-color: var(--accent); background: var(--accent-dim); }
        .upload-zone svg { width: 40px; height: 40px; color: var(--text-muted); margin-bottom: 12px; }
        .upload-zone h3 { color: var(--text-primary); font-size: 15px; margin-bottom: 4px; }
        .upload-zone p { color: var(--text-muted); font-size: 13px; }
        .file-list { margin-top: 12px; }
        .file-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 6px; font-size: 13px; }
        .file-item .remove { margin-left: auto; color: var(--text-muted); cursor: pointer; padding: 2px 6px; border-radius: 4px; }
        .file-item .remove:hover { color: var(--danger); background: var(--danger-bg); }
        
        /* Score badges */
        .score-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: var(--radius-full); font-weight: 700; font-size: 11px; letter-spacing: 0.05em; text-transform: uppercase; }
        .score-badge.go { background: var(--score-go); color: white; }
        .score-badge.review { background: var(--score-review); color: white; }
        .score-badge.pass { background: var(--score-pass); color: white; }
        
        .outcome-badge { display: inline-flex; padding: 3px 8px; border-radius: 10px; font-size: 11px; font-weight: 500; text-transform: capitalize; }
        .outcome-badge.won { background: var(--success-bg); color: var(--success); }
        .outcome-badge.lost { background: var(--danger-bg); color: var(--danger); }
        .outcome-badge.ghost { background: var(--bg-input); color: var(--text-muted); }
        .outcome-badge.pending { background: var(--info-bg); color: var(--info); }
        .outcome-badge.declined { background: var(--bg-input); color: var(--text-secondary); }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); width: 100%; max-width: 600px; max-height: 90vh; overflow: auto; }
        .modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 16px; font-weight: 700; }
        .modal-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 24px; line-height: 1; padding: 4px; }
        .modal-close:hover { color: var(--text-primary); }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 14px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
        
        /* Score report */
        .score-report { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-md); }
        .score-report-header { padding: 32px; text-align: center; background: var(--bg-page); border-bottom: 1px solid var(--border); }
        /* BidIndex Score - THE HERO ELEMENT */
        .score-report-value {
            font-size: 64px;
            font-weight: 800;
            letter-spacing: -0.03em;
            line-height: 1;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            animation: scoreCountUp 0.8s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .score-report-value.go { color: var(--score-go); }
        .score-report-value.review { color: var(--score-review); }
        .score-report-value.pass { color: var(--score-pass); }

        @keyframes scoreCountUp {
            from { opacity: 0; transform: scale(0.8) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .score-report-rec { font-size: 18px; font-weight: 700; margin-top: 12px; }
        .score-component { padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .score-component:last-child { border-bottom: none; }
        .score-component-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .score-component-title { display: flex; align-items: center; gap: 8px; font-weight: 600; font-size: 14px; }
        .score-component-value { font-family: 'Space Mono', monospace; font-weight: 700; font-size: 15px; }
        .score-component-bar { height: 8px; background: var(--bg-input); border-radius: 4px; overflow: hidden; margin-bottom: 8px; }
        .score-component-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
        .score-component-fill.high { background: var(--success); }
        .score-component-fill.medium { background: var(--warning); }
        .score-component-fill.low { background: var(--danger); }
        .score-component-reason { font-size: 13px; color: var(--text-secondary); }
        .score-component-details { margin-top: 10px; padding: 10px; background: var(--bg-input); border-radius: var(--radius); font-size: 12px; }
        
        .keyword-tag { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin: 2px; }
        .keyword-tag.good { background: var(--success-bg); color: var(--success); }
        .keyword-tag.bad { background: var(--danger-bg); color: var(--danger); }
        .keyword-tag .remove { cursor: pointer; opacity: 0.7; margin-left: 2px; }
        .keyword-tag .remove:hover { opacity: 1; }
        
        /* GC selector */
        .gc-selector { border: 1px solid var(--border); border-radius: var(--radius); overflow: visible; background: var(--bg-input); position: relative; }
        .gc-selector-search { display: flex; gap: 12px; padding: 8px 12px; align-items: center; }
        .gc-selector-search input { flex: 1; padding: 10px 12px; background: transparent; border: none; color: var(--text-primary); font-size: 14px; }
        .gc-selector-search input:focus { outline: none; }
        .gc-selector-search input::placeholder { color: var(--text-muted); }
        .gc-selector-search .btn { margin-left: 8px; white-space: nowrap; }
        .gc-selector-list { position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; display: none; border: 1px solid var(--border); border-top: none; background: var(--bg-input); z-index: 100; box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .gc-selector-list.show { display: block; }
        .gc-selector-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; cursor: pointer; font-size: 13px; border-bottom: 1px solid var(--border); }
        .gc-selector-item:last-child { border-bottom: none; }
        .gc-selector-item:hover { background: var(--bg-hover); }
        .gc-selector-item.selected { background: var(--accent-dim); }
        .gc-selected-list { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 20px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 2px solid var(--border-color); min-height: 60px; }
        .gc-selected-tag { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius); font-size: 12px; }
        .gc-selected-tag .remove { cursor: pointer; color: var(--text-muted); }
        .gc-selected-tag .remove:hover { color: var(--danger); }
        
        .competition-indicator { display: inline-flex; align-items: center; gap: 6px; padding: 8px 12px; border-radius: var(--radius); font-size: 13px; font-weight: 500; margin-top: 12px; }
        .competition-indicator.low { background: var(--success-bg); color: var(--success); }
        .competition-indicator.moderate { background: var(--info-bg); color: var(--info); }
        .competition-indicator.high { background: var(--warning-bg); color: var(--warning); }
        .competition-indicator.very-high { background: var(--danger-bg); color: var(--danger); }
        
        /* Weight sliders - IMPROVED */
        .weights-container { background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; }
        .weight-slider { margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
        .weight-slider:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .weight-slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .weight-slider-label { font-size: 14px; font-weight: 500; color: var(--text-primary); }
        .weight-slider-value { font-family: 'Space Mono', monospace; font-weight: 700; font-size: 16px; color: var(--accent); background: var(--accent-dim); padding: 2px 8px; border-radius: 4px; }
        .weight-slider input[type="range"] { width: 100%; height: 8px; border-radius: 4px; background: var(--bg-secondary); appearance: none; cursor: pointer; }
        .weight-slider input[type="range"]::-webkit-slider-thumb { appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--accent); cursor: pointer; border: 2px solid var(--bg-card); }
        .weight-slider input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        .weight-slider-hint { font-size: 11px; color: var(--text-muted); margin-top: 6px; }
        .weight-total { text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius); margin-top: 16px; font-size: 15px; }
        .weight-total-value { font-family: 'Space Mono', monospace; font-weight: 700; font-size: 18px; margin-left: 8px; }
        .weight-total-value.valid { color: var(--success); }
        .weight-total-value.invalid { color: var(--danger); }
        
        /* Toggle improved */
        .toggle { display: flex; align-items: center; gap: 12px; cursor: pointer; font-size: 13px; padding: 8px 0; }
        .toggle-switch { width: 44px; height: 24px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 12px; position: relative; transition: all 0.2s; flex-shrink: 0; }
        .toggle-switch::after { content: ''; position: absolute; top: 3px; left: 3px; width: 16px; height: 16px; background: var(--text-muted); border-radius: 50%; transition: all 0.2s; }
        .toggle input { display: none; }
        .toggle input:checked + .toggle-switch { background: var(--accent); border-color: var(--accent); }
        .toggle input:checked + .toggle-switch::after { left: 23px; background: #000; }
        
        /* Checkbox group improved */
        .checkbox-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius); cursor: pointer; font-size: 13px; transition: all 0.2s; }
        .checkbox-item:hover { border-color: var(--border-light); background: var(--bg-hover); }
        .checkbox-item.selected { background: var(--accent-dim); border-color: var(--accent); }
        .checkbox-item input { display: none; }
        .checkbox-item .check { width: 16px; height: 16px; border: 2px solid var(--border); border-radius: 3px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .checkbox-item.selected .check { background: var(--accent); border-color: var(--accent); }
        .checkbox-item.selected .check::after { content: '✓'; color: #000; font-size: 10px; font-weight: bold; }
        
        /* Keywords config improved */
        .keywords-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .keywords-section { background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 16px; }
        .keywords-section-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
        .keywords-section-header h4 { font-size: 14px; font-weight: 600; }
        .keywords-section.good .keywords-section-header h4 { color: var(--success); }
        .keywords-section.bad .keywords-section-header h4 { color: var(--danger); }
        .keywords-list { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; min-height: 36px; padding: 8px; background: var(--bg-secondary); border-radius: var(--radius); }
        .keywords-input-row { display: flex; gap: 8px; }
        .keywords-input-row input { flex: 1; padding: 8px 10px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text-primary); font-size: 13px; }
        .keywords-input-row input:focus { outline: none; border-color: var(--accent); }
        
        /* GC list */
        .gc-list { display: grid; gap: 10px; }
        .gc-item { display: flex; align-items: center; gap: 14px; padding: 14px; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius); }
        .gc-item-info { flex: 1; }
        .gc-item-name { font-weight: 600; font-size: 14px; margin-bottom: 2px; }
        .gc-item-stats { font-size: 12px; color: var(--text-muted); }
        .gc-item-rating { display: flex; gap: 2px; }
        .star { font-size: 18px; cursor: pointer; color: var(--border); transition: color 0.1s; }
        .star:hover { color: var(--accent-hover); }
        .star.filled { color: var(--accent); }
        
        /* Empty state - Informative & Actionable */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: var(--bg-page);
            border-radius: var(--radius-md);
            border: 1px dashed var(--border);
        }
        .empty-state svg {
            width: 64px;
            height: 64px;
            color: var(--text-muted);
            margin-bottom: 16px;
            opacity: 0.5;
        }
        .empty-state h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        .empty-state p {
            color: var(--text-secondary);
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* Loading */
        .loading { display: flex; align-items: center; justify-content: center; padding: 40px; }
        .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-100%); opacity: 0; } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        
        /* Address prompt */
        .address-prompt { background: var(--warning-bg); border: 1px solid rgba(245,158,11,0.3); border-radius: var(--radius); padding: 14px; margin-top: 12px; }
        .address-prompt-title { font-weight: 600; color: var(--warning); margin-bottom: 8px; font-size: 13px; display: flex; align-items: center; gap: 6px; }
        .address-prompt-row { display: flex; gap: 8px; }
        .address-prompt-row input { flex: 1; }
        
        /* Table */
        .projects-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .projects-table th { text-align: left; padding: 12px 14px; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); background: var(--bg-input); }
        .projects-table td { padding: 14px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        .projects-table tr:hover td { background: var(--bg-hover); }
        .project-name { font-weight: 600; }
        .project-location { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
        
        /* Settings sections */
        .settings-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); margin-bottom: 24px; overflow: hidden; }
        .settings-card-header { padding: 16px 20px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); }
        .settings-card-title { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
        .settings-card-description { font-size: 12px; color: var(--text-muted); }
        .settings-card-body { padding: 20px; }

        /* Loading States */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(99, 102, 241, 0.3);
            border-radius: 50%;
            border-top-color: rgb(99, 102, 241);
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-card) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: var(--radius);
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: var(--radius);
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Success/Error Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-left: 4px solid var(--accent);
            padding: 16px 20px;
            border-radius: var(--radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
        }
        .notification.success { border-left-color: var(--success); }
        .notification.error { border-left-color: var(--danger); }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Improved Accessibility */
        *:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Mobile Responsiveness - Enhanced */
        @media (max-width: 1200px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .page-content { padding: 16px; }
        }

        @media (max-width: 768px) {
            /* Hide sidebar on mobile */
            .sidebar {
                position: fixed;
                left: -280px;
                transition: left 0.3s ease;
                z-index: 1000;
            }
            .sidebar.mobile-open { left: 0; }

            /* Add hamburger menu */
            .mobile-menu-btn {
                display: block;
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 999;
                background: var(--accent);
                color: white;
                border: none;
                padding: 10px 14px;
                border-radius: var(--radius);
                cursor: pointer;
                font-size: 20px;
            }

            .main { margin-left: 0; }
            .stats-grid { grid-template-columns: 1fr; }
            .form-row, .keywords-grid { grid-template-columns: 1fr; }

            /* Stack tables vertically on mobile */
            .projects-table thead { display: none; }
            .projects-table tbody tr {
                display: block;
                margin-bottom: 16px;
                border: 1px solid var(--border);
                border-radius: var(--radius);
                padding: 12px;
            }
            .projects-table tbody td {
                display: block;
                text-align: left;
                padding: 8px 0;
                border: none;
            }
            .projects-table tbody td::before {
                content: attr(data-label);
                font-weight: 600;
                display: block;
                font-size: 12px;
                color: var(--text-muted);
                margin-bottom: 4px;
            }

            /* Adjust modal sizing */
            .modal {
                max-width: 95vw;
                max-height: 95vh;
                margin: 10px;
            }

            /* Make buttons touch-friendly */
            .btn {
                min-height: 44px;
                padding: 12px 20px;
            }

            /* Improve form inputs on mobile */
            .form-input, .form-select, .form-textarea {
                font-size: 16px; /* Prevents zoom on iOS */
            }

            /* Adjust header */
            .header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .page-header {
                padding: 16px;
            }

            .page-title {
                font-size: 24px;
            }

            /* Hide less important columns in tables */
            .projects-table td:nth-child(3),
            .projects-table th:nth-child(3) {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .card {
                border-radius: var(--radius);
            }

            .page-content {
                padding: 12px;
            }

            /* Single column layout for onboarding */
            .onboarding-step {
                padding: 20px;
            }
        }

        /* Dark mode improvements */
        [data-theme="dark"] {
            --bg-primary: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-card: #151515;
            --border: #2a2a2a;
        }
        [data-theme="dark"] .modal {
            background: var(--bg-card);
        }
        [data-theme="dark"] .skeleton {
            background: linear-gradient(90deg, #1a1a1a 25%, #252525 50%, #1a1a1a 75%);
        }

        /* Print styles */
        @media print {
            .sidebar, .header, .btn, .mobile-menu-btn { display: none !important; }
            .main { margin-left: 0; }
            .card { break-inside: avoid; }

            /* AI Chat Print Styles */
            .ai-chat-panel {
                position: static !important;
                width: 100% !important;
                height: auto !important;
                border: none !important;
                box-shadow: none !important;
            }
            .ai-chat-header-actions, .ai-chat-input-container {
                display: none !important;
            }
            .ai-chat-messages {
                padding: 20px !important;
            }
            .ai-chat-message {
                page-break-inside: avoid;
                margin-bottom: 16px !important;
            }
            .ai-chat-bubble {
                max-width: 100% !important;
            }
        }

        /* AI Advisor Chat */
        .ai-chat-button {
            position: fixed;
            bottom: 100px;
            right: 24px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--brand-gradient);
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            box-shadow: var(--shadow-score);
            transition: all var(--transition-base);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .ai-chat-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
        }
        .ai-chat-button.active {
            background: var(--score-pass);
        }

        .ai-chat-panel {
            position: fixed;
            top: 0;
            right: -500px;
            width: 500px;
            height: 100vh;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            transition: right var(--transition-base) ease;
            z-index: 998;
            display: flex;
            flex-direction: column;
        }
        .ai-chat-panel.open {
            right: 0;
        }

        .ai-chat-header {
            padding: 20px 20px 16px 20px;
            border-bottom: 2px solid var(--border);
            background: var(--brand-gradient-subtle);
        }
        .ai-chat-header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .ai-chat-header h3 {
            font-size: 18px;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ai-chat-header-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            margin: 4px 0 0 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .ai-chat-message-count {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: var(--bg-card);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: var(--accent);
        }
        .ai-chat-header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .ai-chat-print, .ai-chat-clear, .ai-chat-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
            transition: all 0.2s;
        }
        .ai-chat-print:hover, .ai-chat-clear:hover, .ai-chat-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        .ai-chat-clear:hover {
            color: var(--danger);
        }
        .ai-chat-close {
            font-size: 24px;
        }

        .ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: relative;
            background: var(--bg-page);
        }
        .ai-chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .ai-chat-messages::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }
        .ai-chat-messages::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }
        .ai-chat-messages::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        .ai-chat-message {
            display: flex;
            gap: 12px;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .ai-chat-message.user {
            flex-direction: row-reverse;
        }
        .ai-chat-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        .ai-chat-message.ai .ai-chat-avatar {
            background: var(--brand-gradient);
        }
        .ai-chat-message.user .ai-chat-avatar {
            background: var(--bg-page);
            border: 1px solid var(--border);
        }
        .ai-chat-bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            font-size: 14px;
            line-height: 1.6;
        }
        .ai-chat-message.ai .ai-chat-bubble {
            background: var(--bg-card);
            border: 1px solid var(--border);
        }
        .ai-chat-message.user .ai-chat-bubble {
            background: var(--brand-gradient);
            color: white;
        }

        .ai-chat-input-container {
            padding: 16px;
            border-top: 1px solid var(--border);
            background: var(--bg-card);
        }
        .ai-chat-input-wrapper {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        .ai-chat-input {
            flex: 1;
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            max-height: 120px;
            font-family: inherit;
        }
        .ai-chat-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .ai-chat-send {
            padding: 12px 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
        }
        .ai-chat-send:hover:not(:disabled) {
            background: var(--accent-hover);
        }
        .ai-chat-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .ai-chat-typing {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }
        .ai-chat-typing span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            animation: typing 1.4s infinite;
        }
        .ai-chat-typing span:nth-child(2) { animation-delay: 0.2s; }
        .ai-chat-typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }

        /* GC Autocomplete */
        .gc-autocomplete-container {
            position: relative;
        }
        .gc-autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 var(--radius) var(--radius);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .gc-autocomplete-dropdown.active {
            display: block;
        }
        .gc-autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
            border-bottom: 1px solid var(--border);
        }
        .gc-autocomplete-item:last-child {
            border-bottom: none;
        }
        .gc-autocomplete-item:hover {
            background: var(--bg-hover);
        }
        .gc-autocomplete-name {
            font-weight: 500;
        }
        .gc-autocomplete-meta {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 12px;
            color: var(--text-muted);
        }
        .gc-autocomplete-rating {
            color: var(--warning);
        }
        .gc-autocomplete-empty {
            padding: 16px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }

    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div class="auth-container" id="authScreen">
        <div class="auth-box">
            <div class="auth-logo">
                <img src="/bidintell-logo-light.svg" alt="BidIntell" />
                <div class="tagline">Decision Intelligence</div>
                <div class="tagline-sub">for Construction Bidding</div>
            </div>
            <div class="auth-tabs">
                <div class="auth-tab active" id="loginTab" onclick="switchAuthTab('login')">Sign In</div>
                <div class="auth-tab" id="signupTab" onclick="switchAuthTab('signup')">Sign Up</div>
            </div>
            <div class="auth-error" id="authError"></div>
            <div class="auth-success" id="authSuccess"></div>
            <form class="auth-form active" id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="you@company.com" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <div style="position: relative;">
                        <input type="password" class="form-input" id="loginPassword" placeholder="••••••••" required autocomplete="current-password" style="padding-right: 60px;">
                        <button type="button" class="show-btn" onclick="togglePassword('loginPassword', this)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 12px; padding: 4px 8px;">Show</button>
                    </div>
                </div>
                <div style="margin-top: 16px; padding: 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); font-size: 12px; color: var(--text-muted); text-align: center;">
                    By signing in you agree to our <a href="#" onclick="showPage('terms'); return false;" style="color: var(--accent); text-decoration: none;">Terms</a> and <a href="#" onclick="showPage('privacy'); return false;" style="color: var(--accent); text-decoration: none;">Privacy Policy</a>
                </div>
                <button type="submit" class="btn btn-primary" id="loginBtn" style="width:100%;padding:12px;margin-top:12px">Sign In</button>
            </form>
            <form class="auth-form" id="signupForm" onsubmit="handleSignup(event)">
                <div class="form-group">
                    <label class="form-label">Company Name</label>
                    <input type="text" class="form-input" id="signupCompany" placeholder="Your Company" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="signupEmail" placeholder="you@company.com" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <div style="position: relative;">
                        <input type="password" class="form-input" id="signupPassword" placeholder="Min 6 characters" minlength="6" required autocomplete="new-password" style="padding-right: 60px;">
                        <button type="button" class="show-btn" onclick="togglePassword('signupPassword', this)" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 12px; padding: 4px 8px;">Show</button>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label style="display: flex; align-items: flex-start; gap: 10px; cursor: pointer; font-size: 13px; line-height: 1.5;">
                        <input type="checkbox" id="tosAcceptance" required style="margin-top: 2px; cursor: pointer;">
                        <span style="color: var(--text-secondary);">I agree to the <a href="#" onclick="showPage('terms'); return false;" style="color: var(--accent); text-decoration: none;">Terms of Service</a> and <a href="#" onclick="showPage('privacy'); return false;" style="color: var(--accent); text-decoration: none;">Privacy Policy</a></span>
                    </label>
                    <div id="tosError" style="display: none; color: var(--danger); font-size: 12px; margin-top: 6px;">You must accept the Terms and Privacy Policy to continue</div>
                </div>
                <button type="submit" class="btn btn-primary" id="signupBtn" style="width:100%;padding:12px;margin-top:8px">Create Account</button>
            </form>
        </div>
    </div>

    <div class="app" id="mainApp" style="display:none">
        <!-- Sidebar -->
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileMenu()" style="display: none;">☰</button>

        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <img src="/bidintell-logo-light.svg" alt="BidIntell" />
                <p>Decision Intelligence</p>
            </div>
            <nav class="nav">
                <div class="nav-item active" data-tab="dashboard">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                    Dashboard
                </div>
                <div class="nav-item" data-tab="analyze">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
                    Analyze Bid
                </div>
                <div class="nav-item" data-tab="projects">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                    Projects
                </div>
                <div class="nav-item" data-tab="analytics">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                    Analytics
                </div>
                <div class="nav-item" data-tab="gcs">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                    Clients
                </div>
                <div class="nav-item" data-tab="keywords">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" /></svg>
                    Keywords
                </div>
                <div class="nav-item" data-tab="settings">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    Settings
                </div>
                <div class="nav-item" data-tab="admin" id="adminNavItem" style="display: none;">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
                    Admin
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="capacity-box capacity-steady" id="capacityIndicator">
                    <div class="capacity-label">Current Capacity</div>
                    <div class="capacity-value"><span class="capacity-dot"></span><span id="capacityText">Steady</span></div>
                </div>
                <div class="user-info"><span id="userEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="9beee8fee9dbfee3faf6ebf7feb5f8f4f6">[email&#160;protected]</a></span><button class="logout-btn" onclick="handleLogout()">Logout</button></div>
            </div>
        </aside>

        <main class="main">
            <!-- Dashboard Tab -->
            <div class="tab-content active" id="tab-dashboard">
                <header class="page-header"><h2 class="page-title">Dashboard</h2><p class="page-subtitle">Your bid intelligence at a glance</p></header>
                <div class="page-content">
                    <div class="stats-grid">
                        <div class="stat-card accent">
                            <div class="stat-label">Total Bids Analyzed</div>
                            <div class="stat-value" id="statBids">0</div>
                            <div style="font-size:11px;color:var(--text-muted);margin-top:4px;"><span id="statBidsThisWeek">0</span> this week</div>
                        </div>
                        <div class="stat-card success">
                            <div class="stat-label">Win Rate</div>
                            <div class="stat-value" id="statWinRate">--</div>
                            <div style="font-size:11px;color:var(--text-muted);margin-top:4px;"><span id="statWinCount">0</span> wins / <span id="statLossCount">0</span> losses</div>
                        </div>
                        <div class="stat-card info">
                            <div class="stat-label">Avg BidIntell Score</div>
                            <div class="stat-value" id="statAvgScore">--</div>
                            <div style="font-size:11px;color:var(--text-muted);margin-top:4px;"><span id="statHighScoreCount">0</span> above 80</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-label">Hours Saved</div>
                            <div class="stat-value" id="statHours">0</div>
                            <div style="font-size:11px;color:var(--text-muted);margin-top:4px;"><span id="statDecisions">0</span> faster decisions</div>
                        </div>
                        <div class="stat-card" style="background:linear-gradient(135deg,var(--accent-dim),rgba(239,68,68,0.1));border-color:var(--accent);">
                            <div class="stat-label">Contract Risks Found</div>
                            <div class="stat-value" id="statContractRisks">0</div>
                            <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">across <span id="statRiskyProjects">0</span> projects</div>
                        </div>
                        <div class="stat-card" style="background:linear-gradient(135deg,rgba(34,197,94,0.1),rgba(59,130,246,0.1));border-color:var(--success);">
                            <div class="stat-label">Data Moat Health</div>
                            <div class="stat-value" id="statDataMoat">--</div>
                            <div style="font-size:11px;color:var(--text-muted);margin-top:4px;"><span id="statOutcomeRate">0</span>% outcomes recorded</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Recent Activity</h3><button class="btn btn-primary btn-sm" onclick="switchTab('analyze')">+ Analyze New Bid</button></div>
                        <div class="card-body" id="recentActivity"></div>
                    </div>
                </div>
            </div>

            <!-- Analyze Tab -->
            <div class="tab-content" id="tab-analyze">
                <header class="page-header"><h2 class="page-title">Analyze Bid</h2><p class="page-subtitle">Upload documents and get your personalized GO/NO-GO recommendation</p></header>
                <div class="page-content">
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Step 1: Upload Bid Documents</h3></div>
                        <div class="card-body">
                            <div class="help-text">
                                <strong>Upload any PDF documents from the bid package:</strong> bid invitation, specifications, drawings, or addenda. BidIntell will extract project details and search for keywords automatically.
                            </div>
                            <div class="upload-zone" id="uploadZone">
                                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                                <h3>Drop PDF files here or click to browse</h3>
                                <p>Supports multiple files • Drop more files anytime</p>
                            </div>
                            <input type="file" id="fileInput" accept=".pdf" multiple style="display: none;">
                            <div class="file-list" id="fileList"></div>
                            <button class="btn btn-secondary btn-sm" id="moreFilesBtn" onclick="document.getElementById('fileInput').click()" style="display: none; margin-top: 12px; width: 100%;">
                                📎 Add More Files
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Step 2: Select GCs Bidding This Project</h3></div>
                        <div class="card-body">
                            <div class="help-text">
                                <strong>Which general contractors are bidding on this project?</strong><br>
                                • Click GCs from the list below to select them (they'll appear in the "Selected GCs" box)<br>
                                • Or type a new GC name and click "+ Add New" to create and select in one step<br>
                                • More GCs = more competition = score adjusts accordingly
                            </div>
                            <div class="gc-selector">
                                <div class="gc-selector-search">
                                    <input type="text" id="gcSearchInput" placeholder="Search GCs or type new name...">
                                    <button class="btn btn-primary btn-sm" onclick="addNewGCFromSearch()" style="border-radius: 0;">+ Add New</button>
                                </div>
                                <div class="gc-selector-list" id="gcSelectorList"></div>
                            </div>
                            <div class="gc-selected-list" id="selectedGCsList"></div>
                            <div id="competitionIndicator"></div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" id="analyzeBtn" onclick="analyzeBid()" disabled style="width: 100%; padding: 14px; font-size: 15px;">
                        <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                        Analyze Bid
                    </button>
                    <div id="analysisResult" style="margin-top: 24px;"></div>
                </div>
            </div>

            <!-- Projects Tab -->
            <div class="tab-content" id="tab-projects">
                <header class="page-header"><h2 class="page-title">Projects</h2><p class="page-subtitle">Track all your analyzed bids and outcomes</p></header>
                <div class="page-content">
                    <!-- Filters and Controls -->
                    <div class="card" style="margin-bottom: 16px;">
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; align-items: end;">
                                <!-- Search -->
                                <div>
                                    <label class="form-label" style="font-size: 12px; margin-bottom: 4px;">🔍 Search</label>
                                    <input type="text" id="projectSearch" placeholder="Project name or location..." class="form-input" oninput="applyProjectFilters()" style="width: 100%;">
                                </div>

                                <!-- Outcome Filter -->
                                <div>
                                    <label class="form-label" style="font-size: 12px; margin-bottom: 4px;">📊 Outcome</label>
                                    <select id="projectOutcomeFilter" class="form-select" onchange="applyProjectFilters()" style="width: 100%;">
                                        <option value="all">All Outcomes</option>
                                        <option value="pending">Pending</option>
                                        <option value="won">Won</option>
                                        <option value="lost">Lost</option>
                                        <option value="ghost">Ghosted</option>
                                        <option value="declined">Declined</option>
                                    </select>
                                </div>

                                <!-- Score Range Filter -->
                                <div>
                                    <label class="form-label" style="font-size: 12px; margin-bottom: 4px;">🎯 Score Range</label>
                                    <select id="projectScoreFilter" class="form-select" onchange="applyProjectFilters()" style="width: 100%;">
                                        <option value="all">All Scores</option>
                                        <option value="go">GO (80-100)</option>
                                        <option value="review">REVIEW (60-79)</option>
                                        <option value="pass">PASS (0-59)</option>
                                    </select>
                                </div>

                                <!-- Sort By -->
                                <div>
                                    <label class="form-label" style="font-size: 12px; margin-bottom: 4px;">↕️ Sort By</label>
                                    <select id="projectSortBy" class="form-select" onchange="applyProjectFilters()" style="width: 100%;">
                                        <option value="date-desc">Date (Newest First)</option>
                                        <option value="date-asc">Date (Oldest First)</option>
                                        <option value="score-desc">Score (High to Low)</option>
                                        <option value="score-asc">Score (Low to High)</option>
                                        <option value="name-asc">Name (A-Z)</option>
                                        <option value="name-desc">Name (Z-A)</option>
                                    </select>
                                </div>

                                <!-- Actions -->
                                <div>
                                    <button class="btn btn-secondary" onclick="clearProjectFilters()" style="width: 100%;">Clear Filters</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header"><h3 class="card-title">All Projects <span id="projectCount" style="color: var(--text-muted); font-size: 14px;"></span></h3><button class="btn btn-secondary btn-sm" onclick="exportProjectsCSV()">📥 Export CSV</button></div>
                        <div class="card-body" style="padding: 0;" id="projectsList"></div>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div class="tab-content" id="tab-analytics">
                <header class="page-header">
                    <h2 class="page-title">AI Learning Analytics</h2>
                    <p class="page-subtitle">Track prediction accuracy and scoring improvements over time</p>
                </header>
                <div class="page-content">
                    <!-- Win Rate Trends Over Time -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">📈 Win Rate Trends</h3>
                            <div class="form-hint">Your win rate performance over time</div>
                        </div>
                        <div class="card-body">
                            <canvas id="winRateTrendChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>

                    <!-- Bid Volume by Month -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">📊 Bid Volume</h3>
                            <div class="form-hint">Number of bids analyzed per month</div>
                        </div>
                        <div class="card-body">
                            <canvas id="bidVolumeChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>

                    <!-- GC Performance Tables -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">🏆 Top Performing GCs</h3>
                            <div class="form-hint">GCs with the highest win rates (minimum 3 bids)</div>
                        </div>
                        <div class="card-body">
                            <div id="topGCsTable"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">👻 High Ghost Rate GCs</h3>
                            <div class="form-hint">GCs with the highest ghost/decline rates</div>
                        </div>
                        <div class="card-body">
                            <div id="worstGCsTable"></div>
                        </div>
                    </div>

                    <!-- Building Type Breakdown -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">🏗️ Projects by Building Type</h3>
                            <div class="form-hint">Distribution of your analyzed projects</div>
                        </div>
                        <div class="card-body">
                            <canvas id="buildingTypeChart" style="max-height: 350px;"></canvas>
                        </div>
                    </div>

                    <!-- Client Type Performance -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">🤝 Client Type Performance</h3>
                            <div class="form-hint">Which types of clients are most profitable for your business?</div>
                        </div>
                        <div class="card-body">
                            <div id="clientTypePerformance"></div>
                        </div>
                    </div>

                    <!-- Prediction Accuracy -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">🎯 Prediction Accuracy</h3>
                            <div class="form-hint">How often do score recommendations match actual outcomes?</div>
                        </div>
                        <div class="card-body">
                            <div id="accuracyMetrics"></div>
                        </div>
                    </div>

                    <!-- User Feedback Analysis -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">💭 User Feedback Analysis</h3>
                            <div class="form-hint">How often do you agree with the AI's score?</div>
                        </div>
                        <div class="card-body">
                            <div id="feedbackAnalysis"></div>
                        </div>
                    </div>

                    <!-- Calibration Insights -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">📊 Calibration Insights</h3>
                            <div class="form-hint">Are scores too conservative or too aggressive?</div>
                        </div>
                        <div class="card-body">
                            <div id="calibrationInsights"></div>
                        </div>
                    </div>

                    <!-- Recommendations -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">💡 AI Recommendations</h3>
                            <div class="form-hint">Suggested improvements based on your data</div>
                        </div>
                        <div class="card-body">
                            <div id="aiRecommendations"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Clients Tab -->
            <div class="tab-content" id="tab-gcs">
                <header class="page-header"><h2 class="page-title">Clients</h2><p class="page-subtitle">Track your relationships and win rates with general contractors, end users, building owners, and other business relationships</p></header>
                <div class="page-content">
                    <div class="help-text">
                        <strong>Your client relationships are a key factor in bid scoring.</strong> Rate each client based on your experience working with them (1-5 stars). Track General Contractors, End Users, and Building Owners. As you record bid outcomes, win rates are calculated automatically.
                    </div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">Your Clients</h3><button class="btn btn-primary btn-sm" onclick="showAddClientModal()">+ Add Client</button></div>
                        <div class="card-body"><div id="gcDatabaseList" class="gc-list"></div></div>
                    </div>
                </div>
            </div>

            <!-- Keywords Tab -->
            <div class="tab-content" id="tab-keywords">
                <header class="page-header"><h2 class="page-title">Keywords</h2><p class="page-subtitle">Configure contract terms to look for in bid documents</p></header>
                <div class="page-content">
                    <div class="help-text">
                        <strong>BidIntell searches your uploaded documents for these terms.</strong><br>
                        • <span style="color: var(--success)">Good terms</span> add +8 points each to your score<br>
                        • <span style="color: var(--danger)">Risk terms</span> subtract points based on your risk tolerance setting (-5 to -15)<br><br>
                        <strong>How to add keywords:</strong> Type a keyword in the box below and press Enter or click Add. To add multiple keywords at once, separate them with commas (e.g., "design-assist, negotiated, preferred").
                    </div>
                    <div class="keywords-grid">
                        <div class="keywords-section good">
                            <div class="keywords-section-header"><h4>✓ Good Terms (+8 points each)</h4></div>
                            <div class="keywords-list" id="goodKeywordsList"></div>
                            <div class="keywords-input-row">
                                <input type="text" id="goodKeywordInput" placeholder="Type keyword(s) separated by commas..." onkeypress="if(event.key==='Enter'){event.preventDefault();addGoodKeyword();}">
                                <button class="btn btn-sm btn-secondary" onclick="addGoodKeyword()">Add</button>
                            </div>
                        </div>
                        <div class="keywords-section bad">
                            <div class="keywords-section-header"><h4>⚠ Risk Terms (penalty varies by risk tolerance)</h4></div>
                            <div class="keywords-list" id="badKeywordsList"></div>
                            <div class="keywords-input-row">
                                <input type="text" id="badKeywordInput" placeholder="Type keyword(s) separated by commas..." onkeypress="if(event.key==='Enter'){event.preventDefault();addBadKeyword();}">
                                <button class="btn btn-sm btn-secondary" onclick="addBadKeyword()">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="tab-settings">
                <header class="page-header"><h2 class="page-title">Settings</h2><p class="page-subtitle">Configure BidIntell to match your business</p></header>
                <div class="page-content">
                    
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div class="settings-card-title">📍 Business Location</div>
                            <div class="settings-card-description">Enter your full office address for accurate distance calculations. At minimum, provide city and state.</div>
                        </div>
                        <div class="settings-card-body">
                            <div class="form-group">
                                <label class="form-label">Office Street Address (Optional)</label>
                                <input type="text" class="form-input" id="settingStreet" placeholder="123 Main Street">
                            </div>
                            <div class="form-row-3">
                                <div class="form-group"><label class="form-label">Office City</label><input type="text" class="form-input" id="settingCity" placeholder="Overland Park" required></div>
                                <div class="form-group"><label class="form-label">State</label><input type="text" class="form-input" id="settingState" placeholder="KS" maxlength="2" style="text-transform: uppercase;" required></div>
                                <div class="form-group"><label class="form-label">ZIP Code (Optional)</label><input type="text" class="form-input" id="settingZip" placeholder="66210" maxlength="5"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Service Radius</label>
                                <select class="form-select" id="settingRadius"><option value="25">25 miles</option><option value="50" selected>50 miles</option><option value="100">100 miles</option><option value="150">150 miles</option><option value="200">200+ miles</option></select>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="settingLocationMatters" checked>
                                <span class="toggle-switch"></span>
                                <span><strong>Include location in scoring</strong> - Turn off if you bid work regardless of distance</span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div class="settings-card-title">🔧 Your Trades</div>
                            <div class="settings-card-description">Select the CSI divisions you work in. BidIntell searches bid docs for these divisions to calculate your Trade Match score.</div>
                        </div>
                        <div class="settings-card-body">
                            <div class="checkbox-grid" id="tradesCheckboxes"></div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div class="settings-card-title">⚖️ Score Weights</div>
                            <div class="settings-card-description">How important is each factor to YOUR bid decisions? Adjust the sliders so they total exactly 100%. For example, if location doesn't matter much to you, reduce it and increase GC relationships.</div>
                        </div>
                        <div class="settings-card-body">
                            <div class="weights-container">
                                <div class="weight-slider" id="weightLocation">
                                    <div class="weight-slider-header">
                                        <span class="weight-slider-label">📍 Location Fit</span>
                                        <span class="weight-slider-value">25%</span>
                                    </div>
                                    <input type="range" min="0" max="60" value="25">
                                    <div class="weight-slider-hint">How much does distance from your office matter?</div>
                                </div>
                                <div class="weight-slider" id="weightKeywords">
                                    <div class="weight-slider-header">
                                        <span class="weight-slider-label">🔑 Keywords & Contract Terms</span>
                                        <span class="weight-slider-value">30%</span>
                                    </div>
                                    <input type="range" min="0" max="60" value="30">
                                    <div class="weight-slider-hint">How much do contract terms (risk clauses, preferences) influence your decision?</div>
                                </div>
                                <div class="weight-slider" id="weightGC">
                                    <div class="weight-slider-header">
                                        <span class="weight-slider-label">🏢 GC Relationship & Competition</span>
                                        <span class="weight-slider-value">25%</span>
                                    </div>
                                    <input type="range" min="0" max="60" value="25">
                                    <div class="weight-slider-hint">How much does your relationship with the GC (and number of competitors) matter?</div>
                                </div>
                                <div class="weight-slider" id="weightTrade">
                                    <div class="weight-slider-header">
                                        <span class="weight-slider-label">🔧 Trade Match</span>
                                        <span class="weight-slider-value">20%</span>
                                    </div>
                                    <input type="range" min="0" max="60" value="20">
                                    <div class="weight-slider-hint">How important is it that your specific trades appear in the specs?</div>
                                </div>
                                <div class="weight-total">
                                    Total: <span class="weight-total-value valid" id="weightTotal">100%</span>
                                    <span id="weightWarning" style="display: none; color: var(--danger); font-size: 12px; margin-left: 10px;">Must equal 100%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div class="settings-card-title">⚡ Risk & Capacity</div>
                            <div class="settings-card-description">These settings affect how BidIntell scores and recommends bids based on your current situation.</div>
                        </div>
                        <div class="settings-card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Risk Tolerance</label>
                                    <select class="form-select" id="settingRiskTolerance">
                                        <option value="low">Low - Avoid risky contracts (-15 pts per risk term)</option>
                                        <option value="medium" selected>Medium - Standard approach (-10 pts per risk term)</option>
                                        <option value="high">High - Comfortable with risk (-5 pts per risk term)</option>
                                    </select>
                                    <div class="form-hint">How much should risk terms (liquidated damages, pay-if-paid, etc.) penalize a bid?</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Current Capacity</label>
                                    <select class="form-select" id="settingCapacity">
                                        <option value="hungry">🔴 Hungry - Need work, more aggressive recommendations</option>
                                        <option value="steady" selected>🟢 Steady - Normal workload, balanced recommendations</option>
                                        <option value="maxed">🟡 Maxed - At capacity, only recommend the best fits</option>
                                    </select>
                                    <div class="form-hint">This affects the recommendation messaging (not the score itself)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div class="settings-card-title">🤖 AI Advisor</div>
                            <div class="settings-card-description">Customize your personalized AI advisor's name and communication style</div>
                        </div>
                        <div class="settings-card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Advisor Name</label>
                                    <select class="form-select" id="settingAiAdvisorName">
                                        <option value="Sam">Sam</option>
                                        <option value="Scout">Scout</option>
                                        <option value="Jake">Jake</option>
                                        <option value="Alex">Alex</option>
                                        <option value="Taylor">Taylor</option>
                                        <option value="Custom">Custom (Enter below)</option>
                                    </select>
                                    <div class="form-hint">This is how your AI advisor will introduce themselves in recommendations</div>
                                </div>
                                <div class="form-group" id="customAdvisorNameGroup" style="display: none;">
                                    <label class="form-label">Custom Advisor Name</label>
                                    <input type="text" class="form-input" id="settingCustomAdvisorName" placeholder="e.g., Chris, Jordan, Morgan...">
                                    <div class="form-hint">Enter any name you'd like (keep it short)</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Advisor Personality</label>
                                <select class="form-select" id="settingAiAdvisorTone">
                                    <option value="supportive">🤝 Supportive Coach - Encouraging, friendly, explains things clearly</option>
                                    <option value="straight_shooter">🎯 Straight Shooter - Direct, no-nonsense, gets to the point</option>
                                    <option value="data_nerd">📊 Data Nerd - Analytical, statistical, loves the numbers</option>
                                </select>
                                <div class="form-hint">This affects how your AI advisor communicates recommendations</div>
                            </div>
                            <div style="padding: 12px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(34, 197, 94, 0.1)); border-radius: var(--radius); font-size: 12px; color: var(--text-secondary); margin-top: 12px; border: 1px solid var(--accent);">
                                <strong>💡 How it works:</strong> Your AI advisor analyzes each bid and gives you personalized GO/REVIEW/PASS recommendations in their unique style. Changes take effect on your next bid analysis or when you re-analyze existing projects.
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div class="settings-card-title">🎛️ Other Preferences</div>
                            <div class="settings-card-description">Additional settings for calculations and defaults</div>
                        </div>
                        <div class="settings-card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Avg. Decision Time (minutes)</label>
                                    <input type="number" class="form-input" id="settingDecisionTime" value="45" min="5" max="240">
                                    <div class="form-hint">How long does it typically take you to review a bid? Used for "Hours Saved" calculation.</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Default GC Rating</label>
                                    <select class="form-select" id="settingDefaultStars">
                                        <option value="1">1 star</option>
                                        <option value="2">2 stars</option>
                                        <option value="3" selected>3 stars (neutral)</option>
                                        <option value="4">4 stars</option>
                                        <option value="5">5 stars</option>
                                    </select>
                                    <div class="form-hint">When you add a new GC, what's their default rating?</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="saveSettings()" style="width: 100%; padding: 14px; font-size: 15px;">💾 Save All Settings</button>
                </div>
            </div>

            <!-- Admin Tab -->
            <div class="tab-content" id="tab-admin">
                <header class="page-header">
                    <h2 class="page-title">🛡️ Admin Dashboard</h2>
                    <p class="page-subtitle">Beta feedback and system management</p>
                </header>
                <div class="page-content">

                    <!-- Beta Feedback Section -->
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div class="settings-card-title">💬 Beta Feedback</div>
                            <div class="settings-card-description">View and manage feedback from beta testers</div>
                        </div>
                        <div class="settings-card-body">
                            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                                <button class="btn btn-secondary" onclick="loadAllFeedback()">🔄 Refresh</button>
                                <select id="feedbackFilter" onchange="filterFeedback()" class="form-select" style="width: 200px;">
                                    <option value="all">All Feedback</option>
                                    <option value="bug">🐛 Bugs Only</option>
                                    <option value="feature">💡 Features Only</option>
                                    <option value="ux">🎨 UX Issues Only</option>
                                    <option value="general">💬 General Only</option>
                                </select>
                            </div>
                            <div id="feedbackList" style="max-height: 600px; overflow-y: auto;">
                                <p style="color: var(--text-muted); text-align: center; padding: 40px;">Click Refresh to load feedback</p>
                            </div>
                        </div>
                    </div>

                    <!-- GC Alias Management -->
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div class="settings-card-title">🔗 GC Alias Management</div>
                            <div class="settings-card-description">Merge duplicate GC entries and manage aliases</div>
                        </div>
                        <div class="settings-card-body">
                            <button class="btn btn-secondary" onclick="findDuplicateGCs()">🔍 Find Potential Duplicates</button>
                            <div id="duplicateGCsList" style="margin-top: 16px;">
                                <p style="color: var(--text-muted);">Click "Find Potential Duplicates" to scan for similar GC names</p>
                            </div>
                        </div>
                    </div>

                    <!-- System Stats -->
                    <div class="settings-card">
                        <div class="settings-card-header">
                            <div class="settings-card-title">📊 System Statistics</div>
                            <div class="settings-card-description">Platform health and usage metrics</div>
                        </div>
                        <div class="settings-card-body">
                            <button class="btn btn-secondary" onclick="loadSystemStats()">📈 Load Stats</button>
                            <div id="systemStats" style="margin-top: 16px;">
                                <p style="color: var(--text-muted);">Click "Load Stats" to view system metrics</p>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Full-Page Report View -->
            <div class="tab-content" id="tab-report">
                <header class="page-header">
                    <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                        <button class="btn btn-secondary" onclick="closeFullReport()" style="padding: 8px 12px;">
                            ← Back
                        </button>
                        <div>
                            <h2 class="page-title" id="reportPageTitle">Bid Report</h2>
                            <p class="page-subtitle" id="reportPageSubtitle">Complete analysis and details</p>
                        </div>
                    </div>
                </header>
                <div class="page-content">

                    <!-- Editable Project Details Card -->
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-header">
                            <h3 class="card-title">📋 Project Details</h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm btn-primary" onclick="reanalyzeProject()" id="reanalyzeBtn">🔄 Re-analyze</button>
                                <button class="btn btn-sm btn-secondary" onclick="showReuploadModal()" id="reuploadBtn">📤 Upload New Documents</button>
                                <button class="btn btn-sm btn-secondary" onclick="showOutcomeFromReport()">+ Add Outcome</button>
                                <button class="btn btn-sm btn-secondary" onclick="printReport()">🖨 Print Report</button>
                                <button class="btn btn-sm btn-primary" onclick="saveReportEdits()">💾 Save Changes</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <input type="hidden" id="reportProjectId" value="">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Project Name</label>
                                    <input type="text" class="form-input" id="reportProjectName" placeholder="Enter project name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Building Type</label>
                                    <select class="form-select" id="reportBuildingType">
                                        <option value="Office">Office</option>
                                        <option value="Retail">Retail</option>
                                        <option value="Healthcare">Healthcare</option>
                                        <option value="Education">Education</option>
                                        <option value="Industrial">Industrial</option>
                                        <option value="Multi-family">Multi-family</option>
                                        <option value="Hospitality">Hospitality</option>
                                        <option value="Government">Government</option>
                                        <option value="Warehouse">Warehouse</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">City</label>
                                    <input type="text" class="form-input" id="reportCity" placeholder="City">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">State</label>
                                    <input type="text" class="form-input" id="reportState" placeholder="State" maxlength="2" style="text-transform: uppercase;" oninput="this.value = this.value.toUpperCase()">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">General Contractors</label>
                                    <div id="reportGCList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; min-height: 40px; padding: 8px; background: var(--bg-secondary); border-radius: 6px;"></div>
                                    <div style="display: flex; gap: 8px;">
                                        <input type="text" class="form-input" id="reportGCInput" placeholder="Add GC name" style="flex: 1;">
                                        <button class="btn btn-sm btn-secondary" onclick="addGCFromReport()">+ Add GC</button>
                                    </div>
                                    <div class="form-hint">Add or remove GCs. New GCs will be added to your database.</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Analysis Date</label>
                                    <input type="date" class="form-input" id="reportAnalysisDate">
                                    <div class="form-hint">When was this bid analyzed?</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- General Contractors Bidding Card -->
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-header">
                            <h3 class="card-title">🏢 General Contractors Bidding</h3>
                        </div>
                        <div class="card-body">
                            <div id="reportGCsContent"></div>
                        </div>
                    </div>

                    <!-- Score Report Card -->
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-header">
                            <h3 class="card-title">📊 AI Scoring Analysis</h3>
                        </div>
                        <div class="card-body">
                            <div id="reportScoreContent"></div>
                        </div>
                    </div>

                    <!-- AI Recommendations Card -->
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-header">
                            <h3 class="card-title">💡 AI Recommendations</h3>
                        </div>
                        <div class="card-body">
                            <div id="reportRecommendations"></div>
                        </div>
                    </div>

                    <!-- Extracted Data Card -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">📄 Extracted Data</h3>
                        </div>
                        <div class="card-body">
                            <div id="reportExtractedData"></div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header"><h3 class="modal-title" id="reportModalTitle">Bid Report</h3><button class="modal-close" onclick="closeModal('reportModal')">×</button></div>
            <div class="modal-body" id="reportModalBody"></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="outcomeModal">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title">Record Outcome</h3><button class="modal-close" onclick="closeModal('outcomeModal')">×</button></div>
            <div class="modal-body">
                <input type="hidden" id="outcomeProjectId">
                <div class="form-group">
                    <label class="form-label">What happened with this bid?</label>
                    <select class="form-select" id="outcomeType" onchange="updateOutcomeFields()">
                        <option value="">Select outcome...</option>
                        <option value="won">🎉 Won - We got the job!</option>
                        <option value="lost">❌ Lost - Someone else got it</option>
                        <option value="ghost">👻 Ghosted - No response from GC</option>
                        <option value="declined">🚫 Didn't Bid - We passed on this one</option>
                    </select>
                </div>
                <div id="outcomeFields"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('outcomeModal')">Cancel</button><button class="btn btn-primary" onclick="saveOutcome()">Save Outcome</button></div>
        </div>
    </div>
    
    <div class="modal-overlay" id="addGCModal">
        <div class="modal" style="max-width: 520px;">
            <div class="modal-header"><h3 class="modal-title">Add Client</h3><button class="modal-close" onclick="closeModal('addGCModal')">×</button></div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Client Type</label>
                    <select class="form-select" id="newClientType">
                        <option value="general_contractor">🏗️ General Contractor</option>
                        <option value="subcontractor">🔧 Subcontractor (other subs)</option>
                        <option value="end_user">👤 End User / Direct Customer</option>
                        <option value="building_owner">🏢 Building Owner / Developer</option>
                        <option value="municipality">🏛️ Municipality / Government</option>
                        <option value="distributor">📦 Distributor / Supplier</option>
                        <option value="manufacturer_rep">🏭 Manufacturer Rep</option>
                    </select>
                    <div class="form-hint">Select the type of client relationship</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Company Name</label>
                    <input type="text" class="form-input" id="newGCName" placeholder="Enter company name...">
                </div>
                <div class="form-group">
                    <label class="form-label">Office Location (optional)</label>
                    <input type="text" class="form-input" id="newGCLocation" placeholder="e.g., Kansas City">
                    <div class="form-hint">Add location if they have multiple offices</div>
                </div>

                <!-- Prominent Rating Section -->
                <div class="form-group" style="background: var(--bg-secondary); padding: 20px; border-radius: var(--radius); border: 2px solid var(--accent); margin: 20px 0;">
                    <label class="form-label" style="font-size: 16px; font-weight: 700; margin-bottom: 8px; display: block;">⭐ Rate Your Experience</label>
                    <div class="form-hint" style="margin-bottom: 16px; font-size: 13px;">
                        Rating this client now helps BidIntell give you better recommendations. You can always change it later!
                    </div>
                    <div style="text-align: center; padding: 12px 0;">
                        <div id="newGCRating" class="gc-item-rating" style="font-size: 40px; letter-spacing: 8px;"></div>
                        <div style="margin-top: 12px; font-size: 14px; color: var(--text-muted);" id="ratingDescription">
                            <span id="ratingLabel"></span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 12px; font-size: 11px; color: var(--text-muted); justify-content: space-between;">
                        <span>★ Poor</span>
                        <span>★★ Fair</span>
                        <span>★★★ Good</span>
                        <span>★★★★ Great</span>
                        <span>★★★★★ Excellent</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Tags (optional)</label>
                    <div style="margin-bottom:12px;">
                        <div style="font-weight:600;font-size:11px;color:var(--success);margin-bottom:6px;">✓ POSITIVE TAGS</div>
                        <div style="display:flex;flex-wrap:wrap;gap:6px;">
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 10px;background:var(--bg-secondary);border-radius:var(--radius);font-size:12px;border:1px solid var(--border-color);"><input type="checkbox" value="fast_pay" class="gcRiskTag"> 💵 Fast pay</label>
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 10px;background:var(--bg-secondary);border-radius:var(--radius);font-size:12px;border:1px solid var(--border-color);"><input type="checkbox" value="fair_pricing" class="gcRiskTag"> ✅ Fair pricing</label>
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 10px;background:var(--bg-secondary);border-radius:var(--radius);font-size:12px;border:1px solid var(--border-color);"><input type="checkbox" value="good_communication" class="gcRiskTag"> 💬 Great communication</label>
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 10px;background:var(--bg-secondary);border-radius:var(--radius);font-size:12px;border:1px solid var(--border-color);"><input type="checkbox" value="repeat_customer" class="gcRiskTag"> 🔄 Repeat customer</label>
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 10px;background:var(--bg-secondary);border-radius:var(--radius);font-size:12px;border:1px solid var(--border-color);"><input type="checkbox" value="easy_to_work_with" class="gcRiskTag"> 🤝 Easy to work with</label>
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 10px;background:var(--bg-secondary);border-radius:var(--radius);font-size:12px;border:1px solid var(--border-color);"><input type="checkbox" value="fair_on_cos" class="gcRiskTag"> 📝 Fair on COs</label>
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 10px;background:var(--bg-secondary);border-radius:var(--radius);font-size:12px;border:1px solid var(--border-color);"><input type="checkbox" value="organized" class="gcRiskTag"> 📋 Well organized</label>
                        </div>
                    </div>
                    <div>
                        <div style="font-weight:600;font-size:11px;color:var(--danger);margin-bottom:6px;">⚠️ RISK TAGS</div>
                        <div style="display:flex;flex-wrap:wrap;gap:6px;">
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 10px;background:var(--bg-secondary);border-radius:var(--radius);font-size:12px;border:1px solid var(--border-color);"><input type="checkbox" value="slow_pay" class="gcRiskTag"> 💰 Slow pay</label>
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 10px;background:var(--bg-secondary);border-radius:var(--radius);font-size:12px;border:1px solid var(--border-color);"><input type="checkbox" value="pay_if_paid" class="gcRiskTag"> 📋 Pay-if-paid</label>
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 10px;background:var(--bg-secondary);border-radius:var(--radius);font-size:12px;border:1px solid var(--border-color);"><input type="checkbox" value="change_order_hostile" class="gcRiskTag"> ⚠️ CO hostile</label>
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 10px;background:var(--bg-secondary);border-radius:var(--radius);font-size:12px;border:1px solid var(--border-color);"><input type="checkbox" value="bid_shopping" class="gcRiskTag"> 🛒 Bid shopping</label>
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 10px;background:var(--bg-secondary);border-radius:var(--radius);font-size:12px;border:1px solid var(--border-color);"><input type="checkbox" value="low_feedback" class="gcRiskTag"> 🔇 Low feedback</label>
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 10px;background:var(--bg-secondary);border-radius:var(--radius);font-size:12px;border:1px solid var(--border-color);"><input type="checkbox" value="scope_creep" class="gcRiskTag"> 📈 Scope creep</label>
                        </div>
                    </div>
                    <div class="form-hint">Tags help track client performance and show in analysis warnings</div>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 8px; justify-content: space-between;">
                <button class="btn btn-secondary" onclick="closeModal('addGCModal')">Cancel</button>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="saveNewGC(true)" style="white-space: nowrap;">
                        <span style="opacity: 0.7;">Rate Later</span>
                    </button>
                    <button class="btn btn-primary" onclick="saveNewGC(false)">
                        <span>Add Client</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reupload Documents Modal -->
    <div class="modal-overlay" id="reuploadModal" style="display: none;">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">📤 Upload New Documents</h3>
                <button class="modal-close" onclick="closeReuploadModal()">✕</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: var(--text-secondary);">
                    Upload new bid documents to re-analyze this project with updated information.
                </p>

                <!-- File Upload Zone -->
                <div id="reuploadDropZone" style="
                    border: 2px dashed var(--border-color);
                    border-radius: var(--radius);
                    padding: 40px;
                    text-align: center;
                    background: var(--bg-secondary);
                    cursor: pointer;
                    transition: all 0.2s;
                    margin-bottom: 16px;
                " ondragover="event.preventDefault(); this.style.borderColor='var(--accent)'; this.style.background='rgba(59, 130, 246, 0.1)';"
                   ondragleave="this.style.borderColor='var(--border-color)'; this.style.background='var(--bg-secondary)';"
                   ondrop="handleReuploadDrop(event)"
                   onclick="document.getElementById('reuploadFileInput').click()">
                    <div style="font-size: 48px; margin-bottom: 12px;">📄</div>
                    <div style="font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">
                        Drop PDFs here or click to browse
                    </div>
                    <div style="font-size: 13px; color: var(--text-muted);">
                        Supported: PDF files (large files may take longer to process)
                    </div>
                </div>

                <input type="file" id="reuploadFileInput" accept=".pdf" multiple style="display: none;" onchange="handleReuploadFiles(this.files)">

                <!-- File List -->
                <div id="reuploadFileList" style="margin-bottom: 16px;"></div>

                <!-- Progress -->
                <div id="reuploadProgress" style="display: none; margin-bottom: 16px;">
                    <div style="margin-bottom: 8px; font-size: 14px; color: var(--text-primary);" id="reuploadProgressText">Processing...</div>
                    <div style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                        <div id="reuploadProgressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--success)); transition: width 0.3s ease;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeReuploadModal()">Cancel</button>
                <button class="btn btn-primary" onclick="processReupload()" id="reuploadProcessBtn" disabled>
                    <span>🔄 Re-analyze with New Documents</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Onboarding Modal -->
    <div class="modal-overlay" id="onboardingModal" style="background: rgba(0,0,0,0.95);">
        <div class="modal" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="border-bottom: 2px solid var(--accent);">
                <div>
                    <h3 class="modal-title">Welcome to BidIntell 🎯</h3>
                    <p style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Let's get you set up in 9 quick steps</p>
                </div>
            </div>

            <!-- Progress Bar -->
            <div style="padding: 16px 24px 0; background: var(--bg-secondary);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="font-size: 12px; color: var(--text-muted);">Step <span id="onboardingCurrentStep">1</span> of 10</span>
                    <span style="font-size: 12px; color: var(--text-muted);"><span id="onboardingProgress">14</span>% complete</span>
                </div>
                <div style="height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;">
                    <div id="onboardingProgressBar" style="height: 100%; width: 14%; background: linear-gradient(90deg, var(--accent), var(--success)); transition: width 0.3s ease;"></div>
                </div>
            </div>

            <div class="modal-body" id="onboardingBody" style="min-height: 320px; padding-top: 24px;">
                <!-- Step content will be dynamically loaded here -->
            </div>

            <div class="modal-footer" style="border-top: 2px solid var(--border-color); padding: 16px 24px;">
                <button class="btn btn-secondary" id="onboardingBackBtn" onclick="onboardingBack()" style="display: none;">← Back</button>
                <div style="flex: 1;"></div>
                <button class="btn btn-secondary" id="onboardingSkipBtn" onclick="skipOnboarding()" style="margin-right: 8px;">Skip for now</button>
                <button class="btn btn-primary" id="onboardingNextBtn" onclick="onboardingNext()">Next →</button>
            </div>
        </div>
    </div>

    <!-- Beta Feedback Widget -->
    <div class="modal-overlay" id="feedbackModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">🎯 Beta Feedback</h3>
                <button class="modal-close" onclick="closeFeedbackModal()">×</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 14px;">
                    Your feedback helps us build BidIntell for real subcontractors. Thank you! 🙏
                </p>

                <div class="form-group">
                    <label class="form-label">Feedback Type</label>
                    <select class="form-select" id="feedbackType">
                        <option value="bug">🐛 Bug Report</option>
                        <option value="feature">💡 Feature Request</option>
                        <option value="ux">🎨 UX/Design Issue</option>
                        <option value="general">💬 General Feedback</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Title (brief summary)</label>
                    <input type="text" class="form-input" id="feedbackTitle" placeholder="e.g., Score calculation seems off">
                </div>

                <div class="form-group">
                    <label class="form-label">Details</label>
                    <textarea class="form-input" id="feedbackDescription" rows="5" placeholder="Please describe what happened, what you expected, and any other details..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">How easy is BidIntell to use? (1-5)</label>
                    <div style="display: flex; gap: 8px; font-size: 28px; margin-top: 8px; justify-content: center;">
                        <span onclick="setFeedbackRating('ease', 1)" id="easeRating1" style="cursor: pointer; color: var(--text-muted); transition: all 0.2s ease;">⭐</span>
                        <span onclick="setFeedbackRating('ease', 2)" id="easeRating2" style="cursor: pointer; color: var(--text-muted); transition: all 0.2s ease;">⭐</span>
                        <span onclick="setFeedbackRating('ease', 3)" id="easeRating3" style="cursor: pointer; color: var(--text-muted); transition: all 0.2s ease;">⭐</span>
                        <span onclick="setFeedbackRating('ease', 4)" id="easeRating4" style="cursor: pointer; color: var(--text-muted); transition: all 0.2s ease;">⭐</span>
                        <span onclick="setFeedbackRating('ease', 5)" id="easeRating5" style="cursor: pointer; color: var(--text-muted); transition: all 0.2s ease;">⭐</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 11px; color: var(--text-muted);">
                        <span>Hard to use</span>
                        <span>Very easy</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">How accurate are the scores? (1-5)</label>
                    <div style="display: flex; gap: 8px; font-size: 28px; margin-top: 8px; justify-content: center;">
                        <span onclick="setFeedbackRating('accuracy', 1)" id="accuracyRating1" style="cursor: pointer; color: var(--text-muted); transition: all 0.2s ease;">⭐</span>
                        <span onclick="setFeedbackRating('accuracy', 2)" id="accuracyRating2" style="cursor: pointer; color: var(--text-muted); transition: all 0.2s ease;">⭐</span>
                        <span onclick="setFeedbackRating('accuracy', 3)" id="accuracyRating3" style="cursor: pointer; color: var(--text-muted); transition: all 0.2s ease;">⭐</span>
                        <span onclick="setFeedbackRating('accuracy', 4)" id="accuracyRating4" style="cursor: pointer; color: var(--text-muted); transition: all 0.2s ease;">⭐</span>
                        <span onclick="setFeedbackRating('accuracy', 5)" id="accuracyRating5" style="cursor: pointer; color: var(--text-muted); transition: all 0.2s ease;">⭐</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 11px; color: var(--text-muted);">
                        <span>Not accurate</span>
                        <span>Very accurate</span>
                    </div>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="feedbackRecommend" style="accent-color: var(--accent);">
                        <span>I would recommend BidIntell to other subs</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeFeedbackModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitFeedback()">Submit Feedback</button>
            </div>
        </div>
    </div>

    <!-- Floating Feedback Button -->
    <button id="feedbackButton" onclick="openFeedbackModal()" style="position: fixed; bottom: 20px; right: 20px; z-index: 999; background: var(--accent); color: white; border: none; border-radius: 50px; padding: 14px 20px; font-size: 14px; font-weight: 600; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); cursor: pointer; display: none; align-items: center; gap: 8px; transition: all 0.2s;">
        <span style="font-size: 18px;">💬</span> Beta Feedback
    </button>

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        // CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://szifhqmrddmdkgschkkw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN6aWZocW1yZGRtZGtnc2Noa2t3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwOTkyMDUsImV4cCI6MjA4NDY3NTIwNX0.XSStBZABbfJRMkGqwG-uh2X6nco7GqtiIxUg_0HHlZE';

        // API Keys removed - now handled by backend functions
        const CLAUDE_API_KEY = undefined;
        const OPENAI_API_KEY = undefined;
        const POSTMARK_API_KEY = undefined;

        const GOOGLE_MAPS_API_KEY = 'AIzaSyAPxYsWrlpVgYW4xBdXg82Zcp5Ll0_icd0';
        const API_BASE_URL = '/.netlify/functions'; // Backend API functions

        let supabaseClient = null;
        let currentUser = null;

        // ============================================
        // SECURE API CLIENT - Calls backend functions
        // ============================================

        /**
         * Call AI API via secure backend
         * @param {string} operation - Operation name (e.g., 'extract_data', 'detect_risks')
         * @param {string} text - Text to analyze
         * @param {string} systemPrompt - System prompt for AI
         * @returns {Promise<string>} - AI response text
         */
        async function callAI(operation, text, systemPrompt, projectId = null) {
            const startTime = Date.now();
            try {
                const response = await fetch(`${API_BASE_URL}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser?.id || 'anonymous',
                        operation,
                        text,
                        systemPrompt
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    const latencyMs = Date.now() - startTime;

                    // Track failed API call
                    await trackAPIUsage(
                        operation,
                        'unknown',
                        'unknown',
                        0,
                        0,
                        0,
                        projectId,
                        false,
                        error.error || `API error: ${response.status}`,
                        latencyMs
                    );

                    throw new Error(error.error || `API error: ${response.status}`);
                }

                const data = await response.json();
                const latencyMs = Date.now() - startTime;

                // Track API usage if we have usage data
                if (data.usage && data.provider && data.model) {
                    const inputTokens = data.usage.input_tokens || 0;
                    const outputTokens = data.usage.output_tokens || 0;

                    // Map provider names (backend returns 'claude', pricing expects 'anthropic')
                    const providerForPricing = data.provider === 'claude' ? 'anthropic' : data.provider;

                    // Calculate cost
                    const cost = calculateAPICost(providerForPricing, data.model, inputTokens, outputTokens);

                    // Track usage
                    await trackAPIUsage(
                        operation,
                        data.provider,
                        data.model,
                        inputTokens,
                        outputTokens,
                        cost,
                        projectId,
                        true,
                        null,
                        latencyMs
                    );
                }

                return data.result;
            } catch (error) {
                console.error('AI API error:', error);
                throw error;
            }
        }

        /**
         * Send error notification via backend
         */
        async function sendErrorNotification(errorType, errorMessage, stackTrace) {
            try {
                await fetch(`${API_BASE_URL}/notify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        errorType,
                        errorMessage,
                        userEmail: currentUser?.email || 'Not logged in',
                        stackTrace
                    })
                });
            } catch (error) {
                console.error('Failed to send error notification:', error);
            }
        }

        // Error notification banner (founder only)
        // Check if current user is admin
        function isAdmin() {
            const adminEmails = ['ryan@fsikc.com', 'ryan@bidintell.ai'];
            return currentUser && adminEmails.includes(currentUser.email);
        }

        function showErrorBanner(message) {
            // Only show to founder
            if (!isAdmin()) {
                console.warn('⚠️ API Error (hidden from user):', message);
                return;
            }

            // Remove any existing error banner
            const existingBanner = document.getElementById('errorBanner');
            if (existingBanner) existingBanner.remove();

            // Create new error banner
            const banner = document.createElement('div');
            banner.id = 'errorBanner';
            banner.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
                color: white;
                padding: 16px 24px;
                text-align: center;
                font-size: 14px;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: space-between;
                animation: slideDown 0.3s ease-out;
            `;

            banner.innerHTML = `
                <div style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 12px;">
                    <span style="font-size: 20px;">⚠️</span>
                    <span>${message}</span>
                </div>
                <button onclick="document.getElementById('errorBanner').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600;">
                    Dismiss
                </button>
            `;

            document.body.appendChild(banner);

            // Auto-dismiss after 10 seconds
            setTimeout(() => {
                if (document.getElementById('errorBanner')) {
                    banner.style.animation = 'slideUp 0.3s ease-out';
                    setTimeout(() => banner.remove(), 300);
                }
            }, 10000);
        }

        // Send email alert for critical errors
        async function sendErrorEmail(errorType, errorDetails) {
            try {
                const response = await fetch('https://api.postmarkapp.com/email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Postmark-Server-Token': POSTMARK_API_KEY
                    },
                    body: JSON.stringify({
                        From: 'hello@bidintell.ai',
                        To: 'ryan@bidintell.ai',
                        Subject: `🚨 BidIQ Error: ${errorType}`,
                        HtmlBody: `
                            <h2>BidIQ Error Alert</h2>
                            <p><strong>Error Type:</strong> ${errorType}</p>
                            <p><strong>Details:</strong> ${errorDetails}</p>
                            <p><strong>Time:</strong> ${new Date().toLocaleString()}</p>
                            <p><strong>User:</strong> ${currentUser?.email || 'Unknown'}</p>
                            <hr>
                            <p style="color: #666; font-size: 12px;">
                                This alert was automatically generated by BidIQ when a critical API error occurred.
                            </p>
                        `,
                        MessageStream: 'outbound'
                    })
                });

                if (!response.ok) {
                    console.error('Failed to send error email:', response.status);
                }
            } catch (e) {
                console.error('Error sending email notification:', e);
            }
        }

        // Initialize Supabase if available
        console.log('Checking for Supabase...', typeof supabase);
        if (typeof supabase !== 'undefined') {
            try {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase client initialized successfully');
            } catch (e) {
                console.error('Failed to initialize Supabase:', e);
            }
        } else {
            console.error('Supabase library not loaded!');
        }
        
        // Auth tab switching
        function switchAuthTab(tab) {
            document.getElementById('loginTab').classList.remove('active');
            document.getElementById('signupTab').classList.remove('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('signupForm').classList.remove('active');
            document.getElementById(tab + 'Form').classList.add('active');
            
            document.getElementById('authError').style.display = 'none';
            document.getElementById('authSuccess').style.display = 'none';
        }
        
        function togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'Hide';
            } else {
                input.type = 'password';
                btn.textContent = 'Show';
            }
        }
        
        function showAuthError(msg) {
            document.getElementById('authError').textContent = msg;
            document.getElementById('authError').style.display = 'block';
            document.getElementById('authSuccess').style.display = 'none';
        }
        
        function showAuthSuccess(msg) {
            document.getElementById('authSuccess').textContent = msg;
            document.getElementById('authSuccess').style.display = 'block';
            document.getElementById('authError').style.display = 'none';
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            console.log('Login attempt started');
            
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            
            console.log('Login email:', email);
            
            if (!email || !password) {
                showAuthError('Please enter both email and password');
                return;
            }
            
            if (!supabaseClient) { 
                showAuthError('Database not connected. Please refresh the page.'); 
                console.error('Supabase client is null');
                return; 
            }
            
            btn.disabled = true;
            btn.textContent = 'Signing in...';
            
            try {
                console.log('Calling Supabase auth...');
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                console.log('Supabase response:', { data, error });
                
                if (error) throw error;
                currentUser = data.user;
                console.log('Login successful, showing app');
                showApp();
            } catch (err) {
                console.error('Login error:', err);
                showAuthError(err.message || 'Login failed. Please check your email and password.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Sign In';
            }
        }
        
        async function handleSignup(e) {
            e.preventDefault();
            console.log('Signup attempt started');

            const company = document.getElementById('signupCompany').value.trim();
            const email = document.getElementById('signupEmail').value.trim().toLowerCase();
            const password = document.getElementById('signupPassword').value;
            const tosAccepted = document.getElementById('tosAcceptance').checked;
            const btn = document.getElementById('signupBtn');
            const tosError = document.getElementById('tosError');

            console.log('Signup email:', email);

            if (!company || !email || !password) {
                showAuthError('Please fill in all fields');
                return;
            }

            if (!tosAccepted) {
                tosError.style.display = 'block';
                showAuthError('You must accept the Terms and Privacy Policy to continue');
                return;
            } else {
                tosError.style.display = 'none';
            }

            if (password.length < 6) {
                showAuthError('Password must be at least 6 characters');
                return;
            }
            
            if (!supabaseClient) { 
                showAuthError('Database not connected. Please refresh the page.'); 
                console.error('Supabase client is null');
                return; 
            }
            
            btn.disabled = true;
            btn.textContent = 'Creating account...';
            
            try {
                console.log('Calling Supabase signup...');
                const tosVersion = '2026-02-05';
                const acceptanceTimestamp = new Date().toISOString();

                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            company_name: company,
                            tos_accepted_at: acceptanceTimestamp,
                            privacy_accepted_at: acceptanceTimestamp,
                            tos_version: tosVersion,
                            privacy_version: tosVersion
                        }
                    }
                });
                
                console.log('Signup response:', { data, error });
                
                if (error) throw error;
                if (data.user && !data.session) {
                    showAuthSuccess('Account created! Check your email to confirm, then sign in.');
                } else {
                    currentUser = data.user;
                    console.log('Signup successful, showing app');
                    showApp();
                }
            } catch (err) {
                console.error('Signup error:', err);
                showAuthError(err.message || 'Signup failed. Please try again.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        }
        
        async function handleLogout() {
            if (supabaseClient) await supabaseClient.auth.signOut();
            currentUser = null;
            clearDataCache();
            // Redirect to landing page instead of showing auth screen
            window.location.href = '/';
        }
        
        async function showApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            if (currentUser) document.getElementById('userEmail').textContent = currentUser.email;

            // Show AI Advisor chat button
            const chatButton = document.getElementById('aiChatButton');
            if (chatButton) {
                chatButton.style.display = 'flex';
            }

            // Update AI Advisor name in chat header
            const settings = await getSettings();
            const advisorName = settings.ai_advisor_name || 'Sam';
            const chatTitle = document.getElementById('aiChatTitle');
            if (chatTitle) {
                chatTitle.textContent = `${advisorName} - AI Advisor`;
            }

            loadAll();
            checkFeedbackButtonVisibility();
        }
        
        // Check for existing session on load
        if (supabaseClient) {
            // Set up auth state listener
            supabaseClient.auth.onAuthStateChange((event, session) => {
                console.log('🔐 Auth state changed:', event, session?.user?.email);

                if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED') {
                    currentUser = session?.user || null;
                    if (currentUser && document.getElementById('mainApp').style.display === 'none') {
                        showApp();
                    }
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    clearDataCache();
                    document.getElementById('authScreen').style.display = 'flex';
                    document.getElementById('mainApp').style.display = 'none';
                }
            });

            // Check for existing session
            supabaseClient.auth.getSession().then(({ data: { session } }) => {
                if (session) {
                    console.log('✅ Existing session found:', session.user.email);
                    currentUser = session.user;
                    showApp();
                } else {
                    console.log('ℹ️ No existing session, showing auth screen');
                }
            });
        }
        
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // State
        let uploadedFiles = [];
        let selectedClients = []; // New: supports GCs, End Users, Building Owners
        let selectedGCs = []; // Legacy: kept for backward compatibility
        let currentAnalysis = null;
        let newClientRatingValue = 3;
        let newGCRatingValue = 3; // Legacy

        // Onboarding State
        let onboardingStep = 1;
        let onboardingData = {
            companyType: 'subcontractor',
            providesInstallation: true,
            productLines: [],
            productCategories: [],
            city: '',
            state: '',
            trades: [],
            clientTypes: ['gcs'], // Types of clients the user works for
            locationImportance: 50,
            riskTolerance: 'medium',
            capacity: 'steady',
            aiAdvisorName: 'Sam',
            aiAdvisorTone: 'supportive',
            gcsAdded: 0,
            sampleBidUploaded: false
        };

        // Helper function to get ISO week number
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        // CSI Divisions - SORTED NUMERICALLY
        const CSI_DIVISIONS = [
            ['01', 'General Requirements'],
            ['02', 'Existing Conditions'],
            ['03', 'Concrete'],
            ['04', 'Masonry'],
            ['05', 'Metals'],
            ['06', 'Wood & Plastics'],
            ['07', 'Thermal & Moisture'],
            ['08', 'Openings'],
            ['09', 'Finishes'],
            ['10', 'Specialties'],
            ['11', 'Equipment'],
            ['12', 'Furnishings'],
            ['13', 'Special Construction'],
            ['14', 'Conveying Equipment'],
            ['21', 'Fire Suppression'],
            ['22', 'Plumbing'],
            ['23', 'HVAC'],
            ['25', 'Integrated Automation'],
            ['26', 'Electrical'],
            ['27', 'Communications'],
            ['28', 'Electronic Safety'],
            ['31', 'Earthwork'],
            ['32', 'Exterior Improvements'],
            ['33', 'Utilities']
        ];

        // ============================================
        // MULTI-SIGNAL TRADE DETECTION
        // ============================================

        // Drawing sheet prefix patterns (Signal 2 - 95% confidence)
        const DRAWING_PREFIXES = {
            mechanical: ['M-', 'M1', 'M2', 'M3', 'M4', 'M5', 'MH-', 'MECH-'],
            electrical: ['E-', 'E1', 'E2', 'E3', 'E4', 'E5', 'ELEC-'],
            plumbing: ['P-', 'P1', 'P2', 'P3', 'P4', 'PLUMB-'],
            fire_protection: ['FP-', 'FP1', 'FP2', 'FP3', 'FIRE-'],
            telecom: ['T-', 'T1', 'T2', 'TC-', 'TELECOM-', 'DATA-'],
            fire_alarm: ['FA-', 'FA1', 'FA2', 'FA3', 'ALARM-'],
            structural: ['S-', 'S1', 'S2', 'S3', 'STRUCT-'],
            architectural: ['A-', 'A1', 'A2', 'A3', 'ARCH-']
        };

        // Map drawing prefixes to CSI divisions
        const PREFIX_TO_CSI = {
            mechanical: ['23'],
            electrical: ['26'],
            plumbing: ['22'],
            fire_protection: ['21'],
            telecom: ['27', '28'],
            fire_alarm: ['28'],
            structural: ['05', '03'],
            architectural: ['06', '07', '08', '09']
        };

        // Material evidence keywords by division (Signal 3 - 80% confidence)
        const MATERIAL_KEYWORDS = {
            '23': {
                keywords: ['ductwork', 'air handler', 'chiller', 'VAV', 'RTU', 'boiler', 'AHU', 'diffuser',
                           'damper', 'refrigerant piping', 'split system', 'exhaust fan', 'cooling tower',
                           'heat pump', 'FCU', 'fan coil', 'makeup air', 'economizer'],
                threshold: 3
            },
            '26': {
                keywords: ['panelboard', 'switchgear', 'conduit', 'receptacle', 'circuit breaker', 'transformer',
                           'bus duct', 'motor control center', 'lighting fixture', 'disconnect', 'wire', 'raceway',
                           'junction box', 'cable tray', 'feeder', 'branch circuit'],
                threshold: 3
            },
            '22': {
                keywords: ['domestic water', 'sanitary', 'storm drain', 'water heater', 'backflow preventer',
                           'fixture schedule', 'roof drain', 'sewer', 'lavatory', 'water closet', 'urinal',
                           'drinking fountain', 'grease trap', 'ejector pump'],
                threshold: 3
            },
            '21': {
                keywords: ['sprinkler', 'standpipe', 'fire pump', 'wet system', 'dry system', 'NFPA 13',
                           'sprinkler head', 'fire department connection', 'FDC', 'siamese', 'fire riser'],
                threshold: 3
            },
            '27': {
                keywords: ['data cable', 'fiber optic', 'access control', 'CCTV', 'cat6', 'patch panel',
                           'network rack', 'intercom', 'PA system', 'structured cabling'],
                threshold: 3
            },
            '28': {
                keywords: ['fire alarm panel', 'pull station', 'smoke detector', 'heat detector',
                           'notification device', 'horn strobe', 'FACP', 'addressable'],
                threshold: 2
            },
            '09': {
                keywords: ['carpet', 'LVT', 'paint', 'drywall', 'ACT ceiling', 'flooring', 'tile',
                           'wallcovering', 'epoxy', 'rubber base', 'vinyl composition'],
                threshold: 3
            }
        };

        // Drawing title patterns (Signal 4 - 85% confidence)
        const DRAWING_TITLE_PATTERNS = {
            '23': ['HVAC PLAN', 'MECHANICAL PLAN', 'HEATING PLAN', 'COOLING PLAN', 'VENTILATION'],
            '26': ['ELECTRICAL PLAN', 'POWER PLAN', 'LIGHTING PLAN', 'ELECTRICAL RISER'],
            '22': ['PLUMBING PLAN', 'PLUMBING RISER', 'DOMESTIC WATER', 'SANITARY PLAN'],
            '21': ['FIRE PROTECTION PLAN', 'SPRINKLER PLAN', 'FIRE SUPPRESSION'],
            '27': ['DATA PLAN', 'TELECOM PLAN', 'COMMUNICATIONS PLAN'],
            '28': ['FIRE ALARM PLAN', 'ALARM FLOOR PLAN']
        };

        function detectDrawingPrefixes(pages) {
            const found = {};
            const allText = pages.map(p => p.text).join('\n');

            for (const [trade, prefixes] of Object.entries(DRAWING_PREFIXES)) {
                const matches = [];
                for (const prefix of prefixes) {
                    const regex = new RegExp(`\\b${prefix.replace('-', '[-\\s]?')}`, 'gi');
                    const matchCount = (allText.match(regex) || []).length;
                    if (matchCount > 0) {
                        matches.push({ prefix, count: matchCount });
                    }
                }

                if (matches.length > 0) {
                    found[trade] = {
                        prefixes: matches,
                        confidence: 0.95,
                        signal: 'drawing_prefix',
                        csi_divisions: PREFIX_TO_CSI[trade] || []
                    };
                }
            }

            return found;
        }

        function detectMaterialEvidence(pages, userDivisions) {
            const found = {};
            const allText = pages.map(p => p.text).join('\n').toLowerCase();

            for (const division of userDivisions) {
                const materialData = MATERIAL_KEYWORDS[division];
                if (!materialData) continue;

                const matchedKeywords = [];
                for (const keyword of materialData.keywords) {
                    const regex = new RegExp(`\\b${keyword}\\b`, 'gi');
                    if (regex.test(allText)) {
                        matchedKeywords.push(keyword);
                    }
                }

                if (matchedKeywords.length >= materialData.threshold) {
                    found[division] = {
                        keywords: matchedKeywords,
                        count: matchedKeywords.length,
                        confidence: 0.80,
                        signal: 'material_evidence'
                    };
                }
            }

            return found;
        }

        function detectDrawingTitles(pages) {
            const found = {};
            const allText = pages.map(p => p.text).join('\n');

            for (const [division, patterns] of Object.entries(DRAWING_TITLE_PATTERNS)) {
                const matches = [];
                for (const pattern of patterns) {
                    const regex = new RegExp(`\\b${pattern}\\b`, 'gi');
                    if (regex.test(allText)) {
                        matches.push(pattern);
                    }
                }

                if (matches.length > 0) {
                    found[division] = {
                        titles: matches,
                        confidence: 0.85,
                        signal: 'drawing_title'
                    };
                }
            }

            return found;
        }

        function detectTradesMultiSignal(pages, userDivisions, foundCSIDivisions = []) {
            console.log('🔍 Multi-signal trade detection starting...');
            console.log('  User divisions:', userDivisions);
            console.log('  CSI divisions found:', foundCSIDivisions);

            const results = {
                matches: [],
                signals_used: [],
                highest_confidence: 0
            };

            // Signal 1: CSI Division Headers (100% confidence)
            const csiMatches = userDivisions.filter(div => foundCSIDivisions.includes(div));
            if (csiMatches.length > 0) {
                results.matches.push(...csiMatches.map(div => ({
                    division: div,
                    confidence: 1.00,
                    signal: 'csi_header',
                    source: 'Specification section headers'
                })));
                results.signals_used.push('CSI Headers');
                results.highest_confidence = 1.00;
            }

            // Signal 2: Drawing Sheet Prefixes (95% confidence)
            const prefixResults = detectDrawingPrefixes(pages);
            for (const [trade, data] of Object.entries(prefixResults)) {
                const matchingDivisions = data.csi_divisions.filter(div => userDivisions.includes(div));
                if (matchingDivisions.length > 0) {
                    for (const div of matchingDivisions) {
                        const alreadyMatched = results.matches.some(m => m.division === div);
                        if (!alreadyMatched) {
                            results.matches.push({
                                division: div,
                                confidence: data.confidence,
                                signal: data.signal,
                                source: `Drawing sheets: ${data.prefixes.map(p => p.prefix).join(', ')}`
                            });
                        }
                    }
                    results.signals_used.push('Drawing Prefixes');
                    if (data.confidence > results.highest_confidence) {
                        results.highest_confidence = data.confidence;
                    }
                }
            }

            // Signal 3: Material Evidence Keywords (80% confidence)
            const materialResults = detectMaterialEvidence(pages, userDivisions);
            for (const [division, data] of Object.entries(materialResults)) {
                const alreadyMatched = results.matches.some(m => m.division === division);
                if (!alreadyMatched) {
                    results.matches.push({
                        division,
                        confidence: data.confidence,
                        signal: data.signal,
                        source: `Material keywords: ${data.keywords.slice(0, 5).join(', ')}${data.keywords.length > 5 ? '...' : ''}`
                    });
                    results.signals_used.push('Material Evidence');
                    if (data.confidence > results.highest_confidence) {
                        results.highest_confidence = data.confidence;
                    }
                }
            }

            // Signal 4: Drawing Titles (85% confidence)
            const titleResults = detectDrawingTitles(pages);
            for (const [division, data] of Object.entries(titleResults)) {
                const alreadyMatched = results.matches.some(m => m.division === division);
                if (!alreadyMatched && userDivisions.includes(division)) {
                    results.matches.push({
                        division,
                        confidence: data.confidence,
                        signal: data.signal,
                        source: `Drawing titles: ${data.titles.join(', ')}`
                    });
                    results.signals_used.push('Drawing Titles');
                    if (data.confidence > results.highest_confidence) {
                        results.highest_confidence = data.confidence;
                    }
                }
            }

            // Remove duplicate signal names
            results.signals_used = [...new Set(results.signals_used)];

            console.log('✅ Multi-signal trade detection complete');
            console.log('  Matches found:', results.matches.length);
            console.log('  Signals used:', results.signals_used);
            console.log('  Highest confidence:', results.highest_confidence);

            return results;
        }

        const DEFAULT_GOOD = [];
        const DEFAULT_BAD = [];

        // Data cache for performance
        let dataCache = { settings: null, keywords: null, clients: null, gcs: null, projects: null }; // gcs kept for backward compat
        
        const DEFAULT_SETTINGS = { city: '', state: '', radius: 50, locationMatters: true, trades: ['23', '26'], riskTolerance: 'medium', capacity: 'steady', weights: { location: 25, keywords: 30, gc: 25, trade: 20 }, decisionTime: 45, defaultStars: 3, onboarding_completed: false };

        // ============================================
        // CONTRACT RISK DETECTION WITH CONFIDENCE WEIGHTING
        // ============================================

        /**
         * Detect contract risks with confidence scores
         * Returns risks categorized by confidence tier: high (≥0.80), medium (0.50-0.79), low (<0.50)
         */
        /**
         * Extract building type from project details
         */
        async function extractBuildingType(projectName, scopeSummary, fullText) {
            const truncatedText = fullText.substring(0, 8000);
            const prompt = `Analyze this construction project and classify the building type.

Project Name: ${projectName}
Scope: ${scopeSummary}

Document excerpt:
${truncatedText}

Classify as ONE of: Healthcare, Office, Multifamily, Retail, Industrial, Education, Higher Education, Government, Religious, Mixed-Use, Infrastructure, Other.

CRITICAL RULES:
1. If multiple building types mentioned together (office + retail, residential + commercial) → Mixed-Use
2. If project name contains "LOFTS" → Multifamily
3. If contains apartments, condos, residential units → Multifamily
4. Default to Other if truly ambiguous

Return JSON with this exact format:
{
  "type": "Office",
  "confidence": 0.85,
  "reasoning": "Project description mentions office space and commercial use"
}`;

            try {
                const response = await callAI('extract_building_type', truncatedText, prompt);

                // Strip markdown code blocks if present (AI sometimes returns ```json...```)
                let jsonStr = response;
                if (response.includes('```')) {
                    const match = response.match(/```(?:json)?\s*([\s\S]*?)```/);
                    if (match) jsonStr = match[1];
                }

                const result = JSON.parse(jsonStr.trim());
                return result;
            } catch (error) {
                console.error('Building type extraction failed:', error);
                return {
                    type: 'Other',
                    confidence: 0,
                    reasoning: 'Extraction failed'
                };
            }
        }

        async function detectContractRisks(fullText) {
            if (!fullText || fullText.length < 100) {
                return {
                    hasContractLanguage: false,
                    risksDetected: [],
                    risksByTier: { high: [], medium: [], low: [] }
                };
            }

            // Quick check: does document contain contract language?
            const contractIndicators = ['shall', 'agreement', 'contract', 'terms', 'conditions', 'indemnify', 'warranty'];
            const hasContractLanguage = contractIndicators.some(word =>
                new RegExp(`\\b${word}\\b`, 'i').test(fullText.substring(0, 10000))
            );

            if (!hasContractLanguage) {
                return {
                    hasContractLanguage: false,
                    risksDetected: [],
                    risksByTier: { high: [], medium: [], low: [] }
                };
            }

            // Use Claude to detect specific contract risks with confidence scores
            const prompt = `Analyze the following construction contract language and identify specific risks. For each risk, provide a confidence score (0.0-1.0) indicating how clearly the risky language appears.

RISK TYPES TO DETECT:
1. pay_if_paid - "Pay if paid" or "Pay when paid" clauses
2. liquidated_damages - Liquidated damages clauses
3. indemnification - Broad indemnification or hold harmless language
4. no_damages_delay - "No damages for delay" clauses
5. consequential_waiver - Waiver of consequential damages
6. high_retainage - Retainage over 10%
7. slow_payment - Payment terms over 45 days
8. termination_convenience - Termination for convenience clauses
9. excessive_warranty - Warranty periods over 2 years

Return ONLY a valid JSON array:
[
  {
    "risk_type": "pay_if_paid",
    "confidence": 0.95,
    "evidence": "Brief quote showing the risky language",
    "location": "Section reference if available"
  }
]

Return [] if no risks are clearly present.

Contract text:
${fullText.substring(0, 40000)}`;

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 2048,
                        messages: [{ role: 'user', content: prompt }]
                    })
                });

                if (!response.ok) throw new Error('Claude API error');

                const data = await response.json();
                let content = data.content[0]?.text || '[]';

                // Parse JSON
                if (content.includes('```')) {
                    const match = content.match(/```(?:json)?\s*([\s\S]*?)```/);
                    if (match) content = match[1];
                }

                const risks = JSON.parse(content.trim());

                // Categorize by confidence tier
                const risksByTier = {
                    high: risks.filter(r => r.confidence >= 0.80),
                    medium: risks.filter(r => r.confidence >= 0.50 && r.confidence < 0.80),
                    low: risks.filter(r => r.confidence < 0.50)
                };

                return {
                    hasContractLanguage: true,
                    risksDetected: risks,
                    risksByTier: risksByTier,
                    totalRisks: risks.length
                };

            } catch (error) {
                console.error('Contract risk detection error:', error);
                return {
                    hasContractLanguage: true,
                    risksDetected: [],
                    risksByTier: { high: [], medium: [], low: [] },
                    error: true
                };
            }
        }

        /**
         * Calculate contract risk penalty with confidence weighting
         * High confidence (≥0.80): Full penalty
         * Medium confidence (0.50-0.79): 60% penalty
         * Low confidence (<0.50): 30% penalty
         */
        function calculateContractRiskPenalty(contractRisks, riskTolerance) {
            if (!contractRisks || !contractRisks.risksDetected || contractRisks.risksDetected.length === 0) {
                return 0;
            }

            // Base penalty per risk based on tolerance
            const basePenalty = riskTolerance === 'low' ? 15 : riskTolerance === 'medium' ? 10 : 5;

            let totalPenalty = 0;

            for (const risk of contractRisks.risksDetected) {
                const confidence = risk.confidence || 1.0;
                let multiplier = 1.0;

                // Apply confidence multiplier
                if (confidence >= 0.80) {
                    multiplier = 1.0;  // High confidence: full penalty
                } else if (confidence >= 0.50) {
                    multiplier = 0.6;  // Medium confidence: 60% penalty
                } else {
                    multiplier = 0.3;  // Low confidence: 30% penalty
                }

                totalPenalty += basePenalty * multiplier;
            }

            return Math.round(totalPenalty);
        }

        // ============================================
        // PROJECT FINGERPRINTING & DUPLICATE DETECTION
        // ============================================

        /**
         * Generate a normalized fingerprint for duplicate detection
         * Uses project name + city + state, normalized to handle variations
         */
        function generateProjectFingerprint(projectName, city, state) {
            if (!projectName) return null;

            // Normalize project name: lowercase, remove special chars, collapse whitespace
            const normalizedName = projectName
                .toLowerCase()
                .replace(/[^\w\s]/g, ' ')  // Replace special chars with space
                .replace(/\s+/g, ' ')       // Collapse multiple spaces
                .trim();

            // Normalize location
            const normalizedCity = city ? city.toLowerCase().trim() : '';
            const normalizedState = state ? state.toUpperCase().trim() : '';

            // Create fingerprint string
            const fingerprintStr = `${normalizedName}|${normalizedCity}|${normalizedState}`;

            // Simple hash function (djb2 algorithm)
            let hash = 5381;
            for (let i = 0; i < fingerprintStr.length; i++) {
                hash = ((hash << 5) + hash) + fingerprintStr.charCodeAt(i);
            }

            return `fp_${Math.abs(hash).toString(36)}`;
        }

        /**
         * Check if a project is a duplicate of an existing one
         * Returns { isDuplicate: boolean, originalProject: object | null }
         */
        async function checkDuplicateProject(projectName, city, state) {
            if (!supabaseClient || !currentUser) return { isDuplicate: false, originalProject: null };

            const fingerprint = generateProjectFingerprint(projectName, city, state);
            if (!fingerprint) return { isDuplicate: false, originalProject: null };

            try {
                const { data, error } = await supabaseClient
                    .from('projects')
                    .select('id, extracted_data, scores, created_at')
                    .eq('user_id', currentUser.id)
                    .eq('fingerprint', fingerprint)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (error) throw error;

                if (data && data.length > 0) {
                    const original = data[0];
                    const daysAgo = Math.round((Date.now() - new Date(original.created_at).getTime()) / (1000 * 60 * 60 * 24));

                    return {
                        isDuplicate: true,
                        originalProject: {
                            id: original.id,
                            name: original.extracted_data?.project_name || 'Untitled Project',
                            score: original.scores?.bidindex_score || original.scores?.final || null,
                            recommendation: original.scores?.recommendation || null,
                            daysAgo: daysAgo,
                            timeAgo: daysAgo < 30 ? `${daysAgo} days ago` :
                                     daysAgo < 90 ? `${Math.round(daysAgo/30)} months ago` :
                                     `${Math.round(daysAgo/365)} year(s) ago`
                        }
                    };
                }

                return { isDuplicate: false, originalProject: null };
            } catch (e) {
                console.error('Error checking duplicate:', e);
                console.error('   Error message:', e.message);
                console.error('   Error details:', e.details);
                return { isDuplicate: false, originalProject: null };
            }
        }

        // ============================================
        // SUPABASE DATA FUNCTIONS
        // ============================================
        
        async function getSettings() {
            if (dataCache.settings) return dataCache.settings;
            if (!supabaseClient || !currentUser) return { ...DEFAULT_SETTINGS };

            try {
                const { data, error } = await supabaseClient
                    .from('user_settings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error || !data) {
                    console.log('📝 Creating default settings for new user');
                    // Create default settings for new user
                    const newSettings = {
                        user_id: currentUser.id,
                        company_type: 'subcontractor',
                        city: '',
                        state: '',
                        search_radius: 50,
                        location_matters: true,
                        trades: ['23', '26'],
                        client_types: ['gcs'],
                        risk_tolerance: 'medium',
                        capacity: 'steady',
                        ai_advisor_name: 'Sam',
                        ai_advisor_tone: 'supportive',
                        weights: DEFAULT_SETTINGS.weights,
                        decision_time: 45,  // INTEGER minutes instead of 'normal'
                        default_stars: 3,
                        onboarding_completed: false
                    };
                    await supabaseClient.from('user_settings').insert(newSettings);
                    dataCache.settings = { ...DEFAULT_SETTINGS };
                    return dataCache.settings;
                }

                // Parse weights - handle both JSONB object and legacy separate columns
                let weights = DEFAULT_SETTINGS.weights;
                if (data.weights && typeof data.weights === 'object') {
                    weights = data.weights;
                } else if (data.weights_location) {
                    // Legacy format
                    weights = {
                        location: data.weights_location || 25,
                        keywords: data.weights_keywords || 30,
                        gc: data.weights_gc || 25,
                        trade: data.weights_trade || 20
                    };
                }

                dataCache.settings = {
                    companyType: data.company_type || 'subcontractor',
                    providesInstallation: data.provides_installation !== false,
                    productLines: data.product_lines || [],
                    productCategories: data.product_categories || [],
                    street: data.street || '',
                    city: data.city || '',
                    state: data.state || '',
                    zip: data.zip || '',
                    radius: data.search_radius || data.radius || 50,
                    locationMatters: data.location_matters !== false,
                    trades: data.trades || ['23', '26'],
                    clientTypes: data.client_types || ['gcs'],
                    riskTolerance: data.risk_tolerance || 'medium',
                    capacity: data.capacity || 'steady',
                    ai_advisor_name: data.ai_advisor_name || 'Sam',
                    ai_advisor_tone: data.ai_advisor_tone || 'supportive',
                    weights: weights,
                    decisionTime: data.decision_time || 45,  // INTEGER minutes instead of 'normal'
                    defaultStars: data.default_stars || 3,
                    onboarding_completed: data.onboarding_completed === true  // Explicit boolean check
                };
                return dataCache.settings;
            } catch (e) {
                console.error('getSettings error:', e);
                return { ...DEFAULT_SETTINGS };
            }
        }

        async function saveSettingsStorage(s) {
            if (!supabaseClient || !currentUser) {
                console.warn('⚠️ Cannot save settings - not authenticated');
                return;
            }

            try {
                console.log('💾 Saving settings to database...', {
                    trades: s.trades,
                    onboarding_completed: s.onboarding_completed
                });

                // Validate capacity value - must match DB constraint
                const validCapacities = ['slow', 'steady', 'aggressive'];
                const capacity = validCapacities.includes(s.capacity) ? s.capacity : 'steady';

                const { data, error } = await supabaseClient.from('user_settings').upsert({
                    user_id: currentUser.id,
                    company_type: s.company_type || s.companyType || 'subcontractor',
                    provides_installation: s.provides_installation !== undefined ? s.provides_installation : (s.providesInstallation !== undefined ? s.providesInstallation : true),
                    product_lines: s.product_lines || s.productLines || [],
                    product_categories: s.product_categories || s.productCategories || [],
                    street: s.street || null,
                    city: s.city,
                    state: s.state,
                    zip: s.zip || null,
                    search_radius: s.search_radius || s.radius,
                    location_matters: s.location_matters || s.locationMatters,
                    trades: s.trades,
                    client_types: s.client_types || [],
                    risk_tolerance: s.risk_tolerance || s.riskTolerance,
                    capacity: capacity,
                    ai_advisor_name: s.ai_advisor_name || 'Sam',
                    ai_advisor_tone: s.ai_advisor_tone || 'supportive',
                    weights: s.weights,
                    decision_time: s.decision_time || s.decisionTime,
                    default_stars: s.default_stars || s.defaultStars,
                    onboarding_completed: s.onboarding_completed !== undefined ? s.onboarding_completed : false,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'user_id' });

                if (error) {
                    console.error('❌ Save settings error:', error);
                    throw error;
                }

                console.log('Settings saved successfully');
                // Clear cache to force fresh load next time
                dataCache.settings = null;
            } catch (e) {
                console.error('saveSettings error:', e);
                throw e;
            }
        }

        async function getKeywords() {
            if (dataCache.keywords) return dataCache.keywords;
            if (!supabaseClient || !currentUser) return { good: [], bad: [] };
            
            try {
                const { data, error } = await supabaseClient
                    .from('user_keywords')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (error || !data) {
                    // Create default keywords for new user
                    await supabaseClient.from('user_keywords').insert({
                        user_id: currentUser.id,
                        good_keywords: [],
                        bad_keywords: []
                    });
                    dataCache.keywords = { good: [], bad: [] };
                    return dataCache.keywords;
                }
                
                dataCache.keywords = {
                    good: data.good_keywords || [],
                    bad: data.bad_keywords || []
                };
                return dataCache.keywords;
            } catch (e) {
                console.error('getKeywords error:', e);
                return { good: [], bad: [] };
            }
        }

        async function saveKeywordsStorage(k) {
            dataCache.keywords = k;
            if (!supabaseClient || !currentUser) return;
            
            try {
                await supabaseClient.from('user_keywords').upsert({
                    user_id: currentUser.id,
                    good_keywords: k.good,
                    bad_keywords: k.bad,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'user_id' });
            } catch (e) {
                console.error('saveKeywords error:', e);
            }
        }

        async function getClients(clientType = null) {
            // If requesting specific type and cached, filter cache
            if (dataCache.clients && clientType) {
                return dataCache.clients.filter(c => c.clientType === clientType);
            }
            if (dataCache.clients && !clientType) return dataCache.clients;

            if (!supabaseClient || !currentUser) return [];

            try {
                let query = supabaseClient
                    .from('clients')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('name');

                if (clientType) {
                    query = query.eq('client_type', clientType);
                }

                const { data, error } = await query;

                const clients = (data || []).map(c => ({
                    id: c.id,
                    name: c.name,
                    clientType: c.client_type || 'general_contractor',
                    rating: c.rating,
                    bids: c.bids || 0,
                    wins: c.wins || 0,
                    riskTags: c.risk_tags || []
                }));

                if (!clientType) {
                    dataCache.clients = clients;
                }

                return clients;
            } catch (e) {
                console.error('getClients error:', e);
                return [];
            }
        }

        // Legacy function - redirects to getClients
        async function getGCs() {
            return await getClients('general_contractor');
        }

        async function saveClients(clientsArray) {
            // This function handles saving the full client array (for compatibility)
            dataCache.clients = clientsArray;
            // Individual client saves handled by saveClient function below
        }

        // Legacy function
        async function saveGCs(gcsArray) {
            return await saveClients(gcsArray);
        }

        async function saveClient(client) {
            if (!supabaseClient || !currentUser) return client;
            dataCache.clients = null; // Invalidate cache

            try {
                const { data, error } = await supabaseClient.from('clients').upsert({
                    id: client.id || undefined,
                    user_id: currentUser.id,
                    name: client.name,
                    client_type: client.clientType || 'general_contractor',
                    rating: client.rating,
                    bids: client.bids || 0,
                    wins: client.wins || 0,
                    risk_tags: client.riskTags || [],
                    updated_at: new Date().toISOString()
                }, { onConflict: 'id' }).select().single();

                if (error) throw error;
                return data || client;
            } catch (e) {
                console.error('saveClient error:', e);
                return client;
            }
        }

        // Legacy function
        async function saveGC(gc) {
            return await saveClient(gc);
        }

        async function deleteClient(id) {
            if (!supabaseClient || !currentUser) return;
            dataCache.clients = null;

            try {
                await supabaseClient.from('clients').delete().eq('id', id);
            } catch (e) {
                console.error('deleteClient error:', e);
            }
        }

        // Legacy function
        async function deleteGC(id) {
            return await deleteClient(id);
        }

        async function getProjects() {
            if (dataCache.projects) {
                console.log('📦 Returning cached projects:', dataCache.projects.length);
                return dataCache.projects;
            }
            if (!supabaseClient || !currentUser) {
                console.warn('⚠️ No supabase client or user');
                return [];
            }

            // Check for stale projects and auto-ghost them
            await checkAndMarkGhostedProjects();

            try {
                const { data, error } = await supabaseClient
                    .from('projects')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });

                console.log('📊 Raw projects from DB:', data?.length || 0, 'Error:', error);
                if (error) {
                    console.error('❌ Supabase error:', error);
                    return [];
                }

                dataCache.projects = (data || []).map(p => ({
                    id: p.id,
                    extracted: p.extracted_data || {},
                    scores: p.scores || {},
                    gcs: p.gcs || [],
                    files: p.files || [],
                    outcome: p.outcome || 'pending',
                    outcomeData: p.outcome_data || {},
                    goodFound: p.good_found || [],
                    badFound: p.bad_found || [],
                    tradesFound: p.trades_found || [],
                    createdAt: p.created_at,
                    // Intelligence Engine fields
                    validationStatus: p.validation_status || null,
                    intelligenceTags: p.intelligence_tags || {},
                    aiAdvisorOutput: p.ai_advisor_output || null,
                    scoreExplanation: p.score_explanation || null,
                    // Layer 0 data
                    contractRisks: p.contract_risks || [],
                    marketMetroArea: p.market_metro_area || null,
                    buildingType: p.building_type ? { type: p.building_type } : null
                }));
                console.log('✅ Mapped projects:', dataCache.projects.length);
                return dataCache.projects;
            } catch (e) {
                console.error('❌ getProjects error:', e);
                return [];
            }
        }

        async function saveProjects(projectsArray) {
            // For compatibility - individual saves handled by saveProject
            dataCache.projects = projectsArray;
        }
        
        async function saveProject(project) {
            if (!supabaseClient || !currentUser) {
                console.error('❌ Cannot save project: not authenticated');
                return project;
            }

            console.log('💾 Saving project to database...', {
                project_name: project.extracted?.project_name,
                outcome: project.outcome,
                has_building_type: !!project.buildingType,
                has_contract_risks: !!project.contractRisks
            });

            dataCache.projects = null; // Invalidate cache

            try {
                // VALIDATION: Ensure required fields exist
                if (!project.extracted || !project.scores) {
                    throw new Error('Invalid project data: missing extracted or scores');
                }

                // SANITIZATION: Clean up data before saving
                const cleanedExtracted = {
                    project_name: project.extracted.project_name || 'Untitled Project',
                    city: project.extracted.project_city || null,
                    state: project.extracted.project_state || null,
                    project_address: project.extracted.project_address || null,
                    project_zip: project.extracted.project_zip || null,
                    bid_deadline: project.extracted.bid_deadline || null,
                    building_type: (typeof project.buildingType === 'object' ? project.buildingType?.type : project.buildingType) || project.extracted.building_type || 'Other',
                    project_size_sf: project.extracted.project_size_sf || null,
                    estimated_value: project.extracted.estimated_value || null,
                    owner_name: project.extracted.owner_name || null,
                    architect_name: project.extracted.architect_name || null,
                    general_contractor: project.extracted.gc_name || null,
                    scope_summary: project.extracted.scope_summary || null,
                    spec_divisions_found: project.extracted.spec_divisions_found || []
                };

                // Generate fingerprint for duplicate detection
                const fingerprint = generateProjectFingerprint(
                    cleanedExtracted.project_name,
                    cleanedExtracted.city,
                    cleanedExtracted.state
                );

                const now = new Date();
                const { data, error } = await supabaseClient.from('projects').insert({
                    user_id: currentUser.id,
                    extracted_data: cleanedExtracted,
                    scores: project.scores,
                    gcs: project.gcs || [],
                    files: project.files || [],
                    full_text: project.fullText || null, // Store full text for re-analysis
                    outcome: project.outcome || 'pending',
                    outcome_data: project.outcomeData || {},
                    good_found: project.goodFound || [],
                    bad_found: project.badFound || [],
                    trades_found: project.tradesFound || [],
                    user_agreement: project.userFeedback?.agreement || 'agree',
                    user_agreement_note: project.userFeedback?.note || null,
                    // Duplicate detection
                    fingerprint: fingerprint,
                    // Layer 0 Intelligence Data
                    market_metro_area: project.marketMetroArea || null,
                    building_type: project.buildingType?.type || null,
                    contract_risks: project.contractRisks || null,
                    // Intelligence Engine Data
                    validation_status: project.validationStatus || { complete: false, missing_fields: [] },
                    intelligence_tags: project.intelligenceTags || {},
                    ai_advisor_output: project.aiAdvisorOutput || null,
                    // Time-series data for fast aggregation
                    created_year: now.getFullYear(),
                    created_month: now.getMonth() + 1,
                    created_week: getWeekNumber(now)
                }).select().single();

                if (error) {
                    console.error('❌ Database error saving project:', error);
                    console.error('   Error message:', error.message);
                    console.error('   Error details:', error.details);
                    console.error('   Error hint:', error.hint);
                    throw error;
                }

                console.log('✅ Project saved successfully:', data.id);
                return { ...project, id: data.id };
            } catch (e) {
                console.error('❌ saveProject error:', e);
                throw e; // Re-throw so calling code can handle it
            }
        }

        async function saveProjectManually() {
            const btn = document.getElementById('saveProjectBtn');
            if (!btn) return;

            // Prevent double-saves
            if (btn.dataset.saved === 'true') {
                console.log('Project already saved');
                return;
            }

            try {
                btn.disabled = true;
                btn.innerHTML = '💾 Saving...';

                if (!supabaseClient || !currentUser) {
                    alert('❌ Not logged in. Please sign in to save projects.');
                    btn.disabled = false;
                    btn.innerHTML = '💾 Save to Projects';
                    return;
                }

                if (!currentAnalysis) {
                    alert('❌ No analysis to save.');
                    btn.disabled = false;
                    btn.innerHTML = '💾 Save to Projects';
                    return;
                }

                // Save project to database
                const savedProject = await saveProject(currentAnalysis);

                if (savedProject && savedProject.id) {
                    currentAnalysis.id = savedProject.id;
                    console.log('✅ Project saved manually:', savedProject.id);

                    // Clear projects cache to force refresh
                    dataCache.projects = null;

                    // Update GC bid counts
                    const gcs = await getGCs();
                    for (const sg of currentAnalysis.gcs) {
                        const gc = gcs.find(g => g.name === sg.name);
                        if (gc) {
                            gc.bids = (gc.bids || 0) + 1;
                            await saveGC(gc);
                        }
                    }

                    // Refresh dashboard to show new project
                    await loadDashboard();

                    // Update button to show saved
                    btn.innerHTML = '✓ Saved to Projects';
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-success');
                    btn.dataset.saved = 'true';

                    console.log('📊 Dashboard refreshed with new project');
                } else {
                    throw new Error('Failed to save project');
                }
            } catch (error) {
                console.error('❌ Save failed:', error);
                alert('❌ Failed to save project: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '💾 Save to Projects';
            }
        }

        async function updateProjectOutcome(id, outcome, outcomeData) {
            if (!supabaseClient || !currentUser) {
                throw new Error('Not authenticated');
            }

            console.log('📝 Updating project outcome:', { id, outcome, outcomeData });
            dataCache.projects = null; // Clear cache before update

            try {
                const { data, error } = await supabaseClient.from('projects').update({
                    outcome,
                    outcome_data: outcomeData,
                    updated_at: new Date().toISOString()
                }).eq('id', id).select().single();

                if (error) {
                    console.error('❌ Update failed:', error);
                    throw error;
                }

                console.log('✅ Project outcome updated:', data);
                return data;
            } catch (e) {
                console.error('❌ updateProjectOutcome error:', e);
                throw e;
            }
        }
        
        async function deleteProject(id) {
            if (!supabaseClient || !currentUser) return;

            // Get project name for confirmation
            const project = allProjectsCache.find(p => p.id === id);
            const projectName = project?.extracted_data?.project_name || project?.extracted?.project_name || 'this project';

            if (!confirm(`Are you sure you want to delete "${projectName}"? This cannot be undone.`)) {
                return;
            }

            try {
                const { error } = await supabaseClient.from('projects').delete().eq('id', id);
                if (error) throw error;

                console.log('✅ Project deleted:', id);
                dataCache.projects = null;

                // Reload projects list
                await loadProjects();
                alert('✓ Project deleted successfully');
            } catch (e) {
                console.error('❌ deleteProject error:', e);
                alert('Failed to delete project: ' + e.message);
            }
        }

        /**
         * Track API usage for cost and profitability analysis
         */
        async function trackAPIUsage(operation, provider, model, inputTokens, outputTokens, cost, projectId = null, success = true, errorMessage = null, latencyMs = null) {
            if (!supabaseClient || !currentUser) return;

            try {
                const totalTokens = inputTokens + outputTokens;

                await supabaseClient.from('api_usage').insert({
                    user_id: currentUser.id,
                    project_id: projectId,
                    api_provider: provider,
                    model: model,
                    operation: operation,
                    input_tokens: inputTokens,
                    output_tokens: outputTokens,
                    total_tokens: totalTokens,
                    cost_usd: cost,
                    success: success,
                    error_message: errorMessage,
                    latency_ms: latencyMs
                });

                console.log(`💰 Tracked API usage: ${provider}/${model} - $${cost.toFixed(4)} (${totalTokens} tokens)`);
            } catch (e) {
                console.error('❌ Failed to track API usage:', e);
                // Don't throw - tracking failures shouldn't break the app
            }
        }

        /**
         * Calculate API cost based on provider, model, and token usage
         * Pricing as of Feb 2026 (update these as needed)
         */
        function calculateAPICost(provider, model, inputTokens, outputTokens) {
            const pricing = {
                anthropic: {
                    'claude-sonnet-4-20250514': { input: 3.00, output: 15.00 }, // per 1M tokens (Sonnet 4.5)
                    'claude-sonnet-4.5': { input: 3.00, output: 15.00 },
                    'claude-haiku-4': { input: 0.25, output: 1.25 },
                    'claude-opus-4.5': { input: 15.00, output: 75.00 }
                },
                openai: {
                    'gpt-4o': { input: 2.50, output: 10.00 },
                    'gpt-4o-mini': { input: 0.15, output: 0.60 }
                }
            };

            const modelPricing = pricing[provider]?.[model];
            if (!modelPricing) {
                console.warn(`⚠️ Unknown pricing for ${provider}/${model}, using default`);
                return (inputTokens + outputTokens) / 1000000 * 5.00; // Default $5/M tokens
            }

            const inputCost = (inputTokens / 1000000) * modelPricing.input;
            const outputCost = (outputTokens / 1000000) * modelPricing.output;
            return inputCost + outputCost;
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllProjects') || document.getElementById('selectAllProjectsHeader');
            const checkboxes = document.querySelectorAll('.project-checkbox');
            const isChecked = selectAll?.checked || false;

            checkboxes.forEach(cb => cb.checked = isChecked);

            // Sync both select all checkboxes
            if (document.getElementById('selectAllProjects')) document.getElementById('selectAllProjects').checked = isChecked;
            if (document.getElementById('selectAllProjectsHeader')) document.getElementById('selectAllProjectsHeader').checked = isChecked;

            updateDeleteButton();
        }

        function updateDeleteButton() {
            const checkboxes = document.querySelectorAll('.project-checkbox:checked');
            const count = checkboxes.length;
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const countSpan = document.getElementById('selectedCount');

            if (deleteBtn && countSpan) {
                if (count > 0) {
                    deleteBtn.style.display = 'block';
                    countSpan.textContent = count;
                } else {
                    deleteBtn.style.display = 'none';
                }
            }

            // Update select all checkbox state
            const allCheckboxes = document.querySelectorAll('.project-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllProjects');
            const selectAllHeader = document.getElementById('selectAllProjectsHeader');

            if (allCheckboxes.length > 0) {
                const allChecked = count === allCheckboxes.length;
                if (selectAllCheckbox) selectAllCheckbox.checked = allChecked;
                if (selectAllHeader) selectAllHeader.checked = allChecked;
            }
        }

        async function deleteSelectedProjects() {
            const checkboxes = document.querySelectorAll('.project-checkbox:checked');
            const projectIds = Array.from(checkboxes).map(cb => cb.dataset.projectId);

            if (projectIds.length === 0) {
                alert('No projects selected');
                return;
            }

            if (!confirm(`Are you sure you want to delete ${projectIds.length} project(s)? This cannot be undone.`)) {
                return;
            }

            try {
                // Delete all selected projects
                for (const id of projectIds) {
                    const { error } = await supabaseClient.from('projects').delete().eq('id', id);
                    if (error) throw error;
                }

                console.log(`✅ Deleted ${projectIds.length} projects`);
                dataCache.projects = null;

                // Reload projects list
                await loadProjects();
                alert(`✓ Successfully deleted ${projectIds.length} project(s)`);
            } catch (e) {
                console.error('❌ Bulk delete error:', e);
                alert('Failed to delete projects: ' + e.message);
            }
        }
        
        // Clear cache on logout
        function clearDataCache() {
            dataCache = { settings: null, keywords: null, gcs: null, projects: null };
        }

        // Debug helper - force reload all data
        async function forceReloadData() {
            console.log('🔄 Force reloading all data...');
            clearDataCache();
            await loadAll();
            console.log('✅ Force reload complete');
            console.log('📊 Data state:', {
                user: currentUser?.email,
                userId: currentUser?.id,
                settingsCached: !!dataCache.settings,
                gcsCached: !!dataCache.gcs,
                projectsCached: !!dataCache.projects,
                gcsCount: dataCache.gcs?.length || 0,
                projectsCount: dataCache.projects?.length || 0
            });
        }
        // Expose for console debugging
        window.forceReloadData = forceReloadData;

        // Navigation
        async function switchTab(id) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`.nav-item[data-tab="${id}"]`)?.classList.add('active');
            document.getElementById(`tab-${id}`)?.classList.add('active');

            // Initialize tab-specific content
            if (id === 'analyze') {
                renderGCSelector();
            } else if (id === 'projects') {
                // Refresh projects list when switching to projects tab
                dataCache.projects = null; // Clear cache to get fresh data
                const projects = await getProjects();
                applyProjectFilters();
            } else if (id === 'dashboard') {
                // Refresh dashboard
                await loadDashboard();
            }
        }
        document.querySelectorAll('.nav-item').forEach(i => i.addEventListener('click', async () => await switchTab(i.dataset.tab)));

        // Modals
        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if (e.target === o && o.id !== 'onboardingModal') o.classList.remove('active'); }));

        // ============================================
        // MOBILE MENU & UX ENHANCEMENTS
        // ============================================

        // Toggle mobile menu
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('mobile-open');
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(e) {
            const sidebar = document.getElementById('sidebar');
            const menuBtn = document.getElementById('mobileMenuBtn');
            if (sidebar && menuBtn && !sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
                sidebar.classList.remove('mobile-open');
            }
        });

        // Show mobile menu button on mobile
        function checkMobileView() {
            const menuBtn = document.getElementById('mobileMenuBtn');
            if (menuBtn) {
                menuBtn.style.display = window.innerWidth <= 768 ? 'block' : 'none';
            }
        }
        window.addEventListener('resize', checkMobileView);
        window.addEventListener('load', checkMobileView);

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="font-size: 20px;">
                        ${type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️'}
                    </span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 4px;">${type === 'success' ? 'Success' : type === 'error' ? 'Error' : 'Info'}</div>
                        <div style="font-size: 14px; color: var(--text-muted);">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 20px; padding: 0; line-height: 1;">×</button>
                </div>
            `;
            document.body.appendChild(notification);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // Loading state helper
        function setLoading(elementId, isLoading) {
            const el = document.getElementById(elementId);
            if (!el) return;

            if (isLoading) {
                el.disabled = true;
                el.dataset.originalContent = el.innerHTML;
                el.innerHTML = '<span class="loading-spinner"></span> Loading...';
            } else {
                el.disabled = false;
                if (el.dataset.originalContent) {
                    el.innerHTML = el.dataset.originalContent;
                }
            }
        }

        // ============================================
        // INTELLIGENCE ENGINE MODULE
        // ============================================
        // Three-layer intelligence system: Validation → Explanation → Recommendation
        // Captures decision data for building competitive moat

        /**
         * Layer 1: Data Validation
         * Checks if all required fields are present for analytics readiness
         * Returns validation status with missing fields array
         */
        function validateBidData(project, settings) {
            const missing = [];
            const extracted = project.extracted || {};

            // Core project fields (check both old and new field names)
            if (!extracted.project_name) missing.push('project_name');

            const hasCity = extracted.city || extracted.project_city;
            if (!hasCity) missing.push('project_city');

            const hasState = extracted.state || extracted.project_state;
            if (!hasState) missing.push('project_state');

            // GC identification (check multiple possible fields)
            const hasGC = (project.gcs && project.gcs.length > 0) ||
                         extracted.gc_names?.length > 0 ||
                         extracted.general_contractor ||
                         extracted.gc_name;
            if (!hasGC) missing.push('general_contractor');

            // Building intelligence
            const hasBuildingType = extracted.building_type ||
                                   project.buildingType?.type ||
                                   project.building_type;
            if (!hasBuildingType) missing.push('building_type');

            if (!Array.isArray(project.tradesFound) || project.tradesFound.length === 0) missing.push('trade_divisions');

            // Scoring components (check for new structure: scores.components)
            if (project.scores && project.scores.components) {
                const comps = project.scores.components;
                if (!comps.location || !comps.keywords || !comps.gc || !comps.trade) {
                    missing.push('score_components');
                }
            } else if (!project.scores) {
                missing.push('score_components');
            }

            return {
                complete: missing.length === 0,
                missing_fields: missing,
                validated_at: new Date().toISOString()
            };
        }

        /**
         * Layer 2: Score Explanation
         * Breaks down each score component into plain English
         * Highlights contract risks with confidence and page numbers
         */
        function explainScore(project, settings) {
            const scores = project.scores || {};
            const extracted = project.extracted || {};
            const totalScore = scores.final || scores.bidindex_score || 0;

            let explanation = [];

            // Overall recommendation
            if (totalScore >= 80) {
                explanation.push("🟢 **Strong Match** - This project aligns well with your preferences.");
            } else if (totalScore >= 60) {
                explanation.push("🟡 **Worth Reviewing** - Some aspects match your criteria.");
            } else {
                explanation.push("🔴 **Weak Match** - This project doesn't align with your typical preferences.");
            }

            explanation.push(""); // Blank line
            explanation.push("**Score Breakdown:**");
            explanation.push("");

            // Location Score
            if (typeof scores.location === 'number') {
                explanation.push(`📍 **Location (${scores.location}%):**`);
                if (scores.location >= 90) {
                    explanation.push(`   ✓ Excellent - Project is ${Math.round(project.distance || 0)} miles from your location`);
                } else if (scores.location >= 70) {
                    explanation.push(`   ✓ Good - Project is ${Math.round(project.distance || 0)} miles away`);
                } else {
                    explanation.push(`   ✗ Far - Project is ${Math.round(project.distance || 0)} miles from your location`);
                }
                explanation.push("");
            }

            // Keywords Score
            if (typeof scores.keywords === 'number') {
                explanation.push(`🔍 **Keywords (${scores.keywords}%):**`);
                const goodCount = Array.isArray(project.goodFound) ? project.goodFound.length : 0;
                const badCount = Array.isArray(project.badFound) ? project.badFound.length : 0;
                if (goodCount > 0 && Array.isArray(project.goodFound)) {
                    explanation.push(`   ✓ Found ${goodCount} preferred keyword(s): ${project.goodFound.slice(0, 3).join(', ')}${goodCount > 3 ? '...' : ''}`);
                }
                if (badCount > 0 && Array.isArray(project.badFound)) {
                    explanation.push(`   ✗ Found ${badCount} excluded keyword(s): ${project.badFound.slice(0, 3).join(', ')}${badCount > 3 ? '...' : ''}`);
                }
                if (goodCount === 0 && badCount === 0) {
                    explanation.push(`   − No matching keywords found`);
                }
                explanation.push("");
            }

            // GC Score
            if (typeof scores.gc === 'number') {
                explanation.push(`🏗️ **General Contractor (${scores.gc}%):**`);
                const gcNames = extracted.gc_names || [extracted.general_contractor || extracted.gc_name].filter(Boolean);
                if (gcNames.length > 0) {
                    const gcList = project.gcs || [];
                    if (gcList.length > 0) {
                        const avgRating = gcList.reduce((sum, gc) => sum + (gc.rating || 3), 0) / gcList.length;
                        const totalBids = gcList.reduce((sum, gc) => sum + (gc.bids || 0), 0);
                        explanation.push(`   ${avgRating >= 4 ? '✓' : avgRating >= 3 ? '−' : '✗'} ${gcNames.join(', ')}`);
                        explanation.push(`   Average rating: ${avgRating.toFixed(1)}★ (${totalBids} past bid${totalBids !== 1 ? 's' : ''})`);
                    } else {
                        explanation.push(`   − ${gcNames.join(', ')} (Not in your database)`);
                    }
                } else {
                    explanation.push(`   − No general contractor identified`);
                }
                explanation.push("");
            }

            // Trade/Product Score
            if (typeof scores.trade === 'number') {
                explanation.push(`🔧 **Trade Match (${scores.trade}%):**`);
                if (Array.isArray(project.tradesFound) && project.tradesFound.length > 0) {
                    const matchedTrades = project.tradesFound.filter(t =>
                        Array.isArray(settings.trades) && settings.trades.some(st => st.toLowerCase().includes(t.toLowerCase()))
                    );
                    if (matchedTrades.length > 0) {
                        explanation.push(`   ✓ Matches your trades: ${matchedTrades.join(', ')}`);
                    } else {
                        explanation.push(`   − Found trades: ${project.tradesFound.join(', ')}`);
                    }
                } else {
                    explanation.push(`   − No trade divisions detected in plans`);
                }
                explanation.push("");
            }

            // Contract Risks
            if (Array.isArray(project.contractRisks) && project.contractRisks.length > 0) {
                explanation.push("⚠️ **Contract Risks Detected:**");
                explanation.push("");
                project.contractRisks.forEach(risk => {
                    const confidence = risk.confidence ? ` (${(risk.confidence * 100).toFixed(0)}% confidence)` : '';
                    const page = risk.page ? ` - Page ${risk.page}` : '';
                    explanation.push(`   • **${risk.type}**${confidence}${page}`);
                    if (risk.context) {
                        explanation.push(`     "${risk.context}"`);
                    }
                });
                explanation.push("");
            }

            return explanation.join('\n');
        }

        /**
         * Layer 3: AI Advisor Response
         * Generates personalized recommendation based on user's AI advisor preferences
         * Three personalities: supportive, straight_shooter, data_nerd
         */
        function generateAdvisorResponse(project, settings, userHistory) {
            const advisorName = settings.ai_advisor_name || 'Sam';
            const advisorTone = settings.ai_advisor_tone || 'supportive';
            const scores = project.scores || {};
            const totalScore = scores.final || scores.bidindex_score || 0;

            let response = [];

            // Greeting with personality
            if (advisorTone === 'supportive') {
                response.push(`Hey! ${advisorName} here. Let me break this down for you.`);
            } else if (advisorTone === 'straight_shooter') {
                response.push(`${advisorName} here. Here's the deal:`);
            } else { // data_nerd
                response.push(`${advisorName} here. I've analyzed the data:`);
            }

            response.push("");

            // Recommendation based on score
            if (totalScore >= 80) {
                if (advisorTone === 'supportive') {
                    response.push("**Recommendation: GO FOR IT! 🎯**");
                    response.push("This bid checks all the boxes. The location works, the GC is solid, and it's right in your wheelhouse.");
                } else if (advisorTone === 'straight_shooter') {
                    response.push("**Recommendation: BID THIS ONE**");
                    response.push("Strong match across the board. Everything lines up.");
                } else {
                    response.push("**Recommendation: HIGH PROBABILITY BID**");
                    response.push(`Score: ${totalScore}/100 (${getScorePercentile(totalScore, userHistory)}th percentile in your history)`);
                }
            } else if (totalScore >= 60) {
                if (advisorTone === 'supportive') {
                    response.push("**Recommendation: REVIEW CAREFULLY 🤔**");
                    response.push("This one has potential, but there are some question marks. Take a closer look before deciding.");
                } else if (advisorTone === 'straight_shooter') {
                    response.push("**Recommendation: YOUR CALL**");
                    response.push("Mixed signals. Could go either way depending on your current capacity.");
                } else {
                    response.push("**Recommendation: CONDITIONAL BID**");
                    response.push(`Score: ${totalScore}/100 (below your typical threshold)`);
                }
            } else {
                if (advisorTone === 'supportive') {
                    response.push("**Recommendation: PROBABLY PASS ⛔**");
                    response.push("This doesn't match your sweet spot. Unless you're really light on work, I'd skip it.");
                } else if (advisorTone === 'straight_shooter') {
                    response.push("**Recommendation: PASS**");
                    response.push("Not a good fit. Move on.");
                } else {
                    response.push("**Recommendation: LOW PROBABILITY BID**");
                    response.push(`Score: ${totalScore}/100 (bottom quartile)`);
                }
            }

            response.push("");

            // Key insights based on components
            const insights = [];
            if (scores.location < 70) {
                insights.push(`Distance is a factor (${Math.round(project.distance || 0)} miles)`);
            }
            if (scores.gc >= 80 && Array.isArray(project.gcs) && project.gcs.length > 0) {
                const winRate = calculateGCWinRate(project.gcs);
                if (winRate > 0) {
                    insights.push(`You've won ${(winRate * 100).toFixed(0)}% with this GC before`);
                }
            }
            if (scores.trade < 60) {
                insights.push("Trade match is weak");
            }
            if (Array.isArray(project.badFound) && project.badFound.length > 0) {
                insights.push(`${project.badFound.length} red flag keyword${project.badFound.length > 1 ? 's' : ''} detected`);
            }

            if (insights.length > 0) {
                response.push("**Key Factors:**");
                insights.forEach(insight => response.push(`• ${insight}`));
                response.push("");
            }

            // Similar projects reference
            const similarProjects = findSimilarProjectsSync(project, userHistory);
            if (similarProjects.length > 0) {
                response.push("**Similar Past Bids:**");
                similarProjects.slice(0, 3).forEach(p => {
                    const outcome = p.outcome === 'won' ? '✓ Won' : p.outcome === 'lost' ? '✗ Lost' : '− No Bid';
                    const projectName = p.extracted?.project_name || 'Untitled';
                    response.push(`• ${outcome}: ${projectName} (Score: ${p.scores?.total || 0})`);
                });
                response.push("");
            }

            // Closing with personality
            if (advisorTone === 'supportive') {
                response.push("Check the score breakdown below for more details. You've got this! 💪");
            } else if (advisorTone === 'straight_shooter') {
                response.push("That's my take. You know your business best.");
            } else {
                response.push("Statistical confidence: " + (totalScore >= 80 ? "High" : totalScore >= 60 ? "Medium" : "Low"));
            }

            return response.join('\n');
        }

        /**
         * Layer 4: Analytics Tagging
         * Tags projects with Layer 1-3 intelligence for future pattern detection
         */
        function tagForAnalytics(project, settings) {
            const extracted = project.extracted || {};
            const scores = project.scores || {};

            const tags = {
                // Layer 1: Personal intelligence
                company_type: settings.company_type || 'subcontractor',
                trades: project.tradesFound || [],
                building_type: extracted.building_type || project.buildingType?.type || null,

                // Layer 2: GC intelligence
                gc_names: extracted.gc_names || [extracted.general_contractor || extracted.gc_name].filter(Boolean),
                gc_avg_rating: Array.isArray(project.gcs) && project.gcs.length > 0
                    ? project.gcs.reduce((sum, gc) => sum + (gc.rating || 3), 0) / project.gcs.length
                    : null,

                // Layer 3: Market intelligence
                market_metro: project.marketMetroArea || null,
                location_score: scores.location || null,
                distance_miles: Math.round(project.distance || 0),

                // Decision factors
                decision_confidence: null, // Set when outcome is added
                has_contract_risks: Array.isArray(project.contractRisks) && project.contractRisks.length > 0,
                risk_types: Array.isArray(project.contractRisks) ? project.contractRisks.map(r => r.type) : [],

                // Competitive intelligence
                keyword_match_good: project.goodFound?.length || 0,
                keyword_match_bad: project.badFound?.length || 0,

                // Time intelligence
                created_at: project.createdAt || new Date().toISOString(),
                bid_deadline: extracted.bid_deadline || null
            };

            return tags;
        }

        /**
         * Helper: Find similar past projects
         * Matches on same GC OR same location + trade + building type
         */
        function findSimilarProjectsSync(currentProject, userHistory) {
            if (!userHistory || userHistory.length === 0) return [];

            const similar = [];
            const currentExtracted = currentProject.extracted || {};
            const currentGCs = (currentExtracted.gc_names || [currentExtracted.general_contractor || currentExtracted.gc_name].filter(Boolean)).map(g => g.toLowerCase());
            const currentCity = currentExtracted.project_city?.toLowerCase();
            const currentTrades = currentProject.tradesFound || [];
            const currentBuildingType = (currentExtracted.building_type || currentProject.buildingType?.type || '').toLowerCase();

            for (const p of userHistory) {
                // Skip if same project or pending
                if (p.id === currentProject.id || p.outcome === 'pending') continue;

                const pExtracted = p.extracted || {};
                const pGCs = (pExtracted.gc_names || [pExtracted.general_contractor || pExtracted.gc_name].filter(Boolean)).map(g => g.toLowerCase());
                const pCity = pExtracted.project_city?.toLowerCase();
                const pTrades = p.tradesFound || [];
                const pBuildingType = (pExtracted.building_type || p.buildingType?.type || '').toLowerCase();

                // Match criteria
                const sameGC = currentGCs.some(gc => pGCs.includes(gc));
                const sameCity = currentCity && pCity && currentCity === pCity;
                const sameTrade = currentTrades.some(t => pTrades.includes(t));
                const sameBuildingType = currentBuildingType && pBuildingType && currentBuildingType === pBuildingType;

                if (sameGC || (sameCity && sameTrade && sameBuildingType)) {
                    similar.push(p);
                }
            }

            // Sort by most recent
            return similar.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
        }

        /**
         * Helper: Calculate win rate with specific GCs
         */
        function calculateGCWinRate(gcs) {
            if (!gcs || gcs.length === 0) return 0;
            const totalBids = gcs.reduce((sum, gc) => sum + (gc.bids || 0), 0);
            const totalWins = gcs.reduce((sum, gc) => sum + (gc.wins || 0), 0);
            return totalBids > 0 ? totalWins / totalBids : 0;
        }

        /**
         * Helper: Get score percentile in user's history
         */
        function getScorePercentile(score, userHistory) {
            if (!userHistory || userHistory.length === 0) return 50;
            const scores = userHistory.map(p => p.scores?.total || 0).filter(s => s > 0);
            if (scores.length === 0) return 50;
            const below = scores.filter(s => s < score).length;
            return Math.round((below / scores.length) * 100);
        }

        // ============================================
        // PASSIVE GHOST TRIGGER
        // ============================================

        /**
         * Auto-mark stale projects as ghosted
         * Runs automatically when projects are loaded
         */
        async function checkAndMarkGhostedProjects() {
            if (!supabaseClient || !currentUser) return;

            try {
                // Get user's ghost threshold (default: 60 days)
                const settings = await getSettings();
                const thresholdDays = settings.ghost_threshold_days || 60;

                // Calculate cutoff date
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - thresholdDays);
                const cutoffISO = cutoffDate.toISOString();

                // Find pending projects older than threshold
                const { data: staleProjects, error } = await supabaseClient
                    .from('projects')
                    .select('id, extracted_data, created_at')
                    .eq('user_id', currentUser.id)
                    .eq('outcome', 'pending')
                    .lt('created_at', cutoffISO);

                if (error) throw error;

                if (staleProjects && staleProjects.length > 0) {
                    console.log(`🕰️ Found ${staleProjects.length} stale projects to auto-ghost`);

                    // Auto-ghost each one
                    for (const project of staleProjects) {
                        const daysAgo = Math.round((Date.now() - new Date(project.created_at).getTime()) / (1000 * 60 * 60 * 24));

                        await supabaseClient
                            .from('projects')
                            .update({
                                outcome: 'ghost',
                                outcome_data: {
                                    auto_ghosted: true,
                                    days_elapsed: daysAgo,
                                    reason: `Automatically marked as ghosted after ${daysAgo} days with no response`
                                },
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', project.id);
                    }

                    console.log(`✅ Auto-ghosted ${staleProjects.length} projects`);
                    dataCache.projects = null; // Invalidate cache
                }
            } catch (e) {
                console.error('Error checking ghosted projects:', e);
            }
        }

        // ============================================
        // BETA FEEDBACK WIDGET
        // ============================================

        let feedbackRatings = { ease: 0, accuracy: 0 };

        function openFeedbackModal() {
            document.getElementById('feedbackModal').classList.add('active');
            feedbackRatings = { ease: 0, accuracy: 0 };
            // Reset stars with all styles
            for (let i = 1; i <= 5; i++) {
                const easeStar = document.getElementById(`easeRating${i}`);
                const accuracyStar = document.getElementById(`accuracyRating${i}`);
                easeStar.style.color = 'var(--text-muted)';
                easeStar.style.filter = 'none';
                easeStar.style.transform = 'scale(1)';
                accuracyStar.style.color = 'var(--text-muted)';
                accuracyStar.style.filter = 'none';
                accuracyStar.style.transform = 'scale(1)';
            }
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').classList.remove('active');
            // Reset form
            document.getElementById('feedbackType').value = 'bug';
            document.getElementById('feedbackTitle').value = '';
            document.getElementById('feedbackDescription').value = '';
            document.getElementById('feedbackRecommend').checked = false;
        }

        function setFeedbackRating(type, rating) {
            feedbackRatings[type] = rating;
            // Update star colors with visual feedback
            const prefix = type === 'ease' ? 'easeRating' : 'accuracyRating';
            for (let i = 1; i <= 5; i++) {
                const star = document.getElementById(`${prefix}${i}`);
                if (i <= rating) {
                    star.style.color = 'var(--warning)';
                    star.style.filter = 'drop-shadow(0 0 4px rgba(245, 158, 11, 0.6))';
                    star.style.transform = 'scale(1.1)';
                } else {
                    star.style.color = 'var(--text-muted)';
                    star.style.filter = 'none';
                    star.style.transform = 'scale(1)';
                }
            }
        }

        async function submitFeedback() {
            const type = document.getElementById('feedbackType').value;
            const title = document.getElementById('feedbackTitle').value.trim();
            const description = document.getElementById('feedbackDescription').value.trim();
            const recommend = document.getElementById('feedbackRecommend').checked;

            if (!title || !description) {
                alert('Please provide a title and description');
                return;
            }

            try {
                const { data, error } = await supabaseClient.from('beta_feedback').insert({
                    user_id: currentUser.id,
                    user_email: currentUser.email,
                    user_company: currentUser.user_metadata?.company_name || null,
                    feedback_type: type,
                    title: title,
                    description: description,
                    ease_of_use: feedbackRatings.ease || null,
                    accuracy_rating: feedbackRatings.accuracy || null,
                    would_recommend: recommend,
                    page_location: window.location.hash || 'main',
                    user_agent: navigator.userAgent,
                    screen_resolution: `${window.screen.width}x${window.screen.height}`
                });

                if (error) throw error;

                // Store submission timestamp to hide button for 30 days
                localStorage.setItem('lastFeedbackSubmission', new Date().toISOString());
                hideFeedbackButton();

                alert('✅ Thank you for your feedback! We appreciate your help making BidIntell better.');
                closeFeedbackModal();
            } catch (e) {
                console.error('Feedback submission error:', e);
                alert('❌ Error submitting feedback. Please try again.');
            }
        }

        function checkFeedbackButtonVisibility() {
            const lastSubmission = localStorage.getItem('lastFeedbackSubmission');
            if (!lastSubmission) {
                // Never submitted, show button
                showFeedbackButton();
                return;
            }

            const lastDate = new Date(lastSubmission);
            const now = new Date();
            const daysSinceSubmission = (now - lastDate) / (1000 * 60 * 60 * 24);

            if (daysSinceSubmission >= 30) {
                // 30+ days passed, show button again
                showFeedbackButton();
            } else {
                // Still within 30 day window, keep hidden
                hideFeedbackButton();
            }
        }

        function showFeedbackButton() {
            const btn = document.getElementById('feedbackButton');
            if (btn) btn.style.display = 'flex';
        }

        function hideFeedbackButton() {
            const btn = document.getElementById('feedbackButton');
            if (btn) btn.style.display = 'none';
        }

        // ============================================
        // ONBOARDING FLOW
        // ============================================

        function renderOnboardingStep(step) {
            onboardingStep = step;
            const body = document.getElementById('onboardingBody');
            const backBtn = document.getElementById('onboardingBackBtn');
            const nextBtn = document.getElementById('onboardingNextBtn');
            const skipBtn = document.getElementById('onboardingSkipBtn');

            // Update progress
            const progress = Math.round((step / 10) * 100);
            document.getElementById('onboardingCurrentStep').textContent = step;
            document.getElementById('onboardingProgress').textContent = progress;
            document.getElementById('onboardingProgressBar').style.width = progress + '%';

            // Show/hide back button
            backBtn.style.display = step === 1 ? 'none' : 'inline-flex';
            skipBtn.style.display = step === 10 ? 'none' : 'inline-block';
            nextBtn.textContent = step === 10 ? 'Complete Setup 🎉' : 'Next →';

            // Render step content
            if (step === 1) {
                body.innerHTML = `
                    <div style="text-align: center; padding: 20px 0;">
                        <div style="font-size: 64px; margin-bottom: 16px;">🏢</div>
                        <h3 style="color: var(--text-primary); margin-bottom: 12px;">What type of company are you?</h3>
                        <p style="color: var(--text-muted); margin-bottom: 32px;">This helps us customize scoring for your business model</p>
                        <div style="max-width: 500px; margin: 0 auto;">
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                ${[
                                    { value: 'subcontractor', icon: '🔧', label: 'Subcontractor', desc: 'I install/build (labor + materials)' },
                                    { value: 'distributor', icon: '📦', label: 'Distributor', desc: 'I supply materials/equipment' },
                                    { value: 'manufacturer_rep', icon: '🏭', label: 'Manufacturer Rep', desc: 'I represent product lines' }
                                ].map(opt => `
                                    <label style="display: flex; align-items: start; gap: 12px; cursor: pointer; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 3px solid ${onboardingData.companyType === opt.value ? 'var(--accent)' : 'transparent'};">
                                        <input type="radio" name="onboarding_companyType" value="${opt.value}" ${onboardingData.companyType === opt.value ? 'checked' : ''} onchange="onboardingData.companyType = this.value; renderOnboardingStep(1); setTimeout(() => onboardingNext(), 300);" style="margin-top: 4px; accent-color: var(--accent);">
                                        <div style="flex: 1; text-align: left;">
                                            <div style="font-size: 16px; margin-bottom: 4px;">${opt.icon} <strong>${opt.label}</strong></div>
                                            <div style="font-size: 13px; color: var(--text-muted);">${opt.desc}</div>
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } else if (step === 2) {
                body.innerHTML = `
                    <div style="text-align: center; padding: 20px 0;">
                        <div style="font-size: 64px; margin-bottom: 16px;">🏢</div>
                        <h3 style="color: var(--text-primary); margin-bottom: 12px;">Where's your office located?</h3>
                        <p style="color: var(--text-muted); margin-bottom: 32px;">This helps us calculate travel distance for project fit scoring</p>
                        <div style="max-width: 400px; margin: 0 auto;">
                            <div class="form-group" style="text-align: left;">
                                <label class="form-label">Office City</label>
                                <input type="text" class="form-input" id="onboarding_city" placeholder="Kansas City" value="${onboardingData.city}">
                            </div>
                            <div class="form-group" style="text-align: left;">
                                <label class="form-label">State</label>
                                <select class="form-select" id="onboarding_state">
                                    <option value="">Select state...</option>
                                    ${['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'].map(s => `<option value="${s}" ${onboardingData.state === s ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                `;
            } else if (step === 3) {
                if (onboardingData.companyType === 'subcontractor') {
                    // Show CSI divisions for subcontractors
                    body.innerHTML = `
                        <div style="text-align: center; padding: 20px 0;">
                            <div style="font-size: 64px; margin-bottom: 16px;">🔧</div>
                            <h3 style="color: var(--text-primary); margin-bottom: 12px;">What trades do you perform?</h3>
                            <p style="color: var(--text-muted); margin-bottom: 32px;">Select all divisions your company works in (choose at least one)</p>
                            <div style="max-width: 500px; margin: 0 auto; text-align: left;">
                                <div id="onboarding_trades" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-height: 400px; overflow-y: auto; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius);">
                                    ${CSI_DIVISIONS.map(([code, name]) => `
                                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px; background: var(--bg-tertiary); border-radius: var(--radius); border: 2px solid ${onboardingData.trades.includes(code) ? 'var(--accent)' : 'transparent'};">
                                            <input type="checkbox" value="${code}" ${onboardingData.trades.includes(code) ? 'checked' : ''} onchange="updateOnboardingTrade(this)" style="accent-color: var(--accent);">
                                            <span style="font-size: 13px;"><strong>${code}</strong> ${name}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Show product lines for distributors and manufacturer reps
                    body.innerHTML = `
                        <div style="text-align: center; padding: 20px 0;">
                            <div style="font-size: 64px; margin-bottom: 16px;">📦</div>
                            <h3 style="color: var(--text-primary); margin-bottom: 12px;">What brands/products do you carry?</h3>
                            <p style="color: var(--text-muted); margin-bottom: 32px;">Add the manufacturers and product lines you distribute</p>
                            <div style="max-width: 500px; margin: 0 auto; text-align: left;">
                                <div class="form-group">
                                    <label class="form-label">Product Lines / Brands</label>
                                    <input type="text" class="form-input" id="onboarding_productLine" placeholder="e.g., Eaton, Square D, Lutron" onkeypress="if(event.key==='Enter') addOnboardingProductLine()">
                                    <button onclick="addOnboardingProductLine()" class="btn btn-secondary" style="margin-top:8px;">+ Add</button>
                                </div>
                                <div id="onboarding_productLinesList" style="margin-top: 12px;">
                                    ${onboardingData.productLines.map(line => `
                                        <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-secondary); border-radius: var(--radius); margin-bottom: 6px;">
                                            <span style="flex: 1;">${line}</span>
                                            <button onclick="removeOnboardingProductLine('${line}')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px;">✕</button>
                                        </div>
                                    `).join('')}
                                </div>

                                <div class="form-group" style="margin-top:20px;">
                                    <label class="form-label">Product Categories</label>
                                    <select class="form-select" id="onboarding_categories" multiple size="6" onchange="updateOnboardingCategories()">
                                        <option value="electrical" ${onboardingData.productCategories.includes('electrical') ? 'selected' : ''}>Electrical Equipment</option>
                                        <option value="lighting" ${onboardingData.productCategories.includes('lighting') ? 'selected' : ''}>Lighting</option>
                                        <option value="hvac" ${onboardingData.productCategories.includes('hvac') ? 'selected' : ''}>HVAC Equipment</option>
                                        <option value="plumbing" ${onboardingData.productCategories.includes('plumbing') ? 'selected' : ''}>Plumbing Fixtures</option>
                                        <option value="flooring" ${onboardingData.productCategories.includes('flooring') ? 'selected' : ''}>Flooring</option>
                                        <option value="security" ${onboardingData.productCategories.includes('security') ? 'selected' : ''}>Security/Access Control</option>
                                        <option value="fire_alarm" ${onboardingData.productCategories.includes('fire_alarm') ? 'selected' : ''}>Fire Alarm</option>
                                        <option value="controls" ${onboardingData.productCategories.includes('controls') ? 'selected' : ''}>Controls/BAS</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } else if (step === 4) {
                body.innerHTML = `
                    <div style="text-align: center; padding: 20px 0;">
                        <div style="font-size: 64px; margin-bottom: 16px;">📍</div>
                        <h3 style="color: var(--text-primary); margin-bottom: 12px;">How important is project location?</h3>
                        <p style="color: var(--text-muted); margin-bottom: 32px;">Adjust the slider based on how much location matters to your business</p>
                        <div style="max-width: 500px; margin: 0 auto;">
                            <div style="background: var(--bg-secondary); padding: 32px; border-radius: var(--radius);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
                                    <span style="font-size: 13px; color: var(--text-muted);">Not Important (0%)</span>
                                    <span style="font-size: 20px; font-weight: 700; color: var(--accent);" id="locationImportanceValue">${onboardingData.locationImportance}%</span>
                                    <span style="font-size: 13px; color: var(--text-muted);">Critical (100%)</span>
                                </div>
                                <input type="range" min="0" max="100" value="${onboardingData.locationImportance}" id="onboarding_locationImportance" oninput="document.getElementById('locationImportanceValue').textContent = this.value + '%'" style="width: 100%; height: 8px; border-radius: 4px; background: linear-gradient(90deg, var(--bg-tertiary) 0%, var(--accent) 100%); outline: none; -webkit-appearance: none; appearance: none; cursor: pointer;">
                                <div style="margin-top: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius); font-size: 12px; color: var(--text-secondary);">
                                    <strong>💡 Tip:</strong> If you work locally, set this high (70-100%). If you travel for work or location doesn't matter, set it low (0-30%).
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (step === 5) {
                body.innerHTML = `
                    <div style="text-align: center; padding: 20px 0;">
                        <div style="font-size: 64px; margin-bottom: 16px;">⚖️</div>
                        <h3 style="color: var(--text-primary); margin-bottom: 12px;">What's your risk tolerance?</h3>
                        <p style="color: var(--text-muted); margin-bottom: 32px;">How cautious should BidIntell be when scoring contract risks?</p>
                        <div style="max-width: 500px; margin: 0 auto;">
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                ${[
                                    { value: 'low', icon: '🛡️', label: 'Low Tolerance', desc: 'Flag every potential risk - I want to be very careful' },
                                    { value: 'medium', icon: '⚖️', label: 'Medium Tolerance', desc: 'Balance risk awareness with opportunity - recommended' },
                                    { value: 'high', icon: '🚀', label: 'High Tolerance', desc: 'Only warn about major red flags - I can handle risk' }
                                ].map(opt => `
                                    <label style="display: flex; align-items: start; gap: 12px; cursor: pointer; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 3px solid ${onboardingData.riskTolerance === opt.value ? 'var(--accent)' : 'transparent'}; transition: all 0.2s;">
                                        <input type="radio" name="onboarding_riskTolerance" value="${opt.value}" ${onboardingData.riskTolerance === opt.value ? 'checked' : ''} onchange="onboardingData.riskTolerance = this.value; renderOnboardingStep(5); setTimeout(() => onboardingNext(), 300);" style="margin-top: 4px; accent-color: var(--accent);">
                                        <div style="flex: 1; text-align: left;">
                                            <div style="font-size: 16px; margin-bottom: 4px;">${opt.icon} <strong>${opt.label}</strong></div>
                                            <div style="font-size: 13px; color: var(--text-muted);">${opt.desc}</div>
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } else if (step === 6) {
                body.innerHTML = `
                    <div style="text-align: center; padding: 20px 0;">
                        <div style="font-size: 64px; margin-bottom: 16px;">🏗️</div>
                        <h3 style="color: var(--text-primary); margin-bottom: 12px;">Current workload capacity?</h3>
                        <p style="color: var(--text-muted); margin-bottom: 32px;">This helps us adjust recommendations based on your bandwidth</p>
                        <div style="max-width: 500px; margin: 0 auto;">
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                ${[
                                    { value: 'aggressive', icon: '🔴', label: 'Hungry for Work', desc: 'We need projects ASAP - be less selective' },
                                    { value: 'steady', icon: '🟢', label: 'Steady & Balanced', desc: 'Normal capacity - use standard criteria' },
                                    { value: 'slow', icon: '🟡', label: 'At Capacity', desc: 'We\'re full - only show best fits' }
                                ].map(opt => `
                                    <label style="display: flex; align-items: start; gap: 12px; cursor: pointer; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 3px solid ${onboardingData.capacity === opt.value ? 'var(--accent)' : 'transparent'}; transition: all 0.2s;">
                                        <input type="radio" name="onboarding_capacity" value="${opt.value}" ${onboardingData.capacity === opt.value ? 'checked' : ''} onchange="onboardingData.capacity = this.value; renderOnboardingStep(6); setTimeout(() => onboardingNext(), 300);" style="margin-top: 4px; accent-color: var(--accent);">
                                        <div style="flex: 1; text-align: left;">
                                            <div style="font-size: 16px; margin-bottom: 4px;">${opt.icon} <strong>${opt.label}</strong></div>
                                            <div style="font-size: 13px; color: var(--text-muted);">${opt.desc}</div>
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } else if (step === 7) {
                body.innerHTML = `
                    <div style="text-align: center; padding: 20px 0;">
                        <div style="font-size: 64px; margin-bottom: 16px;">🤖</div>
                        <h3 style="color: var(--text-primary); margin-bottom: 12px;">Meet your AI Advisor</h3>
                        <p style="color: var(--text-muted); margin-bottom: 32px;">Choose a name and personality for your personalized recommendations</p>
                        <div style="max-width: 500px; margin: 0 auto; text-align: left;">
                            <div class="form-group">
                                <label class="form-label">Advisor Name</label>
                                <select class="form-select" id="onboarding_aiAdvisorName" onchange="toggleCustomAdvisorName(this.value)">
                                    <option value="Sam" ${onboardingData.aiAdvisorName === 'Sam' ? 'selected' : ''}>Sam</option>
                                    <option value="Scout" ${onboardingData.aiAdvisorName === 'Scout' ? 'selected' : ''}>Scout</option>
                                    <option value="Jake" ${onboardingData.aiAdvisorName === 'Jake' ? 'selected' : ''}>Jake</option>
                                    <option value="Alex" ${onboardingData.aiAdvisorName === 'Alex' ? 'selected' : ''}>Alex</option>
                                    <option value="Taylor" ${onboardingData.aiAdvisorName === 'Taylor' ? 'selected' : ''}>Taylor</option>
                                    <option value="Custom" ${!['Sam','Scout','Jake','Alex','Taylor'].includes(onboardingData.aiAdvisorName) ? 'selected' : ''}>Custom (Choose your own)</option>
                                </select>
                                <div class="form-hint">This is how your AI advisor will introduce themselves</div>
                            </div>

                            <div class="form-group" id="customAdvisorNameField" style="margin-top: 12px; display: ${!['Sam','Scout','Jake','Alex','Taylor'].includes(onboardingData.aiAdvisorName) ? 'block' : 'none'};">
                                <label class="form-label">Custom Advisor Name</label>
                                <input type="text" class="form-input" id="onboarding_customAdvisorName" placeholder="e.g., Chris, Jordan, Morgan..." value="${!['Sam','Scout','Jake','Alex','Taylor'].includes(onboardingData.aiAdvisorName) ? onboardingData.aiAdvisorName : ''}" oninput="onboardingData.aiAdvisorName = this.value">
                                <div class="form-hint">Enter any name you'd like (keep it short)</div>
                            </div>

                            <div class="form-group" style="margin-top: 20px;">
                                <label class="form-label">Advisor Personality</label>
                                <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 8px;">
                                    ${[
                                        { value: 'supportive', icon: '🤝', label: 'Supportive Coach', desc: 'Encouraging, friendly, explains things clearly' },
                                        { value: 'straight_shooter', icon: '🎯', label: 'Straight Shooter', desc: 'Direct, no-nonsense, gets to the point' },
                                        { value: 'data_nerd', icon: '📊', label: 'Data Nerd', desc: 'Analytical, statistical, loves the numbers' }
                                    ].map(opt => `
                                        <label style="display: flex; align-items: start; gap: 12px; cursor: pointer; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 3px solid ${onboardingData.aiAdvisorTone === opt.value ? 'var(--accent)' : 'transparent'}; transition: all 0.2s;">
                                            <input type="radio" name="onboarding_aiAdvisorTone" value="${opt.value}" ${onboardingData.aiAdvisorTone === opt.value ? 'checked' : ''} onchange="onboardingData.aiAdvisorTone = this.value; renderOnboardingStep(7);" style="margin-top: 4px; accent-color: var(--accent);">
                                            <div style="flex: 1; text-align: left;">
                                                <div style="font-size: 16px; margin-bottom: 4px;">${opt.icon} <strong>${opt.label}</strong></div>
                                                <div style="font-size: 13px; color: var(--text-muted);">${opt.desc}</div>
                                            </div>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>

                            <div style="padding: 12px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(34, 197, 94, 0.1)); border-radius: var(--radius); font-size: 12px; color: var(--text-secondary); margin-top: 16px; border: 1px solid var(--accent);">
                                <strong>💡 How it works:</strong> Your AI advisor will analyze each bid and give you personalized GO/REVIEW/PASS recommendations in their unique style. You can change this anytime in Settings.
                            </div>
                        </div>
                    </div>
                `;
            } else if (step === 8) {
                body.innerHTML = `
                    <div style="text-align: center; padding: 20px 0;">
                        <div style="font-size: 64px; margin-bottom: 16px;">🤝</div>
                        <h3 style="color: var(--text-primary); margin-bottom: 12px;">Who are your typical clients?</h3>
                        <p style="color: var(--text-muted); margin-bottom: 32px;">Select all that apply - this helps track which client types are most profitable</p>
                        <div style="max-width: 600px; margin: 0 auto;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                ${[
                                    { value: 'gcs', icon: '🏢', label: 'General Contractors', desc: 'Traditional GCs managing projects' },
                                    { value: 'building_owners', icon: '🏢', label: 'Building Owners', desc: 'Property owners hiring direct' },
                                    { value: 'end_users', icon: '👤', label: 'End Users', desc: 'Facility managers, tenants' },
                                    { value: 'developers', icon: '🏗️', label: 'Developers', desc: 'Private real estate developers' },
                                    { value: 'subcontractors', icon: '🔧', label: 'Other Subcontractors', desc: 'Work as a lower-tier sub' },
                                    { value: 'municipalities', icon: '🏛️', label: 'Municipalities', desc: 'Cities, counties, public works' }
                                ].map(opt => `
                                    <label style="display: flex; flex-direction: column; gap: 8px; cursor: pointer; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 3px solid ${onboardingData.clientTypes.includes(opt.value) ? 'var(--accent)' : 'transparent'}; transition: all 0.2s;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <input type="checkbox" value="${opt.value}" ${onboardingData.clientTypes.includes(opt.value) ? 'checked' : ''} onchange="toggleClientType('${opt.value}')" style="accent-color: var(--accent);">
                                            <div style="font-size: 32px;">${opt.icon}</div>
                                        </div>
                                        <div style="text-align: left;">
                                            <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">${opt.label}</div>
                                            <div style="font-size: 12px; color: var(--text-muted);">${opt.desc}</div>
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                            <div style="margin-top: 20px; padding: 12px; background: var(--accent-dim); border-radius: var(--radius); border: 1px solid var(--accent); font-size: 12px; color: var(--text-secondary);">
                                <strong>💡 Why this matters:</strong> BidIntell will track win rates, revenue, and profitability by client type, helping you identify which clients are most valuable to your business.
                            </div>
                        </div>
                    </div>
                `;
            } else if (step === 9) {
                body.innerHTML = `
                    <div style="text-align: center; padding: 20px 0;">
                        <div style="font-size: 64px; margin-bottom: 16px;">🤝</div>
                        <h3 style="color: var(--text-primary); margin-bottom: 12px;">Add your first client</h3>
                        <p style="color: var(--text-muted); margin-bottom: 32px;">You can add more later, but let's start with one you work with often</p>
                        <div style="max-width: 400px; margin: 0 auto; text-align: left;">
                            <div class="form-group">
                                <label class="form-label">Client Company Name</label>
                                <input type="text" class="form-input" id="onboarding_gcName" placeholder="Enter client name...">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Client Type</label>
                                <select class="form-select" id="onboarding_clientType">
                                    <option value="general_contractor">General Contractor</option>
                                    <option value="building_owner">Building Owner</option>
                                    <option value="end_user">End User</option>
                                    <option value="developer">Developer</option>
                                    <option value="subcontractor">Subcontractor</option>
                                    <option value="municipality">Municipality</option>
                                    <option value="municipality">Municipality</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Your Rating</label>
                                <div style="display: flex; gap: 8px; font-size: 32px; margin-top: 8px;">
                                    ${[1,2,3,4,5].map(i => `<span onclick="onboardingData.gcRating = ${i}; renderOnboardingStep(9);" style="cursor: pointer; color: ${i <= (onboardingData.gcRating || 3) ? 'var(--warning)' : 'var(--text-muted)'};">★</span>`).join('')}
                                </div>
                                <div class="form-hint">How would you rate working with this client?</div>
                            </div>
                            <div style="padding: 12px; background: var(--bg-secondary); border-radius: var(--radius); font-size: 12px; color: var(--text-secondary); margin-top: 16px;">
                                <strong>💡 Tip:</strong> You can skip this and add clients later from the Client Manager tab
                            </div>
                        </div>
                    </div>
                `;
            } else if (step === 10) {
                const companyTypeLabel = onboardingData.companyType === 'subcontractor' ? 'Subcontractor' :
                                        onboardingData.companyType === 'distributor' ? 'Distributor' : 'Manufacturer Rep';
                const tradesOrProducts = onboardingData.companyType === 'subcontractor' ?
                    `🔧 Trades: <strong>${onboardingData.trades.length} selected</strong>` :
                    `📦 Product Lines: <strong>${onboardingData.productLines.length} added</strong>`;
                const advisorToneLabel = onboardingData.aiAdvisorTone === 'supportive' ? 'Supportive Coach' :
                                        onboardingData.aiAdvisorTone === 'straight_shooter' ? 'Straight Shooter' : 'Data Nerd';
                const clientTypesLabels = {
                    'gcs': 'General Contractors',
                    'subcontractors': 'Other Subcontractors',
                    'developers': 'Developers',
                    'municipalities': 'Municipalities'
                };
                const clientTypesText = onboardingData.clientTypes.map(t => clientTypesLabels[t]).join(', ');

                body.innerHTML = `
                    <div style="text-align: center; padding: 20px 0;">
                        <div style="font-size: 64px; margin-bottom: 16px;">🎉</div>
                        <h3 style="color: var(--text-primary); margin-bottom: 12px;">You're all set!</h3>
                        <p style="color: var(--text-muted); margin-bottom: 32px;">BidIntell is configured and ready to analyze your bids</p>
                        <div style="max-width: 500px; margin: 0 auto; text-align: left;">
                            <div style="background: var(--bg-secondary); padding: 20px; border-radius: var(--radius); margin-bottom: 20px;">
                                <h4 style="color: var(--text-primary); margin-bottom: 12px;">✅ Your Setup Summary:</h4>
                                <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                                    <div>🏢 Company Type: <strong>${companyTypeLabel}</strong></div>
                                    <div>📍 Office: <strong>${onboardingData.city}, ${onboardingData.state}</strong></div>
                                    <div>${tradesOrProducts}</div>
                                    <div>🤝 Client Types: <strong>${clientTypesText}</strong></div>
                                    <div>📍 Location Importance: <strong>${onboardingData.locationImportance}%</strong></div>
                                    <div>⚖️ Risk Tolerance: <strong>${onboardingData.riskTolerance}</strong></div>
                                    <div>🏗️ Capacity: <strong>${onboardingData.capacity}</strong></div>
                                    <div>🤖 AI Advisor: <strong>${onboardingData.aiAdvisorName}</strong> (${advisorToneLabel})</div>
                                    <div>🤝 GCs Added: <strong>${onboardingData.gcsAdded}</strong></div>
                                </div>
                            </div>
                            <div style="background: linear-gradient(135deg, var(--accent-dim), rgba(34, 197, 94, 0.1)); padding: 20px; border-radius: var(--radius); border: 2px solid var(--accent);">
                                <h4 style="color: var(--text-primary); margin-bottom: 8px;">🚀 Next Step: Analyze Your First Bid</h4>
                                <p style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
                                    Go to the <strong>Analyze</strong> tab and upload a bid document. BidIntell will use AI to extract project details, detect contract risks, identify building type, and give you an intelligent GO/REVIEW/PASS recommendation.
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        async function onboardingNext() {
            // Validate current step
            if (onboardingStep === 1) {
                // Step 1: Company type - always valid, one is selected by default
            } else if (onboardingStep === 2) {
                const city = document.getElementById('onboarding_city')?.value.trim();
                const state = document.getElementById('onboarding_state')?.value;
                if (!city || !state) {
                    alert('Please enter your office city and state');
                    return;
                }
                onboardingData.city = city;
                onboardingData.state = state;
            } else if (onboardingStep === 3) {
                // Step 3: Trades or Product Lines (conditional)
                if (onboardingData.companyType === 'subcontractor') {
                    if (onboardingData.trades.length === 0) {
                        alert('Please select at least one trade division');
                        return;
                    }
                } else {
                    // For distributors/mfg reps, product lines are optional but recommended
                    const categories = document.getElementById('onboarding_categories');
                    if (categories) {
                        onboardingData.productCategories = Array.from(categories.selectedOptions).map(opt => opt.value);
                    }
                }
            } else if (onboardingStep === 4) {
                onboardingData.locationImportance = parseInt(document.getElementById('onboarding_locationImportance')?.value || 50);
            } else if (onboardingStep === 7) {
                // Step 7: AI Advisor - capture selections
                const advisorSelect = document.getElementById('onboarding_aiAdvisorName')?.value;
                if (advisorSelect === 'Custom') {
                    const customName = document.getElementById('onboarding_customAdvisorName')?.value.trim();
                    if (!customName) {
                        alert('Please enter a custom advisor name or select a preset name');
                        return;
                    }
                    onboardingData.aiAdvisorName = customName;
                } else {
                    onboardingData.aiAdvisorName = advisorSelect;
                }
                // aiAdvisorTone is already updated via radio buttons
            } else if (onboardingStep === 8) {
                // Step 8: Client Types - ensure at least one is selected
                if (onboardingData.clientTypes.length === 0) {
                    alert('Please select at least one client type');
                    return;
                }
            } else if (onboardingStep === 9) {
                // Step 9: Client Addition (optional)
                const clientName = document.getElementById('onboarding_gcName')?.value.trim();
                const clientType = document.getElementById('onboarding_clientType')?.value || 'gc';
                if (clientName) {
                    // Add the client with type
                    const newClient = {
                        name: clientName,
                        client_type: clientType,
                        rating: onboardingData.gcRating || 3,
                        bids: 0,
                        wins: 0
                    };
                    await saveGC(newClient);
                    onboardingData.gcsAdded++;
                }
            }

            // Move to next step or complete
            if (onboardingStep === 10) {
                await completeOnboarding();
            } else {
                renderOnboardingStep(onboardingStep + 1);
            }
        }

        function onboardingBack() {
            if (onboardingStep > 1) {
                renderOnboardingStep(onboardingStep - 1);
            }
        }

        function updateOnboardingTrade(checkbox) {
            const code = checkbox.value;
            if (checkbox.checked) {
                if (!onboardingData.trades.includes(code)) {
                    onboardingData.trades.push(code);
                }
            } else {
                onboardingData.trades = onboardingData.trades.filter(t => t !== code);
            }
            // Re-render to update border colors
            renderOnboardingStep(3);
        }

        function toggleClientType(type) {
            if (onboardingData.clientTypes.includes(type)) {
                onboardingData.clientTypes = onboardingData.clientTypes.filter(t => t !== type);
            } else {
                onboardingData.clientTypes.push(type);
            }
            // Re-render to update border colors
            renderOnboardingStep(8);
        }

        function addOnboardingProductLine() {
            const input = document.getElementById('onboarding_productLine');
            const line = input?.value.trim();
            if (line && !onboardingData.productLines.includes(line)) {
                onboardingData.productLines.push(line);
                input.value = '';
                renderOnboardingStep(3);
            }
        }

        function removeOnboardingProductLine(line) {
            onboardingData.productLines = onboardingData.productLines.filter(l => l !== line);
            renderOnboardingStep(3);
        }

        function updateOnboardingCategories() {
            const select = document.getElementById('onboarding_categories');
            if (select) {
                onboardingData.productCategories = Array.from(select.selectedOptions).map(opt => opt.value);
            }
        }

        function toggleCustomAdvisorName(value) {
            const customField = document.getElementById('customAdvisorNameField');
            const customInput = document.getElementById('onboarding_customAdvisorName');

            if (value === 'Custom') {
                customField.style.display = 'block';
                customInput.focus();
                // Clear the stored name so they enter a new one
                if (['Sam','Scout','Jake','Alex','Taylor'].includes(onboardingData.aiAdvisorName)) {
                    onboardingData.aiAdvisorName = '';
                    customInput.value = '';
                }
            } else {
                customField.style.display = 'none';
                onboardingData.aiAdvisorName = value;
            }
        }

        async function completeOnboarding() {
            // Default weights based on company type
            const defaultWeights = {
                subcontractor: { location: 25, keywords: 30, gc: 25, trade: 20 },
                distributor: { location: 15, keywords: 30, gc: 25, trade: 30 },
                manufacturer_rep: { location: 10, keywords: 25, gc: 25, trade: 40 }
            };

            // Use default weights for company type, adjusted by location importance
            const baseWeights = defaultWeights[onboardingData.companyType] || defaultWeights.subcontractor;

            // Adjust location weight based on slider if significantly different
            let locationWeight = baseWeights.location;
            if (onboardingData.locationImportance < 30 && baseWeights.location > 15) {
                locationWeight = Math.max(10, Math.round(baseWeights.location * 0.6));
            } else if (onboardingData.locationImportance > 70 && baseWeights.location < 30) {
                locationWeight = Math.min(40, Math.round(baseWeights.location * 1.4));
            }

            // Redistribute remaining weight proportionally
            const remainingWeight = 100 - locationWeight;
            const baseRemaining = 100 - baseWeights.location;
            const keywordsWeight = Math.round((baseWeights.keywords / baseRemaining) * remainingWeight);
            const gcWeight = Math.round((baseWeights.gc / baseRemaining) * remainingWeight);
            const tradeWeight = 100 - locationWeight - keywordsWeight - gcWeight;

            const settings = {
                company_type: onboardingData.companyType,
                provides_installation: onboardingData.providesInstallation,
                product_lines: onboardingData.productLines,
                product_categories: onboardingData.productCategories,
                city: onboardingData.city,
                state: onboardingData.state,
                search_radius: 100,
                location_matters: onboardingData.locationImportance > 0,
                trades: onboardingData.trades,
                client_types: onboardingData.clientTypes,
                risk_tolerance: onboardingData.riskTolerance,
                capacity: onboardingData.capacity,
                ai_advisor_name: onboardingData.aiAdvisorName,
                ai_advisor_tone: onboardingData.aiAdvisorTone,
                weights: {
                    location: locationWeight,
                    keywords: keywordsWeight,
                    gc: gcWeight,
                    trade: tradeWeight
                },
                decision_time: 45,  // INTEGER minutes instead of 'normal'
                default_stars: 3,
                onboarding_completed: true
            };

            console.log('💾 Saving onboarding settings...', settings);

            try {
                // Save settings and WAIT for completion
                await saveSettingsStorage(settings); // Use saveSettingsStorage directly, not saveSettings()

                // Force clear the cache so getSettings() fetches fresh data
                dataCache.settings = null;

                // Verify it saved
                const savedSettings = await getSettings();
                console.log('✅ Settings saved, onboarding_completed:', savedSettings.onboarding_completed);

                if (!savedSettings.onboarding_completed) {
                    console.error('❌ Onboarding flag did not save! Settings:', savedSettings);
                    alert('Settings saved but onboarding flag may not have persisted. You may see onboarding again on next visit.');
                }

                // Close modal and reload
                closeModal('onboardingModal');

                // Clear ALL caches to force fresh data load
                console.log('🔄 Clearing all caches before reload...');
                dataCache.settings = null;
                dataCache.gcs = null;
                dataCache.projects = null;
                dataCache.keywords = null;

                // Load everything (but onboarding check will pass now)
                console.log('📦 Loading all data after onboarding...');
                await loadAll();

                // Switch to analyze tab
                switchTab('analyze');

                console.log('🎉 Onboarding complete!');
            } catch (error) {
                console.error('❌ Onboarding completion error:', error);
                alert('Failed to save onboarding settings: ' + error.message);
            }
        }

        async function skipOnboarding() {
            if (confirm('Are you sure you want to skip setup? You can configure settings later, but BidIntell won\'t be fully optimized for your business yet.')) {
                try {
                    console.log('🚀 Skipping onboarding...');
                    const settings = await getSettings();
                    console.log('📦 Current settings:', settings);

                    // Set required defaults for skipped onboarding
                    settings.onboarding_completed = true;

                    // Ensure all CHECK constraint fields have valid values
                    settings.capacity = settings.capacity || 'steady';
                    settings.risk_tolerance = settings.risk_tolerance || 'medium';
                    settings.default_stars = settings.default_stars || 3;

                    // Other required fields
                    settings.company_type = settings.company_type || 'subcontractor';
                    settings.typical_clients = settings.typical_clients || ['gcs'];

                    console.log('💾 Saving settings with defaults:', settings);
                    await saveSettingsStorage(settings);

                    console.log('🔄 Clearing cache...');
                    dataCache.settings = null;

                    console.log('✅ Closing modal...');
                    closeModal('onboardingModal');

                    console.log('📦 Loading all data...');
                    await loadAll();

                    console.log('🎉 Onboarding skipped successfully!');
                } catch (error) {
                    console.error('❌ Error skipping onboarding:', error);
                    alert('Failed to skip onboarding: ' + error.message);
                }
            } else {
                console.log('ℹ️ User cancelled skip');
            }
        }

        // File upload
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.style.borderColor = 'var(--accent)'; uploadZone.style.background = 'var(--accent-dim)'; });
        uploadZone.addEventListener('dragleave', () => { uploadZone.style.borderColor = ''; uploadZone.style.background = ''; });
        uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.style.borderColor = ''; uploadZone.style.background = ''; handleFiles(e.dataTransfer.files); });
        fileInput.addEventListener('change', e => handleFiles(e.target.files));

        function handleFiles(files) {
            for (const f of files) {
                if (f.type === 'application/pdf' && !uploadedFiles.find(x => x.name === f.name)) {
                    uploadedFiles.push(f);
                }
            }
            renderFileList();
            updateAnalyzeBtn();
        }

        function renderFileList() {
            const fileListEl = document.getElementById('fileList');
            const moreFilesBtn = document.getElementById('moreFilesBtn');

            fileListEl.innerHTML = uploadedFiles.map((f, i) =>
                `<div class="file-item">📄 <strong>${f.name}</strong> <span style="color:var(--text-muted);margin-left:8px;">(${(f.size / 1024 / 1024).toFixed(1)} MB)</span><span class="remove" onclick="removeFile(${i})">✕</span></div>`
            ).join('');

            // Show "Add More Files" button if files are already uploaded
            if (moreFilesBtn) {
                moreFilesBtn.style.display = uploadedFiles.length > 0 ? 'block' : 'none';
            }
        }

        function removeFile(i) {
            uploadedFiles.splice(i, 1);
            renderFileList();
            updateAnalyzeBtn();
        }

        function updateAnalyzeBtn() {
            document.getElementById('analyzeBtn').disabled = uploadedFiles.length === 0 || selectedGCs.length === 0;
        }

        // GC Selector
        async function renderGCSelector() {
            const gcs = await getGCs();
            const search = document.getElementById('gcSearchInput').value.toLowerCase();
            const filtered = gcs.filter(g => g.name.toLowerCase().includes(search));
            const listEl = document.getElementById('gcSelectorList');

            // Show/hide list based on input
            if (search.trim().length > 0) {
                listEl.classList.add('show');
            } else {
                listEl.classList.remove('show');
            }

            if (filtered.length === 0 && gcs.length === 0) {
                listEl.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text-muted);font-size:13px;">No GCs in database yet.<br>Type a name above and click "Add New"</div>';
            } else if (filtered.length === 0) {
                listEl.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text-muted);font-size:13px;">No matches found.<br>Click "Add New" to add this GC</div>';
            } else {
                listEl.innerHTML = filtered.map(gc => {
                    const isSelected = selectedGCs.find(s => s.name === gc.name);
                    const winRate = gc.bids > 0 ? Math.round(gc.wins / gc.bids * 100) + '% win' : '';
                    return `<div class="gc-selector-item ${isSelected ? 'selected' : ''}" onclick="toggleGC('${gc.name.replace(/'/g, "\\'")}')">
                        <span>${gc.name} ${winRate ? '<span style="color:var(--text-muted);font-size:11px;">(' + winRate + ')</span>' : ''}</span>
                        <span style="color:var(--accent);">${'★'.repeat(gc.rating)}${'☆'.repeat(5 - gc.rating)}</span>
                    </div>`;
                }).join('');
            }
            renderSelectedGCs();
        }

        async function toggleGC(name) {
            const gcs = await getGCs();
            const gc = gcs.find(g => g.name === name);
            if (!gc) return;
            const idx = selectedGCs.findIndex(s => s.name === name);
            if (idx >= 0) {
                // Removing GC
                selectedGCs.splice(idx, 1);
            } else {
                // Adding GC - clear search box and hide list
                selectedGCs.push({ ...gc });
                document.getElementById('gcSearchInput').value = '';
            }
            await renderGCSelector();
            updateCompetition();
            updateAnalyzeBtn();
        }

        function renderSelectedGCs() {
            const container = document.getElementById('selectedGCsList');

            if (selectedGCs.length === 0) {
                container.innerHTML = `
                    <div style="padding: 20px; text-align: center; background: var(--bg-secondary); border-radius: var(--radius); border: 2px dashed var(--border-color); margin: 16px 0;">
                        <div style="font-size: 14px; color: var(--text-muted); margin-bottom: 8px;">
                            👆 No GCs selected yet
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted);">
                            Click GCs from the list above or add a new one
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="padding: 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(34, 197, 94, 0.08)); border-radius: var(--radius); border: 2px solid var(--accent); margin: 16px 0;">
                        <div style="font-weight: 600; margin-bottom: 12px; color: var(--text-primary); display: flex; align-items: center; gap: 8px;">
                            <span>✅ Selected GCs (${selectedGCs.length})</span>
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${selectedGCs.map(gc => `
                                <div class="gc-selected-tag" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-primary); border: 1px solid var(--accent); border-radius: var(--radius); font-size: 14px;">
                                    <span style="font-weight: 500;">${gc.name}</span>
                                    <span style="color: var(--warning); font-size: 12px;">${'★'.repeat(gc.rating)}${'☆'.repeat(5 - gc.rating)}</span>
                                    <span class="remove" onclick="toggleGC('${gc.name.replace(/'/g, "\\'")}')" style="cursor: pointer; color: var(--text-muted); font-weight: bold; padding: 0 4px; hover: color: var(--danger);" title="Remove">✕</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        function updateCompetition() {
            const n = selectedGCs.length;
            if (n === 0) { document.getElementById('competitionIndicator').innerHTML = ''; return; }
            let level, cls, penalty;
            if (n <= 2) { level = 'Low Competition'; cls = 'low'; penalty = 0; }
            else if (n <= 5) { level = 'Moderate Competition'; cls = 'moderate'; penalty = 5; }
            else if (n <= 10) { level = 'High Competition'; cls = 'high'; penalty = 10; }
            else { level = 'Very High Competition'; cls = 'very-high'; penalty = 15; }
            document.getElementById('competitionIndicator').innerHTML = `<div class="competition-indicator ${cls}">${n} GC${n > 1 ? 's' : ''} selected • ${level}${penalty ? ' (-' + penalty + ' score penalty)' : ''}</div>`;
        }

        async function addNewGCFromSearch() {
            const input = document.getElementById('gcSearchInput');
            const name = input.value.trim();
            if (!name) {
                alert('Enter a GC name first');
                return;
            }

            const gcs = await getGCs();
            const existing = gcs.find(g => g.name.toLowerCase() === name.toLowerCase());

            if (existing) {
                // GC already exists - just select it
                if (!selectedGCs.find(s => s.name === existing.name)) {
                    selectedGCs.push({ ...existing });
                    showBanner(`✅ Added "${existing.name}" to selection`, 'success');
                } else {
                    showBanner(`"${existing.name}" is already selected`, 'info');
                }
                input.value = '';
                await renderGCSelector();
                updateCompetition();
                updateAnalyzeBtn();
                return;
            }

            // New GC - prompt for rating
            const ratingHTML = `
                <div style="text-align: center; padding: 20px;">
                    <h3 style="margin-bottom: 16px;">Rate Your Experience with "${name}"</h3>
                    <p style="color: var(--text-muted); margin-bottom: 20px; font-size: 14px;">
                        How would you rate working with this GC? This helps BidIntell give better recommendations.
                    </p>
                    <div style="display: flex; justify-content: center; gap: 12px; font-size: 40px; margin: 20px 0;">
                        ${[1, 2, 3, 4, 5].map(i => `
                            <span onclick="selectRating(${i})" id="ratingStar${i}"
                                  style="cursor: pointer; color: var(--text-muted); transition: all 0.2s;"
                                  onmouseover="highlightStars(${i})"
                                  onmouseout="resetStarHighlight()">★</span>
                        `).join('')}
                    </div>
                    <div id="ratingDescription" style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; min-height: 24px;"></div>
                    <div style="display: flex; gap: 8px; justify-content: center;">
                        <button class="btn btn-secondary" onclick="closeRatingModal()">Cancel</button>
                        <button class="btn btn-primary" id="confirmRatingBtn" onclick="confirmNewGCWithRating()" disabled>Add GC</button>
                    </div>
                </div>
            `;

            // Store the name for later
            window.pendingGCName = name;
            window.pendingGCRating = null;

            // Show in a simple modal (reuse existing modal or create inline)
            const existingModal = document.getElementById('tempRatingModal');
            if (existingModal) existingModal.remove();

            const modalDiv = document.createElement('div');
            modalDiv.id = 'tempRatingModal';
            modalDiv.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.7); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
            `;
            modalDiv.innerHTML = `
                <div style="background: var(--bg-primary); border-radius: var(--radius);
                            max-width: 500px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.3);">
                    ${ratingHTML}
                </div>
            `;
            document.body.appendChild(modalDiv);
        }

        function highlightStars(rating) {
            for (let i = 1; i <= 5; i++) {
                const star = document.getElementById(`ratingStar${i}`);
                if (star) {
                    star.style.color = i <= rating ? 'var(--warning)' : 'var(--text-muted)';
                }
            }
            const descriptions = {
                1: '⭐ Poor - Avoid if possible',
                2: '⭐⭐ Fair - Use with caution',
                3: '⭐⭐⭐ Good - Solid choice',
                4: '⭐⭐⭐⭐ Great - Highly recommended',
                5: '⭐⭐⭐⭐⭐ Excellent - Top tier partner'
            };
            const desc = document.getElementById('ratingDescription');
            if (desc) desc.textContent = descriptions[rating] || '';
        }

        function resetStarHighlight() {
            const current = window.pendingGCRating || 0;
            highlightStars(current);
            if (current === 0) {
                const desc = document.getElementById('ratingDescription');
                if (desc) desc.textContent = 'Click a star to rate';
            }
        }

        function selectRating(rating) {
            window.pendingGCRating = rating;
            highlightStars(rating);
            document.getElementById('confirmRatingBtn').disabled = false;
        }

        function closeRatingModal() {
            const modal = document.getElementById('tempRatingModal');
            if (modal) modal.remove();
            window.pendingGCName = null;
            window.pendingGCRating = null;
        }

        async function confirmNewGCWithRating() {
            const name = window.pendingGCName;
            const rating = window.pendingGCRating;

            if (!name || !rating) {
                alert('Please select a rating');
                return;
            }

            try {
                const newGC = { name, rating, bids: 0, wins: 0 };
                const savedGC = await saveGC(newGC);
                selectedGCs.push({ ...savedGC });

                closeRatingModal();

                const input = document.getElementById('gcSearchInput');
                input.value = '';

                await renderGCSelector();
                updateCompetition();
                updateAnalyzeBtn();
                await loadGCDatabase();

                showBanner(`✅ Added "${name}" with ${rating}★ rating and selected for analysis`, 'success');
            } catch (error) {
                console.error('Error adding GC:', error);
                alert('❌ Error adding GC: ' + error.message);
            }
        }

        // Initialize GC search input listeners when element is ready
        const gcSearchInput = document.getElementById('gcSearchInput');
        if (gcSearchInput) {
            gcSearchInput.addEventListener('input', () => renderGCSelector());
            gcSearchInput.addEventListener('keypress', e => { if (e.key === 'Enter') addNewGCFromSearch(); });
        } else {
            console.warn('gcSearchInput element not found on page load');
        }

        // PDF extraction
        async function extractPDF(file) {
            const ab = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: ab }).promise;
            const pages = [];
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                pages.push({
                    num: i,
                    text: content.items.map(x => x.str).join(' '),
                    filename: file.name // Add filename for multi-file support
                });
            }
            return pages;
        }

        // Geocoding - using OpenStreetMap Nominatim (free)
        async function geocode(addr, fallbackCity = null, fallbackState = null) {
            if (!addr || addr.trim() === '') {
                console.error('❌ Geocode: empty address provided');
                return null;
            }

            console.log('🗺️ GEOCODING REQUEST:', {
                address: addr,
                fallbackCity: fallbackCity,
                fallbackState: fallbackState,
                timestamp: new Date().toISOString()
            });

            // Known cities with duplicate names - use hardcoded coordinates
            // This prevents geocoding from finding wrong cities (e.g., Lawrence, MA instead of Lawrence, KS)
            const knownCities = {
                'lawrence, ks': { lat: 38.9717, lon: -95.2353, display_name: 'Lawrence, Douglas County, Kansas, United States' },
                'lawrence, kansas': { lat: 38.9717, lon: -95.2353, display_name: 'Lawrence, Douglas County, Kansas, United States' },
                'topeka, ks': { lat: 39.0473, lon: -95.6752, display_name: 'Topeka, Shawnee County, Kansas, United States' },
                'manhattan, ks': { lat: 39.1836, lon: -96.5717, display_name: 'Manhattan, Riley County, Kansas, United States' },
                'manhattan, kansas': { lat: 39.1836, lon: -96.5717, display_name: 'Manhattan, Riley County, Kansas, United States' },
                'olathe, ks': { lat: 38.8814, lon: -94.8191, display_name: 'Olathe, Johnson County, Kansas, United States' },
                'overland park, ks': { lat: 38.9822, lon: -94.6708, display_name: 'Overland Park, Johnson County, Kansas, United States' },
                'kansas city, ks': { lat: 39.1142, lon: -94.6275, display_name: 'Kansas City, Wyandotte County, Kansas, United States' },
                'lenexa, ks': { lat: 38.9536, lon: -94.7336, display_name: 'Lenexa, Johnson County, Kansas, United States' },
                'shawnee, ks': { lat: 39.0228, lon: -94.7202, display_name: 'Shawnee, Johnson County, Kansas, United States' }
            };

            // Check if this is a known city - flexible matching
            const addrLower = addr.toLowerCase().trim();

            // Check if this looks like a full street address (contains numbers)
            // If so, DON'T use hardcoded city coordinates - we need precise geocoding
            const hasStreetAddress = /\d/.test(addr); // Contains any digit

            // Only use hardcoded coordinates if NO street address present
            if (!hasStreetAddress) {
                // Try exact match first
                if (knownCities[addrLower]) {
                    console.log('  🎯🎯🎯 USING KNOWN COORDINATES (exact match):', addr);
                    console.log('  Coordinates:', knownCities[addrLower]);
                    return { ...knownCities[addrLower], method: 'known' };
                }

                // Try fallback city/state
                if (fallbackCity && fallbackState) {
                    const cityStateLower = `${fallbackCity}, ${fallbackState}`.toLowerCase().trim();
                    if (knownCities[cityStateLower]) {
                        console.log('  🎯🎯🎯 USING KNOWN COORDINATES (fallback):', cityStateLower);
                        console.log('  Coordinates:', knownCities[cityStateLower]);
                        return { ...knownCities[cityStateLower], method: 'known' };
                    }
                }

                // Try extracting city/state from address string
                // Handles formats like "Penn Lofts, Lawrence, KS" (building name, no street number)
                for (const [key, coords] of Object.entries(knownCities)) {
                    if (addrLower.includes(key)) {
                        console.log(`  🎯🎯🎯 USING KNOWN COORDINATES (contains "${key}"):`, addr);
                        console.log('  Coordinates:', coords);
                        return { ...coords, method: 'known' };
                    }
                }

                // Also check if fallbackCity alone matches any known city (case insensitive)
                // Only do this if NO street address detected
                if (fallbackCity && fallbackState) {
                    const cityLower = fallbackCity.toLowerCase().trim();
                    const stateLower = fallbackState.toLowerCase().trim();
                    const lookupKey = `${cityLower}, ${stateLower}`;

                    for (const [key, coords] of Object.entries(knownCities)) {
                        if (key === lookupKey || key.startsWith(cityLower + ',')) {
                            console.log(`  🎯🎯🎯 USING KNOWN COORDINATES (matched city):`, lookupKey);
                            console.log('  Coordinates:', coords);
                            return { ...coords, method: 'known' };
                        }
                    }
                }
            } else {
                console.log('  🏠 Full street address detected - skipping city center, using precise geocoding');
            }

            console.log('  ⚠️ NO KNOWN CITY MATCH FOUND - will use geocoding API');

            // FIX BUG 2: Progressive geocoding fallback strategy
            const attempts = [];

            // Attempt 1: Full address as provided
            attempts.push(addr);

            // Attempt 2: If we have city/state separately, try that
            if (fallbackCity && fallbackState) {
                attempts.push(`${fallbackCity}, ${fallbackState}`);
            }

            // Attempt 3: Detect and handle county format (e.g., "Johnson County, KS")
            const countyMatch = addr.match(/([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+County,?\s*([A-Z]{2})/i);
            if (countyMatch) {
                const countyName = countyMatch[1];
                const state = countyMatch[2];
                attempts.push(`${countyName} County, ${state}, USA`);
                console.log(`  🏛️ Detected county format: ${countyName} County, ${state}`);
            }

            // Attempt 4: Extract city/state from address string if present
            const cityStateMatch = addr.match(/([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*),?\s*([A-Z]{2})/);
            if (cityStateMatch && !attempts.includes(`${cityStateMatch[1]}, ${cityStateMatch[2]}`)) {
                attempts.push(`${cityStateMatch[1]}, ${cityStateMatch[2]}`);
            }

            // Try each fallback
            for (let i = 0; i < attempts.length; i++) {
                const searchAddr = attempts[i];
                console.log(`  Attempt ${i + 1}/${attempts.length}: "${searchAddr}"`);

                try {
                    const searchWithCountry = searchAddr.includes('USA') ? searchAddr : searchAddr + ', USA';
                    // Request multiple results to handle ambiguous city names
                    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchWithCountry)}&limit=5&countrycodes=us`;

                    const r = await fetch(url, {
                        headers: { 'User-Agent': 'BidIntell/1.0 (bid analysis tool)' }
                    });

                    if (!r.ok) {
                        console.warn(`  ⚠️ HTTP ${r.status} for attempt ${i + 1}`);
                        continue;
                    }

                    const d = await r.json();
                    if (d.length > 0) {
                        // If we have a fallbackState, prefer results in that state
                        let result = d[0]; // Default to first result

                        if (fallbackState && d.length > 1) {
                            const stateAbbr = fallbackState.toUpperCase();
                            // State name mappings for common abbreviations
                            const stateNames = {
                                'KS': 'Kansas', 'MO': 'Missouri', 'CA': 'California', 'TX': 'Texas',
                                'NY': 'New York', 'FL': 'Florida', 'IL': 'Illinois', 'PA': 'Pennsylvania',
                                'OH': 'Ohio', 'GA': 'Georgia', 'NC': 'North Carolina', 'MI': 'Michigan',
                                'IN': 'Indiana', 'MA': 'Massachusetts', 'NJ': 'New Jersey', 'VA': 'Virginia'
                            };
                            const stateName = stateNames[stateAbbr];

                            console.log(`  🔍 Looking for results in ${stateName} (${stateAbbr})`);
                            console.log(`  📍 All results:`, d.map((loc, i) => `${i+1}. ${loc.display_name}`));

                            // Try multiple strategies to find correct state
                            let stateMatch = null;

                            // Strategy 1: Check if state name or abbreviation is in display_name
                            stateMatch = d.find(loc => {
                                const displayLower = loc.display_name.toLowerCase();
                                return displayLower.includes(`, ${stateAbbr.toLowerCase()},`) ||
                                       displayLower.includes(`, ${stateAbbr.toLowerCase()} `) ||
                                       displayLower.endsWith(`, ${stateAbbr.toLowerCase()}`) ||
                                       (stateName && displayLower.includes(`, ${stateName.toLowerCase()},`)) ||
                                       (stateName && displayLower.includes(`, ${stateName.toLowerCase()} `)) ||
                                       (stateName && displayLower.endsWith(`, ${stateName.toLowerCase()}`));
                            });

                            // Strategy 2: If no match, check address object (if available)
                            if (!stateMatch && d[0].address) {
                                stateMatch = d.find(loc =>
                                    loc.address?.state?.toLowerCase() === stateName?.toLowerCase()
                                );
                            }

                            // Strategy 3: Exclude known wrong states for ambiguous city names
                            if (!stateMatch) {
                                const wrongStates = ['Massachusetts', 'Indiana', 'New York']; // Common duplicate city names
                                const filtered = d.filter(loc => {
                                    const displayLower = loc.display_name.toLowerCase();
                                    return !wrongStates.some(state => displayLower.includes(state.toLowerCase()));
                                });
                                if (filtered.length > 0) {
                                    stateMatch = filtered[0];
                                    console.log(`  🔄 Using filtered result (excluded common duplicates)`);
                                }
                            }

                            if (stateMatch) {
                                result = stateMatch;
                                console.log(`  🎯 Found state-specific match: ${stateMatch.display_name}`);
                            } else {
                                console.warn(`  ⚠️ No result found for state ${stateAbbr}, using first result: ${d[0].display_name}`);
                                console.warn(`  ⚠️ THIS MAY BE THE WRONG LOCATION - Please verify!`);
                            }
                        }

                        console.log(`  ✅ Geocoded: ${searchAddr} → ${result.display_name}`);
                        return {
                            lat: parseFloat(result.lat),
                            lon: parseFloat(result.lon),
                            display_name: result.display_name,
                            method: i === 0 ? 'exact' : 'fallback'
                        };
                    } else {
                        console.log(`  ⚠️ No results for attempt ${i + 1}`);
                    }

                    // Rate limiting: wait 1 second between attempts
                    if (i < attempts.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                } catch (e) {
                    console.error(`  ❌ Error on attempt ${i + 1}:`, e.message);
                }
            }

            console.error('❌ All geocoding attempts failed for:', addr);
            return null;
        }

        function haversine(lat1, lon1, lat2, lon2) {
            const R = 3959, dLat = (lat2 - lat1) * Math.PI / 180, dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        // Validate keyword is legitimate (not garbage extraction)
        function isValidKeyword(kw) {
            if (!kw || typeof kw !== 'string') return false;

            const cleaned = kw.trim();
            if (cleaned.length < 3) return false; // Too short
            if (cleaned.length > 50) return false; // Too long

            // No letters (just symbols/numbers)
            if (/^[^a-zA-Z]+$/.test(cleaned)) return false;

            // Just numbers
            if (/^\d+$/.test(cleaned)) return false;

            // Contains parentheses or brackets (often garbage like "(Deduct)")
            if (/[\(\)\[\]]/.test(cleaned)) return false;

            // Common non-keywords
            const lower = cleaned.toLowerCase();
            const invalidTerms = ['na', 'n/a', 'add', 'deduct', 'pkg', 'tbd', 'etc', 'ref', 'see', 'per', 'typ'];
            if (invalidTerms.includes(lower)) return false;

            // Single/double letter abbreviations (e.g., "no", "na", "in", "or")
            if (/^[a-z]{1,2}$/.test(lower)) return false;

            // Contains mostly non-letter characters (like "modulrblock" typos or spec codes)
            const letterCount = (cleaned.match(/[a-zA-Z]/g) || []).length;
            const totalChars = cleaned.length;
            if (letterCount / totalChars < 0.6) return false; // At least 60% letters

            // Starts or ends with special characters
            if (/^[^a-zA-Z]/.test(cleaned) || /[^a-zA-Z0-9]$/.test(cleaned)) return false;

            return true;
        }

        // Keyword search with validation
        function searchKeywords(pages, keywords) {
            const results = [];
            for (const kw of keywords) {
                // Filter out garbage keywords
                if (!isValidKeyword(kw)) {
                    console.warn('Skipping invalid keyword:', kw);
                    continue;
                }

                const found = [];
                // Case-insensitive regex with 'gi' flag, with optional plural 's'
                const rx = new RegExp('\\b' + kw.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + 's?\\b', 'gi');

                for (const p of pages) {
                    if (rx.test(p.text)) {
                        // Include filename for multi-file support
                        found.push({
                            page: p.num,
                            filename: p.filename || 'Document'
                        });
                    }
                }

                if (found.length > 0) {
                    results.push({
                        keyword: kw,
                        pages: found.map(f => f.page), // Keep legacy format for compatibility
                        locations: found // New format with filename
                    });
                }
            }
            return results;
        }

        // OpenAI API extraction (fallback)
        async function extractWithOpenAI(text) {
            const maxChars = 50000;
            const truncatedText = text.length > maxChars ? text.substring(0, maxChars) + '\n\n[Document truncated...]' : text;

            const prompt = `You are analyzing construction bid documents for a subcontractor. Extract the following information and return it as a JSON object. Be precise — only extract what is explicitly stated in the documents.

{
  "project_name": "The name of the construction project, building, or facility.",
  "project_address": "The PHYSICAL STREET ADDRESS where this project will be built.",
  "project_city": "The city where the project is located.",
  "project_state": "The US state abbreviation (2 letters).",
  "project_zip": "The ZIP code if stated.",
  "building_type": "Classify as ONE of: Healthcare, Office, Multifamily, Retail, Industrial, Education, Higher Education, Government, Religious, Mixed-Use, Infrastructure, Other. CRITICAL RULES FOR CLASSIFICATION (check in this order): 1) If document mentions MULTIPLE building types together (office + retail, office + residential, retail + multi-family, residential + retail, etc.) → ALWAYS = Mixed-Use. 2) If project name contains 'LOFTS' (like 'Penn Lofts', 'Industrial Lofts', 'Urban Lofts') → ALWAYS = Multifamily. 3) If description contains 'apartments', 'condos', 'townhomes', 'residential units', 'student housing', 'senior living', 'apartment complex', 'multi-family' → ALWAYS = Multifamily. 4) If owner contains 'school', 'university' → Education. NEVER classify residential projects as Office. Default to Other ONLY if truly ambiguous.",
  "bid_deadline": "The bid due date and time. Return ONLY a date/time string like 'February 15, 2026 at 2:00 PM'. If no deadline is found, return null.",
  "project_size_sf": "🔴 CRITICAL PRIORITY - Total building square footage. Search these locations IN ORDER: 1) Code Notes section (often near cover page), 2) Building Information table/box, 3) Project Summary, 4) Scope of Work section, 5) Section 01 General Requirements, 6) Cover page header/footer. Match ANY pattern: '5,000 SF', '5000 SF', '5,000 square feet', '5000 sq ft', '5000 GSF', '5,000 s.f.', 'Building Area: 5000', 'Project Size: 5000', 'Total SF: 5000', or similar. If you find MULTIPLE numbers, use the LARGEST (total building area). Extract ONLY the numeric digits (remove all commas). Return as integer or null. EXAMPLE: '5,500 SF' → return 5500.",
  "estimated_value": "Estimated project value/budget if stated. Return as a number or null.",
  "owner_name": "The project owner or client name.",
  "architect_name": "The architect or design firm name if mentioned.",
  "gc_name": "The general contractor name if mentioned.",
  "spec_divisions_found": "Array of CSI division numbers found in the documents. Example: [3, 4, 5, 7, 8, 9, 10, 12, 26].",
  "scope_summary": "A brief 2-3 sentence summary of the project scope and major work items."
}

IMPORTANT RULES:
- Return ONLY valid JSON, no other text.
- For project_address: Extract ONLY the construction site address.
- For bid_deadline: Return ONLY a date string or null.
- For project_size_sf: 🔴 CRITICAL - Search EVERYWHERE: code notes section, building info tables, cover page, project summary, scope descriptions, and Section 01. Look for ANY SF pattern: "5,000 SF", "5000 square feet", "5000 sq ft", "5,000 GSF", "Building Area: 5000", "Total SF: 5000". Use LARGEST number found (total building). Extract digits only (no commas). EXAMPLE: "5,500 SF" → 5500.
- For building_type: CHECK IN ORDER: 1) Multiple uses (office + retail, office + residential, retail + apartments) = Mixed-Use. 2) Project name contains "LOFTS" = Multifamily (not Office). 3) Any residential keywords (apartments, condos, townhomes) = Multifamily.

Here is the bid document text:

${truncatedText}`;

            try {
                // Use backend API instead of direct OpenAI call
                const content = await callAI('extract_project_details', truncatedText, prompt);

                // Parse JSON from response
                let jsonStr = content;
                if (content.includes('```')) {
                    const match = content.match(/```(?:json)?\s*([\s\S]*?)```/);
                    if (match) jsonStr = match[1];
                }

                const extracted = JSON.parse(jsonStr.trim());
                console.log('🔍 OpenAI extracted (raw):', extracted);
                return extracted;
            } catch (e) {
                console.error('OpenAI extraction failed:', e);
                throw e;
            }
        }

        // Auto-add extracted GCs to user's database
        async function autoAddExtractedGCs(extracted) {
            if (!currentUser || !supabaseClient) return;

            // Get GC names from various possible fields
            const gcNames = [];
            if (extracted.gc_names && Array.isArray(extracted.gc_names)) {
                gcNames.push(...extracted.gc_names);
            } else if (extracted.general_contractor) {
                gcNames.push(extracted.general_contractor);
            } else if (extracted.gc_name) {
                gcNames.push(extracted.gc_name);
            }

            if (gcNames.length === 0) return;

            // Get existing GCs
            const existingGCs = await getGCs();

            // Add new GCs with default rating
            for (const gcName of gcNames) {
                const name = gcName.trim();
                if (!name) continue;

                // Check if already exists (case-insensitive)
                const exists = existingGCs.find(gc =>
                    gc.name.toLowerCase() === name.toLowerCase()
                );

                if (!exists) {
                    console.log(`🏗️ Auto-adding GC: "${name}" with default 3-star rating`);
                    try {
                        await saveGC({
                            name: name,
                            rating: 3, // Default neutral rating
                            bids: 0,
                            wins: 0,
                            riskTags: []
                        });
                    } catch (error) {
                        console.warn(`Failed to auto-add GC "${name}":`, error);
                    }
                }
            }

            // Invalidate cache to reload with new GCs
            dataCache.gcs = null;
        }

        // Multi-provider AI extraction with fallback
        async function extractWithAI(text) {
            // Try Claude first
            try {
                console.log('🤖 Trying Claude API...');
                const result = await extractWithClaude(text);
                console.log('✅ Claude extraction successful');
                return result;
            } catch (claudeError) {
                console.warn('❌ Claude failed, trying OpenAI fallback...', claudeError.message);

                // Try OpenAI as fallback
                try {
                    const result = await extractWithOpenAI(text);
                    console.log('✅ OpenAI fallback successful');

                    // Show notification that we're using fallback
                    showErrorBanner('ℹ️ Using OpenAI fallback (Claude unavailable)');

                    // Send email notification
                    sendErrorEmail('Claude API Failed - Using OpenAI Fallback', claudeError.message);

                    return result;
                } catch (openaiError) {
                    console.error('❌ Both AI providers failed');

                    // Send critical error email
                    sendErrorEmail('ALL AI Providers Failed', `Claude: ${claudeError.message}\nOpenAI: ${openaiError.message}`);

                    throw new Error('All AI providers failed');
                }
            }
        }

        // Claude API extraction
        async function extractWithClaude(text) {
            // Truncate text if too long (Claude has token limits)
            const maxChars = 50000;
            const truncatedText = text.length > maxChars ? text.substring(0, maxChars) + '\n\n[Document truncated...]' : text;
            
            const prompt = `You are analyzing construction bid documents for a subcontractor. Extract the following information and return it as a JSON object. Be precise — only extract what is explicitly stated in the documents.

{
  "project_name": "The name of the construction project, building, or facility. Look for project titles, building names, or owner names. If multiple names appear, use the most prominent one.",

  "project_address": "The PHYSICAL STREET ADDRESS where this project will be built. Extract ONLY ONE address — the project site address. Do NOT include addresses of architects, engineers, owners' offices, or other firms.",

  "project_city": "The city where the project is located.",

  "project_state": "The US state abbreviation (2 letters) where the project is located. Must be a valid US state code.",

  "project_zip": "The ZIP code if stated.",

  "building_type": "Classify as ONE of: Healthcare, Office, Multifamily, Retail, Industrial, Education, Higher Education, Government, Religious, Mixed-Use, Infrastructure, Other. CRITICAL RULES FOR CLASSIFICATION (check in this order): 1) If document mentions MULTIPLE building types together (office + retail, office + residential, retail + multi-family, residential + retail, etc.) → ALWAYS = Mixed-Use. 2) If project name contains 'LOFTS' (like 'Penn Lofts', 'Industrial Lofts', 'Urban Lofts') → ALWAYS = Multifamily. 3) If description contains 'apartments', 'condos', 'townhomes', 'residential units', 'student housing', 'senior living', 'apartment complex', 'multi-family' → ALWAYS = Multifamily. 4) If owner contains 'school', 'university' → Education. NEVER classify residential projects as Office. Default to Other ONLY if truly ambiguous.",

  "bid_deadline": "The bid due date and time. Return ONLY a date/time string like 'February 15, 2026 at 2:00 PM'. If no deadline is found, return null.",

  "project_size_sf": "🔴 CRITICAL PRIORITY - Total building square footage. Search these locations IN ORDER: 1) Code Notes section (often near cover page), 2) Building Information table/box, 3) Project Summary, 4) Scope of Work section, 5) Section 01 General Requirements, 6) Cover page header/footer. Match ANY pattern: '5,000 SF', '5000 SF', '5,000 square feet', '5000 sq ft', '5000 GSF', '5,000 s.f.', 'Building Area: 5000', 'Project Size: 5000', 'Total SF: 5000', or similar. If you find MULTIPLE numbers, use the LARGEST (total building area). Extract ONLY the numeric digits (remove all commas). Return as integer or null. EXAMPLE: '5,500 SF' → return 5500.",

  "estimated_value": "Estimated project value/budget if stated. Return as a number or null.",

  "owner_name": "The project owner or client name.",

  "architect_name": "The architect or design firm name if mentioned.",

  "gc_name": "The general contractor name if mentioned.",

  "spec_divisions_found": "Array of CSI division numbers found in the documents. Example: [3, 4, 5, 7, 8, 9, 10, 12, 26]. Look for division numbers in section headers, spec references, and scope descriptions.",

  "contract_risk_clauses": {
    "pay_if_paid": "true/false — Is there a pay-if-paid or pay-when-paid clause?",
    "liquidated_damages": "true/false — Are liquidated damages specified?",
    "broad_indemnification": "true/false — Is there broad or unlimited indemnification language?",
    "no_damage_for_delay": "true/false — Is there a no-damage-for-delay clause?",
    "waiver_consequential_damages": "true/false — Is there a waiver of consequential damages?",
    "retainage_over_10_percent": "true/false — Is retainage specified over 10%?"
  },

  "contract_language_present": "true/false — Are there any contract terms, conditions, or agreement language in these documents?",

  "scope_summary": "A brief 2-3 sentence summary of the project scope and major work items."
}

IMPORTANT RULES:
- Return ONLY valid JSON, no other text.
- For project_address: Extract ONLY the construction site address. Ignore architect offices, owner headquarters, or other firm addresses.
- For bid_deadline: Return ONLY a date string or null. NEVER return specification text, scope descriptions, or any non-date content.
- For project_name: Use the building name, project title, or owner name — whichever best identifies the project.
- For building_type: Use context clues like the owner name (e.g., "School" = Education), project description, and scope to classify.
- For spec_divisions_found: Look for 2-digit CSI MasterFormat division numbers (01-49) in section headers and references.
- For project_size_sf: 🔴 CRITICAL - Search EVERYWHERE: code notes section, building info tables, cover page, project summary, scope descriptions, and Section 01. Look for ANY SF pattern: "5,000 SF", "5000 square feet", "5000 sq ft", "5,000 GSF", "Building Area: 5000", "Total SF: 5000". Use LARGEST number found (total building). Extract digits only (no commas). EXAMPLE: "5,500 SF" → 5500.
- For building_type: CHECK IN ORDER: 1) Multiple uses (office + retail, office + residential, retail + apartments) = Mixed-Use. 2) Project name contains "LOFTS" = Multifamily (not Office). 3) Any residential keywords (apartments, condos, townhomes) = Multifamily.
- For contract_risk_clauses: Only mark true if the clause is explicitly present. If no contract language exists, mark all as false.

Here is the bid document text:

${truncatedText}`;

            try {
                // Use backend API instead of direct Claude call
                const content = await callAI('extract_project_details', truncatedText, prompt);
                
                // Parse JSON from response (handle markdown code blocks)
                let jsonStr = content;
                if (content.includes('```')) {
                    const match = content.match(/```(?:json)?\s*([\s\S]*?)```/);
                    if (match) jsonStr = match[1];
                }
                
                const extracted = JSON.parse(jsonStr.trim());
                console.log('🔍 Claude extracted (raw):', extracted);

                // Clean up extracted data
                let projectName = extracted.project_name || null;
                let projectCity = extracted.project_city || null;
                let projectState = extracted.project_state || null;
                let projectAddress = extracted.project_address || null;
                let bidDeadline = extracted.bid_deadline || null;
                let buildingType = extracted.building_type || 'Other';

                // FIX BUG 3: Validate bid_deadline - reject garbage text
                if (bidDeadline && (bidDeadline.length > 100 || !/\d/.test(bidDeadline))) {
                    console.warn('⚠️ Bid deadline looks like garbage text, setting to null:', bidDeadline.substring(0, 50) + '...');
                    bidDeadline = null;
                }

                // FIX BUG 4: Validate project_city - reject if it contains multiple cities
                if (projectCity && (projectCity.includes('•') || projectCity.split(',').length > 2)) {
                    console.warn('⚠️ Project city contains multiple locations, attempting to clean:', projectCity);
                    // Try to extract just the first city
                    const firstCity = projectCity.split(/[•,]/)[0].trim();
                    if (firstCity.length < 30) {
                        projectCity = firstCity;
                    }
                }

                // FIX BUG 1 & 8: Validate and clean up project_name and location fields
                // If project_name is null but project_city contains a long string, Claude might have mixed them up
                if (!projectName && projectCity && projectCity.length > 30) {
                    // City names are rarely longer than 30 chars - this is probably a project name
                    console.warn('⚠️ Project name empty but city is long - Claude may have swapped fields');
                    // Try to parse out the actual city from the string
                    const cityMatch = projectCity.match(/[-–]\s*([^-–\d]{3,}(?:,?\s+[A-Z]{2})?)/);
                    if (cityMatch) {
                        projectName = projectCity.split(/[-–]/)[0].trim();
                        projectCity = cityMatch[1].split(',')[0].trim();
                        console.log('✅ Fixed: project_name =', projectName, ', project_city =', projectCity);
                    }
                }

                // Clean project_city: remove numbers, addresses, and extra text
                if (projectCity) {
                    // Remove street addresses (numbers + street names)
                    projectCity = projectCity.replace(/\d+\s+[A-Z][a-z]+\s+(Street|St|Avenue|Ave|Boulevard|Blvd|Road|Rd|Drive|Dr|Lane|Ln|Way|Court|Ct|Circle|Cir|Parkway|Pkwy).*/gi, '').trim();
                    // Remove zip codes
                    projectCity = projectCity.replace(/\b\d{5}(-\d{4})?\b/g, '').trim();
                    // Remove leading/trailing punctuation
                    projectCity = projectCity.replace(/^[,\-–\s]+|[,\-–\s]+$/g, '').trim();
                    // Remove "Owner:" prefix if present
                    projectCity = projectCity.replace(/^Owner:\s*/i, '').trim();
                    // If still too long, just take first reasonable city name
                    if (projectCity.length > 30) {
                        const parts = projectCity.split(/[,\-–]/);
                        projectCity = parts[0].trim();
                    }
                    console.log('🧹 Cleaned project_city:', projectCity);
                }

                // Ensure project_name doesn't default to "Untitled" if we have ANY identifying info
                if (!projectName || projectName === 'Untitled Project') {
                    // Try owner name first
                    if (extracted.owner_name && extracted.owner_name !== 'null') {
                        projectName = extracted.owner_name;
                    } else if (extracted.scope_summary) {
                        const summaryWords = extracted.scope_summary.split(' ').slice(0, 6).join(' ');
                        projectName = summaryWords;
                    } else if (projectCity && projectState) {
                        projectName = `${projectCity}, ${projectState} Project`;
                    } else {
                        projectName = 'Untitled Project';
                    }
                }

                // FIX BUG 5: Validate building type
                const validBuildingTypes = ['Healthcare', 'Office', 'Multifamily', 'Retail', 'Industrial',
                    'Education', 'Higher Education', 'Government', 'Religious', 'Mixed-Use', 'Infrastructure', 'Other'];
                if (!validBuildingTypes.includes(buildingType)) {
                    console.warn('⚠️ Invalid building type, defaulting to Other:', buildingType);
                    buildingType = 'Other';
                }

                console.log('✅ Final extracted data:', {
                    project_name: projectName,
                    project_city: projectCity,
                    project_state: projectState,
                    building_type: buildingType,
                    bid_deadline: bidDeadline
                });

                // Note: API usage tracking not available from backend callAI function
                // Backend handles API calls internally, usage data not returned

                return {
                    project_name: projectName,
                    project_city: projectCity,
                    project_state: projectState,
                    project_address: projectAddress,
                    project_zip: extracted.project_zip || null,
                    building_type: buildingType,
                    bid_deadline: bidDeadline,
                    project_size_sf: extracted.project_size_sf || null,
                    estimated_value: extracted.estimated_value || null,
                    owner_name: extracted.owner_name || null,
                    architect_name: extracted.architect_name || null,
                    gc_name: extracted.gc_name || null,
                    spec_divisions_found: extracted.spec_divisions_found || [],
                    contract_risk_clauses: extracted.contract_risk_clauses || {
                        pay_if_paid: false,
                        liquidated_damages: false,
                        broad_indemnification: false,
                        no_damage_for_delay: false,
                        waiver_consequential_damages: false,
                        retainage_over_10_percent: false
                    },
                    contract_language_present: extracted.contract_language_present || false,
                    scope_summary: extracted.scope_summary || null
                };
            } catch (e) {
                console.error('Claude extraction failed:', e);

                // Show user-friendly error notification
                const errorMsg = e.message.includes('401') ?
                    '⚠️ Claude API key is invalid or expired. Using basic extraction instead. Please update your API key in Settings.' :
                    '⚠️ AI extraction failed. Using basic extraction instead. Some details may be missing.';

                // Show error banner (founder only)
                showErrorBanner(errorMsg);

                // Send email alert to founder
                const errorType = e.message.includes('401') ? 'Claude API Key Invalid' : 'Claude API Extraction Failed';
                sendErrorEmail(errorType, e.message);

                // Fallback to basic extraction
                return {
                    project_name: extractProjectName(text) || 'Untitled Project',
                    project_city: extractField(text, /(?:city|location)[:\s]+([^,\n]+)/i),
                    project_state: extractField(text, /\b([A-Z]{2})\b(?:\s+\d{5})?/),
                    project_address: extractAddress(text),
                    bid_deadline: extractField(text, /(?:due|deadline|bid date)[:\s]+([^\n]+)/i),
                    has_contract_language: /contract|agreement|terms and conditions/i.test(text)
                };
            }
        }

        // Analysis
        async function analyzeBid() {
            const btn = document.getElementById('analyzeBtn');
            const result = document.getElementById('analysisResult');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="width:18px;height:18px;border-width:2px;margin-right:8px;"></span>Analyzing...';
            
            // Show progress bar
            result.innerHTML = `
                <div class="card" style="padding:24px;">
                    <div style="text-align:center;margin-bottom:16px;">
                        <span class="spinner" style="width:32px;height:32px;"></span>
                    </div>
                    <div id="progressStatus" style="text-align:center;font-size:14px;color:var(--text-secondary);margin-bottom:12px;">Extracting text from PDFs...</div>
                    <div style="background:var(--bg-input);border-radius:4px;height:8px;overflow:hidden;">
                        <div id="progressBar" style="height:100%;background:var(--accent);width:0%;transition:width 0.3s;"></div>
                    </div>
                </div>`;

            const updateProgress = (percent, status) => {
                const bar = document.getElementById('progressBar');
                const text = document.getElementById('progressStatus');
                if (bar) bar.style.width = percent + '%';
                if (text) text.textContent = status;
            };

            try {
                // Extract text from PDFs
                updateProgress(10, 'Extracting text from PDFs...');
                let allPages = [];
                for (let i = 0; i < uploadedFiles.length; i++) {
                    const f = uploadedFiles[i];
                    updateProgress(10 + (i / uploadedFiles.length) * 30, `Reading ${f.name}...`);
                    try {
                        const pages = await extractPDF(f);
                        allPages = allPages.concat(pages);
                    } catch (pdfErr) {
                        console.error('PDF extraction error:', pdfErr);
                    }
                }
                
                if (allPages.length === 0) {
                    throw new Error('Could not extract text from the uploaded PDFs. Please ensure they are valid PDF files.');
                }
                
                const fullText = allPages.map(p => p.text).join('\n\n');
                
                updateProgress(50, 'AI analyzing project details...');

                // Use multi-provider AI extraction (Claude → OpenAI → Regex fallback)
                const extracted = await extractWithAI(fullText);

                // Auto-add extracted GCs to database (so they appear in selector)
                await autoAddExtractedGCs(extracted);

                // Validate and fix extracted data
                const validStates = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'];
                if (extracted.project_state && !validStates.includes(extracted.project_state.toUpperCase())) {
                    console.warn('Invalid state extracted:', extracted.project_state, '- setting to null');
                    extracted.project_state = null;
                }

                // Check for duplicate project
                updateProgress(53, 'Checking for duplicates...');
                const duplicateCheck = await checkDuplicateProject(
                    extracted.project_name,
                    extracted.project_city,
                    extracted.project_state
                );

                updateProgress(55, 'Detecting contract risks...');

                // Layer 0: AI Contract Risk Detection
                const contractRisks = await detectContractRisks(fullText);

                updateProgress(58, 'Identifying building type...');

                // Layer 0: Building Type Extraction
                const buildingType = await extractBuildingType(
                    extracted.project_name || 'Unknown Project',
                    extracted.scope_summary || '',
                    fullText
                );

                updateProgress(60, 'Searching for keywords...');

                const settings = await getSettings();
                const keywords = await getKeywords();
                const goodFound = searchKeywords(allPages, keywords.good);
                const badFound = searchKeywords(allPages, keywords.bad);

                updateProgress(72, 'Checking trade divisions with multi-signal detection...');

                // Multi-signal trade detection
                // First, find CSI headers (Signal 1)
                const foundCSIDivisions = [];
                for (const [code, name] of CSI_DIVISIONS) {
                    if (settings.trades.includes(code)) {
                        for (const p of allPages) {
                            if (new RegExp(`Division\\s*${code}|Section\\s*${code}|\\b${code}\\s*\\d{2}`, 'gi').test(p.text)) {
                                if (!foundCSIDivisions.includes(code)) foundCSIDivisions.push(code);
                            }
                        }
                    }
                }

                // Run multi-signal detection (combines CSI headers with 3 additional signals)
                const tradeDetection = detectTradesMultiSignal(allPages, settings.trades, foundCSIDivisions);
                const tradesFound = tradeDetection.matches.map(m => m.division);

                console.log('📊 Trade Detection Results:', {
                    divisions_found: tradesFound,
                    signals_used: tradeDetection.signals_used,
                    highest_confidence: tradeDetection.highest_confidence,
                    details: tradeDetection.matches
                });

                updateProgress(85, 'Calculating BidIntell score...');

                // Layer 0: Derive market metro area from project location
                const marketMetroArea = extracted.project_city && extracted.project_state
                    ? `${extracted.project_city} Metro, ${extracted.project_state}`
                    : null;

                const scores = await calculateScores(extracted, settings, goodFound, badFound, tradesFound, contractRisks, tradeDetection);

                updateProgress(90, 'Running Intelligence Engine...');

                // Create temporary project object for Intelligence Engine
                const tempProject = {
                    extracted,
                    scores,
                    gcs: [...selectedGCs],
                    goodFound,
                    badFound,
                    tradesFound,
                    contractRisks,
                    buildingType,
                    marketMetroArea,
                    createdAt: new Date().toISOString(),
                    distance: scores.distance // For location analysis
                };

                // Get user history for similar project matching
                const userHistory = await getProjects();

                // Run Intelligence Engine components
                const validationStatus = validateBidData(tempProject, settings);
                const scoreExplanation = explainScore(tempProject, settings);
                const aiAdvisorOutput = generateAdvisorResponse(tempProject, settings, userHistory);
                const intelligenceTags = tagForAnalytics(tempProject, settings);

                console.log('🧠 Intelligence Engine Results:', {
                    validation: validationStatus,
                    tags: intelligenceTags,
                    advisor_tone: settings.ai_advisor_tone || 'supportive'
                });

                updateProgress(95, 'Generating report...');

                currentAnalysis = {
                    id: Date.now().toString(),
                    extracted, scores,
                    gcs: [...selectedGCs],
                    files: uploadedFiles.map(f => f.name),
                    goodFound, badFound, tradesFound,
                    // Layer 0 Intelligence Data
                    contractRisks,
                    buildingType,
                    marketMetroArea,
                    createdAt: new Date().toISOString(),
                    outcome: 'pending', // Default outcome
                    // Intelligence Engine Data
                    validationStatus,
                    scoreExplanation,
                    aiAdvisorOutput,
                    intelligenceTags
                };

                // No auto-save - user must click "Save to Projects" button
                console.log('📊 Analysis complete. Ready to save manually.');

                updateProgress(100, 'Done!');
                await new Promise(r => setTimeout(r, 300)); // Brief pause to show 100%

                // Check for similar past bids
                const similarBid = await findSimilarPastBid(currentAnalysis);

                // Check bid volume guardrail
                const volumeWarning = await checkBidVolumeGuardrail();

                renderResult(currentAnalysis, similarBid, volumeWarning, duplicateCheck);

            } catch (error) {
                console.error(error);
                result.innerHTML = `<div class="card" style="border-color:var(--danger)"><div class="card-body" style="text-align:center"><h3 style="color:var(--danger);margin-bottom:8px;">Analysis Error</h3><p style="color:var(--text-muted);margin-bottom:16px;">${error.message}</p><button class="btn btn-secondary" onclick="resetAnalysis()">Try Again</button></div></div>`;
            }

            btn.disabled = false;
            btn.innerHTML = '<svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>Analyze Bid';
        }

        // Find similar past bid (same GC or same city+trade)
        async function findSimilarPastBid(currentBid) {
            const projects = await getProjects();
            if (projects.length === 0) return null;
            
            const currentGCs = currentBid.gcs.map(g => g.name.toLowerCase());
            const currentCity = currentBid.extracted.project_city?.toLowerCase();
            
            for (const p of projects) {
                // Skip if same project (by ID) or pending
                if (p.id === currentBid.id) continue;
                
                // Check for same GC
                const pastGCs = (p.gcs || []).map(g => g.name.toLowerCase());
                const sharedGC = currentGCs.find(gc => pastGCs.includes(gc));
                
                if (sharedGC && (p.outcome === 'lost' || p.outcome === 'ghost' || p.outcome === 'declined')) {
                    const gc = p.gcs.find(g => g.name.toLowerCase() === sharedGC);
                    const reasons = [];
                    
                    if (p.outcome === 'lost') {
                        if (p.outcomeData?.howHigh) reasons.push(p.outcomeData.howHigh);
                        if (p.outcomeData?.winner) reasons.push(`Lost to ${p.outcomeData.winner}`);
                    } else if (p.outcome === 'ghost') {
                        reasons.push('They ghosted you');
                    } else if (p.outcome === 'declined') {
                        if (p.outcomeData?.reason) reasons.push(p.outcomeData.reason);
                    }
                    
                    // Calculate how long ago
                    const daysAgo = Math.round((Date.now() - new Date(p.createdAt).getTime()) / (1000 * 60 * 60 * 24));
                    const timeAgo = daysAgo < 30 ? `${daysAgo} days ago` : daysAgo < 90 ? `${Math.round(daysAgo/30)} months ago` : `${Math.round(daysAgo/365)} year(s) ago`;
                    
                    return {
                        type: 'gc',
                        gcName: gc?.name || sharedGC,
                        projectName: p.extracted?.project_name || 'a similar project',
                        outcome: p.outcome,
                        reasons,
                        timeAgo,
                        score: p.scores?.final
                    };
                }
                
                // Check for same city (if no GC match found yet)
                const pastCity = p.extracted?.project_city?.toLowerCase();
                if (currentCity && pastCity === currentCity && (p.outcome === 'lost' || p.outcome === 'ghost')) {
                    const daysAgo = Math.round((Date.now() - new Date(p.createdAt).getTime()) / (1000 * 60 * 60 * 24));
                    const timeAgo = daysAgo < 30 ? `${daysAgo} days ago` : `${Math.round(daysAgo/30)} months ago`;
                    
                    return {
                        type: 'location',
                        city: p.extracted.project_city,
                        projectName: p.extracted?.project_name || 'a project',
                        outcome: p.outcome,
                        timeAgo,
                        score: p.scores?.final
                    };
                }
            }
            
            return null;
        }

        // Check bid volume guardrail
        async function checkBidVolumeGuardrail() {
            const projects = await getProjects();
            if (projects.length < 5) return null; // Not enough data
            
            // Get bids from last 7 days
            const oneWeekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            const recentBids = projects.filter(p => new Date(p.createdAt).getTime() > oneWeekAgo);
            
            if (recentBids.length < 3) return null; // Not enough recent activity
            
            // Calculate average score
            const avgScore = Math.round(recentBids.reduce((sum, p) => sum + (p.scores?.final || 0), 0) / recentBids.length);
            
            // Calculate historical win rate for low-score bids
            const lowScoreBids = projects.filter(p => p.scores?.final < 60 && (p.outcome === 'won' || p.outcome === 'lost'));
            const lowScoreWins = lowScoreBids.filter(p => p.outcome === 'won').length;
            const lowScoreWinRate = lowScoreBids.length > 0 ? Math.round((lowScoreWins / lowScoreBids.length) * 100) : null;
            
            // Trigger warning if lots of low-score bids
            if (avgScore < 55 && recentBids.length >= 5) {
                return {
                    count: recentBids.length,
                    avgScore,
                    lowScoreWinRate,
                    period: '7 days'
                };
            }
            
            return null;
        }

        function extractProjectName(text) {
            // Try to find a project name pattern
            const patterns = [
                /project[:\s]+["']?([^"'\n]+)["']?/i,
                /(?:re|subject)[:\s]+([^\n]+)/i,
                /bid\s+(?:for|on)[:\s]+([^\n]+)/i
            ];
            for (const p of patterns) {
                const match = text.match(p);
                if (match && match[1].length > 3 && match[1].length < 100) {
                    return match[1].trim();
                }
            }
            return null;
        }

        function extractAddress(text) {
            // Try to find an address pattern
            const match = text.match(/(\d+\s+[A-Za-z0-9\s]+(?:Street|St|Avenue|Ave|Road|Rd|Boulevard|Blvd|Drive|Dr|Lane|Ln|Way|Court|Ct)[^,\n]*,?\s*[A-Za-z\s]+,?\s*[A-Z]{2}\s*\d{5})/i);
            return match ? match[1].trim() : null;
        }

        function extractField(text, pattern) {
            const match = text.match(pattern);
            return match ? match[1].trim() : null;
        }

        async function calculateScores(extracted, settings, goodFound, badFound, tradesFound, contractRisks = null, tradeDetection = null) {
            const components = {};
            let weights = { ...settings.weights };

            if (!settings.locationMatters) {
                const lw = weights.location;
                const other = weights.keywords + weights.gc + weights.trade;
                if (other > 0) {
                    weights.keywords = Math.round(weights.keywords + lw * weights.keywords / other);
                    weights.gc = Math.round(weights.gc + lw * weights.gc / other);
                    weights.trade = Math.round(weights.trade + lw * weights.trade / other);
                }
                weights.location = 0;
            }

            // Location
            components.location = { score: 50, weight: weights.location, reason: '', needsAddress: false };
            if (settings.locationMatters && settings.city && settings.state) {
                // Build user address with progressive fallback options
                const userAddresses = [];
                if (settings.street && settings.city && settings.state && settings.zip) {
                    userAddresses.push(`${settings.street}, ${settings.city}, ${settings.state} ${settings.zip}`);
                }
                if (settings.street && settings.city && settings.state) {
                    userAddresses.push(`${settings.street}, ${settings.city}, ${settings.state}`);
                }
                if (settings.city && settings.state && settings.zip) {
                    userAddresses.push(`${settings.city}, ${settings.state} ${settings.zip}`);
                }
                userAddresses.push(`${settings.city}, ${settings.state}`);

                console.log('🗺️ Geocoding user office with fallbacks:', userAddresses);

                let userCoords = null;
                for (let i = 0; i < userAddresses.length && !userCoords; i++) {
                    console.log(`  Attempt ${i+1}/${userAddresses.length}: "${userAddresses[i]}"`);
                    userCoords = await geocode(userAddresses[i]);
                    if (userCoords) {
                        console.log(`  ✅ Geocoded successfully`);
                        break;
                    }
                }

                if (!userCoords) {
                    console.error('❌ Failed to geocode user office after all attempts');
                    components.location.reason = `Could not locate your office. Please update your full address (including street) in Settings for accurate distance calculations.`;
                    components.location.score = 50;
                } else {
                    console.log('✅ User office coordinates:', userCoords);

                    // Handle both old and new field names
                    const projCity = extracted.city || extracted.project_city;
                    const projState = extracted.state || extracted.project_state;
                    const projAddr = extracted.project_address || (projCity && projState ? `${projCity}, ${projState}` : null);

                    if (!projAddr && !projCity) {
                        console.warn('⚠️ No project location found in documents');
                        components.location.reason = 'Project location not found in documents - enter manually below';
                        components.location.needsAddress = true;
                    } else {
                        // Try geocoding with progressive fallbacks
                        const projAddrToGeocode = projAddr || `${projCity}, ${projState}`;
                        console.log('🗺️ Geocoding project location:', projAddrToGeocode);
                        console.log('🗺️ Fallback city/state:', projCity, '/', projState);
                        const projCoords = await geocode(projAddrToGeocode, projCity, projState);

                        if (!projCoords) {
                            // FIX BUG 2: If cities match or are in same metro, estimate distance
                            const userCityLower = settings.city?.toLowerCase().trim();
                            const projCityLower = projCity?.toLowerCase().trim();

                            // Kansas City metro area cities
                            const kcMetro = ['kansas city', 'overland park', 'lenexa', 'olathe', 'shawnee',
                                           'leawood', 'prairie village', 'mission', 'merriam', 'independence'];

                            const userInKC = kcMetro.some(city => userCityLower?.includes(city));
                            const projInKC = kcMetro.some(city => projCityLower?.includes(city));

                            if (userCityLower && projCityLower && userCityLower === projCityLower) {
                                console.log('✅ Cities match exactly - estimating ~5 miles distance');
                                const dist = 5;
                                let score = 95; // High score for same city
                                components.location = {
                                    score,
                                    weight: weights.location,
                                    reason: `~${dist} miles (same city: ${projCity})`,
                                    details: { dist, estimated: true }
                                };
                            } else if (userInKC && projInKC) {
                                console.log('✅ Both in Kansas City metro area - estimating ~15 miles');
                                const dist = 15;
                                let score = 90; // High score for same metro
                                components.location = {
                                    score,
                                    weight: weights.location,
                                    reason: `~${dist} miles (Kansas City metro area)`,
                                    details: { dist, estimated: true }
                                };
                            } else {
                                console.error('❌ Failed to geocode project location:', projAddrToGeocode);
                                components.location.reason = `Could not locate "${projCity || projAddrToGeocode}" - try entering full address manually below`;
                                components.location.needsAddress = true;
                            }
                        } else {
                            console.log('✅ Project coordinates:', projCoords);
                            console.log('📍 User office:', userCoords);
                            console.log('📍 Project location:', projCoords);
                            console.log('🗺️ Geocoded addresses:', {
                                userAddress: `${settings.city}, ${settings.state}`,
                                projectAddress: projAddrToGeocode
                            });

                            const dist = Math.round(haversine(userCoords.lat, userCoords.lon, projCoords.lat, projCoords.lon));
                            console.log('📏📏📏 DISTANCE CALCULATED:', dist, 'miles');
                            console.log('📍 User office:', userCoords.display_name || `${userCoords.lat}, ${userCoords.lon}`);
                            console.log('📍 Project location:', projCoords.display_name);
                            console.log('🗺️ Geocoding method:', projCoords.method || 'api');

                            // Sanity check: If distance seems wrong (e.g., > 200 miles for nearby cities), warn
                            let locationWarning = null;
                            if (dist > 200 && settings.state === extracted.project_state) {
                                console.error('🚨 GEOCODING ERROR DETECTED:', {
                                    calculated_distance: dist,
                                    both_in_same_state: settings.state,
                                    user_coords: userCoords,
                                    project_coords: projCoords,
                                    geocoded_to: projCoords.display_name,
                                    message: 'Distance seems VERY wrong - geocoding found wrong location!'
                                });
                                locationWarning = `⚠️ WARNING: ${dist} miles seems incorrect for same-state project. Geocoded to: ${projCoords.display_name}. Please verify project location.`;

                                // Show user-facing warning banner
                                showBanner(`⚠️ Distance (${dist} mi) seems wrong for ${extracted.project_city}, ${extracted.project_state}. Check if geocoding found the correct city!`, 'warning');
                            }

                            let score = dist <= 25 ? 100 : dist <= 50 ? 85 : dist <= 100 ? 70 : dist <= 150 ? 50 : 30;
                            if (dist > settings.radius) score = Math.max(10, score - 20);
                            components.location = {
                                score,
                                weight: weights.location,
                                reason: `${dist} miles from your office${dist > settings.radius ? ' (outside your service area)' : ''}${locationWarning ? '\n' + locationWarning : ''}`,
                                details: { dist, warning: locationWarning }
                            };
                        }
                    }
                }
            } else if (!settings.locationMatters) {
                components.location.reason = 'Location scoring disabled';
                components.location.score = 0;
            } else {
                components.location.reason = 'Set your office location in Settings tab';
                components.location.score = 50;
            }

            // Keywords & Contract Risk
            let kwScore = 50;
            const kwDetails = [];

            // Add points for good keywords found
            for (const item of goodFound) {
                kwScore += 8;
                kwDetails.push({
                    keyword: item.keyword,
                    type: 'good',
                    effect: '+8',
                    pages: item.pages,
                    locations: item.locations // Include filename info for multi-file support
                });
            }

            // Penalize if NO good keywords found - indicates poor match
            if (goodFound.length === 0) {
                kwScore = 30; // Drop to 30 if no keywords match
                kwDetails.push({
                    keyword: 'No matching keywords found',
                    type: 'warning',
                    effect: '-20',
                    pages: [],
                    locations: []
                });
            }

            // Subtract points for bad keywords found
            const penalty = settings.riskTolerance === 'low' ? 15 : settings.riskTolerance === 'medium' ? 10 : 5;
            if (extracted.has_contract_language) {
                for (const item of badFound) {
                    kwScore -= penalty;
                    kwDetails.push({
                        keyword: item.keyword,
                        type: 'bad',
                        effect: `-${penalty}`,
                        pages: item.pages,
                        locations: item.locations // Include filename info for multi-file support
                    });
                }
            }

            // Apply AI Contract Risk Detection penalty
            let aiRiskPenalty = 0;
            if (contractRisks && contractRisks.hasContractLanguage && contractRisks.risksDetected && contractRisks.risksDetected.length > 0) {
                aiRiskPenalty = calculateContractRiskPenalty(contractRisks, settings.riskTolerance);
                kwScore -= aiRiskPenalty;
            }

            kwScore = Math.max(0, Math.min(100, kwScore));
            const kwReason = `Found ${goodFound.length} good terms, ${badFound.length} risk terms${!extracted.has_contract_language ? ' (no contract language detected)' : ''}${aiRiskPenalty > 0 ? ` | AI detected ${contractRisks.risksDetected.length} contract risks (-${aiRiskPenalty})` : ''}`;
            components.keywords = { score: kwScore, weight: weights.keywords, reason: kwReason, details: kwDetails, hasContract: extracted.has_contract_language, aiRisks: contractRisks || null };

            // GC
            let gcScore = 50;
            const gcCount = selectedGCs.length;
            const compPenalty = gcCount <= 2 ? 0 : gcCount <= 5 ? 5 : gcCount <= 10 ? 10 : 15;
            let totalW = 0, weightedSum = 0, bestGC = null, bestRate = 0;

            console.log('🏢 GC Scoring Debug:', {
                gcCount: gcCount,
                compPenalty: compPenalty,
                selectedGCs: selectedGCs.map(gc => ({ name: gc.name, rating: gc.rating, bids: gc.bids, wins: gc.wins }))
            });

            for (const gc of selectedGCs) {
                // Use star rating if no wins yet, even if they have bids
                if (gc.bids > 0 && gc.wins > 0) {
                    const rate = (gc.wins / gc.bids) * 100;
                    weightedSum += rate * gc.bids;
                    totalW += gc.bids;
                    console.log(`  GC: ${gc.name} - Using win rate: ${rate}% (${gc.wins}/${gc.bids}), weight: ${gc.bids}`);
                    if (rate > bestRate || !bestGC) { bestRate = rate; bestGC = gc; }
                } else {
                    // Use star rating if no wins tracked yet
                    const ss = gc.rating * 20;
                    weightedSum += ss;
                    totalW += 1;
                    console.log(`  GC: ${gc.name} - Using rating: ${gc.rating}★ = ${ss} points (${gc.bids || 0} bids, ${gc.wins || 0} wins)`);
                    if (ss > bestRate || !bestGC) { bestRate = ss; bestGC = gc; }
                }
            }
            if (totalW > 0) gcScore = Math.round(weightedSum / totalW);
            gcScore = Math.max(0, gcScore - compPenalty);

            console.log('🏢 GC Score Result:', {
                weightedSum: weightedSum,
                totalW: totalW,
                rawScore: Math.round(weightedSum / totalW),
                finalScore: gcScore,
                bestGC: bestGC?.name
            });
            components.gc = { score: gcScore, weight: weights.gc, reason: `${gcCount} GC${gcCount > 1 ? 's' : ''} bidding${compPenalty ? ' (-' + compPenalty + ' competition penalty)' : ''}`, details: { gcCount, compPenalty, bestGC: bestGC ? { name: bestGC.name, rate: bestGC.bids > 0 ? Math.round(bestGC.wins / bestGC.bids * 100) : null, rating: bestGC.rating } : null } };

            // Trade/Product Match
            if (settings.companyType === 'subcontractor') {
                // Multi-signal trade match for subcontractors
                const tradeScore = settings.trades.length > 0 ? Math.round((tradesFound.length / settings.trades.length) * 100) : 50;

                // Generate reason text with signal information
                let reason = `Found ${tradesFound.length} of your ${settings.trades.length} trade divisions`;
                if (tradeDetection && tradeDetection.signals_used.length > 0) {
                    reason += ` using ${tradeDetection.signals_used.join(', ')}`;
                } else {
                    reason += ' in specs';
                }

                components.trade = {
                    score: tradeScore,
                    weight: weights.trade,
                    reason: reason,
                    details: {
                        found: tradesFound,
                        signals: tradeDetection?.signals_used || [],
                        confidence: tradeDetection?.highest_confidence || 0,
                        matches: tradeDetection?.matches || []
                    }
                };
            } else {
                // Product match for distributors and manufacturer reps
                // Note: This will be async in production, but we'll use a simplified sync version for now
                // In a real implementation, you'd call analyzeProductMatch() here
                const productLines = settings.productLines || [];
                const productCategories = settings.productCategories || [];

                if (productLines.length === 0) {
                    components.trade = {
                        score: 50,
                        weight: weights.trade,
                        reason: 'Add your product lines in Settings to enable product matching',
                        details: { status: 'not_configured' }
                    };
                } else {
                    // Placeholder: In production, this would be an async call to analyzeProductMatch
                    // For now, provide a default score
                    components.trade = {
                        score: 50,
                        weight: weights.trade,
                        reason: 'Product match analysis (configure API for full analysis)',
                        details: { status: 'pending', productLines, productCategories }
                    };
                }
            }

            // Final
            let final = 0;
            for (const k of ['location', 'keywords', 'gc', 'trade']) if (components[k].weight > 0) final += components[k].score * (components[k].weight / 100);
            final = Math.round(final);
            const rec = final >= 80 ? 'GO' : final >= 60 ? 'REVIEW' : 'PASS';
            return { final, recommendation: rec, components, weights };
        }

        async function renderResult(analysis, similarBid = null, volumeWarning = null, duplicateCheck = null) {
            const settings = await getSettings();
            const recClass = analysis.scores.recommendation.toLowerCase();
            const recText = { GO: 'Strong fit for your business', REVIEW: 'Mixed signals - review carefully', PASS: 'Poor fit based on your criteria' }[analysis.scores.recommendation];
            let capMsg = '';
            if (settings.capacity === 'aggressive' && analysis.scores.recommendation === 'REVIEW') capMsg = '<p style="margin-top:12px;padding:12px;background:var(--warning-bg);border-radius:var(--radius);font-size:13px;"><strong>🔴 You\'re hungry for work.</strong> Even though this has mixed signals, it might be worth pursuing.</p>';
            else if (settings.capacity === 'slow' && analysis.scores.recommendation !== 'GO') capMsg = '<p style="margin-top:12px;padding:12px;background:var(--info-bg);border-radius:var(--radius);font-size:13px;"><strong>🟡 You\'re at capacity.</strong> This isn\'t a strong fit - you can probably pass.</p>';

            // Similar bid warning
            let similarBidHtml = '';
            if (similarBid) {
                if (similarBid.type === 'gc') {
                    const reasonsList = similarBid.reasons.length > 0 ? '<ul style="margin:8px 0 0 20px;padding:0;">' + similarBid.reasons.map(r => `<li>${r}</li>`).join('') + '</ul>' : '';
                    similarBidHtml = `
                        <div style="margin-top:12px;padding:12px;background:rgba(251,191,36,0.15);border-radius:var(--radius);border-left:4px solid var(--warning);font-size:13px;">
                            <strong>⚠️ You've worked with ${similarBid.gcName} before</strong><br>
                            <span style="color:var(--text-secondary);">You ${similarBid.outcome === 'lost' ? 'lost' : similarBid.outcome === 'ghost' ? 'were ghosted on' : 'declined'} "${similarBid.projectName}" ${similarBid.timeAgo}${similarBid.score ? ' (score: ' + similarBid.score + ')' : ''}</span>
                            ${reasonsList}
                        </div>`;
                } else if (similarBid.type === 'location') {
                    similarBidHtml = `
                        <div style="margin-top:12px;padding:12px;background:rgba(251,191,36,0.1);border-radius:var(--radius);border-left:4px solid var(--warning);font-size:13px;">
                            <strong>📍 You've bid in ${similarBid.city} before</strong><br>
                            <span style="color:var(--text-secondary);">You ${similarBid.outcome === 'lost' ? 'lost' : 'were ghosted on'} "${similarBid.projectName}" ${similarBid.timeAgo}</span>
                        </div>`;
                }
            }
            
            // Duplicate project warning
            let duplicateHtml = '';
            if (duplicateCheck && duplicateCheck.isDuplicate) {
                const orig = duplicateCheck.originalProject;
                duplicateHtml = `
                    <div style="margin-top:12px;padding:12px;background:rgba(251,191,36,0.15);border-radius:var(--radius);border-left:4px solid var(--warning);font-size:13px;">
                        <strong>⚠️ Duplicate Project Detected</strong><br>
                        <span style="color:var(--text-secondary);">You analyzed "${orig.name}" ${orig.timeAgo}${orig.score ? ` (scored ${orig.score} - ${orig.recommendation})` : ''}.
                        <br><em>This appears to be the same project. Consider if circumstances have changed enough to re-analyze.</em></span>
                    </div>`;
            }

            // Volume guardrail warning
            let volumeHtml = '';
            if (volumeWarning) {
                volumeHtml = `
                    <div style="margin-top:12px;padding:12px;background:rgba(239,68,68,0.1);border-radius:var(--radius);border-left:4px solid var(--danger);font-size:13px;">
                        <strong>⚠️ Bid Volume Check</strong><br>
                        <span style="color:var(--text-secondary);">You've analyzed ${volumeWarning.count} bids in the last ${volumeWarning.period} with an average score of ${volumeWarning.avgScore}.
                        ${volumeWarning.lowScoreWinRate !== null ? `<br>Historically, you win only ${volumeWarning.lowScoreWinRate}% of bids under 60.` : ''}
                        <br><em>Consider being more selective to save estimating time.</em></span>
                    </div>`;
            }

            // Get project name - clean it up
            let projectName = analysis.extracted.project_name || 'Untitled Project';
            if (projectName.length > 60) projectName = projectName.substring(0, 60) + '...';
            
            // Get location string
            let locationStr = '';
            if (analysis.extracted.project_city || analysis.extracted.project_state) {
                locationStr = [analysis.extracted.project_city, analysis.extracted.project_state].filter(Boolean).join(', ');
            }

            // Display building type
            let buildingTypeHtml = '';
            if (analysis.buildingType && analysis.buildingType.type) {
                buildingTypeHtml = `
                    <div style="margin-top:12px;">
                        ${formatBuildingTypeForDisplay(analysis.buildingType)}
                    </div>`;
            }

            // Helper function to format contract risks for display
            function formatContractRisksForDisplay(contractRisks) {
                if (!contractRisks || !contractRisks.risksDetected || contractRisks.risksDetected.length === 0) {
                    return { hasRisks: false, html: '' };
                }

                const riskLabels = {
                    pay_if_paid: 'Pay-if-Paid',
                    liquidated_damages: 'Liquidated Damages',
                    indemnification: 'Broad Indemnification',
                    no_damages_delay: 'No Damages for Delay',
                    consequential_waiver: 'Consequential Waiver',
                    high_retainage: 'High Retainage',
                    slow_payment: 'Slow Payment',
                    termination_convenience: 'Termination for Convenience',
                    excessive_warranty: 'Excessive Warranty',
                    insurance_requirements: 'High Insurance'
                };

                const risksHtml = contractRisks.risksDetected.map(risk => {
                    const riskType = risk.type || 'Unknown Risk';
                    const riskLabel = riskLabels[riskType] || riskType;
                    const confidence = risk.confidence ? `${(risk.confidence * 100).toFixed(0)}% confidence` : '';
                    const level = risk.level || risk.severity || 'moderate';
                    const levelIcon = level === 'high' ? '🔴' : level === 'moderate' ? '⚪' : '🟡';

                    return `
                        <div style="margin-bottom: 8px; padding: 8px; background: var(--bg-secondary); border-radius: 6px;">
                            <div style="font-weight: 600; color: var(--text-primary);">
                                ${levelIcon} ${riskLabel}${confidence ? ` <span style="color: var(--text-muted); font-weight: 400;">(${confidence})</span>` : ''}
                            </div>
                            ${risk.context ? `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">"${risk.context}"</div>` : ''}
                        </div>
                    `;
                }).join('');

                const html = `
                    <div style="margin-top:12px;padding:12px;background:rgba(239,68,68,0.1);border-radius:var(--radius);border-left:4px solid var(--danger);">
                        <strong style="color:var(--danger);">⚠️ Contract Risks Detected</strong>
                        <div style="font-size: 13px; color: var(--text-secondary); margin: 8px 0 12px 0;">
                            These clauses may increase project risk. Review carefully before bidding.
                        </div>
                        ${risksHtml}
                    </div>
                `;

                return { hasRisks: true, html };
            }

            // Helper function to format building type for display
            function formatBuildingTypeForDisplay(buildingType) {
                if (!buildingType || !buildingType.type) return '';
                const confidence = buildingType.confidence ? ` (${(buildingType.confidence * 100).toFixed(0)}% confidence)` : '';
                return `<span style="color: var(--text-primary); font-weight: 500;">${buildingType.type}${confidence}</span>`;
            }

            // Display AI Contract Risks
            let contractRisksHtml = '';
            if (analysis.contractRisks && analysis.contractRisks.hasContractLanguage) {
                const risksDisplay = formatContractRisksForDisplay(analysis.contractRisks);
                if (risksDisplay.hasRisks) {
                    contractRisksHtml = risksDisplay.html;
                }
            }

            // Generate GC risk warnings
            let gcRiskHtml = '';
            const gcRisks = [];
            for (const gc of analysis.gcs) {
                if (gc.riskTags && gc.riskTags.length > 0) {
                    const tagLabels = {
                        slow_pay: '💰 Slow pay',
                        pay_if_paid: '📋 Pay-if-paid',
                        change_order_hostile: '⚠️ CO hostile',
                        bid_shopping: '🛒 Bid shopping',
                        low_feedback: '🔇 Low feedback',
                        scope_creep: '📈 Scope creep'
                    };
                    gcRisks.push({ name: gc.name, tags: gc.riskTags.map(t => tagLabels[t] || t) });
                }
            }
            if (gcRisks.length > 0) {
                gcRiskHtml = `
                    <div style="margin-top:12px;padding:12px;background:rgba(239,68,68,0.1);border-radius:var(--radius);border-left:4px solid var(--danger);font-size:13px;">
                        <strong>⚠️ GC Risk Tags</strong><br>
                        ${gcRisks.map(r => `<span style="color:var(--text-secondary);">${r.name}: ${r.tags.join(', ')}</span>`).join('<br>')}
                    </div>`;
            }

            document.getElementById('analysisResult').innerHTML = `
                <div class="score-report">
                    <div class="score-report-header">
                        <div class="score-report-value ${recClass}">${analysis.scores.final}</div>
                        <div class="score-report-rec">${analysis.scores.recommendation} — ${recText}</div>
                        <p style="color:var(--text-primary);margin-top:12px;font-size:16px;font-weight:600;">${projectName}</p>
                        ${locationStr ? `<p style="color:var(--text-muted);font-size:13px;">${locationStr}</p>` : ''}
                        ${buildingTypeHtml}
                        ${capMsg}
                        ${duplicateHtml}
                        ${similarBidHtml}
                        ${volumeHtml}
                        ${contractRisksHtml}
                        ${gcRiskHtml}
                    </div>
                    ${renderComponent('📍', 'Location Fit', analysis.scores.components.location)}
                    ${renderComponent('🔑', 'Keywords & Contract', analysis.scores.components.keywords)}
                    ${renderComponent('🏢', 'GC Relationship', analysis.scores.components.gc)}
                    ${renderComponent(settings.companyType === 'subcontractor' ? '🔧' : '📦', settings.companyType === 'subcontractor' ? 'Trade Match' : 'Product Match', analysis.scores.components.trade)}

                    ${renderExtractedDataSection(analysis.extracted, analysis.gcs)}

                    ${await renderAIInsights(analysis, settings)}

                    ${renderImprovementTips(analysis.scores)}
                    
                    <div class="manual-override" style="margin-top:20px;padding:16px;background:var(--bg-tertiary);border-radius:var(--radius);border:1px solid var(--border-color);">
                        <div style="font-weight:600;margin-bottom:12px;color:var(--text-primary);">📋 Do you agree with this recommendation?</div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:8px 12px;background:var(--bg-secondary);border-radius:var(--radius);border:2px solid transparent;" class="override-option">
                                <input type="radio" name="userAgreement" value="agree" checked style="accent-color:var(--success);"> 
                                <span>✓ Yes, agree</span>
                            </label>
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:8px 12px;background:var(--bg-secondary);border-radius:var(--radius);border:2px solid transparent;" class="override-option">
                                <input type="radio" name="userAgreement" value="too_high"> 
                                <span>↑ Score too high</span>
                            </label>
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:8px 12px;background:var(--bg-secondary);border-radius:var(--radius);border:2px solid transparent;" class="override-option">
                                <input type="radio" name="userAgreement" value="too_low"> 
                                <span>↓ Score too low</span>
                            </label>
                        </div>
                        <input type="text" class="form-input" id="overrideNote" placeholder="Optional: Why do you disagree? (helps improve scoring)" style="font-size:13px;">
                    </div>
                </div>
                <div style="display:flex;gap:12px;margin-top:20px;align-items:center;">
                    <button id="saveProjectBtn" class="btn btn-primary" onclick="saveProjectManually()" style="flex:1;">💾 Save to Projects</button>
                    <button class="btn btn-secondary" onclick="printReport()">🖨 Print Report</button>
                    <button class="btn btn-secondary" onclick="resetAnalysis()">Start Over</button>
                </div>
                <script>
                    // Add visual feedback for agreement radio buttons
                    setTimeout(() => {
                        document.querySelectorAll('input[name="userAgreement"]').forEach(radio => {
                            radio.addEventListener('change', function() {
                                document.querySelectorAll('.override-option').forEach(label => {
                                    label.style.borderColor = 'transparent';
                                    label.style.background = 'var(--bg-secondary)';
                                });
                                const selectedLabel = this.closest('.override-option');
                                if (selectedLabel) {
                                    selectedLabel.style.borderColor = 'var(--accent)';
                                    selectedLabel.style.background = 'var(--accent-dim)';
                                }
                            });
                        });
                        // Highlight the default checked option
                        const checkedRadio = document.querySelector('input[name="userAgreement"]:checked');
                        if (checkedRadio) {
                            const selectedLabel = checkedRadio.closest('.override-option');
                            if (selectedLabel) {
                                selectedLabel.style.borderColor = 'var(--accent)';
                                selectedLabel.style.background = 'var(--accent-dim)';
                            }
                        }
                    }, 100);
                <\/script>
            `;

            if (analysis.scores.components.location.needsAddress) {
                const loc = document.querySelector('.score-component');
                if (loc) loc.innerHTML += `<div class="address-prompt"><div class="address-prompt-title">📍 Enter project address for accurate distance</div><div class="address-prompt-row"><input type="text" class="form-input" id="manualAddress" placeholder="123 Main St, City, State"><button class="btn btn-primary btn-sm" onclick="recalcAddress()">Calculate</button></div></div>`;
            }
        }

        function renderExtractedDataSection(extracted, gcs) {
            // Format square footage with commas
            const formatSF = (sf) => {
                if (!sf) return 'Not found';
                const num = parseInt(sf);
                if (isNaN(num)) return 'Not found';
                return num.toLocaleString() + ' SF';
            };

            const buildingType = (typeof extracted.building_type === 'object' ? extracted.building_type?.type : extracted.building_type) || 'Not found';

            return `
                <div style="margin-top:20px;padding:16px;background:var(--bg-secondary);border-radius:var(--radius);border:1px solid var(--border-color);">
                    <div style="font-weight:600;margin-bottom:12px;color:var(--text-primary);">📄 Extracted Data</div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
                        <div>
                            <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">Project Name</div>
                            <div style="font-weight:500;font-size:14px;">${extracted.project_name || 'Not found'}</div>
                        </div>
                        <div>
                            <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">Building Type</div>
                            <div style="font-weight:500;font-size:14px;">${buildingType}</div>
                        </div>
                        <div>
                            <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">Location</div>
                            <div style="font-weight:500;font-size:14px;">${extracted.city || extracted.project_city || 'Unknown'}, ${extracted.state || extracted.project_state || '?'}</div>
                        </div>
                        <div>
                            <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">Building Size</div>
                            <div style="font-weight:500;font-size:14px;">${extracted.project_size_sf ? formatSF(extracted.project_size_sf) : 'Not found'}</div>
                        </div>
                        <div>
                            <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">Owner</div>
                            <div style="font-weight:500;font-size:14px;">${extracted.owner_name || 'Not found'}</div>
                        </div>
                        <div>
                            <div style="font-size:11px;color:var(--text-muted);margin-bottom:4px;">Architect</div>
                            <div style="font-weight:500;font-size:14px;">${extracted.architect_name || 'Not found'}</div>
                        </div>
                    </div>
                </div>

                <!-- General Contractors Bidding -->
                <div style="margin-top:20px;padding:16px;background:var(--bg-secondary);border-radius:var(--radius);border:1px solid var(--border-color);">
                    <div style="font-weight:600;margin-bottom:12px;color:var(--text-primary);">🏢 General Contractors Bidding</div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px;">
                        ${(gcs || []).map(gc => {
                            const winRate = gc.bids > 0 ? Math.round((gc.wins / gc.bids) * 100) : 0;
                            const stars = '★'.repeat(gc.rating) + '☆'.repeat(5 - gc.rating);
                            return `
                                <div style="padding:12px;background:var(--bg-primary);border-radius:8px;border:1px solid var(--border-color);">
                                    <div style="font-weight:600;font-size:14px;margin-bottom:4px;">${gc.name}</div>
                                    <div style="color:var(--accent);font-size:16px;margin-bottom:4px;">${stars}</div>
                                    <div style="font-size:12px;color:var(--text-muted);">
                                        ${gc.bids > 0 ? `${gc.wins} wins / ${gc.bids} bids (${winRate}%)` : 'No history yet'}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderComponent(icon, title, comp) {
            const fillClass = comp.score >= 70 ? 'high' : comp.score >= 50 ? 'medium' : 'low';
            let details = '';
            
            // Location details
            if (title === 'Location Fit' && comp.details?.dist !== undefined) {
                const dist = comp.details.dist;
                let explanation = '';
                if (dist <= 25) explanation = 'Excellent - very close to your office';
                else if (dist <= 50) explanation = 'Good - within easy driving distance';
                else if (dist <= 100) explanation = 'Moderate - may require extra travel planning';
                else if (dist <= 150) explanation = 'Far - significant travel required';
                else explanation = 'Very far - consider travel costs carefully';
                details = `<div class="score-component-details"><strong>This job is ${dist} miles from your office.</strong><br><span style="color:var(--text-muted)">${explanation}</span></div>`;
            } else if (title === 'Location Fit' && comp.needsAddress) {
                details = `<div class="score-component-details" style="color:var(--warning);">Could not determine project location from documents. Enter address below for accurate scoring.</div>`;
            } else if (title === 'Location Fit' && !comp.details?.dist) {
                details = `<div class="score-component-details" style="color:var(--text-muted);">${comp.reason}</div>`;
            }
            
            // Keywords details
            if (title === 'Keywords & Contract' && comp.details?.length > 0) {
                const good = comp.details.filter(d => d.type === 'good');
                const bad = comp.details.filter(d => d.type === 'bad');

                // Helper function to format page locations with filename support
                const formatLocations = (item) => {
                    if (item.locations && item.locations.length > 0) {
                        // New format with filename
                        const locs = item.locations.slice(0, 3); // Show first 3 locations
                        const uniqueFiles = [...new Set(locs.map(l => l.filename))];

                        if (uniqueFiles.length > 1) {
                            // Multiple files - show filename + page
                            return locs.map(l => {
                                const shortName = l.filename.length > 20 ? l.filename.substring(0, 17) + '...' : l.filename;
                                return `${shortName} p.${l.page}`;
                            }).join(', ');
                        } else {
                            // Single file - just show page numbers
                            return 'p.' + locs.map(l => l.page).join(',');
                        }
                    } else if (item.pages && item.pages.length > 0) {
                        // Legacy format - just pages
                        return 'p.' + item.pages.slice(0, 3).join(',');
                    }
                    return '';
                };

                details = '<div class="score-component-details">';
                if (good.length) {
                    details += '<div style="margin-bottom:6px;"><strong style="color:var(--success)">✓ Good terms found:</strong></div>';
                    details += good.map(d => {
                        const loc = formatLocations(d);
                        return `<span class="keyword-tag good">${d.keyword} (${d.effect}) ${loc}</span>`;
                    }).join('');
                }
                if (bad.length) {
                    details += '<div style="margin:8px 0 6px;"><strong style="color:var(--danger)">⚠ Risk terms found:</strong></div>';
                    details += bad.map(d => {
                        const loc = formatLocations(d);
                        return `<span class="keyword-tag bad">${d.keyword} (${d.effect}) ${loc}</span>`;
                    }).join('');
                }
                if (!comp.hasContract) details += '<p style="margin-top:10px;font-size:11px;color:var(--text-muted);">ℹ️ No contract language detected - risk terms not penalized</p>';
                details += '</div>';
            } else if (title === 'Keywords & Contract' && (!comp.details || comp.details.length === 0)) {
                details = `<div class="score-component-details" style="color:var(--text-muted);">No keywords found. Add keywords in the Keywords tab to track terms that matter to you.</div>`;
            }
            
            // GC details
            if (title === 'GC Relationship' && comp.details?.bestGC) {
                const b = comp.details.bestGC;
                // Show better messaging when no history exists
                let relationshipText = '';
                if (b.rate !== null) {
                    relationshipText = b.rate > 0 ? `(${b.rate}% win rate)` : `(No bid history yet)`;
                } else {
                    relationshipText = `(${b.rating}★ rating)`;
                }
                details = `<div class="score-component-details"><strong>Best relationship:</strong> ${b.name} ${relationshipText}${comp.details.compPenalty ? `<br><span style="color:var(--warning)">Competition penalty: -${comp.details.compPenalty} points (${comp.details.gcCount} GCs bidding)</span>` : ''}</div>`;
            }
            
            // Trade Match details (for subcontractors)
            if (title === 'Trade Match' && comp.details?.found) {
                const foundNames = comp.details.found.map(code => { const div = CSI_DIVISIONS.find(d => d[0] === code); return div ? `Div ${code} (${div[1]})` : `Div ${code}`; });
                details = `<div class="score-component-details"><strong>Found:</strong> ${foundNames.length > 0 ? foundNames.join(', ') : 'None of your divisions found in specs - verify this project includes your trade'}</div>`;
            }

            // Product Match details (for distributors/mfg reps)
            if (title === 'Product Match') {
                if (comp.details?.status === 'not_configured') {
                    details = `<div class="score-component-details" style="color:var(--text-muted);">Add your product lines in Settings to enable product matching.</div>`;
                } else if (comp.details?.status === 'pending') {
                    details = `<div class="score-component-details" style="color:var(--text-muted);">Tracking ${comp.details.productLines?.length || 0} product lines. Full AI analysis coming soon.</div>`;
                } else if (comp.details?.length > 0) {
                    // Display product match findings
                    const specified = comp.details.filter(d => d.status === 'specified');
                    const approvedEqual = comp.details.filter(d => d.status === 'approved_equal');
                    const orEqual = comp.details.filter(d => d.status === 'or_equal');
                    const competitor = comp.details.filter(d => d.status === 'competitor');

                    details = '<div class="score-component-details">';
                    if (specified.length > 0) {
                        details += '<div style="margin-bottom:6px;"><strong style="color:var(--success)">✅ YOUR PRODUCTS SPECIFIED:</strong></div>';
                        details += specified.map(d => `<span class="keyword-tag good">${d.product_line} - ${d.location || 'Found in specs'}</span>`).join('');
                    }
                    if (approvedEqual.length > 0) {
                        details += '<div style="margin:8px 0 6px;"><strong style="color:var(--success)">✅ APPROVED AS ALTERNATE:</strong></div>';
                        details += approvedEqual.map(d => `<span class="keyword-tag good">${d.product_line}</span>`).join('');
                    }
                    if (orEqual.length > 0) {
                        details += '<div style="margin:8px 0 6px;"><strong style="color:var(--warning)">⚠️ OR EQUAL OPPORTUNITY:</strong></div>';
                        details += `<span class="keyword-tag" style="background:var(--warning-bg);border-color:var(--warning);">Your products may qualify as approved equals</span>`;
                    }
                    if (competitor.length > 0) {
                        details += '<div style="margin:8px 0 6px;"><strong style="color:var(--danger)">❌ COMPETING BRANDS:</strong></div>';
                        details += competitor.map(d => `<span class="keyword-tag bad">${d.context || 'Competitor specified'}</span>`).join('');
                    }
                    details += '</div>';
                }
            }
            
            return `<div class="score-component"><div class="score-component-header"><div class="score-component-title">${icon} ${title} <span style="color:var(--text-muted);font-size:11px;font-weight:normal;">(${comp.weight}% weight)</span></div><div class="score-component-value">${comp.score}/100</div></div><div class="score-component-bar"><div class="score-component-fill ${fillClass}" style="width:${comp.score}%"></div></div><div class="score-component-reason">${comp.reason}</div>${details}</div>`;
        }

        // Generate improvement tips based on scores
        async function renderAIInsights(analysis, settings) {
            // Generate AI Analysis Summary (plain English)
            const buildingType = analysis.buildingType?.type || (typeof analysis.extracted.building_type === 'object' ? analysis.extracted.building_type?.type : analysis.extracted.building_type) || 'Not specified';
            const distance = analysis.scores.components.location.details?.dist || 'an unknown distance';

            const summaryParts = [];
            summaryParts.push(`This ${buildingType.toLowerCase()} project is located ${distance} miles from your office.`);

            if (analysis.scores.components.location.score >= 80) {
                summaryParts.push('The location is within your preferred service area.');
            } else if (analysis.scores.components.location.score >= 60) {
                summaryParts.push('The location is at the edge of your service area.');
            } else {
                summaryParts.push('The location may be outside your typical service area.');
            }

            const goodKeywords = (analysis.goodFound || []).length;
            if (goodKeywords > 0) {
                summaryParts.push(`We found ${goodKeywords} favorable term${goodKeywords !== 1 ? 's' : ''} in the bid documents.`);
            }

            const riskKeywords = (analysis.contractRisks?.risksDetected || []).length;
            if (riskKeywords > 0) {
                summaryParts.push(`However, ${riskKeywords} contract risk${riskKeywords !== 1 ? 's were' : ' was'} identified that may impact your decision.`);
            }

            if (analysis.gcs && analysis.gcs.length > 0) {
                const knownGCs = analysis.gcs.filter(gc => gc.rating >= 3);
                if (knownGCs.length > 0) {
                    summaryParts.push(`You have good relationships with ${knownGCs.length} of the ${analysis.gcs.length} general contractor${analysis.gcs.length !== 1 ? 's' : ''} bidding.`);
                } else {
                    summaryParts.push(`You have limited history with the ${analysis.gcs.length} general contractor${analysis.gcs.length !== 1 ? 's' : ''} on this project.`);
                }
            }

            const aiSummary = summaryParts.join(' ');

            return `
                <div style="margin-top: 20px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border-left: 4px solid var(--accent);">
                    <h4 style="margin: 0 0 12px 0; font-size: 15px; font-weight: 600; color: var(--text-primary);">📊 AI Analysis Summary</h4>
                    <p style="margin: 0; font-size: 14px; line-height: 1.6; color: var(--text-secondary);">${aiSummary}</p>
                </div>
            `;
        }

        function renderImprovementTips(scores) {
            const tips = [];
            const c = scores.components;
            
            // Location tips
            if (c.location.score < 70 && c.location.weight > 0) {
                if (c.location.details?.dist > 100) {
                    tips.push('📍 <strong>Location:</strong> This project is far from your office. Consider if travel costs are worth it, or focus on closer opportunities.');
                } else if (c.location.needsAddress) {
                    tips.push('📍 <strong>Location:</strong> Enter the project address above to get an accurate distance score.');
                }
            }
            
            // Keywords tips
            if (c.keywords.score < 60) {
                if (c.keywords.details?.badCount > 0) {
                    tips.push('🔑 <strong>Contract Risk:</strong> Review the flagged contract terms carefully. Consider negotiating these clauses before signing.');
                }
                if (c.keywords.details?.goodCount === 0) {
                    tips.push('🔑 <strong>Keywords:</strong> None of your preferred terms were found. Add more "good keywords" in Settings to better identify ideal projects.');
                }
            }
            
            // GC tips
            if (c.gc.score < 60) {
                if (c.gc.details?.gcCount > 5) {
                    tips.push('🏢 <strong>Competition:</strong> ' + c.gc.details.gcCount + ' GCs bidding creates price pressure. Focus on negotiated or invited bids for better margins.');
                }
                if (c.gc.details?.bestGC && c.gc.details.bestGC.rate !== null && c.gc.details.bestGC.rate < 20) {
                    tips.push('🏢 <strong>GC History:</strong> Your win rate with ' + c.gc.details.bestGC.name + ' is low. Consider building the relationship before bidding more work.');
                }
                if (!c.gc.details?.bestGC || c.gc.details.bestGC.rating <= 2) {
                    tips.push('🏢 <strong>GC Relationship:</strong> You have no strong relationship with these GCs. Research their reputation before investing time.');
                }
            }
            
            // Trade/Product Match tips
            if (c.trade.score < 70) {
                if (c.trade.details?.found !== undefined) {
                    // Subcontractor trade match
                    tips.push('🔧 <strong>Trade Match:</strong> Not all your divisions were found in specs. Verify your scope is actually included before bidding.');
                } else if (c.trade.details?.status === 'not_configured') {
                    // Product lines not configured
                    tips.push('📦 <strong>Product Match:</strong> Add your product lines in Settings to track when your brands are specified.');
                } else {
                    // Product match for distributors/mfg reps
                    tips.push('📦 <strong>Product Match:</strong> Your products have limited presence in these specs. Review if you have alternatives to offer.');
                }
            }
            
            if (tips.length === 0) {
                if (scores.final >= 80) {
                    return '<div class="improvement-tips" style="margin-top:16px;padding:16px;background:rgba(34,197,94,0.1);border-radius:var(--radius);border-left:4px solid var(--success);"><div style="font-weight:600;color:var(--success);margin-bottom:8px;">✓ Strong Opportunity</div><p style="color:var(--text-secondary);font-size:13px;margin:0;">This bid aligns well with your business. Prioritize it and submit a competitive price.</p></div>';
                }
                return '';
            }
            
            return `<div class="improvement-tips" style="margin-top:16px;padding:16px;background:var(--bg-tertiary);border-radius:var(--radius);border-left:4px solid var(--accent);">
                <div style="font-weight:600;color:var(--text-primary);margin-bottom:12px;">💡 How to Improve Your Chances</div>
                <ul style="margin:0;padding-left:20px;color:var(--text-secondary);font-size:13px;line-height:1.8;">
                    ${tips.map(t => '<li>' + t + '</li>').join('')}
                </ul>
            </div>`;
        }

        // Print report
        async function printReport() {
            // Use currentReportProject if viewing a saved report, otherwise use currentAnalysis
            const a = window.currentReportProject || currentAnalysis;
            if (!a) return;

            // Get user company info
            const settings = await getSettings();
            const companyName = currentUser?.user_metadata?.company_name || settings.company_name || 'Your Company';

            // Dynamic trade/product match labels
            const tradeIcon = settings.companyType === 'subcontractor' ? '🔧' : '📦';
            const tradeLabel = settings.companyType === 'subcontractor' ? 'Trade Match' : 'Product Match';

            // Generate report ID
            const reportId = `BR-${Date.now().toString(36).toUpperCase()}`;
            const reportDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Clean project location
            const location = [a.extracted.project_city, a.extracted.project_state].filter(Boolean).join(', ') || 'Location TBD';

            // Building type - handle both object and string formats
            let buildingType, buildingIcon;
            if (typeof a.buildingType === 'object' && a.buildingType !== null) {
                buildingType = a.buildingType.label || a.buildingType.type || 'Not specified';
                buildingIcon = a.buildingType.icon || '🏗️';
            } else if (typeof a.buildingType === 'string') {
                buildingType = a.buildingType.charAt(0).toUpperCase() + a.buildingType.slice(1);
                buildingIcon = '🏗️';
            } else {
                buildingType = 'Not specified';
                buildingIcon = '🏗️';
            }

            // Bid deadline
            const deadline = a.extracted.bid_deadline || 'Not specified';

            // Score color and badge
            const scoreColor = a.scores.recommendation === 'GO' ? '#22c55e' : a.scores.recommendation === 'REVIEW' ? '#f59e0b' : '#ef4444';
            const badgeText = { GO: 'STRONG FIT', REVIEW: 'REVIEW CAREFULLY', PASS: 'WEAK FIT' }[a.scores.recommendation];
            const badgeBg = { GO: '#dcfce7', REVIEW: '#fef3c7', PASS: '#fee2e2' }[a.scores.recommendation];

            // Good keywords
            const goodKeywords = (a.goodFound || []).map(k => k.keyword).filter(Boolean);

            // Risk keywords from contract risks
            const riskKeywords = (a.contractRisks?.risksDetected || []).map(r => {
                const labels = {
                    pay_if_paid: 'Pay-if-Paid',
                    liquidated_damages: 'Liquidated Damages',
                    indemnification: 'Broad Indemnification',
                    no_damages_delay: 'No Damages for Delay',
                    consequential_waiver: 'Consequential Waiver',
                    high_retainage: 'High Retainage',
                    slow_payment: 'Slow Payment',
                    termination_convenience: 'Termination for Convenience',
                    excessive_warranty: 'Excessive Warranty',
                    insurance_requirements: 'High Insurance'
                };
                return labels[r.type] || r.type;
            });

            // AI Analysis Summary (plain English)
            const summaryParts = [];
            summaryParts.push(`This ${buildingType.toLowerCase()} project is located ${a.scores.components.location.details?.dist || 'an unknown distance'} miles from your office.`);
            if (a.scores.components.location.score >= 80) {
                summaryParts.push('The location is within your preferred service area.');
            } else if (a.scores.components.location.score >= 60) {
                summaryParts.push('The location is at the edge of your service area.');
            } else {
                summaryParts.push('The location may be outside your typical service area.');
            }

            if (goodKeywords.length > 0) {
                summaryParts.push(`We found ${goodKeywords.length} favorable term${goodKeywords.length !== 1 ? 's' : ''} in the bid documents.`);
            }

            if (riskKeywords.length > 0) {
                summaryParts.push(`However, ${riskKeywords.length} contract risk${riskKeywords.length !== 1 ? 's were' : ' was'} identified that may impact your decision.`);
            }

            if (a.gcs && a.gcs.length > 0) {
                const knownGCs = a.gcs.filter(gc => gc.rating >= 3);
                if (knownGCs.length > 0) {
                    summaryParts.push(`You have good relationships with ${knownGCs.length} of the ${a.gcs.length} general contractor${a.gcs.length !== 1 ? 's' : ''} bidding.`);
                } else {
                    summaryParts.push(`You have limited history with the ${a.gcs.length} general contractor${a.gcs.length !== 1 ? 's' : ''} on this project.`);
                }
            }

            const aiSummary = summaryParts.join(' ');

            // How to Improve Your Chances
            const improvements = [];
            if (a.scores.components.location.score < 80) {
                improvements.push('Consider factoring in travel time and logistics costs for this location.');
            }
            if (a.scores.components.gc.score < 70) {
                improvements.push('Reach out to the GCs early to build rapport and clarify scope questions.');
            }
            if (riskKeywords.length > 0) {
                improvements.push('Have your attorney review the contract terms, especially the identified risk clauses.');
            }
            if (a.scores.components.keywords.score < 70) {
                improvements.push('Request clarification on any ambiguous scope items before submitting your bid.');
            }
            if (a.scores.components.trade.score < 80) {
                improvements.push('Highlight your relevant experience in similar projects to strengthen your bid.');
            }
            if (improvements.length === 0) {
                improvements.push('Your profile is a strong match. Submit a competitive price and emphasize your reliability.');
                improvements.push('Follow up with the GC after submission to demonstrate your interest.');
            }

            const printContent = `
                <html>
                <head>
                    <title>BidIntell Report - ${a.extracted.project_name || 'Bid Analysis'}</title>
                    <style>
                        @media print {
                            @page { margin: 0.5in; size: letter; }
                            body { padding: 0; }
                            .no-print { display: none; }
                            .page-break { page-break-before: always; }
                        }
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            background: #fff;
                            color: #333;
                            line-height: 1.6;
                            padding: 40px;
                            max-width: 850px;
                            margin: 0 auto;
                        }

                        /* Header */
                        .report-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding-bottom: 20px;
                            border-bottom: 3px solid #3b82f6;
                            margin-bottom: 30px;
                        }
                        .company-logo {
                            font-size: 24px;
                            font-weight: 800;
                            color: #3b82f6;
                        }
                        .report-meta {
                            text-align: right;
                            font-size: 12px;
                            color: #666;
                        }
                        .report-meta strong {
                            display: block;
                            font-size: 14px;
                            color: #333;
                            margin-bottom: 4px;
                        }

                        /* Title */
                        .report-title {
                            text-align: center;
                            margin-bottom: 30px;
                        }
                        .report-title h1 {
                            font-size: 28px;
                            color: #1a1a1a;
                            margin-bottom: 8px;
                        }
                        .report-title .subtitle {
                            font-size: 14px;
                            color: #666;
                        }

                        /* Project Summary Box */
                        .project-summary {
                            background: #f8f9fa;
                            border: 1px solid #e0e0e0;
                            border-radius: 8px;
                            padding: 20px;
                            margin-bottom: 24px;
                        }
                        .project-summary h2 {
                            font-size: 20px;
                            margin-bottom: 16px;
                            color: #1a1a1a;
                        }
                        .summary-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 12px;
                        }
                        .summary-item {
                            display: flex;
                            align-items: baseline;
                        }
                        .summary-label {
                            font-weight: 600;
                            font-size: 13px;
                            color: #555;
                            margin-right: 8px;
                        }
                        .summary-value {
                            font-size: 13px;
                            color: #333;
                        }

                        /* BidIndex Score */
                        .bidindex-section {
                            text-align: center;
                            background: linear-gradient(135deg, #f0f7ff, #e6f2ff);
                            border: 2px solid #3b82f6;
                            border-radius: 12px;
                            padding: 30px;
                            margin-bottom: 24px;
                        }
                        .bidindex-label {
                            font-size: 16px;
                            color: #555;
                            margin-bottom: 8px;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                            font-weight: 600;
                        }
                        .bidindex-score {
                            font-size: 72px;
                            font-weight: 800;
                            line-height: 1;
                            color: ${scoreColor};
                            margin-bottom: 12px;
                        }
                        .bidindex-badge {
                            display: inline-block;
                            background: ${badgeBg};
                            color: ${scoreColor};
                            font-size: 16px;
                            font-weight: 700;
                            padding: 8px 20px;
                            border-radius: 20px;
                            margin-top: 8px;
                        }

                        /* Score Breakdown Table */
                        .score-breakdown {
                            margin-bottom: 24px;
                        }
                        .score-breakdown h3 {
                            font-size: 16px;
                            margin-bottom: 12px;
                            color: #1a1a1a;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            background: #fff;
                            border: 1px solid #e0e0e0;
                            border-radius: 8px;
                            overflow: hidden;
                        }
                        thead {
                            background: #f8f9fa;
                        }
                        th {
                            text-align: left;
                            padding: 12px;
                            font-size: 13px;
                            font-weight: 600;
                            color: #555;
                            border-bottom: 2px solid #e0e0e0;
                        }
                        td {
                            padding: 12px;
                            font-size: 13px;
                            border-bottom: 1px solid #f0f0f0;
                        }
                        tbody tr:last-child td {
                            border-bottom: none;
                        }
                        .score-cell {
                            font-weight: 700;
                            font-size: 16px;
                            text-align: center;
                        }
                        .weight-cell {
                            text-align: center;
                            color: #666;
                        }

                        /* Keywords Section */
                        .keywords-section {
                            margin-bottom: 24px;
                        }
                        .keywords-section h3 {
                            font-size: 16px;
                            margin-bottom: 12px;
                            color: #1a1a1a;
                        }
                        .keywords-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 16px;
                        }
                        .keywords-box {
                            background: #fff;
                            border: 1px solid #e0e0e0;
                            border-radius: 8px;
                            padding: 16px;
                        }
                        .keywords-box.good {
                            border-left: 4px solid #22c55e;
                        }
                        .keywords-box.risk {
                            border-left: 4px solid #ef4444;
                        }
                        .keywords-title {
                            font-weight: 600;
                            font-size: 13px;
                            margin-bottom: 8px;
                            color: #333;
                        }
                        .keyword-tag {
                            display: inline-block;
                            background: #f0f0f0;
                            padding: 4px 10px;
                            border-radius: 4px;
                            font-size: 12px;
                            margin: 4px 4px 4px 0;
                        }
                        .keyword-tag.good {
                            background: #dcfce7;
                            color: #166534;
                        }
                        .keyword-tag.risk {
                            background: #fee2e2;
                            color: #991b1b;
                        }

                        /* AI Summary */
                        .ai-summary {
                            background: #f8f9fa;
                            border-left: 4px solid #3b82f6;
                            padding: 16px;
                            margin-bottom: 24px;
                            border-radius: 4px;
                        }
                        .ai-summary h3 {
                            font-size: 16px;
                            margin-bottom: 8px;
                            color: #1a1a1a;
                        }
                        .ai-summary p {
                            font-size: 14px;
                            line-height: 1.7;
                            color: #555;
                        }

                        /* Improvements */
                        .improvements {
                            background: #fff;
                            border: 1px solid #e0e0e0;
                            border-radius: 8px;
                            padding: 20px;
                            margin-bottom: 24px;
                        }
                        .improvements h3 {
                            font-size: 16px;
                            margin-bottom: 12px;
                            color: #1a1a1a;
                        }
                        .improvements ul {
                            list-style: none;
                            padding-left: 0;
                        }
                        .improvements li {
                            padding: 8px 0 8px 28px;
                            position: relative;
                            font-size: 13px;
                            line-height: 1.6;
                            color: #555;
                        }
                        .improvements li:before {
                            content: '✓';
                            position: absolute;
                            left: 0;
                            color: #22c55e;
                            font-weight: 700;
                            font-size: 16px;
                        }

                        /* Footer */
                        .report-footer {
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 1px solid #e0e0e0;
                            text-align: center;
                            font-size: 11px;
                            color: #999;
                        }
                        .report-footer .company-name {
                            font-weight: 600;
                            color: #3b82f6;
                            margin-bottom: 4px;
                        }
                    </style>
                </head>
                <body>
                    <!-- Header -->
                    <div class="report-header">
                        <div class="company-logo">${companyName}</div>
                        <div class="report-meta">
                            <strong>Report ID: ${reportId}</strong>
                            ${reportDate}
                        </div>
                    </div>

                    <!-- Title -->
                    <div class="report-title">
                        <h1>BidIntell Analysis Report</h1>
                        <div class="subtitle">AI-Powered Bid Evaluation</div>
                    </div>

                    <!-- Project Summary -->
                    <div class="project-summary">
                        <h2>${a.extracted.project_name || 'Untitled Project'}</h2>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <span class="summary-label">Location:</span>
                                <span class="summary-value">${location}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Building Type:</span>
                                <span class="summary-value">${buildingIcon} ${buildingType}</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">GCs Bidding:</span>
                                <span class="summary-value">${a.gcs?.length || 0}</span>
                            </div>
                        </div>
                    </div>

                    <!-- BidIndex Score -->
                    <div class="bidindex-section">
                        <div class="bidindex-label">BidIndex Score</div>
                        <div class="bidindex-score">${a.scores.final}</div>
                        <div class="bidindex-badge">${badgeText}</div>
                    </div>

                    <!-- Score Breakdown -->
                    <div class="score-breakdown">
                        <h3>Score Breakdown</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Component</th>
                                    <th style="text-align:center;">Weight</th>
                                    <th style="text-align:center;">Score</th>
                                    <th>Analysis</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>📍 Location Fit</td>
                                    <td class="weight-cell">${a.scores.components.location.weight}%</td>
                                    <td class="score-cell">${a.scores.components.location.score}</td>
                                    <td>${a.scores.components.location.reason}</td>
                                </tr>
                                <tr>
                                    <td>🔑 Keywords & Contract</td>
                                    <td class="weight-cell">${a.scores.components.keywords.weight}%</td>
                                    <td class="score-cell">${a.scores.components.keywords.score}</td>
                                    <td>${a.scores.components.keywords.reason}</td>
                                </tr>
                                <tr>
                                    <td>🏢 GC Relationship</td>
                                    <td class="weight-cell">${a.scores.components.gc.weight}%</td>
                                    <td class="score-cell">${a.scores.components.gc.score}</td>
                                    <td>${a.scores.components.gc.reason}</td>
                                </tr>
                                <tr>
                                    <td>${tradeIcon} ${tradeLabel}</td>
                                    <td class="weight-cell">${a.scores.components.trade.weight}%</td>
                                    <td class="score-cell">${a.scores.components.trade.score}</td>
                                    <td>${a.scores.components.trade.reason}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Keywords Found -->
                    <div class="keywords-section">
                        <h3>Keywords Detected</h3>
                        <div class="keywords-grid">
                            <div class="keywords-box good">
                                <div class="keywords-title">✓ Favorable Terms (${goodKeywords.length})</div>
                                ${goodKeywords.length > 0 ?
                                    goodKeywords.map(kw => `<span class="keyword-tag good">${kw}</span>`).join('') :
                                    '<span style="font-size:12px;color:#999;">None detected</span>'
                                }
                            </div>
                            <div class="keywords-box risk">
                                <div class="keywords-title">⚠ Risk Terms (${riskKeywords.length})</div>
                                ${riskKeywords.length > 0 ?
                                    riskKeywords.map(kw => `<span class="keyword-tag risk">${kw}</span>`).join('') :
                                    '<span style="font-size:12px;color:#999;">None detected</span>'
                                }
                            </div>
                        </div>
                    </div>

                    <!-- AI Analysis Summary -->
                    <div class="ai-summary">
                        <h3>AI Analysis Summary</h3>
                        <p>${aiSummary}</p>
                    </div>

                    <!-- How to Improve -->
                    <div class="improvements">
                        <h3>How to Improve Your Chances</h3>
                        <ul>
                            ${improvements.map(tip => `<li>${tip}</li>`).join('')}
                        </ul>
                    </div>

                    <!-- Footer -->
                    <div class="report-footer">
                        <div class="company-name">${companyName}</div>
                        <div>Powered by BidIntell™ | Generated ${new Date().toLocaleString()}</div>
                        <div>Report ID: ${reportId} | ${a.files?.length || 0} document${(a.files?.length || 0) !== 1 ? 's' : ''} analyzed</div>
                    </div>
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        async function recalcAddress() {
            const addr = document.getElementById('manualAddress')?.value.trim();
            if (!addr) return;
            const settings = await getSettings();
            const userCoords = await geocode(`${settings.city}, ${settings.state}`);
            const projCoords = await geocode(addr);
            if (userCoords && projCoords) {
                const dist = Math.round(haversine(userCoords.lat, userCoords.lon, projCoords.lat, projCoords.lon));
                let score = dist <= 25 ? 100 : dist <= 50 ? 85 : dist <= 100 ? 70 : dist <= 150 ? 50 : 30;
                if (dist > settings.radius) score = Math.max(10, score - 20);
                currentAnalysis.scores.components.location = { score, weight: currentAnalysis.scores.components.location.weight, reason: `${dist} miles from your office${dist > settings.radius ? ' (outside service area)' : ''}`, details: { dist } };
                let final = 0;
                for (const k of ['location', 'keywords', 'gc', 'trade']) { const c = currentAnalysis.scores.components[k]; if (c.weight > 0) final += c.score * (c.weight / 100); }
                currentAnalysis.scores.final = Math.round(final);
                currentAnalysis.scores.recommendation = final >= 80 ? 'GO' : final >= 60 ? 'REVIEW' : 'PASS';
                currentAnalysis.extracted.project_address = addr;
                renderResult(currentAnalysis);
            } else alert('Could not geocode that address. Try a different format.');
        }

        async function saveProjectToDb() {
            if (!currentAnalysis) return;

            // Check if user is authenticated
            if (!supabaseClient || !currentUser) {
                alert('❌ Not logged in. Please sign in to save projects.');
                return;
            }

            // Capture user feedback
            const agreement = document.querySelector('input[name="userAgreement"]:checked')?.value || 'agree';
            const overrideNote = document.getElementById('overrideNote')?.value?.trim() || null;

            currentAnalysis.userFeedback = {
                agreement,
                note: overrideNote,
                timestamp: new Date().toISOString()
            };

            // Show saving indicator
            const saveBtn = event.target;
            const originalText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '💾 Saving...';

            try {
                // Save project to database
                const savedProject = await saveProject({ ...currentAnalysis, outcome: 'pending' });

                if (!savedProject || !savedProject.id) {
                    throw new Error('Failed to save project - no ID returned');
                }

                console.log('✅ Project saved:', savedProject.id);

                // Update GC bid counts
                const gcs = await getGCs();
                for (const sg of currentAnalysis.gcs) {
                    const gc = gcs.find(g => g.name === sg.name);
                    if (gc) {
                        gc.bids = (gc.bids || 0) + 1;
                        await saveGC(gc);
                    }
                }

                // Show success message
                saveBtn.innerHTML = '✅ Saved!';
                setTimeout(() => {
                    resetAnalysis();
                    switchTab('projects');
                    loadAll();
                }, 1000);

            } catch (error) {
                console.error('❌ Save failed:', error);
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
                alert('Failed to save project: ' + error.message + '\n\nCheck browser console for details.');
            }
        }

        async function resetAnalysis() {
            uploadedFiles = []; selectedGCs = []; currentAnalysis = null;
            document.getElementById('fileList').innerHTML = '';
            document.getElementById('selectedGCsList').innerHTML = '';
            document.getElementById('competitionIndicator').innerHTML = '';
            document.getElementById('analysisResult').innerHTML = '';
            document.getElementById('gcSearchInput').value = '';
            fileInput.value = '';
            updateAnalyzeBtn();
            await renderGCSelector();
        }

        // Dashboard
        // Animate number counting
        function animateValue(elementId, start, end, duration = 600, suffix = '') {
            const element = document.getElementById(elementId);
            if (!element) return;
            const range = end - start;
            const increment = range / (duration / 16);
            let current = start;
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    element.textContent = Math.round(end) + suffix;
                    clearInterval(timer);
                } else {
                    element.textContent = Math.round(current) + suffix;
                }
            }, 16);
        }

        async function loadDashboard() {
            const projects = await getProjects();
            const settings = await getSettings();

            // Total bids analyzed
            animateValue('statBids', 0, projects.length);

            // Bids this week
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const bidsThisWeek = projects.filter(p => new Date(p.created_at) >= oneWeekAgo).length;
            animateValue('statBidsThisWeek', 0, bidsThisWeek);

            // Win rate
            const won = projects.filter(p => p.outcome === 'won').length;
            const lost = projects.filter(p => p.outcome === 'lost').length;
            const winRate = (won + lost) > 0 ? Math.round((won / (won + lost)) * 100) : 0;
            document.getElementById('statWinRate').textContent = winRate > 0 ? winRate + '%' : '--';
            document.getElementById('statWinCount').textContent = won;
            document.getElementById('statLossCount').textContent = lost;

            // Average score
            const projectsWithScores = projects.filter(p => p.scores && (p.scores.final || p.scores.bidindex_score));
            const avgScore = projectsWithScores.length > 0
                ? Math.round(projectsWithScores.reduce((sum, p) => sum + (p.scores.final || p.scores.bidindex_score), 0) / projectsWithScores.length)
                : 0;
            document.getElementById('statAvgScore').textContent = avgScore > 0 ? avgScore : '--';
            const highScoreCount = projectsWithScores.filter(p => (p.scores.final || p.scores.bidindex_score) >= 80).length;
            document.getElementById('statHighScoreCount').textContent = highScoreCount;

            // Hours saved
            const hoursSaved = Math.round(projects.length * settings.decisionTime / 60);
            animateValue('statHours', 0, hoursSaved);
            document.getElementById('statDecisions').textContent = projects.length;

            // Contract risks detected
            let totalRisks = 0;
            let riskyProjects = 0;
            projects.forEach(p => {
                if (p.contract_risks && p.contract_risks.risksDetected && p.contract_risks.risksDetected.length > 0) {
                    totalRisks += p.contract_risks.risksDetected.length;
                    riskyProjects++;
                }
            });
            animateValue('statContractRisks', 0, totalRisks);
            document.getElementById('statRiskyProjects').textContent = riskyProjects;

            // Data moat health (% of projects with outcomes)
            const projectsWithOutcomes = projects.filter(p => p.outcome && p.outcome !== 'pending').length;
            const outcomeRate = projects.length > 0 ? Math.round((projectsWithOutcomes / projects.length) * 100) : 0;
            document.getElementById('statDataMoat').textContent = outcomeRate > 0 ? outcomeRate + '%' : '--';
            document.getElementById('statOutcomeRate').textContent = outcomeRate;

            const recent = projects.slice(0, 5);
            if (recent.length === 0) {
                document.getElementById('recentActivity').innerHTML = '<div class="empty-state"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg><h3>No bids analyzed yet</h3><p>Upload your first bid documents to get started</p><button class="btn btn-primary" onclick="switchTab(\'analyze\')">Analyze Your First Bid</button></div>';
            } else {
                document.getElementById('recentActivity').innerHTML = `<table class="projects-table"><thead><tr><th>Project</th><th>GC</th><th>Score</th><th>Outcome</th><th></th></tr></thead><tbody>${recent.map(p => {
                    const extracted = p.extracted_data || p.extracted || {};
                    const scores = p.scores || {};
                    // Handle both old (bidindex_score) and new (final) field names
                    const score = scores.final || scores.bidindex_score || 0;
                    const recommendation = scores.recommendation || (score >= 80 ? 'GO' : score >= 60 ? 'REVIEW' : 'PASS');
                    // Handle both old (project_city) and new (city) field names
                    const city = extracted.city || extracted.project_city || '';
                    const state = extracted.state || extracted.project_state || '';
                    // Get building type (match Projects table format)
                    const buildingType = (typeof extracted.building_type === 'object' ? extracted.building_type?.type : extracted.building_type) || 'Unknown Type';
                    // Get GC names from gcs array (match Projects table format)
                    let gcDisplay = 'Unknown';
                    if (p.gcs && Array.isArray(p.gcs) && p.gcs.length > 0) {
                        gcDisplay = p.gcs.map(gc => gc.name).join(', ');
                    } else if (extracted.general_contractor || extracted.gc_name) {
                        gcDisplay = extracted.general_contractor || extracted.gc_name;
                    }
                    // Format recommendation class for badge (use colorful score-badge)
                    const recClass = recommendation.toLowerCase();
                    // Format outcome for badge (use colorful outcome-badge)
                    const outcomeClass = (p.outcome || 'pending').toLowerCase();
                    const outcomeText = (p.outcome || 'pending').toUpperCase();
                    return `<tr>
                        <td>
                            <div style="font-weight:600;">${extracted.project_name || 'Unnamed Project'}</div>
                            <div style="font-size:12px; color:var(--text-muted);">${buildingType} • ${city}${city && state ? ', ' : ''}${state}</div>
                        </td>
                        <td>${gcDisplay}</td>
                        <td><span class="score-badge ${recClass}">${score} ${recommendation}</span></td>
                        <td><span class="outcome-badge ${outcomeClass}">${outcomeText}</span></td>
                        <td><button class="btn btn-sm btn-secondary" onclick="viewReport('${p.id}')">View</button></td>
                    </tr>`;
                }).join('')}</tbody></table>`;
            }
            await updateCapacity();
        }

        async function updateCapacity() {
            const settings = await getSettings();
            document.getElementById('capacityIndicator').className = 'capacity-box capacity-' + settings.capacity;
            document.getElementById('capacityText').textContent = settings.capacity.charAt(0).toUpperCase() + settings.capacity.slice(1);
        }

        // Projects
        // Project filtering and sorting
        let allProjectsCache = [];

        function applyProjectFilters() {
            if (allProjectsCache.length === 0) return;

            let filtered = [...allProjectsCache];

            // Apply search filter
            const search = document.getElementById('projectSearch')?.value.toLowerCase();
            if (search) {
                filtered = filtered.filter(p => {
                    const extracted = p.extracted_data || p.extracted;
                    const name = (extracted?.project_name || '').toLowerCase();
                    const location = `${extracted?.city || ''} ${extracted?.state || ''}`.toLowerCase();
                    return name.includes(search) || location.includes(search);
                });
            }

            // Apply outcome filter
            const outcomeFilter = document.getElementById('projectOutcomeFilter')?.value;
            if (outcomeFilter && outcomeFilter !== 'all') {
                filtered = filtered.filter(p => p.outcome === outcomeFilter);
            }

            // Apply score filter
            const scoreFilter = document.getElementById('projectScoreFilter')?.value;
            if (scoreFilter && scoreFilter !== 'all') {
                filtered = filtered.filter(p => {
                    const scores = p.scores || {};
                    const finalScore = scores.final || scores.bidindex_score || 0;
                    if (scoreFilter === 'go') return finalScore >= 80;
                    if (scoreFilter === 'review') return finalScore >= 60 && finalScore < 80;
                    if (scoreFilter === 'pass') return finalScore < 60;
                    return true;
                });
            }

            // Apply sorting
            const sortBy = document.getElementById('projectSortBy')?.value || 'date-desc';
            filtered.sort((a, b) => {
                const aExtracted = a.extracted_data || a.extracted;
                const bExtracted = b.extracted_data || b.extracted;

                if (sortBy === 'date-desc') return new Date(b.created_at) - new Date(a.created_at);
                if (sortBy === 'date-asc') return new Date(a.created_at) - new Date(b.created_at);
                if (sortBy === 'score-desc') return ((b.scores?.final || b.scores?.bidindex_score) || 0) - ((a.scores?.final || a.scores?.bidindex_score) || 0);
                if (sortBy === 'score-asc') return ((a.scores?.final || a.scores?.bidindex_score) || 0) - ((b.scores?.final || b.scores?.bidindex_score) || 0);
                if (sortBy === 'name-asc') {
                    const aName = (aExtracted?.project_name || '').toLowerCase();
                    const bName = (bExtracted?.project_name || '').toLowerCase();
                    return aName.localeCompare(bName);
                }
                if (sortBy === 'name-desc') {
                    const aName = (aExtracted?.project_name || '').toLowerCase();
                    const bName = (bExtracted?.project_name || '').toLowerCase();
                    return bName.localeCompare(aName);
                }
                return 0;
            });

            // Update count display
            const countEl = document.getElementById('projectCount');
            if (countEl) {
                countEl.textContent = `(${filtered.length} of ${allProjectsCache.length})`;
            }

            // Render filtered projects
            renderProjectsTable(filtered);
        }

        function clearProjectFilters() {
            const searchEl = document.getElementById('projectSearch');
            const outcomeEl = document.getElementById('projectOutcomeFilter');
            const scoreEl = document.getElementById('projectScoreFilter');
            const sortEl = document.getElementById('projectSortBy');

            if (searchEl) searchEl.value = '';
            if (outcomeEl) outcomeEl.value = 'all';
            if (scoreEl) scoreEl.value = 'all';
            if (sortEl) sortEl.value = 'date-desc';

            applyProjectFilters();
        }

        function renderProjectsTable(projects) {
            if (!projects || projects.length === 0) {
                document.getElementById('projectsList').innerHTML = '<div class="empty-state" style="padding:40px;"><h3>No matching projects</h3><p>Try adjusting your filters</p></div>';
                return;
            }

            const html = `
                <div style="margin-bottom: 12px; display: flex; gap: 8px; align-items: center;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="checkbox" id="selectAllProjects" onchange="toggleSelectAll()" style="cursor: pointer;">
                        <span style="font-size: 13px; color: var(--text-secondary);">Select All</span>
                    </label>
                    <button class="btn btn-sm" onclick="deleteSelectedProjects()" style="background:var(--danger); color:white; display:none;" id="deleteSelectedBtn">🗑️ Delete Selected (<span id="selectedCount">0</span>)</button>
                </div>
                <table class="projects-table">
                    <thead>
                        <tr>
                            <th style="width:3%;"><input type="checkbox" id="selectAllProjectsHeader" onchange="toggleSelectAll()" style="cursor:pointer;"></th>
                            <th style="width:25%;">Project</th>
                            <th style="width:14%;">GC</th>
                            <th style="width:12%;">Location</th>
                            <th style="width:9%;">Score</th>
                            <th style="width:8%;">Outcome</th>
                            <th style="width:9%;">Date</th>
                            <th style="width:20%; text-align:right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${projects.map(p => {
                            const extracted = p.extracted_data || p.extracted || {};
                            const scores = p.scores || {};

                            // Debug logging for first project
                            if (projects.indexOf(p) === 0) {
                                console.log('📊 First project data:', {
                                    extracted_data: p.extracted_data,
                                    scores: p.scores,
                                    created_at: p.created_at
                                });
                            }

                            const score = scores.bidindex_score || scores.final || 0;
                            const recommendation = scores.recommendation || (score >= 80 ? 'GO' : score >= 60 ? 'REVIEW' : 'PASS');
                            const recClass = recommendation === 'GO' ? 'success' : recommendation === 'REVIEW' ? 'warning' : '';
                            const outcomeClass = p.outcome === 'won' ? 'success' : p.outcome === 'lost' ? 'danger' : p.outcome === 'ghost' ? 'muted' : '';

                            // Fix date handling - show analysis date and bid date
                            let dateDisplay = '—'; // Default to em dash for no date

                            // Helper to validate and format date
                            const formatDate = (dateValue) => {
                                if (!dateValue) return null;
                                const d = new Date(dateValue);
                                if (isNaN(d.getTime())) return null; // Invalid date
                                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                            };

                            // Get both dates
                            const analysisDate = formatDate(p.created_at);
                            const bidDate = formatDate(extracted.bid_deadline);

                            // Build date display: Analysis date (primary), bid date (secondary)
                            if (analysisDate && bidDate) {
                                dateDisplay = `<div style="font-size:13px;"><strong>Analyzed:</strong> ${analysisDate}</div><div style="font-size:11px; color:var(--text-muted);">Bid Due: ${bidDate}</div>`;
                            } else if (analysisDate) {
                                dateDisplay = `<div style="font-size:13px;">${analysisDate}</div>`;
                            } else if (bidDate) {
                                dateDisplay = `<div style="font-size:13px; color:var(--text-muted);">Bid: ${bidDate}</div>`;
                            }

                            // Handle both old (project_city) and new (city) field names
                            const city = extracted.city || extracted.project_city || '';
                            const state = extracted.state || extracted.project_state || '';

                            // Get GC names from gcs array (not from extracted fields)
                            let gcDisplay = 'Unknown';
                            if (p.gcs && Array.isArray(p.gcs) && p.gcs.length > 0) {
                                gcDisplay = p.gcs.map(gc => gc.name).join(', ');
                            } else if (extracted.general_contractor || extracted.gc_name) {
                                gcDisplay = extracted.general_contractor || extracted.gc_name;
                            }

                            // Show score display
                            const scoreDisplay = score > 0 ? `${score} - ${recommendation}` : 'No score yet';

                            return `
                                <tr>
                                    <td style="text-align:center;">
                                        <input type="checkbox" class="project-checkbox" data-project-id="${p.id}" onchange="updateDeleteButton()" style="cursor:pointer;">
                                    </td>
                                    <td>
                                        <div style="font-weight:600;">${extracted.project_name || 'Unnamed Project'}</div>
                                        <div style="font-size:12px; color:var(--text-muted);">${(typeof extracted.building_type === 'object' ? extracted.building_type?.type : extracted.building_type) || 'Unknown Type'}</div>
                                    </td>
                                    <td>${gcDisplay}</td>
                                    <td>${city}${city && state ? ', ' : ''}${state}</td>
                                    <td><span class="score-badge ${recClass}">${scoreDisplay}</span></td>
                                    <td><span class="outcome-badge ${outcomeClass}">${(p.outcome || 'pending').toUpperCase()}</span></td>
                                    <td style="color:var(--text-muted);">${dateDisplay}</td>
                                    <td style="white-space: nowrap;">
                                        <div style="display: flex; gap: 6px; justify-content: flex-end;">
                                            <button class="btn btn-sm btn-secondary" onclick="viewReport('${p.id}')" style="padding:6px 12px;" title="View full report">👁️ View</button>
                                            ${p.outcome === 'pending' ? `<button class="btn btn-sm btn-secondary" onclick="showOutcome('${p.id}')" style="padding:6px 12px;" title="Add outcome">📝 Outcome</button>` : ''}
                                            <button class="btn btn-sm" onclick="deleteProject('${p.id}')" style="padding:6px 10px; background:var(--danger); color:white;" title="Delete project">🗑️</button>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('projectsList').innerHTML = html;
        }

        // Export projects to CSV
        async function exportProjectsCSV() {
            const projects = allProjectsCache.length > 0 ? allProjectsCache : await getProjects();
            if (projects.length === 0) {
                alert('No projects to export');
                return;
            }

            // Build CSV content
            const headers = ['Project Name', 'GC', 'City', 'State', 'Building Type', 'Score', 'Recommendation', 'Outcome', 'Date Analyzed', 'Location Match', 'Keywords Match', 'GC Match', 'Trade/Product Match'];
            const rows = projects.map(p => {
                const extracted = p.extracted_data || p.extracted;
                const scores = p.scores || {};
                const components = scores.score_components || {};

                return [
                    extracted?.project_name || '',
                    extracted?.general_contractor || '',
                    extracted?.city || '',
                    extracted?.state || '',
                    extracted?.building_type || '',
                    scores.final || scores.bidindex_score || 0,
                    scores.recommendation || '',
                    p.outcome || 'pending',
                    new Date(p.created_at).toLocaleDateString(),
                    components.location?.score || 0,
                    components.keywords?.score || 0,
                    components.gc?.score || 0,
                    components.trade?.score || components.product?.score || 0
                ];
            });

            // Convert to CSV
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => {
                    // Escape commas and quotes
                    const str = String(cell).replace(/"/g, '""');
                    return str.includes(',') || str.includes('"') || str.includes('\n') ? `"${str}"` : str;
                }).join(','))
            ].join('\n');

            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().split('T')[0];
            link.setAttribute('href', url);
            link.setAttribute('download', `BidIntell_Projects_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function loadProjects() {
            const projects = await getProjects();
            allProjectsCache = projects;

            if (projects.length === 0) {
                document.getElementById('projectsList').innerHTML = '<div class="empty-state" style="padding:40px;"><h3>No projects yet</h3><p>Analyze your first bid to see it here</p></div>';
                document.getElementById('projectCount').textContent = '';
                return;
            }

            // Apply filters (will render the table)
            applyProjectFilters();
        }

        async function viewReport(id) {
            const projects = await getProjects();
            const settings = await getSettings();
            const p = projects.find(x => x.id === id);
            if (!p) {
                console.error('❌ Project not found:', id);
                return;
            }

            console.log('📄 Opening report for project:', p);

            try {
                // Store current project ID globally for save function
                window.currentReportProject = p;

                // Store which tab we came from for the back button
                const tabs = ['dashboard', 'projects', 'gcs', 'keywords', 'settings', 'analytics', 'admin'];
                for (const tabName of tabs) {
                    const tabElement = document.getElementById(`tab-${tabName}`);
                    if (tabElement && tabElement.classList.contains('active')) {
                        window.previousTab = tabName;
                        break;
                    }
                }

                // Use appropriate label based on company type
                const tradeIcon = settings.companyType === 'subcontractor' ? '🔧' : '📦';
                const tradeLabel = settings.companyType === 'subcontractor' ? 'Trade Match' : 'Product Match';

                // Populate page title
                console.log('Populating title...');
                const titleEl = document.getElementById('reportPageTitle');
                const subtitleEl = document.getElementById('reportPageSubtitle');
                if (!titleEl || !subtitleEl) {
                    console.error('❌ Title elements not found!', {titleEl, subtitleEl});
                    return;
                }
                titleEl.textContent = p.extracted.project_name || 'Bid Report';
                const buildingType = (typeof p.extracted.building_type === 'object' ? p.extracted.building_type?.type : p.extracted.building_type) || '';
                const city = p.extracted.city || p.extracted.project_city || '';
                const state = p.extracted.state || p.extracted.project_state || '';
                const location = [city, state].filter(Boolean).join(', ');
                subtitleEl.textContent = location && buildingType ? `${location} • ${buildingType}` : (location || buildingType);

                // Populate editable fields
                document.getElementById('reportProjectId').value = p.id;
                document.getElementById('reportProjectName').value = p.extracted.project_name || '';
                document.getElementById('reportBuildingType').value = (typeof p.extracted.building_type === 'object' ? p.extracted.building_type?.type : p.extracted.building_type) || 'Other';
                document.getElementById('reportCity').value = p.extracted.city || p.extracted.project_city || '';
                document.getElementById('reportState').value = p.extracted.state || p.extracted.project_state || '';

                // Format bid deadline
                if (p.extracted.bid_deadline) {
                    try {
                        const deadlineDate = new Date(p.extracted.bid_deadline);
                        if (!isNaN(deadlineDate.getTime())) {
                            document.getElementById('reportBidDeadline').value = deadlineDate.toISOString().split('T')[0];
                        }
                    } catch(e) {
                        console.warn('Could not parse bid deadline:', e);
                    }
                }

                // Load GCs into reportGCList
                reportGCList = [];
                const allGCs = await getGCs();

                // Get GC data from project - prefer p.gcs (which has ratings), fallback to extracted data
                if (p.gcs && Array.isArray(p.gcs) && p.gcs.length > 0) {
                    reportGCList = p.gcs.map(gc => ({ ...gc }));
                } else {
                    // Fallback to extracted GC names (no ratings)
                    let gcNames = [];
                    if (p.extracted.gc_names && Array.isArray(p.extracted.gc_names)) {
                        gcNames = p.extracted.gc_names;
                    } else if (p.extracted.general_contractor) {
                        gcNames = [p.extracted.general_contractor];
                    } else if (p.extracted.gc_name) {
                        gcNames = [p.extracted.gc_name];
                    }

                    // Convert names to GC objects with ratings from database
                    reportGCList = gcNames.map(name => {
                        const existingGC = allGCs.find(gc => gc.name.toLowerCase() === name.toLowerCase());
                        return existingGC ? { ...existingGC } : { name, rating: 0, bids: 0, wins: 0 };
                    });
                }

                renderReportGCList();

                // Analysis date
                if (p.createdAt) {
                    try {
                        const createdDate = new Date(p.createdAt);
                        if (!isNaN(createdDate.getTime())) {
                            document.getElementById('reportAnalysisDate').value = createdDate.toISOString().split('T')[0];
                        }
                    } catch(e) {
                        console.warn('Could not parse createdAt:', e);
                    }
                }

                // Populate score content
                const scoreHTML = `
                    <div class="score-report">
                        <div class="score-report-header">
                            <div class="score-report-value ${p.scores.recommendation.toLowerCase()}">${p.scores.final}</div>
                            <div class="score-report-rec">${p.scores.recommendation}</div>
                        </div>
                        ${renderComponent('📍', 'Location Fit', p.scores.components.location)}
                        ${renderComponent('🔑', 'Keywords & Contract', p.scores.components.keywords)}
                        ${renderComponent('🏢', 'GC Relationship', p.scores.components.gc)}
                        ${renderComponent(tradeIcon, tradeLabel, p.scores.components.trade)}
                    </div>
                `;
                document.getElementById('reportScoreContent').innerHTML = scoreHTML;

                // Populate GCs content
                let gcsHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">';
                if (p.gcs && p.gcs.length > 0) {
                    p.gcs.forEach(gc => {
                        const winRate = gc.bids > 0 ? Math.round((gc.wins / gc.bids) * 100) : 0;
                        const stars = '★'.repeat(gc.rating) + '☆'.repeat(5 - gc.rating);
                        gcsHTML += `
                            <div style="padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius); border: 1px solid var(--border-color);">
                                <div style="font-weight: 600; font-size: 15px; margin-bottom: 6px; color: var(--text-primary);">${gc.name}</div>
                                <div style="color: var(--accent); font-size: 18px; margin-bottom: 6px;">${stars}</div>
                                <div style="font-size: 13px; color: var(--text-muted);">
                                    ${gc.bids > 0 ? `${gc.wins} wins / ${gc.bids} bids (${winRate}% win rate)` : 'No history yet'}
                                </div>
                            </div>
                        `;
                    });
                } else {
                    gcsHTML += '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No GCs specified for this project</div>';
                }
                gcsHTML += '</div>';
                document.getElementById('reportGCsContent').innerHTML = gcsHTML;

                // Populate recommendations - Use Intelligence Engine output if available
                let recsHTML = '<div style="line-height: 1.6;">';

                // Debug: Log Intelligence Engine data
                console.log('🧠 Intelligence Engine Data:', {
                    hasValidationStatus: !!p.validationStatus,
                    hasAiAdvisorOutput: !!p.aiAdvisorOutput,
                    hasScoreExplanation: !!p.scoreExplanation,
                    aiAdvisorOutput: p.aiAdvisorOutput,
                    validationStatus: p.validationStatus
                });

                // Display validation status if available
                if (p.validationStatus) {
                    if (p.validationStatus.complete) {
                        recsHTML += '<div style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--success-bg); border: 1px solid var(--success); border-radius: var(--radius); margin-bottom: 16px;">';
                        recsHTML += '<span style="font-size: 20px;">✅</span>';
                        recsHTML += '<span style="color: var(--success); font-weight: 600;">All data validated - Ready for analytics</span>';
                        recsHTML += '</div>';
                    } else if (p.validationStatus.missing_fields && p.validationStatus.missing_fields.length > 0) {
                        recsHTML += '<div style="display: flex; align-items: center; gap: 8px; padding: 12px; background: var(--warning-bg); border: 1px solid var(--warning); border-radius: var(--radius); margin-bottom: 16px;">';
                        recsHTML += '<span style="font-size: 20px;">⚠️</span>';
                        recsHTML += '<div><div style="color: var(--warning); font-weight: 600; margin-bottom: 4px;">Incomplete data</div>';
                        recsHTML += '<div style="font-size: 13px; color: var(--text-muted);">Missing: ' + p.validationStatus.missing_fields.join(', ') + '</div></div>';
                        recsHTML += '</div>';
                    }
                }

                // Display AI Advisor response if available (Intelligence Engine)
                if (p.aiAdvisorOutput) {
                    // Convert markdown-style formatting to HTML
                    const advisorHTML = p.aiAdvisorOutput
                        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>') // Bold text
                        .replace(/^• (.+)$/gm, '<li style="margin-left: 20px;">$1</li>') // Bullet points
                        .replace(/\n\n/g, '</p><p style="margin-bottom: 12px;">') // Paragraphs
                        .replace(/\n/g, '<br>'); // Line breaks
                    recsHTML += `<div style="margin-bottom: 16px;"><p style="margin-bottom: 12px;">${advisorHTML}</p></div>`;
                } else {
                    // Fallback to old format if Intelligence Engine data not available
                    if (p.scores.explanation) {
                        recsHTML += `<p style="margin-bottom: 12px;">${p.scores.explanation}</p>`;
                    }
                    if (p.scores.action_items && p.scores.action_items.length > 0) {
                        recsHTML += '<div style="margin-top: 16px;"><strong>Action Items:</strong><ul style="margin-top: 8px; padding-left: 20px;">';
                        p.scores.action_items.forEach(item => {
                            recsHTML += `<li style="margin-bottom: 6px;">${item}</li>`;
                        });
                        recsHTML += '</ul></div>';
                    }
                }

                // Display score explanation if available (Intelligence Engine)
                if (p.scoreExplanation && !p.aiAdvisorOutput) {
                    // If we don't have AI advisor output but do have score explanation, show it
                    const explanationHTML = p.scoreExplanation
                        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                        .replace(/^• (.+)$/gm, '<li style="margin-left: 20px;">$1</li>')
                        .replace(/\n\n/g, '</p><p style="margin-bottom: 12px;">')
                        .replace(/\n/g, '<br>');
                    recsHTML += `<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);"><p style="margin-bottom: 12px;">${explanationHTML}</p></div>`;
                }

                // AI Analysis Summary (plain English)
                const buildingTypeLabel = (typeof p.extracted.building_type === 'object' ? p.extracted.building_type?.type : p.extracted.building_type) || 'Not specified';
                const summaryParts = [];
                summaryParts.push(`This ${buildingTypeLabel.toLowerCase()} project is located ${p.scores.components.location.details?.dist || 'an unknown distance'} miles from your office.`);
                if (p.scores.components.location.score >= 80) {
                    summaryParts.push('The location is within your preferred service area.');
                } else if (p.scores.components.location.score >= 60) {
                    summaryParts.push('The location is at the edge of your service area.');
                } else {
                    summaryParts.push('The location may be outside your typical service area.');
                }

                const goodKeywords = (p.good_keywords || []).length;
                if (goodKeywords > 0) {
                    summaryParts.push(`We found ${goodKeywords} favorable term${goodKeywords !== 1 ? 's' : ''} in the bid documents.`);
                }

                const riskKeywords = (p.contract_risks || []).length;
                if (riskKeywords > 0) {
                    summaryParts.push(`However, ${riskKeywords} contract risk${riskKeywords !== 1 ? 's were' : ' was'} identified that may impact your decision.`);
                }

                if (p.gcs && p.gcs.length > 0) {
                    const knownGCs = p.gcs.filter(gc => gc.rating >= 3);
                    if (knownGCs.length > 0) {
                        summaryParts.push(`You have good relationships with ${knownGCs.length} of the ${p.gcs.length} general contractor${p.gcs.length !== 1 ? 's' : ''} bidding.`);
                    } else {
                        summaryParts.push(`You have limited history with the ${p.gcs.length} general contractor${p.gcs.length !== 1 ? 's' : ''} on this project.`);
                    }
                }

                const aiSummary = summaryParts.join(' ');

                // How to Improve Your Chances
                const improvements = [];
                if (p.scores.components.location.score < 80) {
                    improvements.push('Consider factoring in travel time and logistics costs for this location.');
                }
                if (p.scores.components.gc.score < 70) {
                    improvements.push('Reach out to the GCs early to build rapport and clarify scope questions.');
                }
                if (riskKeywords > 0) {
                    improvements.push('Have your attorney review the contract terms, especially the identified risk clauses.');
                }
                if (p.scores.components.keywords.score < 70) {
                    improvements.push('Request clarification on any ambiguous scope items before submitting your bid.');
                }
                if (p.scores.components.trade.score < 80) {
                    improvements.push('Highlight your relevant experience in similar projects to strengthen your bid.');
                }
                if (improvements.length === 0) {
                    improvements.push('Your profile is a strong match. Submit a competitive price and emphasize your reliability.');
                    improvements.push('Follow up with the GC after submission to demonstrate your interest.');
                }

                // Display AI Summary and Improvements
                recsHTML += `
                    <div style="margin-top: 20px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border-left: 4px solid var(--accent);">
                        <h4 style="margin: 0 0 12px 0; font-size: 15px; font-weight: 600; color: var(--text-primary);">📊 AI Analysis Summary</h4>
                        <p style="margin: 0; font-size: 14px; line-height: 1.6; color: var(--text-secondary);">${aiSummary}</p>
                    </div>
                    <div style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border-left: 4px solid var(--success);">
                        <h4 style="margin: 0 0 12px 0; font-size: 15px; font-weight: 600; color: var(--text-primary);">💡 How to Improve Your Chances</h4>
                        <ul style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.8; color: var(--text-secondary);">
                            ${improvements.map(tip => `<li>${tip}</li>`).join('')}
                        </ul>
                    </div>
                `;

                // Add interactive Q&A with Help Center
                const advisorName = (await getSettings()).ai_advisor_name || 'Sam';
                recsHTML += `
                    <div style="margin-top: 24px; padding: 20px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%); border-radius: var(--radius); border: 2px solid var(--border-color);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <div style="font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">💬</span>
                                <span>Help Center - Ask ${advisorName}</span>
                            </div>
                            <button onclick="toggleAIChat()" style="padding: 6px 12px; background: var(--accent); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 6px; transition: all 0.2s;" onmouseover="this.style.background='var(--accent-hover)'" onmouseout="this.style.background='var(--accent)'">
                                💬 Open Chat History
                            </button>
                        </div>
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <span>Get instant answers about this bid, your chances, risks, or strategy advice.</span>
                            <span style="font-size: 11px; padding: 2px 8px; background: var(--accent); color: white; border-radius: 12px; white-space: nowrap;">UNLIMITED</span>
                        </div>
                        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                            <input type="text" id="samQuestionInput" class="form-input" placeholder="e.g., Why is my GC score low? Should I bid this?" style="flex: 1; font-size: 14px;">
                            <button class="btn btn-primary" onclick="askSamQuestion()" id="askSamBtn" style="min-width: 120px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                                <span>Ask ${advisorName}</span>
                            </button>
                        </div>
                        <div id="samQuestionResponse" style="display: none; margin-top: 16px; padding: 16px; background: var(--bg-primary); border-radius: var(--radius); border-left: 4px solid var(--accent);"></div>
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 4px;">
                            <span>💡</span>
                            <span>Your conversation history is saved. Click "Open Chat History" to see past messages or continue a conversation.</span>
                        </div>
                    </div>
                `;

                recsHTML += '</div>';
                document.getElementById('reportRecommendations').innerHTML = recsHTML;

                // Add Enter key support for Sam question input
                setTimeout(() => {
                    const input = document.getElementById('samQuestionInput');
                    if (input) {
                        input.addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') {
                                askSamQuestion();
                            }
                        });
                    }
                }, 100);

                // Populate extracted data
                let extractedHTML = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">';

                // Format square footage with commas
                const formatSF = (sf) => {
                    if (!sf) return 'Not found';
                    const num = parseInt(sf);
                    if (isNaN(num)) return 'Not found';
                    return num.toLocaleString() + ' SF';
                };

                // Get GC names from various possible field names
                let gcDisplay = 'Not found';
                if (p.extracted.gc_names && Array.isArray(p.extracted.gc_names) && p.extracted.gc_names.length > 0) {
                    gcDisplay = p.extracted.gc_names.join(', ');
                } else if (p.extracted.general_contractor) {
                    gcDisplay = p.extracted.general_contractor;
                } else if (p.extracted.gc_name) {
                    gcDisplay = p.extracted.gc_name;
                }

                // Clean up architect name - filter out taglines/service lists
                let architectDisplay = p.extracted.architect_name || 'Not found';
                if (architectDisplay && architectDisplay !== 'Not found') {
                    // If it contains 3+ commas, it's likely a service list, not a firm name
                    const commaCount = (architectDisplay.match(/,/g) || []).length;
                    if (commaCount >= 3) {
                        architectDisplay = 'Not found';
                    }
                }

                // Reuse city and state variables already declared above
                const locationValue = [city, state].filter(Boolean).join(', ') || 'Not found';

                const extractedFields = [
                    { label: 'Project Name', value: p.extracted.project_name },
                    { label: 'Building Type', value: (typeof p.extracted.building_type === 'object' ? p.extracted.building_type?.type : p.extracted.building_type) },
                    { label: 'Location', value: locationValue },
                    { label: 'Building Size', value: formatSF(p.extracted.project_size_sf) },
                    { label: 'Owner', value: p.extracted.owner_name || p.extracted.owner || 'Not found' },
                    { label: 'Architect', value: architectDisplay }
                ];

                extractedFields.forEach(field => {
                    extractedHTML += `
                        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">${field.label}</div>
                            <div style="font-weight: 500;">${field.value || 'Not found'}</div>
                        </div>
                    `;
                });

                extractedHTML += '</div>';
                document.getElementById('reportExtractedData').innerHTML = extractedHTML;

                // Show report tab and hide others
                console.log('Switching to report tab...');
                switchTab('report');
                console.log('✅ Report view loaded successfully');
            } catch (error) {
                console.error('❌ Error loading report view:', error);
                alert('Failed to load report: ' + error.message);
            }
        }

        async function reanalyzeProject() {
            const project = window.currentReportProject;
            if (!project) {
                alert('No project loaded');
                return;
            }

            const btn = document.getElementById('reanalyzeBtn');
            if (!btn) return;

            // Disable button and show loading state
            btn.disabled = true;
            btn.innerHTML = '🔄 Analyzing...';

            try {
                // Get current settings
                const settings = await getSettings();

                // IMPORTANT: Set selectedGCs from project data for GC scoring
                // The calculateScores function uses the global selectedGCs variable
                selectedGCs = project.gcs || reportGCList || [];
                console.log('🏢 Re-analyze: Using GCs from project:', selectedGCs.map(gc => gc.name));

                // RE-EXTRACT from documents if full text is available
                let extracted = project.extracted;
                let reextracted = false;

                if (project.full_text && project.full_text.length > 100) {
                    console.log('🔄 Re-extracting data from documents with updated prompts...');
                    try {
                        extracted = await extractWithAI(project.full_text);
                        console.log('✅ Re-extraction complete:', extracted);
                        reextracted = true;
                    } catch (extractError) {
                        console.error('❌ Re-extraction failed, using existing data:', extractError);
                        showBanner('⚠️ Re-extraction failed, recalculating with existing data', 'warning');
                    }
                } else {
                    console.warn('⚠️ No stored document text available');
                    console.warn('   This project was analyzed before document storage was added.');
                    console.warn('   Re-analyzing will only recalculate scores, not re-extract data.');
                    console.warn('   To get updated extraction, please upload the documents again.');
                }

                // Re-run scoring with (possibly updated) extracted data
                const scores = await calculateScores(
                    extracted,
                    settings,
                    project.goodFound || [],
                    project.badFound || [],
                    project.tradesFound || [],
                    project.contractRisks || [],
                    null // tradeDetection - will be recalculated
                );

                // Get user history for Intelligence Engine
                const userHistory = await getProjects();

                // Create updated project object with new extracted data
                const updatedProject = {
                    ...project,
                    extracted,
                    scores,
                    distance: scores.distance // Update distance with new location
                };

                // Re-run Intelligence Engine
                const validationStatus = validateBidData(updatedProject, settings);
                const scoreExplanation = explainScore(updatedProject, settings);
                const aiAdvisorOutput = generateAdvisorResponse(updatedProject, settings, userHistory);
                const intelligenceTags = tagForAnalytics(updatedProject, settings);

                console.log('🧠 Re-analysis Intelligence Engine Results:', {
                    validation: validationStatus,
                    tags: intelligenceTags
                });

                // Update in database with new extracted data
                const { error } = await supabaseClient.from('projects').update({
                    extracted_data: extracted,
                    scores: scores,
                    validation_status: validationStatus,
                    ai_advisor_output: aiAdvisorOutput,
                    intelligence_tags: intelligenceTags,
                    updated_at: new Date().toISOString()
                }).eq('id', project.id);

                if (error) throw error;

                // IMPORTANT: Update window.currentReportProject with new scores BEFORE refreshing view
                // This ensures print report uses the latest data
                if (window.currentReportProject && window.currentReportProject.id === project.id) {
                    window.currentReportProject = {
                        ...window.currentReportProject,
                        extracted,
                        scores,
                        distance: scores.distance,
                        validation_status: validationStatus,
                        ai_advisor_output: aiAdvisorOutput,
                        intelligence_tags: intelligenceTags
                    };
                    console.log('✅ Updated window.currentReportProject with new scores:', window.currentReportProject.scores);
                }

                // Clear cache to force refresh
                dataCache.projects = null;

                // Show success message
                if (reextracted) {
                    showBanner('✅ Project re-analyzed with updated extraction prompts', 'success');
                } else {
                    showBanner('⚠️ Scores recalculated. To re-extract data, please upload documents again.', 'warning');
                }

                // Reload the report view
                await viewReport(project.id);

            } catch (error) {
                console.error('❌ Re-analysis failed:', error);
                showBanner('❌ Re-analysis failed: ' + error.message, 'error');
            } finally {
                // Re-enable button
                btn.disabled = false;
                btn.innerHTML = '🔄 Re-analyze';
            }
        }

        // Reupload Documents for Re-analysis
        let reuploadFiles = [];

        function showReuploadModal() {
            const project = window.currentReportProject;
            if (!project) {
                alert('No project loaded');
                return;
            }

            // Reset state
            reuploadFiles = [];
            document.getElementById('reuploadFileList').innerHTML = '';
            document.getElementById('reuploadProcessBtn').disabled = true;
            document.getElementById('reuploadProgress').style.display = 'none';

            // Show modal
            document.getElementById('reuploadModal').style.display = 'flex';
        }

        function closeReuploadModal() {
            document.getElementById('reuploadModal').style.display = 'none';
            reuploadFiles = [];
        }

        function handleReuploadDrop(event) {
            event.preventDefault();
            const dropZone = event.currentTarget;
            dropZone.style.borderColor = 'var(--border-color)';
            dropZone.style.background = 'var(--bg-secondary)';

            const files = Array.from(event.dataTransfer.files).filter(f => f.type === 'application/pdf');
            handleReuploadFiles(files);
        }

        function handleReuploadFiles(files) {
            if (!files || files.length === 0) return;

            const fileArray = Array.from(files).filter(f => f.type === 'application/pdf');

            if (fileArray.length === 0) {
                showBanner('❌ Please upload PDF files only', 'error');
                return;
            }

            // Note: No file size limit - matches original upload behavior
            // Large files are handled by PDF.js and text truncation in extractTextFromPDF

            reuploadFiles = fileArray;

            // Display file list
            const listHTML = reuploadFiles.map((file, idx) => `
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius); margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 24px;">📄</span>
                        <div>
                            <div style="font-weight: 600; font-size: 14px; color: var(--text-primary);">${file.name}</div>
                            <div style="font-size: 12px; color: var(--text-muted);">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                        </div>
                    </div>
                    <button onclick="removeReuploadFile(${idx})" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 20px; padding: 4px 8px;" title="Remove">✕</button>
                </div>
            `).join('');

            document.getElementById('reuploadFileList').innerHTML = listHTML;
            document.getElementById('reuploadProcessBtn').disabled = false;
        }

        function removeReuploadFile(idx) {
            reuploadFiles.splice(idx, 1);
            handleReuploadFiles(reuploadFiles);
            if (reuploadFiles.length === 0) {
                document.getElementById('reuploadProcessBtn').disabled = true;
            }
        }

        async function processReupload() {
            if (reuploadFiles.length === 0) {
                showBanner('❌ Please upload at least one PDF file', 'error');
                return;
            }

            const project = window.currentReportProject;
            if (!project) {
                alert('No project loaded');
                return;
            }

            const btn = document.getElementById('reuploadProcessBtn');
            const progressDiv = document.getElementById('reuploadProgress');
            const progressBar = document.getElementById('reuploadProgressBar');
            const progressText = document.getElementById('reuploadProgressText');

            try {
                // Disable button
                btn.disabled = true;
                btn.innerHTML = '⏳ Processing...';
                progressDiv.style.display = 'block';

                // Step 1: Extract text from PDFs
                progressText.textContent = 'Extracting text from PDFs...';
                progressBar.style.width = '20%';

                let combinedText = '';
                for (let i = 0; i < reuploadFiles.length; i++) {
                    const file = reuploadFiles[i];
                    progressText.textContent = `Extracting text from ${file.name} (${i + 1}/${reuploadFiles.length})...`;
                    const text = await extractTextFromPDF(file);
                    combinedText += `\n\n--- ${file.name} ---\n\n${text}`;
                }

                if (combinedText.length < 100) {
                    throw new Error('Could not extract text from PDFs');
                }

                // Step 2: Extract data with AI
                progressText.textContent = 'Analyzing documents with AI...';
                progressBar.style.width = '50%';

                const extracted = await extractWithAI(combinedText);

                // Step 3: Recalculate scores
                progressText.textContent = 'Calculating scores...';
                progressBar.style.width = '70%';

                const settings = await getSettings();
                selectedGCs = project.gcs || [];

                const scores = await calculateScores(
                    extracted,
                    settings,
                    project.goodFound || [],
                    project.badFound || [],
                    project.tradesFound || [],
                    project.contractRisks || [],
                    null
                );

                // Step 4: Run Intelligence Engine
                progressText.textContent = 'Running intelligence engine...';
                progressBar.style.width = '85%';

                const userHistory = await getProjects();
                const validationStatus = validateBidData({ ...project, extracted, scores }, settings);
                const aiAdvisorOutput = generateAdvisorResponse({ ...project, extracted, scores }, settings, userHistory);
                const intelligenceTags = tagForAnalytics({ ...project, extracted, scores }, settings);

                // Step 5: Update database
                progressText.textContent = 'Saving to database...';
                progressBar.style.width = '95%';

                const { error } = await supabaseClient.from('projects').update({
                    extracted_data: extracted,
                    full_text: combinedText, // Save new full text
                    scores: scores,
                    validation_status: validationStatus,
                    ai_advisor_output: aiAdvisorOutput,
                    intelligence_tags: intelligenceTags,
                    updated_at: new Date().toISOString()
                }).eq('id', project.id);

                if (error) throw error;

                // Update window.currentReportProject
                window.currentReportProject = {
                    ...project,
                    extracted,
                    full_text: combinedText,
                    scores,
                    distance: scores.distance,
                    validation_status: validationStatus,
                    ai_advisor_output: aiAdvisorOutput,
                    intelligence_tags: intelligenceTags
                };

                // Clear cache
                dataCache.projects = null;

                // Complete
                progressText.textContent = 'Complete!';
                progressBar.style.width = '100%';

                console.log('✅ Reupload complete, refreshing report in 500ms...');
                console.log('   Project ID:', project.id);
                console.log('   Cache cleared:', dataCache.projects === null);

                // Close modal and show success
                setTimeout(async () => {
                    try {
                        closeReuploadModal();
                        showBanner('✅ Project re-analyzed with new documents', 'success');

                        // Force cache clear again just to be sure
                        dataCache.projects = null;

                        console.log('🔄 Calling viewReport to refresh...');
                        await viewReport(project.id);
                        console.log('✅ Report refreshed successfully');
                    } catch (refreshError) {
                        console.error('❌ Failed to refresh report:', refreshError);
                        showBanner('⚠️ Re-analysis complete, refreshing page...', 'info');
                        // Fallback: Just reload the page to show updated report
                        setTimeout(() => location.reload(), 1000);
                    }
                }, 500);

            } catch (error) {
                console.error('❌ Reupload failed:', error);
                showBanner('❌ Failed to process documents: ' + error.message, 'error');
                progressDiv.style.display = 'none';
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>🔄 Re-analyze with New Documents</span>';
            }
        }

        // Report GC Management
        let reportGCList = [];

        function renderReportGCList() {
            const container = document.getElementById('reportGCList');
            if (!container) return;

            if (reportGCList.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px; padding: 4px;">No GCs added yet</div>';
            } else {
                container.innerHTML = reportGCList.map((gc, idx) => `
                    <div style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--bg-tertiary); border-radius: 6px; border: 1px solid var(--border);">
                        <span style="font-weight: 500;">${gc.name}</span>
                        <span style="color: var(--warning);">${'★'.repeat(gc.rating || 0)}${'☆'.repeat(5 - (gc.rating || 0))}</span>
                        <button onclick="removeReportGC(${idx})" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 0; margin-left: 4px; font-size: 16px; line-height: 1;">&times;</button>
                    </div>
                `).join('');
            }
        }

        async function removeReportGC(index) {
            reportGCList.splice(index, 1);
            renderReportGCList();

            // Auto-save after removing GC
            await autoSaveReportGCs();
        }

        // Auto-save GCs to project without requiring user to click Save Changes
        async function autoSaveReportGCs() {
            const projectId = document.getElementById('reportProjectId').value;
            if (!projectId) return;

            try {
                // Update GCs in database
                const { error } = await supabaseClient
                    .from('projects')
                    .update({
                        gcs: reportGCList,
                        extracted_data: {
                            ...window.currentReportProject.extracted,
                            gc_names: reportGCList.map(gc => gc.name)
                        }
                    })
                    .eq('id', projectId);

                if (error) throw error;

                // Update current project reference
                if (window.currentReportProject) {
                    window.currentReportProject.gcs = reportGCList;
                }

                // Clear cache
                dataCache.projects = null;

                console.log('✅ GCs auto-saved to project');
            } catch (error) {
                console.error('❌ Auto-save GCs failed:', error);
                showBanner('❌ Failed to auto-save: ' + error.message, 'error');
            }
        }

        async function addGCFromReport() {
            const input = document.getElementById('reportGCInput');
            const name = input.value.trim();

            if (!name) {
                showBanner('❌ Please enter a GC name', 'error');
                return;
            }

            // Check if already in list
            if (reportGCList.find(gc => gc.name.toLowerCase() === name.toLowerCase())) {
                showBanner('ℹ️ GC already in list', 'info');
                input.value = '';
                return;
            }

            // Check if exists in database
            const allGCs = await getGCs();
            const existingGC = allGCs.find(gc => gc.name.toLowerCase() === name.toLowerCase());

            if (existingGC) {
                // Use existing GC with its rating
                reportGCList.push({ ...existingGC });
                renderReportGCList();
                input.value = '';
                showBanner(`✅ Added "${existingGC.name}" and auto-saved`, 'success');

                // Auto-save project with new GC
                await autoSaveReportGCs();
            } else {
                // Show rating modal for new GC (auto-save happens in confirmReportGC)
                showReportGCRatingModal(name);
            }
        }

        function showReportGCRatingModal(gcName) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;';
            modal.innerHTML = `
                <div style="background: var(--bg-primary); padding: 32px; border-radius: 12px; max-width: 450px; width: 90%;">
                    <h3 style="margin: 0 0 16px 0; text-align: center;">Rate Your Experience with "${gcName}"</h3>
                    <div style="display: flex; justify-content: center; gap: 12px; margin: 24px 0; font-size: 48px;">
                        ${[1,2,3,4,5].map(i => `<span id="reportRatingStar${i}" onclick="selectReportRating(${i})" style="cursor: pointer; color: var(--text-muted); transition: color 0.2s;">★</span>`).join('')}
                    </div>
                    <div id="reportRatingLabel" style="text-align: center; color: var(--text-muted); font-size: 14px; margin-bottom: 24px; min-height: 20px;">Select a rating</div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="cancelReportGCRating()" style="flex: 1;">Cancel</button>
                        <button class="btn btn-primary" id="confirmReportGCBtn" onclick="confirmReportGC()" disabled style="flex: 1;">Add GC</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            window.currentReportGCModal = { modal, gcName, rating: null };
        }

        function selectReportRating(rating) {
            if (!window.currentReportGCModal) return;

            window.currentReportGCModal.rating = rating;

            // Update star colors
            for (let i = 1; i <= 5; i++) {
                const star = document.getElementById(`reportRatingStar${i}`);
                if (star) {
                    star.style.color = i <= rating ? 'var(--warning)' : 'var(--text-muted)';
                }
            }

            // Update label
            const labels = ['Poor - Avoid', 'Below Average', 'Average', 'Good', 'Excellent!'];
            document.getElementById('reportRatingLabel').textContent = labels[rating - 1];

            // Enable confirm button
            document.getElementById('confirmReportGCBtn').disabled = false;
        }

        async function confirmReportGC() {
            if (!window.currentReportGCModal || !window.currentReportGCModal.rating) return;

            const { gcName, rating, modal } = window.currentReportGCModal;

            // Add to report GC list
            reportGCList.push({ name: gcName, rating, bids: 0, wins: 0 });

            // Save to database
            await saveGC({ name: gcName, rating, bids: 0, wins: 0 });

            // Clear cache and update UI
            dataCache.gcs = null;
            renderReportGCList();
            document.getElementById('reportGCInput').value = '';

            // Close modal
            document.body.removeChild(modal);
            window.currentReportGCModal = null;

            // Auto-save project with new GC
            await autoSaveReportGCs();
        }

        function cancelReportGCRating() {
            if (!window.currentReportGCModal) return;
            document.body.removeChild(window.currentReportGCModal.modal);
            window.currentReportGCModal = null;
            document.getElementById('reportGCInput').value = '';
        }

        async function askSamQuestion() {
            const input = document.getElementById('samQuestionInput');
            const btn = document.getElementById('askSamBtn');
            const responseDiv = document.getElementById('samQuestionResponse');

            const question = input.value.trim();
            if (!question) {
                showBanner('❌ Please enter a question', 'error');
                return;
            }

            // Disable input while loading
            btn.disabled = true;
            btn.innerHTML = '🤔 Thinking...';
            responseDiv.style.display = 'block';
            responseDiv.innerHTML = '<div style="text-align: center; color: var(--text-muted);"><div style="font-size: 24px; margin-bottom: 8px;">🤔</div>Thinking...</div>';

            try {
                const settings = await getSettings();
                const project = window.currentReportProject || currentAnalysis;
                const advisorName = settings.ai_advisor_name || 'Sam';
                const advisorTone = settings.ai_advisor_tone || 'supportive';

                // Build context about the bid for the AI
                const context = {
                    project_name: project.extracted?.project_name || 'this project',
                    location: `${project.extracted?.city || ''}, ${project.extracted?.state || ''}`.trim() || 'Unknown',
                    building_type: project.buildingType?.type || project.extracted?.building_type || 'Unknown',
                    score: project.scores?.final || 0,
                    recommendation: project.scores?.recommendation || 'REVIEW',
                    score_components: {
                        location: project.scores?.components?.location?.score || 0,
                        keywords: project.scores?.components?.keywords?.score || 0,
                        gc: project.scores?.components?.gc?.score || 0,
                        trade: project.scores?.components?.trade?.score || 0
                    },
                    gcs: (project.gcs || []).map(gc => ({ name: gc.name, rating: gc.rating })),
                    contract_risks: project.contractRisks?.risksDetected?.length || 0,
                    user_company_type: settings.companyType,
                    user_trades: settings.trades || [],
                    user_capacity: settings.capacity,
                    user_risk_tolerance: settings.riskTolerance
                };

                // Build the prompt for Claude
                const prompt = `You are ${advisorName}, the BidIntell AI Advisor. Your personality is ${advisorTone}.

USER QUESTION: "${question}"

BID CONTEXT:
- Project: ${context.project_name}
- Location: ${context.location}
- Building Type: ${context.building_type}
- BidIndex Score: ${context.score}/100 (${context.recommendation})
- Score Breakdown:
  • Location: ${context.score_components.location}/100
  • Keywords & Contract: ${context.score_components.keywords}/100
  • GC Relationship: ${context.score_components.gc}/100
  • Trade/Product Match: ${context.score_components.trade}/100
- GCs Bidding: ${context.gcs.map(gc => `${gc.name} (${gc.rating}★)`).join(', ') || 'None'}
- Contract Risks: ${context.contract_risks}
- User Company: ${context.user_company_type}
- User Trades: ${context.user_trades.join(', ') || 'Not specified'}
- User Capacity: ${context.user_capacity}
- Risk Tolerance: ${context.user_risk_tolerance}

YOUR ROLE:
- Answer their question directly and helpfully
- Use the bid context to give specific, actionable advice
- Match your personality: ${advisorTone === 'supportive' ? 'encouraging and optimistic' : advisorTone === 'straight_shooter' ? 'direct and no-nonsense' : 'analytical and data-focused'}
- Keep it under 150 words
- Use "I" and refer to yourself as ${advisorName}

IMPORTANT:
- You ALREADY KNOW the user's trade/company type from the context above - NEVER ask "What's your trade?"
- Be specific about THIS bid, not generic advice
- If they ask about scores, explain what's driving them
- If they ask "should I bid", give a clear recommendation with reasoning
- Don't make up data - only use what's provided in context

Respond now:`;

                // Use backend API instead of direct Claude call
                const answer = await callAI('answer_question', prompt, 'You are a helpful AI assistant analyzing construction bid documents. Answer concisely and helpfully.');
                if (!answer || answer.trim() === '') {
                    throw new Error('Empty response from AI');
                }

                // Display the answer
                const answerHTML = answer
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n\n/g, '</p><p style="margin-bottom: 12px;">')
                    .replace(/\n/g, '<br>');

                responseDiv.innerHTML = `
                    <div style="display: flex; align-items: start; gap: 12px;">
                        <div style="font-size: 32px; line-height: 1;">💬</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 8px; color: var(--accent);">${advisorName} says:</div>
                            <div style="line-height: 1.6; color: var(--text-primary);">
                                <p style="margin-bottom: 12px;">${answerHTML}</p>
                            </div>
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); font-size: 12px; color: var(--text-muted);">
                                💬 This conversation is saved in your <a href="#" onclick="toggleAIChat(); return false;" style="color: var(--accent); text-decoration: underline;">chat history</a>
                            </div>
                        </div>
                    </div>
                `;

                // Add to chat history so it's preserved
                aiChatHistory.push({ role: 'user', content: question });
                aiChatHistory.push({ role: 'assistant', content: answer });

                // Clear input
                input.value = '';

            } catch (error) {
                console.error('❌ Ask Sam failed:', error);
                responseDiv.innerHTML = `
                    <div style="color: var(--danger);">
                        <strong>⚠️ Sorry, I couldn't answer that right now.</strong><br>
                        ${error.message}
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.innerHTML = `Ask ${(await getSettings()).ai_advisor_name || 'Sam'}`;
            }
        }

        function closeFullReport() {
            // Return to the previous view
            const previousTab = window.previousTab || 'dashboard';
            switchTab(previousTab);
        }

        function showOutcomeFromReport() {
            const projectId = document.getElementById('reportProjectId').value;
            if (projectId) {
                showOutcome(projectId);
            }
        }

        async function saveReportEdits() {
            const projectId = document.getElementById('reportProjectId').value;
            if (!projectId) return;

            const updatedData = {
                project_name: document.getElementById('reportProjectName').value,
                building_type: document.getElementById('reportBuildingType').value,
                city: document.getElementById('reportCity').value,
                state: document.getElementById('reportState').value.toUpperCase(),
                gc_names: reportGCList.map(gc => gc.name),
            };

            // Update analysis date if changed
            const analysisDate = document.getElementById('reportAnalysisDate').value;
            const createdAt = analysisDate ? new Date(analysisDate).toISOString() : null;

            try {
                // Update extracted data, building type, and GCs in projects table
                const { error: projectError } = await supabaseClient
                    .from('projects')
                    .update({
                        extracted_data: { ...window.currentReportProject.extracted, ...updatedData },
                        building_type: updatedData.building_type,
                        gcs: reportGCList,
                        created_at: createdAt || window.currentReportProject.createdAt
                    })
                    .eq('id', projectId);

                if (projectError) throw projectError;

                // GCs are already saved via reportGCList in the addGCFromReport function
                // No need to insert them again here since they're saved when added to the list

                // Clear cache and show success
                dataCache.projects = null;
                dataCache.gcDatabase = null;

                showBanner('✅ Project details saved successfully', 'success');

                // Reload the report with updated data
                await viewReport(projectId);

            } catch (error) {
                console.error('Error saving report edits:', error);
                showBanner('❌ Failed to save changes: ' + error.message, 'error');
            }
        }

        function showBanner(message, type = 'info') {
            const banner = document.createElement('div');
            banner.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : 'var(--accent)'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 500;
                animation: slideIn 0.3s ease-out;
            `;
            banner.textContent = message;
            document.body.appendChild(banner);

            setTimeout(() => {
                banner.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => banner.remove(), 300);
            }, 3000);
        }

        function showOutcome(id) {
            document.getElementById('outcomeProjectId').value = id;
            document.getElementById('outcomeType').value = '';
            document.getElementById('outcomeFields').innerHTML = '';
            openModal('outcomeModal');
        }

        function updateOutcomeFields() {
            const type = document.getElementById('outcomeType').value;
            let html = '';

            // Get project to pre-fill date
            const projectId = document.getElementById('outcomeProjectId').value;
            const project = allProjectsCache.find(p => p.id === projectId);
            const currentDate = project?.created_at ? new Date(project.created_at).toISOString().split('T')[0] : new Date().toISOString().split('T')[0];

            if (type === 'won') {
                html = `
                    <div class="form-group">
                        <label class="form-label">Bid Analysis Date</label>
                        <input type="date" class="form-input" id="outcomeDate" value="${currentDate}">
                        <div class="form-hint">When was this bid analyzed? You can backdate if needed.</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Final Bid Amount ($)</label>
                        <input type="number" class="form-input" id="outcomeAmount" placeholder="500000">
                        <div class="form-hint">Your bid amount, not the final contract amount</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Alternates ($)</label>
                        <input type="number" class="form-input" id="outcomeAlternates" placeholder="50000">
                        <div class="form-hint">Total value of alternates bid (if any)</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Final Margin (%)</label>
                        <input type="number" class="form-input" id="outcomeMargin" step="0.1" placeholder="12.5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">How competitive was your pricing?</label>
                        <select class="form-select" id="outcomeHowCompetitive">
                            <option value="">Select...</option>
                            <option value="lowest">We were the lowest bidder</option>
                            <option value="competitive">Competitively priced (within 5%)</option>
                            <option value="premium">Client paid premium to use us</option>
                            <option value="unknown">Unknown</option>
                        </select>
                        <div class="form-hint">Helps understand if you're leaving money on the table</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Decision Confidence</label>
                        <div class="confidence-slider" style="display:flex;gap:4px;margin-top:8px;">
                            ${[1,2,3,4,5].map(n => `<button type="button" class="conf-btn" data-val="${n}" onclick="setConfidence(${n})" style="width:40px;height:40px;border-radius:8px;border:2px solid var(--border-color);background:var(--bg-secondary);cursor:pointer;font-weight:600;">${n}</button>`).join('')}
                        </div>
                        <div class="form-hint">1 = Lucky win, 5 = Expected to win</div>
                        <input type="hidden" id="outcomeConfidence" value="3">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pricing & Win Feedback (helps AI learn for future bids)</label>
                        <textarea class="form-input" id="outcomePricingFeedback" rows="3" placeholder="e.g., 'GC said we won because of better healthcare experience' or 'Client valued our past work on similar projects'"></textarea>
                        <div class="form-hint">Share why you won - AI will learn from this for future recommendations</div>
                    </div>`;
            } else if (type === 'lost') {
                html = `
                    <div class="form-group">
                        <label class="form-label">Bid Analysis Date</label>
                        <input type="date" class="form-input" id="outcomeDate" value="${currentDate}">
                        <div class="form-hint">When was this bid analyzed? You can backdate if needed.</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">How high were you?</label>
                        <select class="form-select" id="outcomeHowHigh">
                            <option value="">Unknown</option>
                            <option>Within 5%</option>
                            <option>5-10% high</option>
                            <option>10-20% high</option>
                            <option>Over 20% high</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Who won?</label>
                        <input type="text" class="form-input" id="outcomeWinner" placeholder="Competitor name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Other competitors you usually lose to? (optional)</label>
                        <input type="text" class="form-input" id="outcomeOtherCompetitors" placeholder="e.g., ABC Electric, XYZ Mechanical">
                        <div class="form-hint">Separate names with commas</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Decision Confidence</label>
                        <div class="confidence-slider" style="display:flex;gap:4px;margin-top:8px;">
                            ${[1,2,3,4,5].map(n => `<button type="button" class="conf-btn" data-val="${n}" onclick="setConfidence(${n})" style="width:40px;height:40px;border-radius:8px;border:2px solid var(--border-color);background:var(--bg-secondary);cursor:pointer;font-weight:600;">${n}</button>`).join('')}
                        </div>
                        <div class="form-hint">1 = Surprised we lost, 5 = Expected to lose</div>
                        <input type="hidden" id="outcomeConfidence" value="3">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Why did you lose? (helps AI learn for future bids)</label>
                        <textarea class="form-input" id="outcomePricingFeedback" rows="3" placeholder="e.g., 'Winner had better healthcare experience' or 'GC said pricing was too high and winner offered value engineering'"></textarea>
                        <div class="form-hint">AI learns from this feedback - be specific about what the GC/client said</div>
                    </div>`;
            } else if (type === 'ghost') {
                html = `
                    <div class="form-group">
                        <label class="form-label">Bid Analysis Date</label>
                        <input type="date" class="form-input" id="outcomeDate" value="${currentDate}">
                        <div class="form-hint">When was this bid analyzed? You can backdate if needed.</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">GC Responsiveness Before Going Silent</label>
                        <div style="display:flex;gap:16px;margin-top:8px;">
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;">
                                <input type="checkbox" id="gcAcknowledged"> Acknowledged receipt
                            </label>
                            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px;">
                                <input type="checkbox" id="gcAnsweredQuestions"> Answered pre-bid questions
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Days since bid submission</label>
                        <input type="number" class="form-input" id="outcomeDaysSince" placeholder="60" value="60">
                    </div>
                    <div class="form-group" id="ghostedGCsContainer" style="display:none;">
                        <label class="form-label">Which GC(s) ghosted?</label>
                        <textarea class="form-input" id="outcomeGhostedGCs" rows="2" placeholder="e.g., Turner Construction, JE Dunn"></textarea>
                        <div class="form-hint">List which GCs stopped responding</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Decision Confidence</label>
                        <div class="confidence-slider" style="display:flex;gap:4px;margin-top:8px;">
                            ${[1,2,3,4,5].map(n => `<button type="button" class="conf-btn" data-val="${n}" onclick="setConfidence(${n})" style="width:40px;height:40px;border-radius:8px;border:2px solid var(--border-color);background:var(--bg-secondary);cursor:pointer;font-weight:600;">${n}</button>`).join('')}
                        </div>
                        <div class="form-hint">1 = Should have followed up more, 5 = Expected this response</div>
                        <input type="hidden" id="outcomeConfidence" value="3">
                    </div>`;
            } else if (type === 'declined') {
                html = `
                    <div class="form-group">
                        <label class="form-label">Bid Analysis Date</label>
                        <input type="date" class="form-input" id="outcomeDate" value="${currentDate}">
                        <div class="form-hint">When was this bid analyzed? You can backdate if needed.</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Why didn't you bid? (select all that apply)</label>
                        <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
                            <label class="reason-checkbox" style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px 12px;background:var(--bg-secondary);border-radius:var(--radius);font-size:13px;">
                                <input type="checkbox" value="too_many_gcs"> Too many GCs bidding
                            </label>
                            <label class="reason-checkbox" style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px 12px;background:var(--bg-secondary);border-radius:var(--radius);font-size:13px;">
                                <input type="checkbox" value="gc_relationship"> Weak GC relationship
                            </label>
                            <label class="reason-checkbox" style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px 12px;background:var(--bg-secondary);border-radius:var(--radius);font-size:13px;">
                                <input type="checkbox" value="bad_contract"> Bad contract terms
                            </label>
                            <label class="reason-checkbox" style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px 12px;background:var(--bg-secondary);border-radius:var(--radius);font-size:13px;">
                                <input type="checkbox" value="out_of_territory"> Out of territory
                            </label>
                            <label class="reason-checkbox" style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px 12px;background:var(--bg-secondary);border-radius:var(--radius);font-size:13px;">
                                <input type="checkbox" value="capacity"> At capacity / too busy
                            </label>
                            <label class="reason-checkbox" style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px 12px;background:var(--bg-secondary);border-radius:var(--radius);font-size:13px;">
                                <input type="checkbox" value="pricing"> Unlikely to win on price
                            </label>
                            <label class="reason-checkbox" style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px 12px;background:var(--bg-secondary);border-radius:var(--radius);font-size:13px;">
                                <input type="checkbox" value="scope_unclear"> Scope unclear
                            </label>
                            <label class="reason-checkbox" style="display:flex;align-items:center;gap:8px;cursor:pointer;padding:8px 12px;background:var(--bg-secondary);border-radius:var(--radius);font-size:13px;">
                                <input type="checkbox" value="other"> Other
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Additional notes (optional)</label>
                        <input type="text" class="form-input" id="outcomeDeclineNotes" placeholder="Any other context...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Decision Confidence</label>
                        <div class="confidence-slider" style="display:flex;gap:4px;margin-top:8px;">
                            ${[1,2,3,4,5].map(n => `<button type="button" class="conf-btn" data-val="${n}" onclick="setConfidence(${n})" style="width:40px;height:40px;border-radius:8px;border:2px solid var(--border-color);background:var(--bg-secondary);cursor:pointer;font-weight:600;">${n}</button>`).join('')}
                        </div>
                        <div class="form-hint">1 = Maybe should have bid, 5 = Definitely right to pass</div>
                        <input type="hidden" id="outcomeConfidence" value="3">
                    </div>`;
            }
            document.getElementById('outcomeFields').innerHTML = html;
            // Initialize confidence to 3
            setTimeout(() => setConfidence(3), 10);

            // For GHOST outcomes with multiple GCs, show the "which GCs ghosted" field
            if (type === 'ghost' && project?.gcs && project.gcs.length > 1) {
                setTimeout(() => {
                    const container = document.getElementById('ghostedGCsContainer');
                    if (container) {
                        container.style.display = 'block';
                        // Pre-populate with GC names as a hint
                        const gcNames = project.gcs.map(gc => gc.name).join(', ');
                        document.getElementById('outcomeGhostedGCs').placeholder = `e.g., ${gcNames}`;
                    }
                }, 20);
            }
        }
        
        function setConfidence(val) {
            document.getElementById('outcomeConfidence').value = val;
            document.querySelectorAll('.conf-btn').forEach(btn => {
                btn.style.background = parseInt(btn.dataset.val) <= val ? 'var(--accent)' : 'var(--bg-secondary)';
                btn.style.color = parseInt(btn.dataset.val) <= val ? 'white' : 'var(--text-primary)';
                btn.style.borderColor = parseInt(btn.dataset.val) <= val ? 'var(--accent)' : 'var(--border-color)';
            });
        }

        async function saveOutcome() {
            const id = document.getElementById('outcomeProjectId').value;
            const type = document.getElementById('outcomeType').value;
            if (!type) { alert('Please select an outcome'); return; }
            
            let outcomeData = {
                gcAcknowledged: document.getElementById('gcAcknowledged')?.checked || false,
                gcAnsweredQuestions: document.getElementById('gcAnsweredQuestions')?.checked || false,
                confidence: parseInt(document.getElementById('outcomeConfidence')?.value) || 3
            };
            
            if (type === 'won') {
                outcomeData.amount = document.getElementById('outcomeAmount')?.value;
                outcomeData.alternates = document.getElementById('outcomeAlternates')?.value;
                outcomeData.margin = document.getElementById('outcomeMargin')?.value;
                outcomeData.howCompetitive = document.getElementById('outcomeHowCompetitive')?.value;
                outcomeData.pricingFeedback = document.getElementById('outcomePricingFeedback')?.value;
                // Update GC wins
                const projects = await getProjects();
                const p = projects.find(x => x.id === id);
                if (p) {
                    const gcs = await getGCs();
                    for (const sg of p.gcs) {
                        const gc = gcs.find(g => g.name === sg.name);
                        if (gc) {
                            gc.wins = (gc.wins || 0) + 1;
                            await saveGC(gc);
                        }
                    }
                }
            } else if (type === 'lost') {
                outcomeData.howHigh = document.getElementById('outcomeHowHigh')?.value;
                outcomeData.winner = document.getElementById('outcomeWinner')?.value;
                outcomeData.otherCompetitors = document.getElementById('outcomeOtherCompetitors')?.value?.split(',').map(s => s.trim()).filter(Boolean) || [];
                outcomeData.pricingFeedback = document.getElementById('outcomePricingFeedback')?.value;
            } else if (type === 'ghost') {
                outcomeData.daysSince = parseInt(document.getElementById('outcomeDaysSince')?.value) || 60;
                outcomeData.ghostedGCs = document.getElementById('outcomeGhostedGCs')?.value;
            } else if (type === 'declined') {
                outcomeData.reasons = Array.from(document.querySelectorAll('.reason-checkbox input:checked')).map(cb => cb.value);
                outcomeData.notes = document.getElementById('outcomeDeclineNotes')?.value;
                if (outcomeData.reasons.length === 0) {
                    alert('Please select at least one reason for passing');
                    return;
                }
            }

            // Get the updated date if user changed it
            const updatedDate = document.getElementById('outcomeDate')?.value;

            try {
                await updateProjectOutcome(id, type, outcomeData);

                // Update the project date if changed
                if (updatedDate) {
                    const dateToSave = new Date(updatedDate).toISOString();
                    await supabaseClient.from('projects').update({
                        created_at: dateToSave
                    }).eq('id', id);
                    console.log('✅ Project date updated to:', dateToSave);
                }
                closeModal('outcomeModal');

                // Force cache clear and reload
                dataCache.projects = null;
                await loadProjects();
                await loadDashboard();

                // If we're on the report page, reload it
                const reportTab = document.getElementById('tab-report');
                if (reportTab && reportTab.style.display !== 'none') {
                    await viewReport(id);
                }

                console.log('✅ Outcome saved and UI refreshed');
            } catch (error) {
                console.error('❌ Failed to save outcome:', error);
                alert('Failed to save outcome: ' + error.message);
            }
        }

        async function deleteProjectUI(id) {
            if (!confirm('Delete this project?')) return;
            await deleteProject(id);
            await loadAll();
        }

        async function exportCSV() {
            const projects = await getProjects();
            if (!projects.length) { alert('No projects to export'); return; }
            const rows = [['Project', 'City', 'State', 'Score', 'Recommendation', 'GCs', 'Outcome', 'Date']];
            for (const p of projects) rows.push([p.extracted.project_name || '', p.extracted.project_city || '', p.extracted.project_state || '', p.scores.final, p.scores.recommendation, p.gcs.map(g => g.name).join('; '), p.outcome, p.createdAt?.split('T')[0] || '']);
            const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
            const a = document.createElement('a'); a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv); a.download = 'bidiq_export.csv'; a.click();
        }

        // GC Database
        const GC_TAG_LABELS = {
            // Positive tags
            fast_pay: '💵 Fast pay',
            fair_pricing: '✅ Fair pricing',
            good_communication: '💬 Great communication',
            repeat_customer: '🔄 Repeat customer',
            easy_to_work_with: '🤝 Easy to work with',
            fair_on_cos: '📝 Fair on COs',
            organized: '📋 Well organized',
            // Negative tags
            slow_pay: '💰 Slow pay',
            pay_if_paid: '📋 Pay-if-paid',
            change_order_hostile: '⚠️ CO hostile',
            bid_shopping: '🛒 Bid shopping',
            low_feedback: '🔇 Low feedback',
            scope_creep: '📈 Scope creep'
        };

        const POSITIVE_TAGS = ['fast_pay', 'fair_pricing', 'good_communication', 'repeat_customer', 'easy_to_work_with', 'fair_on_cos', 'organized'];
        const NEGATIVE_TAGS = ['slow_pay', 'pay_if_paid', 'change_order_hostile', 'bid_shopping', 'low_feedback', 'scope_creep'];

        // Backwards compatibility
        const RISK_TAG_LABELS = GC_TAG_LABELS;
        
        async function loadGCDatabase() {
            const gcs = await getGCs();
            if (!gcs.length) {
                document.getElementById('gcDatabaseList').innerHTML = '<div class="empty-state"><h3>No GCs yet</h3><p>Add your first general contractor</p><button class="btn btn-primary" onclick="showAddGCModal()">+ Add GC</button></div>';
                return;
            }
            document.getElementById('gcDatabaseList').innerHTML = gcs.map(gc => {
                const rate = gc.bids > 0 ? Math.round(gc.wins / gc.bids * 100) : null;
                const tagsHtml = (gc.riskTags || []).length > 0
                    ? `<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px;">${gc.riskTags.map(t => {
                        const isPositive = POSITIVE_TAGS.includes(t);
                        const color = isPositive ? 'var(--success)' : 'var(--danger)';
                        const bg = isPositive ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.15)';
                        return `<span style="font-size:10px;padding:2px 6px;background:${bg};color:${color};border-radius:4px;">${GC_TAG_LABELS[t] || t}</span>`;
                    }).join('')}</div>`
                    : '';
                return `<div class="gc-item">
                    <div class="gc-item-info">
                        <div class="gc-item-name">${gc.name}</div>
                        <div class="gc-item-stats">${gc.bids || 0} bids${rate !== null ? ' • ' + rate + '% win rate' : ''}</div>
                        ${tagsHtml}
                    </div>
                    <div class="gc-item-rating">${[1, 2, 3, 4, 5].map(i => `<span class="star ${i <= gc.rating ? 'filled' : ''}" onclick="rateGC('${gc.name.replace(/'/g, "\\'")}', ${i})">★</span>`).join('')}</div>
                    <button class="btn btn-sm btn-secondary" onclick="editGCTags('${gc.name.replace(/'/g, "\\'")}')" style="margin-left:8px;">Tags</button>
                    <button class="btn btn-sm btn-secondary" onclick="deleteGCUI('${gc.name.replace(/'/g, "\\'")}')" style="color:var(--danger);margin-left:4px;">×</button>
                </div>`;
            }).join('');
        }
        
        async function editGCTags(name) {
            const gcs = await getGCs();
            const gc = gcs.find(g => g.name === name);
            if (!gc) return;
            
            const currentTags = gc.riskTags || [];

            const positiveTagsHtml = POSITIVE_TAGS.map(val =>
                `<label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 10px;background:var(--bg-secondary);border-radius:var(--radius);font-size:12px;border:1px solid var(--border-color);">
                    <input type="checkbox" value="${val}" class="editGCTag" ${currentTags.includes(val) ? 'checked' : ''}> ${GC_TAG_LABELS[val]}
                </label>`
            ).join('');

            const negativeTagsHtml = NEGATIVE_TAGS.map(val =>
                `<label style="display:flex;align-items:center;gap:6px;cursor:pointer;padding:6px 10px;background:var(--bg-secondary);border-radius:var(--radius);font-size:12px;border:1px solid var(--border-color);">
                    <input type="checkbox" value="${val}" class="editGCTag" ${currentTags.includes(val) ? 'checked' : ''}> ${GC_TAG_LABELS[val]}
                </label>`
            ).join('');
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.id = 'editTagsModal';
            modal.innerHTML = `
                <div class="modal" style="max-width:500px;">
                    <div class="modal-header"><h3 class="modal-title">Edit Tags: ${name}</h3><button class="modal-close" onclick="closeModal('editTagsModal');document.getElementById('editTagsModal').remove();">×</button></div>
                    <div class="modal-body">
                        <div style="margin-bottom:16px;">
                            <div style="font-weight:600;margin-bottom:8px;color:var(--success);display:flex;align-items:center;gap:6px;">
                                ✓ Positive Tags
                            </div>
                            <div style="display:flex;flex-wrap:wrap;gap:8px;">${positiveTagsHtml}</div>
                        </div>
                        <div>
                            <div style="font-weight:600;margin-bottom:8px;color:var(--danger);display:flex;align-items:center;gap:6px;">
                                ⚠️ Risk Tags
                            </div>
                            <div style="display:flex;flex-wrap:wrap;gap:8px;">${negativeTagsHtml}</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeModal('editTagsModal');document.getElementById('editTagsModal').remove();">Cancel</button>
                        <button class="btn btn-primary" onclick="saveGCTags('${name.replace(/'/g, "\\'")}')">Save Tags</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);
        }
        
        async function saveGCTags(name) {
            const gcs = await getGCs();
            const gc = gcs.find(g => g.name === name);
            if (!gc) return;
            
            gc.riskTags = Array.from(document.querySelectorAll('.editGCTag:checked')).map(cb => cb.value);
            await saveGC(gc);
            
            document.getElementById('editTagsModal')?.remove();
            await loadGCDatabase();
        }

        async function showAddGCModal() {
            document.getElementById('newGCName').value = '';
            document.getElementById('newGCLocation').value = '';
            // Clear risk tags
            document.querySelectorAll('.gcRiskTag').forEach(cb => cb.checked = false);
            const settings = await getSettings();
            newGCRatingValue = settings.defaultStars;
            renderNewGCRating();
            openModal('addGCModal');
        }

        function renderNewGCRating() {
            document.getElementById('newGCRating').innerHTML = [1, 2, 3, 4, 5].map(i => `<span class="star ${i <= newGCRatingValue ? 'filled' : ''}" onclick="setNewGCRating(${i})">★</span>`).join('');

            // Update rating label
            const labels = {
                1: '⭐ Poor - Avoid if possible',
                2: '⭐⭐ Fair - Proceed with caution',
                3: '⭐⭐⭐ Good - Decent GC to work with',
                4: '⭐⭐⭐⭐ Great - Reliable and professional',
                5: '⭐⭐⭐⭐⭐ Excellent - Top tier partner!'
            };
            const labelEl = document.getElementById('ratingLabel');
            if (labelEl) {
                labelEl.textContent = labels[newGCRatingValue] || '';
                labelEl.style.fontWeight = '600';
                labelEl.style.color = newGCRatingValue >= 4 ? 'var(--success)' : newGCRatingValue <= 2 ? 'var(--danger)' : 'var(--warning)';
            }
        }

        function setNewGCRating(r) {
            newGCRatingValue = r;
            renderNewGCRating();
        }

        async function saveNewGC(rateLater = false) {
            const name = document.getElementById('newGCName').value.trim();
            const loc = document.getElementById('newGCLocation').value.trim();
            const clientType = document.getElementById('newClientType')?.value || 'general_contractor';

            if (!name) {
                alert('Please enter the client name');
                return;
            }

            // If rating later, set to default 3 stars and show notification
            let rating = newGCRatingValue;
            if (rateLater) {
                const settings = await getSettings();
                rating = settings.defaultStars || 3;
                showNotification(`Client added with default ${rating}-star rating. You can update it anytime from the Clients tab.`, 'info');
            }
            const fullName = loc ? `${name} - ${loc}` : name;
            const clients = await getClients();
            if (clients.find(c => c.name.toLowerCase() === fullName.toLowerCase())) {
                alert('This client already exists');
                return;
            }

            // Capture risk tags
            const riskTags = Array.from(document.querySelectorAll('.gcRiskTag:checked')).map(cb => cb.value);

            await saveClient({ name: fullName, clientType: clientType, rating: rating, bids: 0, wins: 0, riskTags });
            closeModal('addGCModal');

            // Show success notification
            if (!rateLater) {
                const clientTypeLabel = {
                    'general_contractor': 'General Contractor',
                    'subcontractor': 'Subcontractor',
                    'end_user': 'End User',
                    'building_owner': 'Building Owner',
                    'municipality': 'Municipality',
                    'distributor': 'Distributor',
                    'manufacturer_rep': 'Manufacturer Rep'
                }[clientType] || 'Client';
                showNotification(`${name} added as ${clientTypeLabel} with ${rating}-star rating!`, 'success');
            }

            await loadGCDatabase();
            await renderGCSelector();
        }

        // Wrapper function for new UI
        async function showAddClientModal() {
            return await showAddGCModal();
        }

        async function rateGC(name, rating) {
            const gcs = await getGCs();
            const gc = gcs.find(g => g.name === name);
            if (gc) { 
                gc.rating = rating; 
                await saveGC(gc);
                await loadGCDatabase(); 
            }
        }

        async function deleteGCUI(name) {
            if (!confirm('Delete ' + name + '?')) return;
            const gcs = await getGCs();
            const gc = gcs.find(g => g.name === name);
            if (gc && gc.id) {
                await deleteGC(gc.id);
            }
            await loadGCDatabase();
            await renderGCSelector();
        }

        // Keywords - FIXED
        async function loadKeywords() {
            const kw = await getKeywords();
            document.getElementById('goodKeywordsList').innerHTML = kw.good.map(k => `<span class="keyword-tag good">${k}<span class="remove" onclick="removeKeyword('good','${k.replace(/'/g, "\\'")}')">×</span></span>`).join('') || '<span style="color:var(--text-muted);font-size:12px;">No good keywords yet</span>';
            document.getElementById('badKeywordsList').innerHTML = kw.bad.map(k => `<span class="keyword-tag bad">${k}<span class="remove" onclick="removeKeyword('bad','${k.replace(/'/g, "\\'")}')">×</span></span>`).join('') || '<span style="color:var(--text-muted);font-size:12px;">No risk keywords yet</span>';
        }

        // Add good keyword(s) - supports comma-separated input
        async function addGoodKeyword() {
            const input = document.getElementById('goodKeywordInput');
            const rawVal = input.value.trim();
            if (!rawVal) { alert('Please enter a keyword'); return; }
            
            // Split by comma for multiple keywords
            const keywords = rawVal.split(',').map(k => k.trim().toLowerCase()).filter(k => k.length > 0);
            if (keywords.length === 0) { alert('Please enter a keyword'); return; }
            
            const kw = await getKeywords();
            let added = 0;
            for (const val of keywords) {
                if (!kw.good.includes(val)) {
                    kw.good.push(val);
                    added++;
                }
            }
            
            if (added > 0) {
                await saveKeywordsStorage(kw);
                await loadKeywords();
            }
            input.value = '';
            input.focus();
        }

        // Add bad keyword(s) - supports comma-separated input
        async function addBadKeyword() {
            const input = document.getElementById('badKeywordInput');
            const rawVal = input.value.trim();
            if (!rawVal) { alert('Please enter a keyword'); return; }
            
            // Split by comma for multiple keywords
            const keywords = rawVal.split(',').map(k => k.trim().toLowerCase()).filter(k => k.length > 0);
            if (keywords.length === 0) { alert('Please enter a keyword'); return; }
            
            const kw = await getKeywords();
            let added = 0;
            for (const val of keywords) {
                if (!kw.bad.includes(val)) {
                    kw.bad.push(val);
                    added++;
                }
            }
            
            if (added > 0) {
                await saveKeywordsStorage(kw);
                await loadKeywords();
            }
            input.value = '';
            input.focus();
        }

        async function removeKeyword(type, val) {
            const kw = await getKeywords();
            kw[type] = kw[type].filter(k => k !== val);
            await saveKeywordsStorage(kw);
            await loadKeywords();
        }

        // Google Maps Autocomplete
        let addressAutocomplete = null;

        function initGoogleMaps() {
            console.log('🗺️ Google Maps API loaded');
            // Autocomplete will be initialized when Settings tab is opened
        }

        function initAddressAutocomplete() {
            console.log('🗺️ Initializing address autocomplete...');

            if (!window.google || !window.google.maps || !window.google.maps.places) {
                console.warn('⚠️ Google Maps Places API not loaded yet - retrying in 1 second...');
                setTimeout(initAddressAutocomplete, 1000);
                return;
            }

            const input = document.getElementById('settingStreet');
            if (!input) {
                console.warn('⚠️ settingStreet input not found - retrying in 500ms...');
                setTimeout(initAddressAutocomplete, 500);
                return;
            }

            try {
                // Create autocomplete object
                addressAutocomplete = new google.maps.places.Autocomplete(input, {
                    types: ['address'],
                    componentRestrictions: { country: 'us' }
                });

                console.log('✅ Google Maps autocomplete initialized');

                // Listen for place selection
                addressAutocomplete.addListener('place_changed', () => {
                    const place = addressAutocomplete.getPlace();

                    if (!place.address_components) {
                        console.warn('No address components in selected place');
                        return;
                    }

                    // Parse address components
                    let street = '';
                    let city = '';
                    let state = '';
                    let zip = '';

                    for (const component of place.address_components) {
                        const types = component.types;

                        if (types.includes('street_number')) {
                            street = component.long_name + ' ';
                        } else if (types.includes('route')) {
                            street += component.long_name;
                        } else if (types.includes('locality')) {
                            city = component.long_name;
                        } else if (types.includes('administrative_area_level_1')) {
                            state = component.short_name;
                        } else if (types.includes('postal_code')) {
                            zip = component.long_name;
                        }
                    }

                    // Auto-fill the form fields
                    if (street) document.getElementById('settingStreet').value = street.trim();
                    if (city) document.getElementById('settingCity').value = city;
                    if (state) document.getElementById('settingState').value = state;
                    if (zip) document.getElementById('settingZip').value = zip;

                    console.log('✅ Address autocompleted:', { street, city, state, zip });
                });
            } catch (error) {
                console.error('❌ Error initializing autocomplete:', error);
            }
        }

        // Settings
        async function loadSettings() {
            const s = await getSettings();

            // Initialize product lines for settings management
            settingsProductLines = s.productLines || [];

            if (document.getElementById('settingStreet')) document.getElementById('settingStreet').value = s.street || '';
            document.getElementById('settingCity').value = s.city || '';
            document.getElementById('settingState').value = s.state || '';
            if (document.getElementById('settingZip')) document.getElementById('settingZip').value = s.zip || '';
            document.getElementById('settingRadius').value = s.radius;
            document.getElementById('settingLocationMatters').checked = s.locationMatters;
            document.getElementById('settingRiskTolerance').value = s.riskTolerance;
            document.getElementById('settingCapacity').value = s.capacity;
            document.getElementById('settingDecisionTime').value = s.decisionTime;
            document.getElementById('settingDefaultStars').value = s.defaultStars;

            // AI Advisor settings
            const aiAdvisorName = s.ai_advisor_name || 'Sam';
            const aiAdvisorNameSelect = document.getElementById('settingAiAdvisorName');
            const customNameGroup = document.getElementById('customAdvisorNameGroup');
            const customNameInput = document.getElementById('settingCustomAdvisorName');

            const presetNames = ['Sam', 'Scout', 'Jake', 'Alex', 'Taylor'];
            if (presetNames.includes(aiAdvisorName)) {
                aiAdvisorNameSelect.value = aiAdvisorName;
                customNameGroup.style.display = 'none';
            } else {
                aiAdvisorNameSelect.value = 'Custom';
                customNameGroup.style.display = 'block';
                customNameInput.value = aiAdvisorName;
            }

            document.getElementById('settingAiAdvisorTone').value = s.ai_advisor_tone || 'supportive';

            // Add change listener for advisor name dropdown
            aiAdvisorNameSelect.addEventListener('change', function() {
                if (this.value === 'Custom') {
                    customNameGroup.style.display = 'block';
                    customNameInput.focus();
                } else {
                    customNameGroup.style.display = 'none';
                }
            });

            document.querySelector('#weightLocation input').value = s.weights.location;
            document.querySelector('#weightLocation .weight-slider-value').textContent = s.weights.location + '%';
            document.querySelector('#weightKeywords input').value = s.weights.keywords;
            document.querySelector('#weightKeywords .weight-slider-value').textContent = s.weights.keywords + '%';
            document.querySelector('#weightGC input').value = s.weights.gc;
            document.querySelector('#weightGC .weight-slider-value').textContent = s.weights.gc + '%';
            document.querySelector('#weightTrade input').value = s.weights.trade;
            document.querySelector('#weightTrade .weight-slider-value').textContent = s.weights.trade + '%';
            updateWeightTotal();

            // Render Trades or Product Lines based on company type
            const tradesContainer = document.getElementById('tradesCheckboxes');

            if (s.companyType === 'subcontractor') {
                // CSI Divisions - SORTED
                tradesContainer.innerHTML = CSI_DIVISIONS.map(([code, name]) =>
                    `<label class="checkbox-item ${s.trades.includes(code) ? 'selected' : ''}"><input type="checkbox" value="${code}" ${s.trades.includes(code) ? 'checked' : ''}><span class="check"></span>${code}: ${name}</label>`
                ).join('');

                tradesContainer.querySelectorAll('.checkbox-item').forEach(el => {
                    const cb = el.querySelector('input');
                    cb.addEventListener('change', () => {
                        el.classList.toggle('selected', cb.checked);
                    });
                });
            } else {
                // Product Lines for Distributors/Mfg Reps
                const productLines = s.productLines || [];
                const productCategories = s.productCategories || [];

                tradesContainer.innerHTML = `
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Product Lines / Brands</label>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <input type="text" id="settingProductLineInput" placeholder="e.g., Eaton, Square D, Lutron" class="form-input" style="flex: 1;">
                            <button onclick="addSettingsProductLine()" class="btn btn-secondary">+ Add</button>
                        </div>
                        <div id="settingsProductLinesList" style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${productLines.map(line => `
                                <div style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--bg-secondary); border-radius: var(--radius); font-size: 13px;">
                                    <span>${line}</span>
                                    <button onclick="removeSettingsProductLine('${line.replace(/'/g, "\\'")}')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 2px; font-size: 16px; line-height: 1;">×</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Product Categories</label>
                        <select id="settingProductCategories" multiple size="6" class="form-select" style="width: 100%;">
                            <option value="electrical" ${productCategories.includes('electrical') ? 'selected' : ''}>Electrical Equipment</option>
                            <option value="lighting" ${productCategories.includes('lighting') ? 'selected' : ''}>Lighting</option>
                            <option value="hvac" ${productCategories.includes('hvac') ? 'selected' : ''}>HVAC Equipment</option>
                            <option value="plumbing" ${productCategories.includes('plumbing') ? 'selected' : ''}>Plumbing Fixtures</option>
                            <option value="flooring" ${productCategories.includes('flooring') ? 'selected' : ''}>Flooring</option>
                            <option value="security" ${productCategories.includes('security') ? 'selected' : ''}>Security/Access Control</option>
                            <option value="fire_alarm" ${productCategories.includes('fire_alarm') ? 'selected' : ''}>Fire Alarm</option>
                            <option value="controls" ${productCategories.includes('controls') ? 'selected' : ''}>Controls/BAS</option>
                        </select>
                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Hold Ctrl/Cmd to select multiple</div>
                    </div>
                `;
            }

            // Update settings card title and description based on company type
            const tradesCard = tradesContainer.closest('.settings-card');
            if (tradesCard) {
                const titleEl = tradesCard.querySelector('.settings-card-title');
                const descEl = tradesCard.querySelector('.settings-card-description');

                if (s.companyType === 'subcontractor') {
                    titleEl.textContent = '🔧 Your Trades';
                    descEl.textContent = 'Select the CSI divisions you work in. BidIntell searches bid docs for these divisions to calculate your Trade Match score.';
                } else if (s.companyType === 'distributor') {
                    titleEl.textContent = '📦 Your Product Lines';
                    descEl.textContent = 'Add the brands and product lines you distribute. BidIntell will detect when these products are specified in bid documents.';
                } else {
                    titleEl.textContent = '🏭 Your Product Lines';
                    descEl.textContent = 'Add the manufacturer brands you represent. BidIntell will identify projects where your products are specified or approved.';
                }
            }

            // Update weight slider label based on company type
            const tradeWeightLabel = document.querySelector('#weightTrade .weight-slider-label');
            if (tradeWeightLabel) {
                if (s.companyType === 'subcontractor') {
                    tradeWeightLabel.textContent = '🔧 Trade Match';
                } else {
                    tradeWeightLabel.textContent = '📦 Product Match';
                }
            }

            // Update weight hint based on company type
            const tradeWeightHint = document.querySelector('#weightTrade .weight-slider-hint');
            if (tradeWeightHint) {
                if (s.companyType === 'subcontractor') {
                    tradeWeightHint.textContent = 'How important is it that your specific trades appear in the specs?';
                } else {
                    tradeWeightHint.textContent = 'How important is it that your products are specified in bid documents?';
                }
            }

            // Initialize Google Places Autocomplete
            setTimeout(() => initAddressAutocomplete(), 500);
        }

        // Product line management for settings
        let settingsProductLines = [];

        async function addSettingsProductLine() {
            const input = document.getElementById('settingProductLineInput');
            const line = input?.value.trim();
            if (line && !settingsProductLines.includes(line)) {
                settingsProductLines.push(line);
                input.value = '';
                await loadSettings(); // Reload to show updated list
            }
        }

        async function removeSettingsProductLine(line) {
            settingsProductLines = settingsProductLines.filter(l => l !== line);
            await loadSettings(); // Reload to show updated list
        }

        function updateWeightTotal() {
            const l = parseInt(document.querySelector('#weightLocation input').value) || 0;
            const k = parseInt(document.querySelector('#weightKeywords input').value) || 0;
            const g = parseInt(document.querySelector('#weightGC input').value) || 0;
            const t = parseInt(document.querySelector('#weightTrade input').value) || 0;
            const total = l + k + g + t;
            const el = document.getElementById('weightTotal');
            const warning = document.getElementById('weightWarning');
            el.textContent = total + '%';
            el.className = 'weight-total-value ' + (total === 100 ? 'valid' : 'invalid');
            warning.style.display = total === 100 ? 'none' : 'inline';
        }

        document.querySelectorAll('.weight-slider input').forEach(input => {
            input.addEventListener('input', () => {
                input.closest('.weight-slider').querySelector('.weight-slider-value').textContent = input.value + '%';
                updateWeightTotal();
            });
        });

        async function saveSettings() {
            const currentSettings = await getSettings();

            const weights = {
                location: parseInt(document.querySelector('#weightLocation input').value) || 0,
                keywords: parseInt(document.querySelector('#weightKeywords input').value) || 0,
                gc: parseInt(document.querySelector('#weightGC input').value) || 0,
                trade: parseInt(document.querySelector('#weightTrade input').value) || 0
            };
            const total = weights.location + weights.keywords + weights.gc + weights.trade;
            if (total !== 100) { alert('Score weights must total exactly 100%. Currently: ' + total + '%'); return; }

            // Build settings object based on company type
            const s = {
                company_type: currentSettings.companyType,
                provides_installation: currentSettings.providesInstallation,
                street: document.getElementById('settingStreet')?.value.trim() || null,
                city: document.getElementById('settingCity').value.trim(),
                state: document.getElementById('settingState').value.trim().toUpperCase(),
                zip: document.getElementById('settingZip')?.value.trim() || null,
                radius: parseInt(document.getElementById('settingRadius').value),
                locationMatters: document.getElementById('settingLocationMatters').checked,
                riskTolerance: document.getElementById('settingRiskTolerance').value,
                capacity: document.getElementById('settingCapacity').value,
                decisionTime: parseInt(document.getElementById('settingDecisionTime').value) || 45,
                defaultStars: parseInt(document.getElementById('settingDefaultStars').value),
                ai_advisor_name: document.getElementById('settingAiAdvisorName').value === 'Custom'
                    ? document.getElementById('settingCustomAdvisorName').value.trim() || 'Sam'
                    : document.getElementById('settingAiAdvisorName').value,
                ai_advisor_tone: document.getElementById('settingAiAdvisorTone').value,
                weights
            };

            // Add trades or product lines based on company type
            if (currentSettings.companyType === 'subcontractor') {
                const selectedTrades = Array.from(document.querySelectorAll('#tradesCheckboxes input:checked')).map(cb => cb.value);
                console.log('Selected trades:', selectedTrades);
                s.trades = selectedTrades;
                s.product_lines = [];
                s.product_categories = [];
            } else {
                // Save product lines and categories for distributors/mfg reps
                const categoriesSelect = document.getElementById('settingProductCategories');
                const selectedCategories = categoriesSelect ? Array.from(categoriesSelect.selectedOptions).map(opt => opt.value) : [];

                console.log('Product lines:', settingsProductLines);
                console.log('Product categories:', selectedCategories);

                s.trades = [];
                s.product_lines = settingsProductLines;
                s.product_categories = selectedCategories;
            }

            try {
                await saveSettingsStorage(s);
                await updateCapacity();
                // Reload settings from database to confirm they were saved
                dataCache.settings = null;
                await loadSettings();
                alert('✓ Settings saved to cloud!');
            } catch (e) {
                alert('❌ Error saving settings: ' + e.message);
            }
        }

        // ============================================
        // ANALYTICS & LEARNING FUNCTIONS
        // ============================================

        function calculatePredictionAccuracy(projects) {
            const withOutcomes = projects.filter(p => p.outcome && p.outcome !== 'pending' && p.scores?.final);
            if (withOutcomes.length === 0) return null;

            const results = {
                total: withOutcomes.length,
                byScore: { go: { total: 0, won: 0 }, review: { total: 0, won: 0 }, pass: { total: 0, won: 0 } },
                byOutcome: { won: 0, lost: 0, ghost: 0, declined: 0 }
            };

            withOutcomes.forEach(p => {
                const score = p.scores.final;
                const outcome = p.outcome;

                // Track outcomes
                results.byOutcome[outcome]++;

                // Track by score bucket
                const bucket = score >= 80 ? 'go' : score >= 60 ? 'review' : 'pass';
                results.byScore[bucket].total++;
                if (outcome === 'won') results.byScore[bucket].won++;
            });

            return results;
        }

        function calculateUserFeedback(projects) {
            const withFeedback = projects.filter(p => p.user_agreement && p.user_agreement !== 'agree');
            const total = projects.filter(p => p.scores?.final).length;

            return {
                total,
                disagreements: withFeedback.length,
                tooHigh: withFeedback.filter(p => p.user_agreement === 'too_high').length,
                tooLow: withFeedback.filter(p => p.user_agreement === 'too_low').length,
                agreementRate: total > 0 ? ((total - withFeedback.length) / total * 100).toFixed(1) : 0
            };
        }

        function calculateCalibration(projects) {
            const byOutcome = projects.filter(p => p.outcome && p.outcome !== 'pending' && p.scores?.final);
            if (byOutcome.length === 0) return null;

            const groups = { won: [], lost: [], ghost: [], declined: [] };
            byOutcome.forEach(p => groups[p.outcome].push(p.scores.final));

            return {
                avgScoreWon: groups.won.length > 0 ? (groups.won.reduce((a,b) => a+b, 0) / groups.won.length).toFixed(1) : 0,
                avgScoreLost: groups.lost.length > 0 ? (groups.lost.reduce((a,b) => a+b, 0) / groups.lost.length).toFixed(1) : 0,
                avgScoreGhost: groups.ghost.length > 0 ? (groups.ghost.reduce((a,b) => a+b, 0) / groups.ghost.length).toFixed(1) : 0,
                avgScoreDeclined: groups.declined.length > 0 ? (groups.declined.reduce((a,b) => a+b, 0) / groups.declined.length).toFixed(1) : 0
            };
        }

        function generateRecommendations(accuracy, feedback, calibration) {
            const recommendations = [];

            if (!accuracy || accuracy.total < 5) {
                return ['<div class="help-text">📊 Complete at least 5 projects with outcomes to see AI recommendations.</div>'];
            }

            // Check prediction accuracy
            const goWinRate = accuracy.byScore.go.total > 0 ? (accuracy.byScore.go.won / accuracy.byScore.go.total * 100) : 0;
            const passWinRate = accuracy.byScore.pass.total > 0 ? (accuracy.byScore.pass.won / accuracy.byScore.pass.total * 100) : 0;

            if (goWinRate < 50 && accuracy.byScore.go.total >= 3) {
                recommendations.push({
                    type: 'warning',
                    title: 'Low Win Rate on GO Recommendations',
                    message: `You're winning only ${goWinRate.toFixed(0)}% of GO-scored bids. The algorithm may be too optimistic. Consider increasing your score thresholds or adjusting component weights.`
                });
            }

            if (passWinRate > 20 && accuracy.byScore.pass.total >= 3) {
                recommendations.push({
                    type: 'warning',
                    title: 'Missing Opportunities',
                    message: `You won ${passWinRate.toFixed(0)}% of PASS-scored bids. The algorithm may be too conservative. You might be passing on winnable projects.`
                });
            }

            // Check user feedback
            if (feedback && feedback.disagreements > 0) {
                const disagreeRate = (feedback.disagreements / feedback.total * 100);
                if (disagreeRate > 30) {
                    recommendations.push({
                        type: 'info',
                        title: 'Frequent Score Disagreements',
                        message: `You disagree with ${disagreeRate.toFixed(0)}% of scores (${feedback.tooHigh} too high, ${feedback.tooLow} too low). Consider adjusting component weights in Settings to better match your preferences.`
                    });
                }
            }

            // Check calibration
            if (calibration && calibration.avgScoreWon && calibration.avgScoreLost) {
                const wonScore = parseFloat(calibration.avgScoreWon);
                const lostScore = parseFloat(calibration.avgScoreLost);

                if (wonScore - lostScore < 10) {
                    recommendations.push({
                        type: 'warning',
                        title: 'Poor Score Separation',
                        message: `Average score for won bids (${wonScore}) is close to lost bids (${lostScore}). The algorithm isn't differentiating well. Check if your keyword lists and GC ratings are accurate.`
                    });
                }
            }

            if (recommendations.length === 0) {
                recommendations.push({
                    type: 'success',
                    title: 'Scores Looking Good!',
                    message: 'Your prediction accuracy is solid and scores align with outcomes. Keep tracking results to further refine the algorithm.'
                });
            }

            return recommendations;
        }

        // Store chart instances to destroy before re-rendering
        let chartInstances = {
            winRateTrend: null,
            bidVolume: null,
            buildingType: null
        };

        // Generate Win Rate Trend Chart
        function renderWinRateTrendChart(projects) {
            const canvas = document.getElementById('winRateTrendChart');
            if (!canvas) return;

            // Group projects by month
            const monthlyData = {};
            projects.forEach(p => {
                if (!p.outcome || p.outcome === 'pending') return;

                const date = new Date(p.created_at);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { total: 0, won: 0 };
                }

                monthlyData[monthKey].total++;
                if (p.outcome === 'won') monthlyData[monthKey].won++;
            });

            // Sort by month and calculate win rates
            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(m => {
                const [year, month] = m.split('-');
                return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });
            const winRates = sortedMonths.map(m => {
                const data = monthlyData[m];
                return data.total > 0 ? (data.won / data.total * 100).toFixed(1) : 0;
            });

            // Destroy previous chart
            if (chartInstances.winRateTrend) chartInstances.winRateTrend.destroy();

            // Create new chart
            const ctx = canvas.getContext('2d');
            chartInstances.winRateTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Win Rate %',
                        data: winRates,
                        borderColor: 'rgb(52, 211, 153)',
                        backgroundColor: 'rgba(52, 211, 153, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const monthKey = sortedMonths[context.dataIndex];
                                    const data = monthlyData[monthKey];
                                    return `Win Rate: ${context.parsed.y}% (${data.won}/${data.total} bids)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { callback: value => value + '%' }
                        }
                    }
                }
            });
        }

        // Generate Bid Volume Chart
        function renderBidVolumeChart(projects) {
            const canvas = document.getElementById('bidVolumeChart');
            if (!canvas) return;

            // Group by month
            const monthlyVolume = {};
            projects.forEach(p => {
                const date = new Date(p.created_at);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyVolume[monthKey] = (monthlyVolume[monthKey] || 0) + 1;
            });

            const sortedMonths = Object.keys(monthlyVolume).sort();
            const labels = sortedMonths.map(m => {
                const [year, month] = m.split('-');
                return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            });
            const volumes = sortedMonths.map(m => monthlyVolume[m]);

            // Destroy previous chart
            if (chartInstances.bidVolume) chartInstances.bidVolume.destroy();

            const ctx = canvas.getContext('2d');
            chartInstances.bidVolume = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Bids Analyzed',
                        data: volumes,
                        backgroundColor: 'rgba(99, 102, 241, 0.7)',
                        borderColor: 'rgb(99, 102, 241)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        // Generate Top/Worst GC Tables
        async function renderGCPerformanceTables(projects) {
            // Get all GCs
            const gcs = await getGCs();
            if (!gcs || gcs.length === 0) {
                document.getElementById('topGCsTable').innerHTML = '<div class="help-text">No GC data available yet.</div>';
                document.getElementById('worstGCsTable').innerHTML = '<div class="help-text">No GC data available yet.</div>';
                return;
            }

            // Calculate performance for each GC
            const gcStats = gcs.map(gc => {
                const gcProjects = projects.filter(p => {
                    const extracted = p.extracted_data || p.extracted;
                    return extracted && extracted.general_contractor === gc.name;
                });

                const total = gcProjects.length;
                const won = gcProjects.filter(p => p.outcome === 'won').length;
                const lost = gcProjects.filter(p => p.outcome === 'lost').length;
                const ghost = gcProjects.filter(p => p.outcome === 'ghost').length;
                const declined = gcProjects.filter(p => p.outcome === 'declined').length;
                const winRate = total > 0 ? (won / total * 100).toFixed(1) : 0;
                const ghostRate = total > 0 ? ((ghost + declined) / total * 100).toFixed(1) : 0;

                return { name: gc.name, total, won, lost, ghost, declined, winRate: parseFloat(winRate), ghostRate: parseFloat(ghostRate) };
            }).filter(stat => stat.total >= 3); // Minimum 3 bids

            // Sort for top performers (high win rate)
            const topGCs = [...gcStats].sort((a, b) => b.winRate - a.winRate).slice(0, 5);

            // Sort for worst performers (high ghost rate)
            const worstGCs = [...gcStats].sort((a, b) => b.ghostRate - a.ghostRate).slice(0, 5);

            // Render Top GCs
            if (topGCs.length > 0) {
                document.getElementById('topGCsTable').innerHTML = `
                    <table style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border); text-align: left;">
                                <th style="padding: 12px;">GC Name</th>
                                <th style="padding: 12px; text-align: center;">Total Bids</th>
                                <th style="padding: 12px; text-align: center;">Won</th>
                                <th style="padding: 12px; text-align: center;">Win Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${topGCs.map((gc, i) => `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 12px;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 20px;">${i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : '🏅'}</span>
                                            <strong>${gc.name}</strong>
                                        </div>
                                    </td>
                                    <td style="padding: 12px; text-align: center;">${gc.total}</td>
                                    <td style="padding: 12px; text-align: center; color: var(--success);">${gc.won}</td>
                                    <td style="padding: 12px; text-align: center;">
                                        <strong style="color: var(--success);">${gc.winRate}%</strong>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                document.getElementById('topGCsTable').innerHTML = '<div class="help-text">Need at least 3 bids with outcomes per GC to show performance rankings.</div>';
            }

            // Render Worst GCs
            if (worstGCs.length > 0 && worstGCs[0].ghostRate > 0) {
                document.getElementById('worstGCsTable').innerHTML = `
                    <table style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border); text-align: left;">
                                <th style="padding: 12px;">GC Name</th>
                                <th style="padding: 12px; text-align: center;">Total Bids</th>
                                <th style="padding: 12px; text-align: center;">Ghosted</th>
                                <th style="padding: 12px; text-align: center;">Ghost Rate</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${worstGCs.map(gc => `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 12px;"><strong>${gc.name}</strong></td>
                                    <td style="padding: 12px; text-align: center;">${gc.total}</td>
                                    <td style="padding: 12px; text-align: center; color: var(--text-muted);">${gc.ghost + gc.declined}</td>
                                    <td style="padding: 12px; text-align: center;">
                                        <strong style="color: var(--danger);">${gc.ghostRate}%</strong>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                document.getElementById('worstGCsTable').innerHTML = '<div class="help-text">No ghost/decline data available yet.</div>';
            }
        }

        // Generate Client Type Performance Analysis
        async function renderClientTypePerformance(projects) {
            const container = document.getElementById('clientTypePerformance');
            if (!container) return;

            // Get all GCs/clients with their types
            const gcs = await getGCs();
            if (!gcs || gcs.length === 0) {
                container.innerHTML = '<div class="help-text">No client data available yet. Add clients in the GC Manager tab.</div>';
                return;
            }

            // Map client type codes to labels
            const clientTypeLabels = {
                'gc': 'General Contractors',
                'subcontractor': 'Subcontractors',
                'developer': 'Developers',
                'municipality': 'Municipalities'
            };

            // Calculate performance by client type
            const clientTypeStats = {};

            // Initialize stats for each client type
            ['gc', 'subcontractor', 'developer', 'municipality'].forEach(type => {
                clientTypeStats[type] = {
                    type,
                    label: clientTypeLabels[type],
                    totalBids: 0,
                    won: 0,
                    lost: 0,
                    ghost: 0,
                    declined: 0,
                    winRate: 0,
                    avgScore: 0,
                    totalRevenue: 0 // Will be calculated if outcome_data has revenue
                };
            });

            // Analyze projects by client type
            projects.forEach(p => {
                if (!p.gcs || p.gcs.length === 0) return;

                p.gcs.forEach(gc => {
                    const clientType = gc.client_type || 'gc';
                    const stats = clientTypeStats[clientType];

                    if (stats && p.outcome && p.outcome !== 'pending') {
                        stats.totalBids++;

                        if (p.outcome === 'won') stats.won++;
                        else if (p.outcome === 'lost') stats.lost++;
                        else if (p.outcome === 'ghost') stats.ghost++;
                        else if (p.outcome === 'declined') stats.declined++;

                        // Add score if available
                        if (p.scores?.final) {
                            stats.avgScore += p.scores.final;
                        }

                        // Add revenue if available
                        if (p.outcome === 'won' && p.outcome_data?.revenue) {
                            stats.totalRevenue += parseFloat(p.outcome_data.revenue);
                        }
                    }
                });
            });

            // Calculate averages and filter out types with no data
            const activeClientTypes = Object.values(clientTypeStats)
                .map(stats => {
                    if (stats.totalBids > 0) {
                        stats.winRate = ((stats.won / stats.totalBids) * 100).toFixed(1);
                        stats.avgScore = (stats.avgScore / stats.totalBids).toFixed(0);
                    }
                    return stats;
                })
                .filter(stats => stats.totalBids > 0)
                .sort((a, b) => b.winRate - a.winRate);

            if (activeClientTypes.length === 0) {
                container.innerHTML = '<div class="help-text">No projects with outcomes yet. Complete some bids to see client type performance.</div>';
                return;
            }

            // Render the table
            container.innerHTML = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border); text-align: left;">
                                <th style="padding: 12px;">Client Type</th>
                                <th style="padding: 12px; text-align: center;">Total Bids</th>
                                <th style="padding: 12px; text-align: center;">Won</th>
                                <th style="padding: 12px; text-align: center;">Win Rate</th>
                                <th style="padding: 12px; text-align: center;">Avg Score</th>
                                <th style="padding: 12px; text-align: center;">Revenue</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${activeClientTypes.map((stats, i) => {
                                const icon = stats.type === 'gc' ? '🏢' :
                                           stats.type === 'subcontractor' ? '🔧' :
                                           stats.type === 'developer' ? '🏗️' : '🏛️';
                                const winRateColor = parseFloat(stats.winRate) >= 50 ? 'var(--success)' :
                                                    parseFloat(stats.winRate) >= 30 ? 'var(--warning)' : 'var(--danger)';
                                const revenueDisplay = stats.totalRevenue > 0 ?
                                    `$${stats.totalRevenue.toLocaleString()}` :
                                    '<span style="color: var(--text-muted);">—</span>';

                                return `
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <td style="padding: 12px;">
                                            <div style="display: flex; align-items: center; gap: 8px;">
                                                <span style="font-size: 24px;">${icon}</span>
                                                <strong>${stats.label}</strong>
                                            </div>
                                        </td>
                                        <td style="padding: 12px; text-align: center;">${stats.totalBids}</td>
                                        <td style="padding: 12px; text-align: center; color: var(--success);">${stats.won}</td>
                                        <td style="padding: 12px; text-align: center;">
                                            <strong style="color: ${winRateColor};">${stats.winRate}%</strong>
                                        </td>
                                        <td style="padding: 12px; text-align: center;">
                                            ${stats.avgScore}
                                        </td>
                                        <td style="padding: 12px; text-align: center; font-weight: 600; color: var(--success);">
                                            ${revenueDisplay}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 20px; padding: 16px; background: var(--accent-dim); border-radius: var(--radius); border: 1px solid var(--accent); font-size: 13px;">
                    <strong>💡 AI Insight:</strong> ${generateClientTypeInsight(activeClientTypes)}
                </div>
            `;
        }

        // Generate AI insight based on client type performance
        function generateClientTypeInsight(clientTypes) {
            if (clientTypes.length === 0) return 'Add more project outcomes to see insights.';

            const best = clientTypes[0];
            const worst = clientTypes[clientTypes.length - 1];

            if (clientTypes.length === 1) {
                return `You've only worked with ${best.label} so far. Consider diversifying your client types to compare performance.`;
            }

            const winRateDiff = parseFloat(best.winRate) - parseFloat(worst.winRate);

            if (winRateDiff > 20) {
                return `You have a <strong>${winRateDiff.toFixed(0)}% higher win rate</strong> with ${best.label} (${best.winRate}%) compared to ${worst.label} (${worst.winRate}%). Focus your bidding efforts on ${best.label} for better success rates.`;
            } else if (winRateDiff > 10) {
                return `${best.label} show slightly better results (${best.winRate}% vs ${worst.winRate}%). Consider why you're more successful with certain client types.`;
            } else {
                return `Your win rates are consistent across client types (${best.winRate}% to ${worst.winRate}%). This suggests your expertise translates well across different clients.`;
            }
        }

        // Generate Building Type Breakdown Chart
        function renderBuildingTypeChart(projects) {
            const canvas = document.getElementById('buildingTypeChart');
            if (!canvas) return;

            // Count by building type
            const typeCounts = {};
            projects.forEach(p => {
                const extracted = p.extracted_data || p.extracted;
                const buildingType = extracted?.building_type || 'Unknown';
                typeCounts[buildingType] = (typeCounts[buildingType] || 0) + 1;
            });

            const labels = Object.keys(typeCounts);
            const data = Object.values(typeCounts);
            const colors = [
                'rgba(99, 102, 241, 0.8)',
                'rgba(52, 211, 153, 0.8)',
                'rgba(251, 146, 60, 0.8)',
                'rgba(244, 63, 94, 0.8)',
                'rgba(168, 85, 247, 0.8)',
                'rgba(34, 197, 94, 0.8)',
                'rgba(234, 179, 8, 0.8)',
                'rgba(59, 130, 246, 0.8)'
            ];

            // Destroy previous chart
            if (chartInstances.buildingType) chartInstances.buildingType.destroy();

            const ctx = canvas.getContext('2d');
            chartInstances.buildingType = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#1a1a1a'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        async function renderAnalytics() {
            const projects = await getProjects();
            if (!projects || projects.length === 0) {
                document.getElementById('accuracyMetrics').innerHTML = '<div class="help-text">📊 No projects yet. Start analyzing bids to see AI learning insights.</div>';
                document.getElementById('feedbackAnalysis').innerHTML = '';
                document.getElementById('calibrationInsights').innerHTML = '';
                document.getElementById('aiRecommendations').innerHTML = '';

                // Clear charts
                const charts = ['winRateTrendChart', 'bidVolumeChart', 'buildingTypeChart'];
                charts.forEach(id => {
                    const canvas = document.getElementById(id);
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.font = '14px sans-serif';
                        ctx.fillStyle = '#666';
                        ctx.textAlign = 'center';
                        ctx.fillText('No data available yet', canvas.width / 2, canvas.height / 2);
                    }
                });

                document.getElementById('topGCsTable').innerHTML = '<div class="help-text">No data available yet.</div>';
                document.getElementById('worstGCsTable').innerHTML = '<div class="help-text">No data available yet.</div>';
                return;
            }

            // Render new enhanced charts
            renderWinRateTrendChart(projects);
            renderBidVolumeChart(projects);
            await renderGCPerformanceTables(projects);
            await renderClientTypePerformance(projects);
            renderBuildingTypeChart(projects);

            // Calculate metrics
            const accuracy = calculatePredictionAccuracy(projects);
            const feedback = calculateUserFeedback(projects);
            const calibration = calculateCalibration(projects);
            const recommendations = generateRecommendations(accuracy, feedback, calibration);

            // Render Prediction Accuracy
            if (accuracy && accuracy.total > 0) {
                const goWinRate = accuracy.byScore.go.total > 0 ? (accuracy.byScore.go.won / accuracy.byScore.go.total * 100).toFixed(0) : 0;
                const reviewWinRate = accuracy.byScore.review.total > 0 ? (accuracy.byScore.review.won / accuracy.byScore.review.total * 100).toFixed(0) : 0;
                const passWinRate = accuracy.byScore.pass.total > 0 ? (accuracy.byScore.pass.won / accuracy.byScore.pass.total * 100).toFixed(0) : 0;

                document.getElementById('accuracyMetrics').innerHTML = `
                    <div class="stats-grid" style="margin-bottom:20px;">
                        <div class="stat-card success">
                            <div class="stat-label">GO Recommendations (80-100)</div>
                            <div class="stat-value">${goWinRate}% win rate</div>
                            <div class="form-hint">${accuracy.byScore.go.won} won / ${accuracy.byScore.go.total} total</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-label">REVIEW Recommendations (60-79)</div>
                            <div class="stat-value">${reviewWinRate}% win rate</div>
                            <div class="form-hint">${accuracy.byScore.review.won} won / ${accuracy.byScore.review.total} total</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">PASS Recommendations (0-59)</div>
                            <div class="stat-value">${passWinRate}% win rate</div>
                            <div class="form-hint">${accuracy.byScore.pass.won} won / ${accuracy.byScore.pass.total} total</div>
                        </div>
                    </div>
                    <div class="help-text">
                        <strong>Total projects with outcomes:</strong> ${accuracy.total}
                        (${accuracy.byOutcome.won} won, ${accuracy.byOutcome.lost} lost, ${accuracy.byOutcome.ghost} ghosted, ${accuracy.byOutcome.declined} declined)
                    </div>
                `;
            } else {
                document.getElementById('accuracyMetrics').innerHTML = '<div class="help-text">Complete at least 1 project with an outcome to see accuracy metrics.</div>';
            }

            // Render User Feedback
            if (feedback && feedback.total > 0) {
                document.getElementById('feedbackAnalysis').innerHTML = `
                    <div class="stats-grid" style="margin-bottom:20px;">
                        <div class="stat-card info">
                            <div class="stat-label">Agreement Rate</div>
                            <div class="stat-value">${feedback.agreementRate}%</div>
                            <div class="form-hint">${feedback.total - feedback.disagreements} agreed / ${feedback.total} total</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-label">Score Too High</div>
                            <div class="stat-value">${feedback.tooHigh}</div>
                            <div class="form-hint">False positives</div>
                        </div>
                        <div class="stat-card warning">
                            <div class="stat-label">Score Too Low</div>
                            <div class="stat-value">${feedback.tooLow}</div>
                            <div class="form-hint">False negatives</div>
                        </div>
                    </div>
                    <div class="help-text">Use the feedback toggles after each analysis to train the AI on your preferences.</div>
                `;
            } else {
                document.getElementById('feedbackAnalysis').innerHTML = '<div class="help-text">User feedback will appear here after you analyze bids and provide agreement ratings.</div>';
            }

            // Render Calibration
            if (calibration && calibration.avgScoreWon) {
                document.getElementById('calibrationInsights').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card success">
                            <div class="stat-label">Avg Score - Won Bids</div>
                            <div class="stat-value">${calibration.avgScoreWon}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg Score - Lost Bids</div>
                            <div class="stat-value">${calibration.avgScoreLost}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg Score - Ghosted</div>
                            <div class="stat-value">${calibration.avgScoreGhost}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg Score - Declined</div>
                            <div class="stat-value">${calibration.avgScoreDeclined}</div>
                        </div>
                    </div>
                    <div class="help-text" style="margin-top:16px;">
                        <strong>Ideal calibration:</strong> Won bids should have higher average scores than lost/ghosted bids. A 15-20 point difference indicates good calibration.
                    </div>
                `;
            } else {
                document.getElementById('calibrationInsights').innerHTML = '<div class="help-text">Calibration insights will appear after completing more projects with outcomes.</div>';
            }

            // Render Recommendations
            const recHtml = recommendations.map(rec => {
                if (typeof rec === 'string') return rec;
                const icon = rec.type === 'success' ? '✅' : rec.type === 'warning' ? '⚠️' : 'ℹ️';
                const color = rec.type === 'success' ? 'var(--success)' : rec.type === 'warning' ? 'var(--warning)' : 'var(--info)';
                return `
                    <div style="padding:16px; background:var(--bg-secondary); border-radius:var(--radius); margin-bottom:12px; border-left:4px solid ${color};">
                        <div style="font-weight:600; margin-bottom:6px;">${icon} ${rec.title}</div>
                        <div style="font-size:14px; color:var(--text-muted);">${rec.message}</div>
                    </div>
                `;
            }).join('');
            document.getElementById('aiRecommendations').innerHTML = recHtml;
        }

        // Load all data on app init
        async function loadAll() {
            try {
                console.log('🔄 loadAll() started');
                await loadSettings();

                // Check if onboarding is needed (only if user is authenticated)
                const settings = await getSettings();
                console.log('📋 loadAll - checking onboarding:', {
                    onboarding_completed: settings.onboarding_completed,
                    onboarding_type: typeof settings.onboarding_completed,
                    currentUser: !!currentUser,
                    userId: currentUser?.id
                });

                // Only show onboarding if explicitly NOT completed (must be false, not undefined)
                if (settings.onboarding_completed !== true && currentUser && supabaseClient) {
                    console.log('🎯 Showing onboarding because onboarding_completed =', settings.onboarding_completed);
                    renderOnboardingStep(1);
                    document.getElementById('onboardingModal').classList.add('active');
                    return; // Don't load other data until onboarding is complete
                } else {
                    console.log('✅ Skipping onboarding - onboarding_completed:', settings.onboarding_completed);
                    document.getElementById('onboardingModal').classList.remove('active');
                }

                console.log('📥 Loading keywords...');
                await loadKeywords();
                console.log('📥 Loading GCs...');
                await loadGCDatabase();
                console.log('📥 Loading projects...');
                await loadProjects();
                console.log('📥 Loading dashboard...');
                await loadDashboard();
                console.log('📥 Updating capacity...');
                await updateCapacity();
                console.log('📥 Rendering analytics...');
                await renderAnalytics();

                console.log('✅ loadAll() completed successfully');

                // Show admin tab for founders only
                if (isAdmin()) {
                    document.getElementById('adminNavItem').style.display = 'flex';
                } else {
                    document.getElementById('adminNavItem').style.display = 'none';
                }
            } catch (error) {
                console.error('❌ loadAll() error:', error);
                throw error;
            }
        }

        // ============================================
        // ADMIN DASHBOARD FUNCTIONS (Phase 2)
        // ============================================

        let allFeedback = [];

        async function loadAllFeedback() {
            try {
                const { data, error } = await supabaseClient.from('beta_feedback').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                allFeedback = data || [];
                renderFeedback(allFeedback);
            } catch (e) {
                console.error('Error loading feedback:', e);
                document.getElementById('feedbackList').innerHTML = '<p style="color: var(--danger);">Error loading feedback</p>';
            }
        }

        function filterFeedback() {
            const filter = document.getElementById('feedbackFilter').value;
            renderFeedback(filter === 'all' ? allFeedback : allFeedback.filter(f => f.feedback_type === filter));
        }

        function renderFeedback(feedback) {
            if (!feedback.length) {
                document.getElementById('feedbackList').innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 40px;">No feedback found</p>';
                return;
            }

            const typeIcons = { bug: '🐛', feature: '💡', ux: '🎨', general: '💬' };
            const statusColors = { new: 'var(--warning)', reviewing: 'var(--accent)', resolved: 'var(--success)', wont_fix: 'var(--text-muted)' };

            document.getElementById('feedbackList').innerHTML = feedback.map(f => `
                <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); margin-bottom: 12px; border-left: 4px solid ${statusColors[f.status] || 'var(--text-muted)'};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div><strong style="font-size: 15px;">${typeIcons[f.feedback_type] || '💬'} ${f.title}</strong>
                            <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${f.user_email} | ${f.user_company || 'No company'} | ${new Date(f.created_at).toLocaleDateString()}</div>
                        </div>
                        <span style="padding: 4px 12px; background: ${statusColors[f.status]}; color: white; border-radius: 12px; font-size: 11px; font-weight: 600;">${f.status.toUpperCase()}</span>
                    </div>
                    <p style="margin: 8px 0; color: var(--text-secondary); font-size: 14px;">${f.description}</p>
                    ${f.ease_of_use ? `<div style="font-size: 12px; color: var(--text-muted);">Ease: ${f.ease_of_use}/5 ⭐ | Accuracy: ${f.accuracy_rating || 'N/A'}/5 ⭐${f.would_recommend ? ' | 👍 Would recommend' : ''}</div>` : ''}
                </div>
            `).join('');
        }

        async function findDuplicateGCs() {
            const gcs = await getGCs();
            const duplicates = [];
            for (let i = 0; i < gcs.length; i++) {
                for (let j = i + 1; j < gcs.length; j++) {
                    const n1 = gcs[i].name.toLowerCase().replace(/[^a-z0-9]/g, '');
                    const n2 = gcs[j].name.toLowerCase().replace(/[^a-z0-9]/g, '');
                    if (n1.includes(n2) || n2.includes(n1) || levenshteinDist(n1, n2) < 3) {
                        duplicates.push({ gc1: gcs[i], gc2: gcs[j] });
                    }
                }
            }

            document.getElementById('duplicateGCsList').innerHTML = !duplicates.length ?
                '<p style="color: var(--success);">✅ No obvious duplicates found!</p>' :
                duplicates.map(d => `<div style="padding: 12px; background: var(--bg-secondary); border-radius: var(--radius); margin-bottom: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div><strong>${d.gc1.name}</strong> (${d.gc1.bids} bids) ↔️ <strong>${d.gc2.name}</strong> (${d.gc2.bids} bids)</div>
                        <button class="btn btn-secondary btn-sm" onclick="mergeGCs('${d.gc1.id}', '${d.gc2.id}')">Merge</button>
                    </div></div>`).join('');
        }

        function levenshteinDist(a, b) {
            const m = []; for (let i = 0; i <= b.length; i++) m[i] = [i]; for (let j = 0; j <= a.length; j++) m[0][j] = j;
            for (let i = 1; i <= b.length; i++) for (let j = 1; j <= a.length; j++) m[i][j] = b.charAt(i-1) === a.charAt(j-1) ? m[i-1][j-1] : Math.min(m[i-1][j-1]+1, m[i][j-1]+1, m[i-1][j]+1);
            return m[b.length][a.length];
        }

        async function mergeGCs(id1, id2) {
            try {
                const gcs = await getGCs();
                const gc1 = gcs.find(g => g.id === id1);
                const gc2 = gcs.find(g => g.id === id2);

                if (!gc1 || !gc2) {
                    alert('❌ Error: GC not found');
                    return;
                }

                // Ask user which name to keep
                const choice = confirm(
                    `Which name should we keep?\n\n` +
                    `Click OK to keep: "${gc1.name}"\n` +
                    `Click Cancel to keep: "${gc2.name}"\n\n` +
                    `We'll merge all bids/wins and delete the other entry.`
                );

                let primaryId, primaryName, secondaryId;
                if (choice) {
                    // Keep gc1
                    primaryId = id1;
                    primaryName = gc1.name;
                    secondaryId = id2;
                } else {
                    // Keep gc2
                    primaryId = id2;
                    primaryName = gc2.name;
                    secondaryId = id1;
                }

                const primaryGC = gcs.find(g => g.id === primaryId);
                const secondaryGC = gcs.find(g => g.id === secondaryId);

                // Final confirmation
                if (!confirm(`Confirm: Merge into "${primaryName}" and delete the other? This cannot be undone.`)) {
                    return;
                }

                // Merge bids and wins into primary
                await supabaseClient.from('general_contractors').update({
                    bids: primaryGC.bids + secondaryGC.bids,
                    wins: primaryGC.wins + secondaryGC.wins,
                    updated_at: new Date().toISOString()
                }).eq('id', primaryId);

                // Delete secondary
                await supabaseClient.from('general_contractors').delete().eq('id', secondaryId);

                // Clear cache
                dataCache.gcs = null;

                alert(`✅ GCs merged! Kept "${primaryName}" with ${primaryGC.bids + secondaryGC.bids} total bids.`);
                findDuplicateGCs();
            } catch (e) {
                console.error('Merge error:', e);
                alert('❌ Error merging: ' + e.message);
            }
        }

        async function loadSystemStats() {
            try {
                // Fetch ALL users' data (founder access)
                const { data: allUsers, error: usersError } = await supabaseClient
                    .from('user_settings')
                    .select('user_id, company_type, onboarding_completed, created_at');

                const { data: allProjects, error: projectsError } = await supabaseClient
                    .from('projects')
                    .select('user_id, outcome, scores, created_at');

                if (usersError || projectsError) {
                    throw new Error('Failed to load system stats');
                }

                // Calculate metrics
                const totalUsers = allUsers?.length || 0;
                const completedOnboarding = allUsers?.filter(u => u.onboarding_completed).length || 0;
                const totalProjects = allProjects?.length || 0;

                // Active users (analyzed in last 30 days)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const activeUsers = new Set(
                    allProjects?.filter(p => new Date(p.created_at) > thirtyDaysAgo).map(p => p.user_id) || []
                ).size;

                // Projects this week
                const sevenDaysAgo = new Date();
                sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
                const projectsThisWeek = allProjects?.filter(p => new Date(p.created_at) > sevenDaysAgo).length || 0;

                // Outcomes across all users
                const outcomes = { pending: 0, won: 0, lost: 0, ghost: 0, declined: 0 };
                allProjects?.forEach(p => {
                    if (outcomes.hasOwnProperty(p.outcome)) {
                        outcomes[p.outcome]++;
                    }
                });

                // Average score across all projects
                const projectsWithScores = allProjects?.filter(p => p.scores?.final) || [];
                const avgScore = projectsWithScores.length
                    ? Math.round(projectsWithScores.reduce((sum, p) => sum + p.scores.final, 0) / projectsWithScores.length)
                    : 0;

                // Average projects per user
                const avgProjectsPerUser = totalUsers > 0 ? (totalProjects / totalUsers).toFixed(1) : 0;

                // User breakdown by company type
                const companyTypes = allUsers?.reduce((acc, u) => {
                    acc[u.company_type || 'unknown'] = (acc[u.company_type || 'unknown'] || 0) + 1;
                    return acc;
                }, {}) || {};

                document.getElementById('systemStats').innerHTML = `
                    <h4 style="margin-bottom: 16px; color: var(--text-primary);">📊 Platform-Wide Metrics</h4>

                    <!-- Key Metrics Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        <div style="padding: 16px; background: linear-gradient(135deg, var(--accent-dim), rgba(59, 130, 246, 0.1)); border-radius: var(--radius); border: 1px solid var(--accent); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--accent);">${totalUsers}</div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Total Users</div>
                        </div>
                        <div style="padding: 16px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.05)); border-radius: var(--radius); border: 1px solid var(--success); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--success);">${activeUsers}</div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Active (30d)</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border-color); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--text-primary);">${totalProjects}</div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Total Bids Analyzed</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border-color); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--warning);">${projectsThisWeek}</div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Bids This Week</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border-color); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--info);">${avgProjectsPerUser}</div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Avg Bids/User</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border-color); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--success);">${avgScore}</div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Avg Score</div>
                        </div>
                    </div>

                    <!-- Outcomes Breakdown -->
                    <div style="margin-bottom: 20px; padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border-color);">
                        <strong style="display: block; margin-bottom: 12px;">Bid Outcomes (All Users):</strong>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; font-size: 13px;">
                            <div><span style="color: var(--info);">⏳ Pending:</span> <strong>${outcomes.pending}</strong></div>
                            <div><span style="color: var(--success);">✅ Won:</span> <strong>${outcomes.won}</strong></div>
                            <div><span style="color: var(--danger);">❌ Lost:</span> <strong>${outcomes.lost}</strong></div>
                            <div><span style="color: var(--text-muted);">👻 Ghosted:</span> <strong>${outcomes.ghost}</strong></div>
                            <div><span style="color: var(--warning);">🚫 Declined:</span> <strong>${outcomes.declined}</strong></div>
                        </div>
                    </div>

                    <!-- User Breakdown -->
                    <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border-color);">
                        <strong style="display: block; margin-bottom: 12px;">User Breakdown:</strong>
                        <div style="font-size: 13px; line-height: 1.8;">
                            <div>Completed Onboarding: <strong>${completedOnboarding} / ${totalUsers}</strong> (${totalUsers > 0 ? Math.round((completedOnboarding / totalUsers) * 100) : 0}%)</div>
                            ${Object.entries(companyTypes).map(([type, count]) =>
                                `<div>${type.charAt(0).toUpperCase() + type.slice(1)}: <strong>${count}</strong></div>`
                            ).join('')}
                        </div>
                    </div>

                    <!-- Profitability Section -->
                    <div id="profitabilitySection" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="loadProfitabilityData()" style="width: 100%;">💰 Load Profitability & Cost Analysis</button>
                    </div>

                    <!-- Test Accounts Access -->
                    <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, rgba(234, 179, 8, 0.1), rgba(234, 179, 8, 0.05)); border-radius: var(--radius); border: 1px solid var(--warning);">
                        <strong style="display: block; margin-bottom: 12px;">🔍 View Test Account:</strong>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-secondary btn-sm" onclick="viewUserData('ryan@fsikc.com')">📊 View ryan@fsikc.com Data</button>
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
                            View bid data from test account (founder only)
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading system stats:', error);
                document.getElementById('systemStats').innerHTML = `
                    <div style="padding: 16px; background: var(--danger-bg); border: 1px solid var(--danger); border-radius: var(--radius); color: var(--danger);">
                        ❌ Error loading system stats: ${error.message}
                    </div>`;
            }
        }

        async function viewUserData(email) {
            alert(`Feature coming soon: View ${email}'s projects and analytics in a modal`);
            // TODO: Implement modal with user's project list, scores, outcomes, etc.
        }

        async function loadProfitabilityData() {
            try {
                const profitabilitySection = document.getElementById('profitabilitySection');
                profitabilitySection.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner"></div><div style="margin-top: 12px;">Loading cost & revenue data...</div></div>';

                // Fetch API usage data
                const { data: apiUsage, error: apiError } = await supabaseClient
                    .from('api_usage')
                    .select('user_id, api_provider, model, operation, cost_usd, input_tokens, output_tokens, created_at');

                // Fetch revenue data
                const { data: revenue, error: revenueError } = await supabaseClient
                    .from('user_revenue')
                    .select('user_id, plan_name, mrr, status');

                // Fetch user settings for email addresses
                const { data: users, error: usersError } = await supabaseClient
                    .from('user_settings')
                    .select('user_id, created_at');

                if (apiError || revenueError || usersError) {
                    throw new Error('Failed to load profitability data');
                }

                // Calculate total costs
                const totalCosts = (apiUsage || []).reduce((sum, u) => sum + parseFloat(u.cost_usd || 0), 0);
                const totalRevenue = (revenue || []).filter(r => r.status === 'active').reduce((sum, r) => sum + parseFloat(r.mrr || 0), 0);
                const profitMargin = totalRevenue > 0 ? ((totalRevenue - totalCosts) / totalRevenue * 100) : 0;
                const netProfit = totalRevenue - totalCosts;

                // Costs this month
                const now = new Date();
                const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                const costsThisMonth = (apiUsage || [])
                    .filter(u => new Date(u.created_at) >= monthStart)
                    .reduce((sum, u) => sum + parseFloat(u.cost_usd || 0), 0);

                // Costs by provider
                const costsByProvider = (apiUsage || []).reduce((acc, u) => {
                    acc[u.api_provider] = (acc[u.api_provider] || 0) + parseFloat(u.cost_usd || 0);
                    return acc;
                }, {});

                // Costs by operation type
                const costsByOperation = (apiUsage || []).reduce((acc, u) => {
                    acc[u.operation] = (acc[u.operation] || 0) + parseFloat(u.cost_usd || 0);
                    return acc;
                }, {});

                // Per-user costs and revenue
                const userCosts = (apiUsage || []).reduce((acc, u) => {
                    acc[u.user_id] = (acc[u.user_id] || 0) + parseFloat(u.cost_usd || 0);
                    return acc;
                }, {});

                const userRevenue = (revenue || []).reduce((acc, r) => {
                    if (r.status === 'active') {
                        acc[r.user_id] = parseFloat(r.mrr || 0);
                    }
                    return acc;
                }, {});

                // Create per-user profitability table
                const userIds = [...new Set([...Object.keys(userCosts), ...Object.keys(userRevenue)])];
                const userProfitability = userIds.map(userId => {
                    const cost = userCosts[userId] || 0;
                    const rev = userRevenue[userId] || 0;
                    const profit = rev - cost;
                    const margin = rev > 0 ? ((rev - cost) / rev * 100) : 0;
                    const revenueData = (revenue || []).find(r => r.user_id === userId);
                    return {
                        userId,
                        cost,
                        revenue: rev,
                        profit,
                        margin,
                        planName: revenueData?.plan_name || 'free'
                    };
                }).sort((a, b) => b.profit - a.profit);

                // Token usage stats
                const totalTokens = (apiUsage || []).reduce((sum, u) => sum + (u.input_tokens || 0) + (u.output_tokens || 0), 0);
                const avgCostPerToken = totalTokens > 0 ? (totalCosts / totalTokens * 1000000).toFixed(2) : 0;

                profitabilitySection.innerHTML = `
                    <h4 style="margin-bottom: 16px; color: var(--text-primary);">💰 Profitability & Cost Analysis</h4>

                    <!-- Financial Metrics Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px;">
                        <div style="padding: 16px; background: linear-gradient(135deg, ${netProfit >= 0 ? 'rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.05)' : 'rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.05)'}); border-radius: var(--radius); border: 1px solid ${netProfit >= 0 ? 'var(--success)' : 'var(--danger)'}; text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: ${netProfit >= 0 ? 'var(--success)' : 'var(--danger)'};">$${netProfit.toFixed(2)}</div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Net Profit (MRR)</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border-color); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--success);">$${totalRevenue.toFixed(2)}</div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Monthly Revenue</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border-color); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--danger);">$${totalCosts.toFixed(2)}</div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Total API Costs</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border-color); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--info);">${profitMargin.toFixed(1)}%</div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Profit Margin</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border-color); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--warning);">$${costsThisMonth.toFixed(2)}</div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Costs This Month</div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border-color); text-align: center;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--text-primary);">$${avgCostPerToken}</div>
                            <div style="font-size: 13px; color: var(--text-muted); margin-top: 4px;">Per 1M Tokens</div>
                        </div>
                    </div>

                    <!-- Cost Breakdown -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border-color);">
                            <strong style="display: block; margin-bottom: 12px;">Costs by Provider:</strong>
                            <div style="font-size: 13px; line-height: 1.8;">
                                ${Object.entries(costsByProvider).map(([provider, cost]) =>
                                    `<div style="display: flex; justify-content: space-between;"><span>${provider}:</span><strong>$${cost.toFixed(4)}</strong></div>`
                                ).join('')}
                            </div>
                        </div>
                        <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border-color);">
                            <strong style="display: block; margin-bottom: 12px;">Costs by Operation:</strong>
                            <div style="font-size: 13px; line-height: 1.8;">
                                ${Object.entries(costsByOperation).map(([operation, cost]) =>
                                    `<div style="display: flex; justify-content: space-between;"><span>${operation}:</span><strong>$${cost.toFixed(4)}</strong></div>`
                                ).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Per-User Profitability -->
                    <div style="padding: 16px; background: var(--bg-secondary); border-radius: var(--radius); border: 1px solid var(--border-color);">
                        <strong style="display: block; margin-bottom: 12px;">Per-User Profitability:</strong>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; font-size: 13px; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 1px solid var(--border-color);">
                                        <th style="text-align: left; padding: 8px;">User ID</th>
                                        <th style="text-align: left; padding: 8px;">Plan</th>
                                        <th style="text-align: right; padding: 8px;">Revenue</th>
                                        <th style="text-align: right; padding: 8px;">Costs</th>
                                        <th style="text-align: right; padding: 8px;">Profit</th>
                                        <th style="text-align: right; padding: 8px;">Margin</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${userProfitability.map(u => `
                                        <tr style="border-bottom: 1px solid var(--border-color);">
                                            <td style="padding: 8px; font-family: monospace; font-size: 11px;">${u.userId.substring(0, 8)}...</td>
                                            <td style="padding: 8px;"><span style="padding: 2px 8px; background: var(--accent-dim); border-radius: 4px; font-size: 11px;">${u.planName}</span></td>
                                            <td style="text-align: right; padding: 8px; color: var(--success);">$${u.revenue.toFixed(2)}</td>
                                            <td style="text-align: right; padding: 8px; color: var(--danger);">$${u.cost.toFixed(2)}</td>
                                            <td style="text-align: right; padding: 8px; font-weight: 600; color: ${u.profit >= 0 ? 'var(--success)' : 'var(--danger)'};">$${u.profit.toFixed(2)}</td>
                                            <td style="text-align: right; padding: 8px; color: ${u.margin >= 50 ? 'var(--success)' : u.margin >= 0 ? 'var(--warning)' : 'var(--danger)'};">${u.margin.toFixed(1)}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div style="margin-top: 16px; padding: 12px; background: var(--accent-dim); border-radius: var(--radius); border: 1px solid var(--accent); font-size: 13px;">
                        <strong>💡 Tip:</strong> To track revenue, manually add records to the <code>user_revenue</code> table with Stripe customer IDs and MRR amounts. You can also build a Stripe webhook to auto-sync subscription data.
                    </div>
                `;

            } catch (error) {
                console.error('Error loading profitability data:', error);
                document.getElementById('profitabilitySection').innerHTML = `
                    <div style="padding: 16px; background: var(--danger-bg); border: 1px solid var(--danger); border-radius: var(--radius); color: var(--danger);">
                        ❌ Error loading profitability data: ${error.message}
                    </div>`;
            }
        }

        // ============================================
        // AI ADVISOR CHAT
        // ============================================

        let aiChatHistory = [];
        let aiChatOpen = false;

        async function toggleAIChat() {
            const panel = document.getElementById('aiChatPanel');
            const button = document.getElementById('aiChatButton');
            const feedbackBtn = document.getElementById('feedbackButton');

            aiChatOpen = !aiChatOpen;

            if (aiChatOpen) {
                panel.classList.add('open');
                button.classList.add('active');
                button.innerHTML = '✕';

                // Hide beta feedback button when chat is open
                if (feedbackBtn) {
                    feedbackBtn.style.display = 'none';
                }

                // Update advisor name in header
                const settings = await getSettings();
                const advisorName = settings.ai_advisor_name || 'Sam';
                const advisorNameElement = document.getElementById('aiChatAdvisorName');
                if (advisorNameElement) {
                    advisorNameElement.textContent = advisorName;
                }

                // If first open and no messages, show welcome
                if (aiChatHistory.length === 0) {
                    addAIChatWelcome();
                }
            } else {
                panel.classList.remove('open');
                button.classList.remove('active');
                button.innerHTML = '💬';

                // Show beta feedback button again when chat closes
                if (feedbackBtn) {
                    feedbackBtn.style.display = 'flex';
                }
            }
        }

        async function clearAIChatHistory() {
            if (!confirm('Clear all chat history? This cannot be undone.')) {
                return;
            }

            // Clear history
            aiChatHistory = [];

            // Show welcome message again
            await addAIChatWelcome();
        }

        async function addAIChatWelcome() {
            const settings = await getSettings();
            const advisorName = settings.ai_advisor_name || 'Sam';

            const welcomeMsg = {
                role: 'assistant',
                content: `Hey! I'm ${advisorName}, your AI advisor. I can help you with:\n\n• Understanding your bid scores\n• Explaining why a project is GO/REVIEW/PASS\n• Strategy advice for winning work\n• Questions about BidIntell features\n• General bidding advice\n\nWhat's on your mind?`
            };

            aiChatHistory.push(welcomeMsg);
            renderAIChatMessages();
        }

        function renderAIChatMessages() {
            const container = document.getElementById('aiChatMessages');

            container.innerHTML = aiChatHistory.map(msg => {
                const isUser = msg.role === 'user';
                const avatar = isUser ? '👤' : '🤖';

                return `
                    <div class="ai-chat-message ${isUser ? 'user' : 'ai'}">
                        <div class="ai-chat-avatar">${avatar}</div>
                        <div class="ai-chat-bubble">${msg.content.replace(/\n/g, '<br>')}</div>
                    </div>
                `;
            }).join('');

            // Update message counter
            const countElement = document.getElementById('aiChatMessageCount');
            if (countElement) {
                countElement.textContent = aiChatHistory.length;
            }

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        async function sendAIChatMessage() {
            const input = document.getElementById('aiChatInput');
            const sendBtn = document.getElementById('aiChatSend');
            const message = input.value.trim();

            if (!message) return;

            // Add user message
            aiChatHistory.push({ role: 'user', content: message });
            input.value = '';
            renderAIChatMessages();

            // Show typing indicator
            const container = document.getElementById('aiChatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'ai-chat-message ai';
            typingDiv.innerHTML = `
                <div class="ai-chat-avatar">🤖</div>
                <div class="ai-chat-bubble">
                    <div class="ai-chat-typing">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            container.appendChild(typingDiv);
            container.scrollTop = container.scrollHeight;

            // Disable send button
            sendBtn.disabled = true;

            try {
                const settings = await getSettings();
                const advisorName = settings.ai_advisor_name || 'Sam';
                const advisorTone = settings.ai_advisor_tone || 'supportive';

                // Build context with user profile
                let contextInfo = `You are ${advisorName}, the user's AI advisor in BidIntell (a construction bid analysis tool). `;

                if (advisorTone === 'supportive') {
                    contextInfo += `You're encouraging, use "we" language, and explain things clearly.`;
                } else if (advisorTone === 'straight_shooter') {
                    contextInfo += `You're direct, no-nonsense, and get to the point quickly.`;
                } else if (advisorTone === 'data_nerd') {
                    contextInfo += `You love data, statistics, and detailed analysis.`;
                }

                // Add user profile context - CRITICAL so AI knows their business
                contextInfo += `\n\nUser Profile:`;
                contextInfo += `\n- Company Type: ${settings.company_type || settings.companyType || 'subcontractor'}`;
                if (settings.trades && settings.trades.length > 0) {
                    contextInfo += `\n- Trades: ${settings.trades.join(', ')}`;
                }
                if (settings.product_lines && settings.product_lines.length > 0) {
                    contextInfo += `\n- Product Lines: ${settings.product_lines.join(', ')}`;
                }
                contextInfo += `\n- Office Location: ${settings.city || 'Unknown'}, ${settings.state || '?'}`;
                contextInfo += `\n- Service Area: ${settings.search_radius || settings.radius || '?'} miles`;
                contextInfo += `\n- Capacity: ${settings.capacity || 'moderate'}`;

                // Add current project context if viewing one
                if (window.currentReportProject) {
                    const p = window.currentReportProject;
                    contextInfo += `\n\nCurrent project context: "${p.extracted?.project_name || 'Unknown'}" - Score: ${p.scores?.final || 0}/100 (${p.scores?.recommendation || 'N/A'}), Location: ${p.extracted?.city || '?'}, ${p.extracted?.state || '?'}, GCs: ${(p.gcs || []).map(gc => gc.name).join(', ') || 'None'}`;
                }

                contextInfo += `\n\nIMPORTANT: You already know the user's trade and business details above. Never ask "What's your trade?" - you should already know!`;

                // Build conversation history
                const messages = [
                    { role: 'user', content: contextInfo },
                    ...aiChatHistory.slice(-10).map(msg => ({ // Last 10 messages for context
                        role: msg.role === 'user' ? 'user' : 'assistant',
                        content: msg.content
                    }))
                ];

                // Use backend API instead of direct Claude call
                // Convert messages array to a single prompt string
                const combinedPrompt = messages.map(m =>
                    `${m.role === 'user' ? 'User' : 'Assistant'}: ${m.content}`
                ).join('\n\n');

                const aiResponse = await callAI('ai_chat', combinedPrompt, 'You are a helpful AI assistant for BidIntell, helping users understand their construction bids.');
                if (!aiResponse || aiResponse.trim() === '') {
                    throw new Error('Empty response from AI');
                }

                // Remove typing indicator
                typingDiv.remove();

                // Add AI response
                aiChatHistory.push({ role: 'assistant', content: aiResponse });
                renderAIChatMessages();

            } catch (error) {
                console.error('❌ AI chat error:', error);
                typingDiv.remove();

                aiChatHistory.push({
                    role: 'assistant',
                    content: 'Sorry, I encountered an error. Please try again.'
                });
                renderAIChatMessages();
            } finally {
                sendBtn.disabled = false;
            }
        }

        // Handle Enter key in chat input
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('aiChatInput');
            if (chatInput) {
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendAIChatMessage();
                    }
                });
            }
        });

        // ============================================
        // GC AUTOCOMPLETE
        // ============================================

        let gcAutocompleteDropdown = null;
        let gcAutocompleteActive = null;

        async function initGCAutocomplete(inputId, onSelect) {
            const input = document.getElementById(inputId);
            if (!input) return;

            // Wrap input in container if not already
            if (!input.parentElement.classList.contains('gc-autocomplete-container')) {
                const wrapper = document.createElement('div');
                wrapper.className = 'gc-autocomplete-container';
                input.parentNode.insertBefore(wrapper, input);
                wrapper.appendChild(input);
            }

            // Create dropdown
            const dropdown = document.createElement('div');
            dropdown.className = 'gc-autocomplete-dropdown';
            dropdown.id = `${inputId}-dropdown`;
            input.parentElement.appendChild(dropdown);

            // Show suggestions on focus/input
            input.addEventListener('input', async () => {
                await showGCAutocompleteSuggestions(input, dropdown, onSelect);
            });

            input.addEventListener('focus', async () => {
                if (input.value.trim()) {
                    await showGCAutocompleteSuggestions(input, dropdown, onSelect);
                }
            });

            // Close dropdown on blur (with delay for click)
            input.addEventListener('blur', () => {
                setTimeout(() => {
                    dropdown.classList.remove('active');
                }, 200);
            });

            // Store reference
            gcAutocompleteActive = { input, dropdown, onSelect };
        }

        async function showGCAutocompleteSuggestions(input, dropdown, onSelect) {
            const query = input.value.trim().toLowerCase();

            if (!query) {
                dropdown.classList.remove('active');
                return;
            }

            // Get all GCs from database
            const allGCs = await getGCs();

            // Filter matching GCs
            const matches = allGCs.filter(gc =>
                gc.name.toLowerCase().includes(query)
            ).slice(0, 10); // Limit to 10 results

            if (matches.length === 0) {
                dropdown.innerHTML = `
                    <div class="gc-autocomplete-empty">
                        No matching GCs found.<br>
                        <span style="color: var(--accent); cursor: pointer;" onclick="hideGCAutocomplete()">Continue typing to add new</span>
                    </div>
                `;
                dropdown.classList.add('active');
                return;
            }

            // Store matches for later retrieval
            dropdown.gcMatches = matches;

            // Render suggestions
            dropdown.innerHTML = matches.map((gc, index) => {
                const winRate = gc.bids > 0 ? Math.round((gc.wins / gc.bids) * 100) : null;
                const ratingStars = '★'.repeat(gc.rating) + '☆'.repeat(5 - gc.rating);

                return `
                    <div class="gc-autocomplete-item" data-gc-index="${index}">
                        <div>
                            <div class="gc-autocomplete-name">${gc.name}</div>
                            ${gc.location ? `<div class="gc-autocomplete-meta">${gc.location}</div>` : ''}
                        </div>
                        <div class="gc-autocomplete-meta">
                            <span class="gc-autocomplete-rating">${ratingStars}</span>
                            ${winRate !== null ? `<span>${winRate}% win</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            dropdown.classList.add('active');

            // Add click event delegation for items
            dropdown.addEventListener('click', (e) => {
                const item = e.target.closest('.gc-autocomplete-item');
                if (item && dropdown.gcMatches) {
                    const index = parseInt(item.dataset.gcIndex);
                    const gc = dropdown.gcMatches[index];
                    if (gc) {
                        selectGCAutocomplete(gc);
                    }
                }
            });
        }

        function selectGCAutocomplete(gc) {
            if (!gcAutocompleteActive) return;

            const { input, dropdown, onSelect } = gcAutocompleteActive;

            // Fill input
            input.value = gc.name;

            // Hide dropdown
            dropdown.classList.remove('active');

            // Call callback with selected GC
            if (onSelect) {
                onSelect(gc);
            }
        }

        function hideGCAutocomplete() {
            if (gcAutocompleteDropdown) {
                gcAutocompleteDropdown.classList.remove('active');
            }
        }

        // Initialize autocomplete for all GC inputs when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize for analyze tab GC search
            const gcSearchInput = document.getElementById('gcSearchInput');
            if (gcSearchInput) {
                initGCAutocomplete('gcSearchInput', async (gc) => {
                    // Auto-select the GC
                    await toggleGC(gc.name);
                    // Clear search
                    gcSearchInput.value = '';
                    await renderGCSelector();
                });
            }

            // Initialize for report GC input
            const reportGCInput = document.getElementById('reportGCInput');
            if (reportGCInput) {
                initGCAutocomplete('reportGCInput', (gc) => {
                    // Auto-fill and add to report
                    reportGCInput.value = gc.name;
                    // User can still click "Add GC" button to confirm
                });
            }

            // Initialize for add GC modal
            const newGCName = document.getElementById('newGCName');
            if (newGCName) {
                initGCAutocomplete('newGCName', (gc) => {
                    // Fill in existing GC details
                    newGCName.value = gc.name;
                    if (gc.location) {
                        document.getElementById('newGCLocation').value = gc.location;
                    }
                    // Show message that GC already exists
                    showBanner(`"${gc.name}" already exists in your database (${gc.rating}★ rating)`, 'info');
                });
            }
        });

        // Print AI chat conversation
        async function printAIChat() {
            const settings = await getSettings();
            const advisorName = settings.ai_advisor_name || 'Sam';
            const userName = currentUser?.email || 'User';
            const timestamp = new Date().toLocaleString();

            // Create printable HTML
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>AI Advisor Chat - ${advisorName}</title>
                    <style>
                        body {
                            font-family: 'Plus Jakarta Sans', -apple-system, sans-serif;
                            max-width: 800px;
                            margin: 40px auto;
                            padding: 20px;
                            color: #333;
                        }
                        .chat-header {
                            border-bottom: 2px solid #3b82f6;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        .chat-header h1 {
                            margin: 0 0 8px 0;
                            color: #3b82f6;
                        }
                        .chat-header p {
                            margin: 4px 0;
                            color: #666;
                            font-size: 14px;
                        }
                        .chat-message {
                            margin-bottom: 24px;
                            page-break-inside: avoid;
                        }
                        .chat-message-header {
                            font-weight: 600;
                            margin-bottom: 8px;
                            color: #555;
                        }
                        .chat-message.user .chat-message-header {
                            color: #3b82f6;
                        }
                        .chat-message.ai .chat-message-header {
                            color: #8b5cf6;
                        }
                        .chat-message-content {
                            padding: 12px 16px;
                            border-radius: 8px;
                            background: #f5f5f5;
                            line-height: 1.6;
                        }
                        .chat-message.user .chat-message-content {
                            background: #e3f2fd;
                        }
                        .chat-footer {
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 1px solid #ddd;
                            font-size: 12px;
                            color: #999;
                            text-align: center;
                        }
                    </style>
                </head>
                <body>
                    <div class="chat-header">
                        <h1>💬 Help Center Transcript</h1>
                        <p><strong>Advisor:</strong> ${advisorName}</p>
                        <p><strong>User:</strong> ${userName}</p>
                        <p><strong>Date:</strong> ${timestamp}</p>
                        <p><strong>Messages:</strong> ${aiChatHistory.length} messages in conversation</p>
                    </div>

                    ${aiChatHistory.map((msg, idx) => {
                        const isUser = msg.role === 'user';
                        const label = isUser ? userName : advisorName;
                        return `
                            <div class="chat-message ${isUser ? 'user' : 'ai'}">
                                <div class="chat-message-header">${label}:</div>
                                <div class="chat-message-content">${msg.content.replace(/\n/g, '<br>')}</div>
                            </div>
                        `;
                    }).join('')}

                    <div class="chat-footer">
                        Powered by BidIntell™ AI Advisor | Generated ${timestamp}
                    </div>
                </body>
                </html>
            `;

            // Open print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

    </script>

    <!-- AI Advisor Chat Button & Panel -->
    <button class="ai-chat-button" id="aiChatButton" onclick="toggleAIChat()" style="display: none;">💬</button>

    <div class="ai-chat-panel" id="aiChatPanel">
        <div class="ai-chat-header">
            <div class="ai-chat-header-top">
                <h3>
                    <span>💬</span>
                    <span id="aiChatTitle">AI Help Center</span>
                </h3>
                <div class="ai-chat-header-actions">
                    <button class="ai-chat-print" onclick="printAIChat()" title="Print conversation">🖨️</button>
                    <button class="ai-chat-clear" onclick="clearAIChatHistory()" title="Clear history">🗑️</button>
                    <button class="ai-chat-close" onclick="toggleAIChat()">✕</button>
                </div>
            </div>
            <div class="ai-chat-header-subtitle">
                <span>Chat with <strong id="aiChatAdvisorName">Sam</strong></span>
                <span class="ai-chat-message-count">
                    <span>💬</span>
                    <span id="aiChatMessageCount">0</span> messages
                </span>
            </div>
        </div>

        <div class="ai-chat-messages" id="aiChatMessages">
            <!-- Messages will be rendered here -->
        </div>

        <div class="ai-chat-input-container">
            <div class="ai-chat-input-wrapper">
                <textarea
                    class="ai-chat-input"
                    id="aiChatInput"
                    placeholder="Ask me anything..."
                    rows="1"
                ></textarea>
                <button class="ai-chat-send" id="aiChatSend" onclick="sendAIChatMessage()">
                    ➤
                </button>
            </div>
        </div>
    </div>

</body>
</html>