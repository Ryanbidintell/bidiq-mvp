<!DOCTYPE html>
<html>
<head>
    <title>BidIQ - Analyze Bid</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: auto; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: #333; margin-top: 0; }
        h2 { color: #555; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
        h3 { color: #666; margin-top: 0; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 12px 24px; background: #e0e0e0; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 16px; }
        .tab.active { background: #4CAF50; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Forms */
        label { display: block; margin: 10px 0 5px; font-weight: bold; color: #555; }
        input[type="text"], input[type="number"], select, textarea {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;
        }
        textarea { min-height: 80px; font-family: monospace; }
        .hint { font-size: 12px; color: #888; margin-top: 3px; }
        
        /* Weight sliders */
        .weight-row { display: flex; align-items: center; gap: 15px; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .weight-label { width: 200px; font-weight: bold; }
        .weight-slider { flex: 1; }
        .weight-value { width: 60px; text-align: center; font-weight: bold; font-size: 18px; color: #4CAF50; }
        input[type="range"] { width: 100%; }
        
        /* Buttons */
        button {
            background: #4CAF50; color: white; padding: 15px 30px; border: none;
            border-radius: 4px; cursor: pointer; font-size: 16px; margin: 5px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        
        /* Results */
        #result { margin-top: 20px; }
        .score-box { 
            font-size: 48px; font-weight: bold; text-align: center;
            padding: 30px; border-radius: 8px; margin: 20px 0;
        }
        .score-go { background: #28a745; color: white; }
        .score-review { background: #ffc107; color: black; }
        .score-pass { background: #dc3545; color: white; }
        
        /* Score breakdown */
        .score-breakdown { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .score-component { 
            display: flex; align-items: center; padding: 12px 0; 
            border-bottom: 1px solid #e0e0e0;
        }
        .score-component:last-child { border-bottom: none; }
        .component-icon { font-size: 24px; width: 40px; }
        .component-name { width: 180px; font-weight: bold; }
        .component-bar { flex: 1; height: 24px; background: #e0e0e0; border-radius: 12px; overflow: hidden; margin: 0 15px; }
        .component-fill { height: 100%; border-radius: 12px; transition: width 0.5s; }
        .fill-high { background: linear-gradient(90deg, #28a745, #20c997); }
        .fill-medium { background: linear-gradient(90deg, #ffc107, #fd7e14); }
        .fill-low { background: linear-gradient(90deg, #dc3545, #e83e8c); }
        .component-score { width: 60px; text-align: right; font-weight: bold; font-size: 18px; }
        .component-weight { width: 50px; text-align: right; color: #888; font-size: 12px; }
        .component-detail { font-size: 12px; color: #666; margin-left: 40px; padding: 5px 0; }
        
        /* Details panel */
        .details { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px; }
        .detail-row { display: flex; border-bottom: 1px solid #ddd; padding: 10px 0; }
        .detail-label { font-weight: bold; width: 180px; color: #555; }
        .detail-value { flex: 1; }
        
        /* Keywords display */
        .keyword-tag { 
            display: inline-block; padding: 4px 10px; margin: 2px; 
            border-radius: 15px; font-size: 12px;
        }
        .keyword-good { background: #d4edda; color: #155724; }
        .keyword-bad { background: #f8d7da; color: #721c24; }
        .keyword-product { background: #cce5ff; color: #004085; }
        .keyword-missing { background: #fff3cd; color: #856404; }
        
        /* Grid layout */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
        
        /* Status messages */
        .status { padding: 15px; border-radius: 8px; margin: 15px 0; }
        .status-info { background: #d1ecf1; color: #0c5460; }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        
        /* Progress bar */
        .progress-container { background: #e0e0e0; border-radius: 10px; height: 20px; margin: 10px 0; overflow: hidden; }
        .progress-bar { background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; transition: width 0.3s; }
        .progress-text { text-align: center; font-size: 14px; margin-top: 5px; }
        
        /* Extraction stats */
        .extraction-stats { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 15px; margin: 20px 0; 
        }
        .stat-box { 
            background: #f0f0f0; padding: 15px; border-radius: 8px; text-align: center;
        }
        .stat-number { font-size: 28px; font-weight: bold; color: #4CAF50; }
        .stat-label { font-size: 12px; color: #666; }
        
        /* Saved indicator */
        .saved-indicator { 
            display: inline-block; padding: 5px 10px; background: #28a745; 
            color: white; border-radius: 4px; font-size: 12px; margin-left: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ BidIQ - AI Bid Analysis</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('analyze')">üìÑ Analyze Bid</button>
            <button class="tab" onclick="showTab('preferences')">‚öôÔ∏è My Preferences</button>
            <button class="tab" onclick="showTab('keywords')">üîë Keywords</button>
            <button class="tab" onclick="showTab('gcs')">üè¢ GC Ratings</button>
        </div>
        
        <!-- ANALYZE TAB -->
        <div id="tab-analyze" class="tab-content active">
            <h2>Upload Bid Documents</h2>
            <p>Upload your complete bid package (invite, specs, contract, drawings). BidIQ reads <strong>ALL pages</strong> to find your keywords.</p>
            
            <input type="file" id="pdfFile" accept=".pdf" multiple>
            <p class="hint">Select one or more PDF files. All pages will be searched for your keywords.</p>
            
            <button id="analyzeBtn" onclick="analyzeBid()">ü§ñ Analyze with AI</button>
            
            <div id="progress" style="display: none;">
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progress-text">Starting...</div>
            </div>
            
            <div id="result"></div>
        </div>
        
        <!-- PREFERENCES TAB -->
        <div id="tab-preferences" class="tab-content">
            <h2>My Business Preferences</h2>
            <p>Configure your business parameters. These affect how bids are scored FOR YOU.</p>
            
            <div class="grid-2">
                <div>
                    <label>Office Location (City, State)</label>
                    <input type="text" id="pref-location" placeholder="Kansas City, MO">
                    <p class="hint">Used to calculate distance to projects</p>
                </div>
                <div>
                    <label>Service Radius (miles)</label>
                    <select id="pref-radius">
                        <option value="25">25 miles - Local only</option>
                        <option value="50" selected>50 miles - Regional</option>
                        <option value="100">100 miles - Wide regional</option>
                        <option value="150">150+ miles - Will travel</option>
                    </select>
                </div>
            </div>
            
            <label>My Trades (CSI Divisions)</label>
            <div id="csi-checkboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 5px; margin: 10px 0;">
            </div>
            
            <label>Risk Tolerance</label>
            <select id="pref-risk">
                <option value="low">Conservative - Flag all risky clauses</option>
                <option value="medium" selected>Moderate - Standard terms acceptable</option>
                <option value="high">Aggressive - Comfortable with risk</option>
            </select>
            
            <label>Unknown GC Treatment</label>
            <select id="pref-unknown-gc">
                <option value="2">Treat as negative (2 stars)</option>
                <option value="3" selected>Treat as neutral (3 stars)</option>
                <option value="4">Treat as positive (4 stars)</option>
            </select>
            
            <h3 style="margin-top: 30px;">üìä Score Component Weights</h3>
            <p>Adjust how much each factor matters to YOUR business. Weights must total 100%.</p>
            
            <div id="weights-container">
                <div class="weight-row">
                    <span class="weight-label">üìç Location Fit</span>
                    <input type="range" class="weight-slider" id="weight-location" min="0" max="60" value="25" oninput="updateWeights()">
                    <span class="weight-value" id="weight-location-val">25%</span>
                </div>
                <div class="weight-row">
                    <span class="weight-label">üîß Trade Match</span>
                    <input type="range" class="weight-slider" id="weight-trade" min="0" max="60" value="25" oninput="updateWeights()">
                    <span class="weight-value" id="weight-trade-val">25%</span>
                </div>
                <div class="weight-row">
                    <span class="weight-label">üîë Keywords Found</span>
                    <input type="range" class="weight-slider" id="weight-keywords" min="0" max="60" value="25" oninput="updateWeights()">
                    <span class="weight-value" id="weight-keywords-val">25%</span>
                </div>
                <div class="weight-row">
                    <span class="weight-label">üè¢ GC Relationship</span>
                    <input type="range" class="weight-slider" id="weight-gc" min="0" max="60" value="25" oninput="updateWeights()">
                    <span class="weight-value" id="weight-gc-val">25%</span>
                </div>
                <div class="weight-row" style="background: #e8f5e9;">
                    <span class="weight-label"><strong>Total</strong></span>
                    <span style="flex:1"></span>
                    <span class="weight-value" id="weight-total" style="font-size: 24px;">100%</span>
                </div>
            </div>
            
            <button onclick="savePreferences()">üíæ Save Preferences</button>
            <button class="btn-secondary" onclick="resetWeights()">‚Ü∫ Reset to Default</button>
            <span id="save-indicator" style="display:none" class="saved-indicator">‚úì Saved</span>
        </div>
        
        <!-- KEYWORDS TAB -->
        <div id="tab-keywords" class="tab-content">
            <h2>Contract & Spec Keywords</h2>
            <p>Tell BidIQ which words or phrases in contracts and specs you like to see and which ones are red flags. The system will search your uploaded documents for these terms and score the bid accordingly.</p>
            
            <!-- GOOD KEYWORDS -->
            <div style="background: #f0fff4; border: 1px solid #28a745; border-radius: 8px; padding: 20px; margin: 20px 0;">
                <h3 style="margin-top: 0; color: #28a745;">‚úÖ Good / Preferred Terms</h3>
                <p style="margin-bottom: 15px;">Enter contract or spec language that is a positive signal for you (must-have or nice-to-have). The AI will match exact phrases and close variations.</p>
                
                <div class="grid-2" style="margin-bottom: 15px;">
                    <div>
                        <label style="font-weight: normal; font-size: 13px; color: #666;">üí∞ Payment & Cash Flow</label>
                        <p class="hint" style="margin: 3px 0 8px;">e.g., progress payments monthly, no retainage, net 30</p>
                    </div>
                    <div>
                        <label style="font-weight: normal; font-size: 13px; color: #666;">ü§ù Relationship & Process</label>
                        <p class="hint" style="margin: 3px 0 8px;">e.g., repeat client, negotiated contract, design-assist</p>
                    </div>
                </div>
                
                <textarea id="kw-products-good" style="min-height: 100px;" placeholder="repeat client&#10;negotiated contract&#10;design-assist&#10;BIM coordination by GC&#10;no retainage&#10;progress payments monthly&#10;early involvement"></textarea>
                <p class="hint">One keyword or short phrase per line. Found = positive points.</p>
            </div>
            
            <!-- BAD KEYWORDS -->
            <div style="background: #fff5f5; border: 1px solid #dc3545; border-radius: 8px; padding: 20px; margin: 20px 0;">
                <h3 style="margin-top: 0; color: #dc3545;">üö© Bad / Red-Flag Terms</h3>
                <p style="margin-bottom: 15px;">Enter contract or spec language that is a negative signal or deal-breaker for you. The AI will flag exact matches and close variations.</p>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label style="font-weight: normal; font-size: 13px; color: #666;">üí∏ Payment Risk</label>
                        <p class="hint" style="margin: 3px 0;">pay if paid, 10% retainage</p>
                    </div>
                    <div>
                        <label style="font-weight: normal; font-size: 13px; color: #666;">‚è∞ Schedule Risk</label>
                        <p class="hint" style="margin: 3px 0;">no damages for delay, time is of the essence</p>
                    </div>
                    <div>
                        <label style="font-weight: normal; font-size: 13px; color: #666;">‚öñÔ∏è Liability Risk</label>
                        <p class="hint" style="margin: 3px 0;">broad form indemnity, duty to defend</p>
                    </div>
                </div>
                
                <textarea id="kw-products-bad" style="min-height: 100px;" placeholder="pay if paid&#10;pay when paid&#10;liquidated damages&#10;no damages for delay&#10;termination for convenience&#10;broad form indemnity&#10;time is of the essence&#10;duty to defend&#10;10% retainage"></textarea>
                <p class="hint">One keyword or short phrase per line. Found = negative points (severity based on your Risk Tolerance setting).</p>
            </div>
            
            <!-- MUST-HAVE KEYWORDS -->
            <div style="background: #fff8e6; border: 1px solid #ffc107; border-radius: 8px; padding: 20px; margin: 20px 0;">
                <h3 style="margin-top: 0; color: #856404;">‚ö†Ô∏è Must-Have Terms (Deal Breakers if Missing)</h3>
                <p style="margin-bottom: 15px;">List specific products, manufacturers, or contract terms that <strong>must</strong> appear for this project to be a fit. If BidIQ doesn't find these, the bid gets a major penalty.</p>
                
                <textarea id="kw-products-musthave" style="min-height: 60px;" placeholder="Lenel&#10;owner-furnished materials&#10;AIA A201"></textarea>
                <p class="hint">One item per line. If NOT found = strong negative hit. Leave blank if no hard requirements.</p>
            </div>
            
            <!-- SPEC SECTIONS TO SEARCH -->
            <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin: 20px 0;">
                <h3 style="margin-top: 0;">üìã Spec Sections to Search</h3>
                <p style="margin-bottom: 15px;">Select which CSI divisions are relevant to your trade. BidIQ will look for your keywords in these sections and verify they exist in the bid package.</p>
                
                <div id="keyword-csi-checkboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 8px;">
                </div>
                <p class="hint" style="margin-top: 10px;">These sync with your "My Trades" selection in Preferences.</p>
            </div>
            
            <div style="margin-top: 25px;">
                <button onclick="saveKeywords()">üíæ Save Keywords</button>
                <button class="btn-secondary" onclick="loadDefaultKeywords()">‚Ü∫ Load Example Defaults</button>
                <span id="kw-save-indicator" style="display:none; padding: 8px 15px; border-radius: 4px; color: white;">‚úì Saved</span>
            </div>
        </div>
        
        <!-- GC RATINGS TAB -->
        <div id="tab-gcs" class="tab-content">
            <h2>My GC Relationships</h2>
            <p>Rate the GCs you work with. This feeds the Relationship score today and trains BidIQ's intelligence engine over time. Higher-rated GCs will push their bids higher in your overall score.</p>
            
            <div id="gc-list"></div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                <input type="text" id="new-gc-name" placeholder="GC Company Name" style="flex: 1; min-width: 200px;">
                <select id="new-gc-rating" style="width: 180px;">
                    <option value="1">‚≠ê Avoid if possible</option>
                    <option value="2">‚≠ê‚≠ê Below average</option>
                    <option value="3" selected>‚≠ê‚≠ê‚≠ê Neutral / New</option>
                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Good relationship</option>
                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Preferred partner</option>
                </select>
                <button onclick="addGC()">+ Add GC</button>
            </div>
            
            <p class="hint" style="margin-top: 15px;">
                <strong>How to rate:</strong> Think about trust, fairness on change orders, how they handle schedule pressure, and how often you actually make money with them.
            </p>
            
            <div style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #2196F3;">
                <strong>üîÆ Coming Soon:</strong> We'll track how these ratings line up with your future wins and margins so BidIQ can start recommending which GCs are worth prioritizing.
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // API Key (move to backend in production!)
        const CLAUDE_API_KEY = "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";
        
        // CSI Divisions
        const CSI_DIVISIONS = [
            {num: 1, name: "General Requirements"},
            {num: 2, name: "Existing Conditions"},
            {num: 3, name: "Concrete"},
            {num: 4, name: "Masonry"},
            {num: 5, name: "Metals"},
            {num: 6, name: "Wood, Plastics, Composites"},
            {num: 7, name: "Thermal & Moisture Protection"},
            {num: 8, name: "Openings (Doors/Windows)"},
            {num: 9, name: "Finishes (Drywall/Paint/Flooring)"},
            {num: 10, name: "Specialties"},
            {num: 11, name: "Equipment"},
            {num: 12, name: "Furnishings"},
            {num: 13, name: "Special Construction"},
            {num: 14, name: "Conveying Equipment"},
            {num: 21, name: "Fire Suppression"},
            {num: 22, name: "Plumbing"},
            {num: 23, name: "HVAC"},
            {num: 25, name: "Integrated Automation"},
            {num: 26, name: "Electrical"},
            {num: 27, name: "Communications (Low Voltage)"},
            {num: 28, name: "Electronic Safety & Security"},
            {num: 31, name: "Earthwork"},
            {num: 32, name: "Exterior Improvements"},
            {num: 33, name: "Utilities"}
        ];
        
        // Default keywords (combined products + contract terms)
        const DEFAULT_KEYWORDS = {
            productsGood: ["negotiated contract", "repeat client", "design-assist", "design assist", "BIM coordination", "progress payments", "no retainage"],
            productsBad: ["pay if paid", "pay-if-paid", "pay when paid", "pay-when-paid", "liquidated damages", "no damages for delay", "termination for convenience", "broad form indemnity", "time is of the essence"],
            productsMustHave: []
        };
        
        // ==================== GEOCODING & DISTANCE ====================
        
        // Haversine formula - calculates distance between two lat/long points in miles
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return Math.round(R * c);
        }
        
        // Geocode a location string using OpenStreetMap Nominatim (free)
        async function geocodeLocation(locationString) {
            try {
                const encoded = encodeURIComponent(locationString);
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encoded}&limit=1&countrycodes=us`,
                    {
                        headers: {
                            'User-Agent': 'BidIQ-MVP/1.0 (bid analysis tool)'
                        }
                    }
                );
                
                if (!response.ok) throw new Error('Geocoding failed');
                
                const data = await response.json();
                if (data.length === 0) return null;
                
                return {
                    lat: parseFloat(data[0].lat),
                    lon: parseFloat(data[0].lon),
                    display: data[0].display_name
                };
            } catch (err) {
                console.warn('Geocoding error:', err);
                return null;
            }
        }
        
        // Calculate location score based on actual distance
        function calculateLocationScore(distanceMiles, serviceRadiusMiles) {
            if (distanceMiles <= serviceRadiusMiles) {
                // Within radius: 100 at center, 75 at edge
                const ratio = distanceMiles / serviceRadiusMiles;
                return Math.round(100 - (ratio * 25));
            } else {
                // Outside radius: decreasing score
                const overage = distanceMiles - serviceRadiusMiles;
                const penalty = Math.min(overage / serviceRadiusMiles, 1) * 50;
                return Math.max(20, Math.round(75 - penalty));
            }
        }
        
        // ==================== PREFERENCE MANAGEMENT ====================
        
        function loadPreferences() {
            const prefs = JSON.parse(localStorage.getItem('bidiq_preferences') || '{}');
            
            document.getElementById('pref-location').value = prefs.location || '';
            document.getElementById('pref-radius').value = prefs.radius || '50';
            document.getElementById('pref-risk').value = prefs.riskTolerance || 'medium';
            document.getElementById('pref-unknown-gc').value = prefs.unknownGC || '3';
            
            document.getElementById('weight-location').value = prefs.weights?.location || 25;
            document.getElementById('weight-trade').value = prefs.weights?.trade || 25;
            document.getElementById('weight-keywords').value = prefs.weights?.keywords || 25;
            document.getElementById('weight-gc').value = prefs.weights?.gc || 25;
            updateWeights();
            
            const selectedDivisions = prefs.divisions || [];
            CSI_DIVISIONS.forEach(div => {
                const isSelected = selectedDivisions.includes(div.num);
                const prefCb = document.getElementById('csi-' + div.num);
                const kwCb = document.getElementById('kw-csi-' + div.num);
                if (prefCb) prefCb.checked = isSelected;
                if (kwCb) kwCb.checked = isSelected;
            });
        }
        
        async function savePreferences() {
            const locationInput = document.getElementById('pref-location').value;
            const indicator = document.getElementById('save-indicator');
            
            // Build base preferences
            const prefs = {
                location: locationInput,
                radius: parseInt(document.getElementById('pref-radius').value),
                riskTolerance: document.getElementById('pref-risk').value,
                unknownGC: document.getElementById('pref-unknown-gc').value,
                weights: {
                    location: parseInt(document.getElementById('weight-location').value),
                    trade: parseInt(document.getElementById('weight-trade').value),
                    keywords: parseInt(document.getElementById('weight-keywords').value),
                    gc: parseInt(document.getElementById('weight-gc').value)
                },
                divisions: getSelectedDivisions(),
                coordinates: null
            };
            
            // Geocode the office location if provided
            if (locationInput && locationInput.trim().length > 0) {
                indicator.style.display = 'inline-block';
                indicator.textContent = 'üìç Geocoding...';
                indicator.style.background = '#ffc107';
                
                const coords = await geocodeLocation(locationInput);
                if (coords) {
                    prefs.coordinates = { lat: coords.lat, lon: coords.lon };
                    indicator.textContent = '‚úì Saved & Geocoded';
                    indicator.style.background = '#28a745';
                } else {
                    indicator.textContent = '‚ö†Ô∏è Saved (location not found)';
                    indicator.style.background = '#fd7e14';
                }
            } else {
                indicator.style.display = 'inline-block';
                indicator.textContent = '‚úì Saved';
                indicator.style.background = '#28a745';
            }
            
            localStorage.setItem('bidiq_preferences', JSON.stringify(prefs));
            setTimeout(() => indicator.style.display = 'none', 2500);
        }
        
        function getSelectedDivisions() {
            const selected = [];
            CSI_DIVISIONS.forEach(div => {
                const cb = document.getElementById('csi-' + div.num);
                if (cb && cb.checked) selected.push(div.num);
            });
            return selected;
        }
        
        function loadKeywords() {
            const kw = JSON.parse(localStorage.getItem('bidiq_keywords') || 'null') || DEFAULT_KEYWORDS;
            document.getElementById('kw-products-good').value = (kw.productsGood || []).join('\n');
            document.getElementById('kw-products-bad').value = (kw.productsBad || []).join('\n');
            document.getElementById('kw-products-musthave').value = (kw.productsMustHave || []).join('\n');
        }
        
        function saveKeywords() {
            const kw = {
                productsGood: parseKeywords('kw-products-good'),
                productsBad: parseKeywords('kw-products-bad'),
                productsMustHave: parseKeywords('kw-products-musthave')
            };
            localStorage.setItem('bidiq_keywords', JSON.stringify(kw));
            
            const indicator = document.getElementById('kw-save-indicator');
            indicator.style.display = 'inline-block';
            setTimeout(() => indicator.style.display = 'none', 2000);
        }
        
        function parseKeywords(elementId) {
            return document.getElementById(elementId).value
                .split('\n')
                .map(k => k.trim())
                .filter(k => k.length > 0);
        }
        
        function loadDefaultKeywords() {
            localStorage.removeItem('bidiq_keywords');
            loadKeywords();
        }
        
        function loadGCRatings() {
            const ratings = JSON.parse(localStorage.getItem('bidiq_gc_ratings') || '[]');
            renderGCList(ratings);
        }
        
        function saveGCRatings(ratings) {
            localStorage.setItem('bidiq_gc_ratings', JSON.stringify(ratings));
        }
        
        function renderGCList(ratings) {
            const container = document.getElementById('gc-list');
            if (ratings.length === 0) {
                container.innerHTML = '<p style="color: #888;">No GCs added yet. Add GCs you\'ve worked with below.</p>';
                return;
            }
            
            container.innerHTML = ratings.map((gc, i) => `
                <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8f9fa; margin: 5px 0; border-radius: 4px;">
                    <span style="flex: 1; font-weight: bold;">${gc.name}</span>
                    <span>${'‚≠ê'.repeat(gc.rating)}</span>
                    <button onclick="removeGC(${i})" style="background: #dc3545; padding: 5px 10px;">‚úï</button>
                </div>
            `).join('');
        }
        
        function addGC() {
            const name = document.getElementById('new-gc-name').value.trim();
            const rating = parseInt(document.getElementById('new-gc-rating').value);
            
            if (!name) return alert('Please enter a GC name');
            
            const ratings = JSON.parse(localStorage.getItem('bidiq_gc_ratings') || '[]');
            ratings.push({ name, rating, normalized: name.toLowerCase() });
            saveGCRatings(ratings);
            renderGCList(ratings);
            
            document.getElementById('new-gc-name').value = '';
        }
        
        function removeGC(index) {
            const ratings = JSON.parse(localStorage.getItem('bidiq_gc_ratings') || '[]');
            ratings.splice(index, 1);
            saveGCRatings(ratings);
            renderGCList(ratings);
        }
        
        function updateWeights() {
            const weights = ['location', 'trade', 'keywords', 'gc'];
            let total = 0;
            weights.forEach(w => {
                const val = parseInt(document.getElementById('weight-' + w).value);
                document.getElementById('weight-' + w + '-val').textContent = val + '%';
                total += val;
            });
            
            const totalEl = document.getElementById('weight-total');
            totalEl.textContent = total + '%';
            totalEl.style.color = total === 100 ? '#28a745' : '#dc3545';
        }
        
        function resetWeights() {
            ['location', 'trade', 'keywords', 'gc'].forEach(w => {
                document.getElementById('weight-' + w).value = 25;
            });
            updateWeights();
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }
        
        function initCSICheckboxes() {
            // Preferences tab checkboxes
            const prefContainer = document.getElementById('csi-checkboxes');
            prefContainer.innerHTML = CSI_DIVISIONS.map(div => `
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="csi-${div.num}" value="${div.num}" onchange="syncCSICheckboxes(${div.num})">
                    <span>Div ${div.num.toString().padStart(2, '0')} - ${div.name}</span>
                </label>
            `).join('');
            
            // Keywords tab checkboxes (synced with preferences)
            const kwContainer = document.getElementById('keyword-csi-checkboxes');
            kwContainer.innerHTML = CSI_DIVISIONS.map(div => `
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 5px; background: white; border-radius: 4px;">
                    <input type="checkbox" id="kw-csi-${div.num}" value="${div.num}" onchange="syncCSICheckboxes(${div.num})">
                    <span>Div ${div.num.toString().padStart(2, '0')} - ${div.name}</span>
                </label>
            `).join('');
        }
        
        function syncCSICheckboxes(divNum) {
            // Sync both checkbox sets
            const prefCb = document.getElementById('csi-' + divNum);
            const kwCb = document.getElementById('kw-csi-' + divNum);
            
            // Determine which was just changed and sync the other
            if (event.target.id.startsWith('kw-')) {
                prefCb.checked = kwCb.checked;
            } else {
                kwCb.checked = prefCb.checked;
            }
        }
        
        function loadCSIFromPreferences() {
            // Load saved divisions and check both sets of boxes
            const prefs = JSON.parse(localStorage.getItem('bidiq_preferences') || '{}');
            const selectedDivisions = prefs.divisions || [];
            
            CSI_DIVISIONS.forEach(div => {
                const isSelected = selectedDivisions.includes(div.num);
                const prefCb = document.getElementById('csi-' + div.num);
                const kwCb = document.getElementById('kw-csi-' + div.num);
                if (prefCb) prefCb.checked = isSelected;
                if (kwCb) kwCb.checked = isSelected;
            });
        }
        
        function updateProgress(percent, text) {
            document.getElementById('progress').style.display = 'block';
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-text').textContent = text;
        }
        
        // ==================== MAIN ANALYSIS FUNCTION ====================
        
        async function analyzeBid() {
            const fileInput = document.getElementById('pdfFile');
            const files = fileInput.files;
            const result = document.getElementById('result');
            const btn = document.getElementById('analyzeBtn');
            
            if (files.length === 0) {
                result.innerHTML = '<div class="status status-error">‚ùå Please select at least one PDF file!</div>';
                return;
            }
            
            const prefs = JSON.parse(localStorage.getItem('bidiq_preferences') || '{}');
            if (!prefs.location || !prefs.divisions?.length) {
                result.innerHTML = '<div class="status status-error">‚ùå Please configure your preferences first (location and trades)!</div>';
                showTab('preferences');
                document.querySelector('[onclick="showTab(\'preferences\')"]').classList.add('active');
                return;
            }
            
            btn.disabled = true;
            result.innerHTML = '';
            
            try {
                // ===== STEP 1: Extract ALL text from ALL pages =====
                updateProgress(5, 'Starting PDF extraction...');
                
                let allText = '';
                let totalPages = 0;
                let fileStats = [];
                
                for (let f = 0; f < files.length; f++) {
                    const file = files[f];
                    updateProgress(10 + (f / files.length) * 30, `Reading ${file.name}...`);
                    
                    const { text, pageCount } = await extractAllTextFromPDF(file, (pageNum, total) => {
                        const fileProgress = 10 + ((f + pageNum/total) / files.length) * 30;
                        updateProgress(fileProgress, `Reading ${file.name} - Page ${pageNum}/${total}`);
                    });
                    
                    allText += `\n\n===== FILE: ${file.name} =====\n\n${text}`;
                    totalPages += pageCount;
                    fileStats.push({ name: file.name, pages: pageCount, chars: text.length });
                }
                
                if (allText.length < 100) {
                    throw new Error('Could not extract enough text from PDFs. They may be scanned images.');
                }
                
                const keywords = JSON.parse(localStorage.getItem('bidiq_keywords') || 'null') || DEFAULT_KEYWORDS;
                
                // ===== STEP 2: Local keyword search (FREE, searches ENTIRE document) =====
                updateProgress(45, 'Searching for your keywords across all pages...');
                
                const keywordResults = searchKeywordsLocally(allText, keywords);
                
                // ===== STEP 3: Detect CSI divisions locally =====
                updateProgress(55, 'Detecting spec divisions...');
                
                const divisionsFound = detectCSIDivisions(allText);
                
                // ===== STEP 4: Send ONLY first portion to Claude for understanding =====
                updateProgress(65, 'AI extracting project details...');
                
                // Only send first ~12,000 chars for basic info extraction
                const textForClaude = allText.substring(0, 12000);
                const basicInfo = await extractBasicInfoWithClaude(textForClaude);
                
                // ===== STEP 5: Geocode project location =====
                updateProgress(75, 'Calculating distance to project...');
                
                let projectCoords = null;
                if (basicInfo.project_city && basicInfo.project_state) {
                    const projectLocation = `${basicInfo.project_city}, ${basicInfo.project_state}`;
                    projectCoords = await geocodeLocation(projectLocation);
                }
                
                // Calculate distance if we have both coordinates
                let distanceMiles = null;
                if (prefs.coordinates && projectCoords) {
                    distanceMiles = haversineDistance(
                        prefs.coordinates.lat, prefs.coordinates.lon,
                        projectCoords.lat, projectCoords.lon
                    );
                }
                
                // ===== STEP 6: Combine all extraction results =====
                updateProgress(85, 'Calculating your personalized score...');
                
                const extraction = {
                    ...basicInfo,
                    spec_divisions: divisionsFound,
                    want_found: keywordResults.wantFound,
                    dont_want_found: keywordResults.dontWantFound,
                    must_have_found: keywordResults.mustHaveFound,
                    must_have_missing: keywordResults.mustHaveMissing,
                    total_pages: totalPages,
                    total_chars: allText.length,
                    file_stats: fileStats,
                    project_coords: projectCoords,
                    distance_miles: distanceMiles
                };
                
                // ===== STEP 7: Calculate score with user's weights =====
                const scoreResult = calculateScore(extraction, prefs, keywords);
                
                updateProgress(100, 'Done!');
                
                // ===== STEP 7: Display results =====
                setTimeout(() => {
                    document.getElementById('progress').style.display = 'none';
                    displayResults(extraction, scoreResult, prefs);
                }, 500);
                
                btn.disabled = false;
                btn.innerHTML = 'ü§ñ Analyze with AI';
                
            } catch (err) {
                document.getElementById('progress').style.display = 'none';
                result.innerHTML = `<div class="status status-error">‚ùå Error: ${err.message}</div>`;
                console.error('Full error:', err);
                btn.disabled = false;
                btn.innerHTML = 'ü§ñ Analyze with AI';
            }
        }
        
        // ==================== PDF EXTRACTION (ALL PAGES) ====================
        
        async function extractAllTextFromPDF(file, progressCallback) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
            let text = '';
            const pageCount = pdf.numPages;
            
            // Extract ALL pages, not just first 10
            for (let i = 1; i <= pageCount; i++) {
                if (progressCallback) progressCallback(i, pageCount);
                
                try {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    const pageText = content.items.map(item => item.str).join(' ');
                    text += pageText + '\n';
                } catch (e) {
                    console.warn(`Could not extract page ${i}:`, e);
                }
            }
            
            return { text, pageCount };
        }
        
        // ==================== LOCAL KEYWORD SEARCH (FREE!) ====================
        
        function searchKeywordsLocally(fullText, keywords) {
            const textLower = fullText.toLowerCase();
            
            // Search for "I WANT" items (products + good contract terms combined)
            const wantFound = (keywords.productsGood || []).filter(kw => 
                textLower.includes(kw.toLowerCase())
            );
            
            // Search for "I DON'T WANT" items (products + bad contract terms combined)
            const dontWantFound = (keywords.productsBad || []).filter(kw => 
                textLower.includes(kw.toLowerCase())
            );
            
            // Search for must-have items
            const mustHaveFound = (keywords.productsMustHave || []).filter(kw => 
                textLower.includes(kw.toLowerCase())
            );
            const mustHaveMissing = (keywords.productsMustHave || []).filter(kw => 
                !textLower.includes(kw.toLowerCase())
            );
            
            return {
                wantFound,
                dontWantFound,
                mustHaveFound,
                mustHaveMissing
            };
        }
        
        // ==================== LOCAL CSI DIVISION DETECTION ====================
        
        function detectCSIDivisions(fullText) {
            const textUpper = fullText.toUpperCase();
            const foundDivisions = [];
            
            // Look for patterns like "DIVISION 26", "DIV 26", "SECTION 26", "26 00 00"
            CSI_DIVISIONS.forEach(div => {
                const patterns = [
                    `DIVISION ${div.num}`,
                    `DIVISION ${div.num.toString().padStart(2, '0')}`,
                    `DIV ${div.num}`,
                    `DIV. ${div.num}`,
                    `SECTION ${div.num}`,
                    `${div.num.toString().padStart(2, '0')} 00 00`,
                    `${div.num.toString().padStart(2, '0')}0000`,
                    `${div.num.toString().padStart(2, '0')} `,
                ];
                
                const found = patterns.some(p => textUpper.includes(p));
                if (found) foundDivisions.push(div.num);
            });
            
            return [...new Set(foundDivisions)].sort((a,b) => a - b);
        }
        
        // ==================== CLAUDE API (Only for understanding, not keywords) ====================
        
        async function extractBasicInfoWithClaude(textSample) {
            const prompt = `Extract ONLY basic project information from this bid document. Return ONLY a JSON object, no other text.

DOCUMENT SAMPLE:
${textSample}

Extract these fields (use null if not found):
{
  "project_name": "Project name",
  "gc_name": "General Contractor company name", 
  "project_city": "City",
  "project_state": "State 2-letter code",
  "project_sf": null or number,
  "bid_deadline": "YYYY-MM-DD" or null,
  "project_type": ["office", "healthcare", "education", "retail", "industrial", etc]
}

Return ONLY valid JSON.`;

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': CLAUDE_API_KEY,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1024,
                    messages: [{ role: 'user', content: prompt }]
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'API request failed');
            }
            
            const data = await response.json();
            let jsonText = data.content[0].text;
            
            // Clean response
            jsonText = jsonText.replace(/```json\s*/gi, '').replace(/```\s*/gi, '').trim();
            const startIndex = jsonText.indexOf('{');
            const endIndex = jsonText.lastIndexOf('}');
            if (startIndex !== -1 && endIndex !== -1) {
                jsonText = jsonText.substring(startIndex, endIndex + 1);
            }
            
            console.log('Claude basic info:', jsonText);
            return JSON.parse(jsonText);
        }
        
        // ==================== SCORE CALCULATION ====================
        
        function calculateScore(extraction, prefs, keywords) {
            const weights = prefs.weights || { location: 25, trade: 25, keywords: 25, gc: 25 };
            const gcRatings = JSON.parse(localStorage.getItem('bidiq_gc_ratings') || '[]');
            
            const totalWeight = weights.location + weights.trade + weights.keywords + weights.gc;
            const normalize = (w) => (w / totalWeight) * 100;
            
            // ========== 1. LOCATION SCORE ==========
            let locationScore = 50;
            let locationDetail = "Location not specified in documents";
            const serviceRadius = parseInt(prefs.radius) || 50;
            
            if (extraction.distance_miles !== null && extraction.distance_miles !== undefined) {
                // We have actual distance calculated via geocoding
                locationScore = calculateLocationScore(extraction.distance_miles, serviceRadius);
                
                if (extraction.distance_miles <= serviceRadius) {
                    locationDetail = `${extraction.project_city}, ${extraction.project_state} - ${extraction.distance_miles} miles from your office ‚úì`;
                } else {
                    const overage = extraction.distance_miles - serviceRadius;
                    locationDetail = `${extraction.project_city}, ${extraction.project_state} - ${extraction.distance_miles} miles (${overage} miles outside your ${serviceRadius}-mile radius)`;
                }
            } else if (extraction.project_city && extraction.project_state && prefs.location) {
                // Fallback: couldn't geocode, just compare states
                const userState = prefs.location.split(',').pop().trim().toUpperCase().substring(0, 2);
                const projectState = (extraction.project_state || '').toUpperCase();
                
                if (userState === projectState) {
                    locationScore = 70;
                    locationDetail = `${extraction.project_city}, ${projectState} - Same state (exact distance unavailable)`;
                } else {
                    locationScore = 45;
                    locationDetail = `${extraction.project_city}, ${projectState} - Different state (exact distance unavailable)`;
                }
            } else if (extraction.project_city || extraction.project_state) {
                locationScore = 50;
                locationDetail = `${extraction.project_city || '?'}, ${extraction.project_state || '?'} - Could not determine distance`;
            }
            
            // ========== 2. TRADE MATCH SCORE ==========
            let tradeScore = 50;
            let tradeDetail = "No spec divisions detected";
            const userDivisions = prefs.divisions || [];
            const projectDivisions = extraction.spec_divisions || [];
            
            if (projectDivisions.length > 0 && userDivisions.length > 0) {
                const matching = userDivisions.filter(d => projectDivisions.includes(d));
                const coverage = matching.length / userDivisions.length;
                
                tradeScore = Math.round(coverage * 100);
                
                if (matching.length === userDivisions.length) {
                    tradeDetail = `‚úì All your trades found: Div ${matching.join(', ')}`;
                } else if (matching.length > 0) {
                    const missing = userDivisions.filter(d => !projectDivisions.includes(d));
                    tradeDetail = `Found Div ${matching.join(', ')} | Missing: Div ${missing.join(', ')}`;
                } else {
                    tradeScore = 20;
                    tradeDetail = `None of your trades (Div ${userDivisions.join(', ')}) found in specs`;
                }
            } else if (projectDivisions.length > 0) {
                tradeDetail = `Divisions found: ${projectDivisions.join(', ')} - Configure your trades in Preferences`;
            }
            
            // ========== 3. KEYWORDS SCORE (products + contract terms combined) ==========
            let keywordsScore = 70; // Start at 70, adjust based on findings
            let keywordsDetails = [];
            
            // "I WANT" items found = positive points
            (extraction.want_found || []).forEach(kw => {
                keywordsScore += 12;
                keywordsDetails.push({ text: kw, type: 'good', effect: '+12' });
            });
            
            // "I DON'T WANT" items found = negative points (adjusted by risk tolerance)
            (extraction.dont_want_found || []).forEach(kw => {
                let penalty = 15;
                if (prefs.riskTolerance === 'low') penalty = 20;
                if (prefs.riskTolerance === 'high') penalty = 10;
                keywordsScore -= penalty;
                keywordsDetails.push({ text: kw, type: 'bad', effect: `-${penalty}` });
            });
            
            // Must-have items found = bonus
            (extraction.must_have_found || []).forEach(kw => {
                keywordsScore += 15;
                keywordsDetails.push({ text: kw, type: 'musthave', effect: '+15' });
            });
            
            // Must-have items MISSING = big penalty
            (extraction.must_have_missing || []).forEach(kw => {
                keywordsScore -= 30;
                keywordsDetails.push({ text: kw + ' (NOT FOUND)', type: 'missing', effect: '-30' });
            });
            
            keywordsScore = Math.max(0, Math.min(100, keywordsScore));
            
            // ========== 4. GC RELATIONSHIP SCORE ==========
            let gcScore = parseInt(prefs.unknownGC || 3) * 20;
            let gcDetail = "No GC identified";
            
            if (extraction.gc_name) {
                const gcNormalized = extraction.gc_name.toLowerCase();
                const foundGC = gcRatings.find(gc => 
                    gcNormalized.includes(gc.normalized) || gc.normalized.includes(gcNormalized)
                );
                
                if (foundGC) {
                    gcScore = foundGC.rating * 20;
                    gcDetail = `${extraction.gc_name} - Your rating: ${'‚≠ê'.repeat(foundGC.rating)}`;
                } else {
                    gcDetail = `${extraction.gc_name} - Not in your list (using ${prefs.unknownGC || 3}-star default)`;
                }
            }
            
            // ========== FINAL SCORE ==========
            const finalScore = Math.round(
                (locationScore * normalize(weights.location) / 100) +
                (tradeScore * normalize(weights.trade) / 100) +
                (keywordsScore * normalize(weights.keywords) / 100) +
                (gcScore * normalize(weights.gc) / 100)
            );
            
            let recommendation = 'PASS';
            if (finalScore >= 75) recommendation = 'GO';
            else if (finalScore >= 55) recommendation = 'REVIEW';
            
            return {
                finalScore,
                recommendation,
                components: {
                    location: { score: locationScore, weight: weights.location, detail: locationDetail },
                    trade: { score: tradeScore, weight: weights.trade, detail: tradeDetail },
                    keywords: { score: keywordsScore, weight: weights.keywords, details: keywordsDetails },
                    gc: { score: gcScore, weight: weights.gc, detail: gcDetail }
                }
            };
        }
        
        // ==================== DISPLAY RESULTS ====================
        
        function displayResults(extraction, scoreResult, prefs) {
            const { finalScore, recommendation, components } = scoreResult;
            
            let scoreClass = 'score-pass';
            if (recommendation === 'GO') scoreClass = 'score-go';
            else if (recommendation === 'REVIEW') scoreClass = 'score-review';
            
            const getFillClass = (score) => {
                if (score >= 70) return 'fill-high';
                if (score >= 40) return 'fill-medium';
                return 'fill-low';
            };
            
            const html = `
                <div class="score-box ${scoreClass}">
                    ${finalScore}/100 - ${recommendation}
                </div>
                
                <div class="extraction-stats">
                    <div class="stat-box">
                        <div class="stat-number">${extraction.distance_miles !== null ? extraction.distance_miles : '?'}</div>
                        <div class="stat-label">Miles Away</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${extraction.total_pages}</div>
                        <div class="stat-label">Pages Analyzed</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${extraction.file_stats?.length || 0}</div>
                        <div class="stat-label">Files Processed</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${(extraction.spec_divisions || []).length}</div>
                        <div class="stat-label">Divisions Found</div>
                    </div>
                </div>
                
                <div class="score-breakdown">
                    <h3>üìä Score Breakdown (Your Weights)</h3>
                    
                    <div class="score-component">
                        <span class="component-icon">üìç</span>
                        <span class="component-name">Location Fit</span>
                        <div class="component-bar"><div class="component-fill ${getFillClass(components.location.score)}" style="width: ${components.location.score}%"></div></div>
                        <span class="component-score">${components.location.score}</span>
                        <span class="component-weight">${components.location.weight}%</span>
                    </div>
                    <div class="component-detail">${components.location.detail}</div>
                    
                    <div class="score-component">
                        <span class="component-icon">üîß</span>
                        <span class="component-name">Trade Match</span>
                        <div class="component-bar"><div class="component-fill ${getFillClass(components.trade.score)}" style="width: ${components.trade.score}%"></div></div>
                        <span class="component-score">${components.trade.score}</span>
                        <span class="component-weight">${components.trade.weight}%</span>
                    </div>
                    <div class="component-detail">${components.trade.detail}</div>
                    
                    <div class="score-component">
                        <span class="component-icon">üîë</span>
                        <span class="component-name">Keywords Found</span>
                        <div class="component-bar"><div class="component-fill ${getFillClass(components.keywords.score)}" style="width: ${components.keywords.score}%"></div></div>
                        <span class="component-score">${components.keywords.score}</span>
                        <span class="component-weight">${components.keywords.weight}%</span>
                    </div>
                    <div class="component-detail">
                        ${components.keywords.details.length > 0 
                            ? components.keywords.details.map(d => 
                                `<span class="keyword-tag ${d.type === 'good' || d.type === 'musthave' ? 'keyword-good' : d.type === 'missing' ? 'keyword-missing' : 'keyword-bad'}">${d.text} (${d.effect})</span>`
                            ).join(' ')
                            : '<span style="color:#888">No keywords configured - add them in Keywords tab</span>'
                        }
                    </div>
                    
                    <div class="score-component">
                        <span class="component-icon">üè¢</span>
                        <span class="component-name">GC Relationship</span>
                        <div class="component-bar"><div class="component-fill ${getFillClass(components.gc.score)}" style="width: ${components.gc.score}%"></div></div>
                        <span class="component-score">${components.gc.score}</span>
                        <span class="component-weight">${components.gc.weight}%</span>
                    </div>
                    <div class="component-detail">${components.gc.detail}</div>
                </div>
                
                <div class="details">
                    <h3>üìã Extracted Project Details</h3>
                    <div class="detail-row">
                        <span class="detail-label">Project Name:</span>
                        <span class="detail-value">${extraction.project_name || 'Not found'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">General Contractor:</span>
                        <span class="detail-value">${extraction.gc_name || 'Not found'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Location:</span>
                        <span class="detail-value">${extraction.project_city || '?'}, ${extraction.project_state || '?'}${extraction.distance_miles !== null ? ` (${extraction.distance_miles} miles from you)` : ''}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Project Size:</span>
                        <span class="detail-value">${extraction.project_sf ? extraction.project_sf.toLocaleString() + ' SF' : 'Not specified'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Bid Deadline:</span>
                        <span class="detail-value">${extraction.bid_deadline || 'Not specified'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Project Type:</span>
                        <span class="detail-value">${(extraction.project_type || []).join(', ') || 'Not specified'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Spec Divisions Found:</span>
                        <span class="detail-value">${(extraction.spec_divisions || []).map(d => 'Div ' + d).join(', ') || 'None detected'}</span>
                    </div>
                </div>
                
                <div class="details">
                    <h3>üìÅ Files Analyzed</h3>
                    ${(extraction.file_stats || []).map(f => `
                        <div class="detail-row">
                            <span class="detail-label">${f.name}</span>
                            <span class="detail-value">${f.pages} pages, ${Math.round(f.chars/1000)}K characters</span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('result').innerHTML = html;
        }
        
        // ==================== INITIALIZE ====================
        
        document.addEventListener('DOMContentLoaded', function() {
            initCSICheckboxes();
            loadPreferences();
            loadKeywords();
            loadGCRatings();
        });
    </script>
</body>
</html>
