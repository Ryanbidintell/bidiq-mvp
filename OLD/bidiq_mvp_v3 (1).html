<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BidIQ v3 - AI Bid Intelligence</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root{--primary:#2563eb;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;--gray-500:#6b7280;--gray-700:#374151;--gray-900:#111827}
        *{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--gray-100);color:var(--gray-900);line-height:1.5}.container{max-width:1200px;margin:0 auto;padding:20px}header{background:linear-gradient(135deg,var(--gray-900),#1e3a5f);color:white;padding:20px;margin-bottom:20px}header h1{font-size:28px}.tabs{display:flex;gap:5px;margin-bottom:20px;flex-wrap:wrap}.tab-btn{padding:12px 24px;border:none;background:white;cursor:pointer;border-radius:8px 8px 0 0;font-size:14px;font-weight:500;color:var(--gray-500)}.tab-btn.active{background:var(--primary);color:white}.tab-content{display:none;background:white;padding:30px;border-radius:0 8px 8px 8px;box-shadow:0 1px 3px rgba(0,0,0,.1)}.tab-content.active{display:block}.card{background:white;border-radius:12px;padding:24px;margin-bottom:20px;box-shadow:0 1px 3px rgba(0,0,0,.1)}.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin-bottom:30px}.stat-card{background:white;border-radius:12px;padding:20px;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,.1);position:relative}.stat-card .value{font-size:36px;font-weight:700;color:var(--primary)}.stat-card .label{color:var(--gray-500);font-size:14px}.stat-card .info-icon{position:absolute;top:10px;right:10px;width:18px;height:18px;background:var(--gray-200);border-radius:50%;font-size:12px;color:var(--gray-500);cursor:help;display:flex;align-items:center;justify-content:center}.tooltip{visibility:hidden;opacity:0;position:absolute;z-index:1000;background:var(--gray-900);color:white;padding:12px;border-radius:8px;font-size:13px;width:260px;bottom:calc(100% + 10px);left:50%;transform:translateX(-50%);transition:opacity .2s}.tooltip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:8px solid transparent;border-top-color:var(--gray-900)}.stat-card:hover .tooltip{visibility:visible;opacity:1}label{display:block;font-weight:500;margin-bottom:6px;color:var(--gray-700)}input[type="text"],input[type="number"],select,textarea{width:100%;padding:10px 14px;border:1px solid var(--gray-300);border-radius:8px;font-size:14px}input:focus,select:focus{outline:none;border-color:var(--primary)}.form-group{margin-bottom:20px}.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px}.hint{font-size:12px;color:var(--gray-500);margin-top:4px}button,.btn{padding:12px 24px;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer}.btn-primary{background:var(--primary);color:white}.btn-secondary{background:var(--gray-200);color:var(--gray-700)}.btn-success{background:var(--success);color:white}.btn-danger{background:var(--danger);color:white}.btn-small{padding:8px 16px;font-size:13px}.score-badge{display:inline-flex;padding:6px 14px;border-radius:20px;font-weight:600;font-size:14px}.score-go{background:#dcfce7;color:#166534}.score-review{background:#fef3c7;color:#92400e}.score-pass{background:#fee2e2;color:#991b1b}.score-display{text-align:center;padding:30px;border-radius:12px;margin-bottom:24px}.score-display.go{background:linear-gradient(135deg,#dcfce7,#bbf7d0)}.score-display.review{background:linear-gradient(135deg,#fef3c7,#fde68a)}.score-display.pass{background:linear-gradient(135deg,#fee2e2,#fecaca)}.score-display .score-number{font-size:64px;font-weight:800}.score-display .recommendation{font-size:24px;font-weight:600;margin-top:10px}.score-display .summary{margin-top:15px;font-size:16px;opacity:.9}.score-component{background:var(--gray-50);border-radius:12px;padding:20px;margin-bottom:16px;border-left:4px solid var(--gray-300)}.score-component.good{border-left-color:var(--success);background:#f0fdf4}.score-component.caution{border-left-color:var(--warning);background:#fffbeb}.score-component.poor{border-left-color:var(--danger);background:#fef2f2}.score-component-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}.score-component-title{font-size:16px;font-weight:600}.score-component-score{font-size:18px;font-weight:700}.score-component-body{color:var(--gray-700);font-size:14px;line-height:1.6}.why-matters{margin-top:12px;padding-top:12px;border-top:1px dashed var(--gray-300);font-size:13px;color:var(--gray-600)}.address-prompt{background:#fef3c7;border:2px dashed #f59e0b;border-radius:8px;padding:16px;margin-top:12px}.address-prompt .input-row{display:flex;gap:10px;margin-top:8px}.address-prompt input{flex:1}.keyword-tag{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:4px;font-size:13px;margin:2px}.keyword-tag.found{background:#dcfce7;color:#166534}.keyword-tag.missing{background:#fee2e2;color:#991b1b}.keyword-tag.risk{background:#fef3c7;color:#92400e}.keyword-tag .page-ref{font-size:11px;opacity:.7}table{width:100%;border-collapse:collapse}th,td{padding:12px;text-align:left;border-bottom:1px solid var(--gray-200)}th{background:var(--gray-50);font-weight:600;font-size:13px;color:var(--gray-600);text-transform:uppercase}.gc-selector{border:1px solid var(--gray-300);border-radius:8px;padding:16px;background:var(--gray-50)}.gc-search{position:relative}.gc-suggestions{position:absolute;top:100%;left:0;right:0;background:white;border:1px solid var(--gray-300);border-radius:0 0 8px 8px;max-height:200px;overflow-y:auto;z-index:100;display:none}.gc-suggestions.show{display:block}.gc-suggestion{padding:10px 14px;cursor:pointer;display:flex;justify-content:space-between}.gc-suggestion:hover{background:var(--gray-100)}.selected-gcs{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}.selected-gc{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;background:white;border:1px solid var(--gray-300);border-radius:6px;font-size:14px}.selected-gc .remove{cursor:pointer;color:var(--gray-400);font-size:18px}.progress-container{background:var(--gray-200);border-radius:10px;height:20px;overflow:hidden;margin:20px 0}.progress-bar{height:100%;background:linear-gradient(90deg,var(--primary),#60a5fa);transition:width .3s}.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}.modal-overlay.show{display:flex}.modal{background:white;border-radius:12px;max-width:700px;width:95%;max-height:90vh;overflow-y:auto}.modal-header{padding:20px 24px;border-bottom:1px solid var(--gray-200);display:flex;justify-content:space-between}.modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--gray-400)}.modal-body{padding:24px}.modal-footer{padding:16px 24px;border-top:1px solid var(--gray-200);display:flex;justify-content:flex-end;gap:12px}.file-upload{border:2px dashed var(--gray-300);border-radius:12px;padding:40px;text-align:center;cursor:pointer}.file-upload:hover{border-color:var(--primary)}.file-item{display:flex;justify-content:space-between;padding:10px;background:var(--gray-50);border-radius:6px;margin-bottom:8px}.division-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:8px}.division-item{display:flex;align-items:center;gap:8px;padding:8px}.keywords-list{display:flex;flex-wrap:wrap;gap:8px;padding:12px;background:var(--gray-50);border-radius:8px;min-height:50px}.keyword-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:white;border:1px solid var(--gray-300);border-radius:20px;font-size:13px}.keyword-chip.want{background:#dcfce7}.keyword-chip.dontwant{background:#fee2e2}.keyword-chip.musthave{background:#dbeafe}.weight-slider{display:flex;align-items:center;gap:12px;margin-bottom:12px}.weight-slider label{width:180px;margin-bottom:0}.weight-slider input[type="range"]{flex:1}.weight-slider .value{width:50px;text-align:right;font-weight:600}.weight-total{text-align:right;font-weight:600;padding:12px;background:var(--gray-100);border-radius:8px;margin-top:12px}.weight-total.error{background:#fee2e2;color:var(--danger)}
    </style>
</head>
<body>
    <header><div class="container"><h1>üéØ BidIQ v3</h1><p>AI-Powered Bid Intelligence ‚Ä¢ Address Prompts, Tooltips & Page Numbers</p></div></header>
    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab-btn" onclick="showTab('analyze')">üìÑ Analyze</button>
            <button class="tab-btn" onclick="showTab('projects')">üìÅ Projects</button>
            <button class="tab-btn" onclick="showTab('prefs')">‚öôÔ∏è Preferences</button>
            <button class="tab-btn" onclick="showTab('keywords')">üîë Keywords</button>
            <button class="tab-btn" onclick="showTab('gcs')">üè¢ GCs</button>
        </div>
        <div id="tab-dashboard" class="tab-content active">
            <h2 style="margin-bottom:20px">Welcome back!</h2>
            <div class="stats-grid">
                <div class="stat-card"><span class="info-icon">?</span><div class="tooltip">Total bids analyzed</div><div class="value" id="stat-total">0</div><div class="label">Bids</div></div>
                <div class="stat-card"><span class="info-icon">?</span><div class="tooltip"><b>Win Rate:</b> Won√∑(Won+Lost). Excludes pending/ghost.</div><div class="value" id="stat-winrate">--%</div><div class="label">Win Rate</div></div>
                <div class="stat-card"><span class="info-icon">?</span><div class="tooltip">Bids needing outcome update</div><div class="value" id="stat-pending">0</div><div class="label">Pending</div></div>
                <div class="stat-card"><span class="info-icon">?</span><div class="tooltip"><b>Hours Saved:</b> Bids √ó <span id="tip-time">1.5</span> hrs</div><div class="value" id="stat-hours">0</div><div class="label">Hours Saved</div></div>
            </div>
            <div class="card"><h3 style="margin-bottom:16px">üìà Recent Activity</h3><div id="recent-activity"><p style="color:var(--gray-500);text-align:center;padding:40px">No bids yet. <a href="#" onclick="showTab('analyze');return false">Analyze first bid ‚Üí</a></p></div></div>
            <div class="card"><h3 style="margin-bottom:16px">üèÜ Top GCs</h3><div id="top-gcs"><p style="color:var(--gray-500);text-align:center;padding:40px">Track outcomes to see stats</p></div></div>
        </div>
        <div id="tab-analyze" class="tab-content">
            <h2>Analyze New Bid</h2><p style="margin-bottom:24px;color:var(--gray-600)">Upload docs, select GCs, get your personalized score.</p>
            <div class="card"><h3 style="margin-bottom:16px">Step 1: Who's Bidding?</h3><p class="hint" style="margin-bottom:12px">Select all GCs. More = more competition.</p>
                <div class="gc-selector"><div class="gc-search"><input type="text" id="gc-search" placeholder="Search or add GC..." autocomplete="off"><div class="gc-suggestions" id="gc-suggestions"></div></div><div class="selected-gcs" id="selected-gcs"><span style="color:var(--gray-500)">None selected</span></div></div><div id="comp-badge" style="margin-top:12px"></div>
            </div>
            <div class="card"><h3 style="margin-bottom:16px">Step 2: Upload Documents</h3>
                <div class="file-upload" id="file-area" onclick="document.getElementById('pdf-input').click()"><div style="font-size:48px;margin-bottom:16px">üìÑ</div><p><b>Drag & drop PDFs</b> or click</p><input type="file" id="pdf-input" accept=".pdf" multiple style="display:none"></div><div id="file-list"></div>
            </div>
            <button class="btn btn-primary" onclick="analyzeBid()" style="width:100%;padding:16px;font-size:16px">ü§ñ Analyze with AI</button>
            <div id="progress" style="display:none;margin-top:20px"><div class="progress-container"><div class="progress-bar" id="prog-bar" style="width:0"></div></div><p id="prog-text" style="text-align:center;color:var(--gray-600)">Starting...</p></div>
            <div id="results" style="display:none;margin-top:24px"></div>
        </div>
        <div id="tab-projects" class="tab-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px"><h2>My Projects</h2><div style="display:flex;gap:12px"><select id="filter" onchange="loadProjects()" style="width:auto"><option value="all">All</option><option value="pending">Pending</option><option value="won">Won</option><option value="lost">Lost</option><option value="ghost">Ghost</option><option value="didnt-bid">Didn't Bid</option></select><button class="btn btn-secondary btn-small" onclick="exportCSV()">üì• Export</button></div></div>
            <div class="card" style="overflow-x:auto"><table><thead><tr><th>Project</th><th>GCs</th><th>Score</th><th>Deadline</th><th>Outcome</th><th>Actions</th></tr></thead><tbody id="proj-table"><tr><td colspan="6" style="text-align:center;padding:40px;color:var(--gray-500)">No projects</td></tr></tbody></table></div>
        </div>
        <div id="tab-prefs" class="tab-content">
            <h2 style="margin-bottom:24px">Preferences</h2>
            <div class="card"><h3 style="margin-bottom:20px">üìç Location</h3><div class="form-row"><div class="form-group"><label>Office</label><input type="text" id="pref-loc" placeholder="City, State"><p class="hint">For distance calc</p></div><div class="form-group"><label>Radius</label><select id="pref-radius"><option value="25">25mi</option><option value="50" selected>50mi</option><option value="100">100mi</option><option value="150">150mi</option><option value="999">No limit</option></select></div></div><div class="form-group"><label><input type="checkbox" id="pref-loc-on" checked style="width:auto"> Location matters</label></div></div>
            <div class="card"><h3 style="margin-bottom:20px">üîß My Trades</h3><div class="division-grid" id="div-grid"></div></div>
            <div class="card"><h3 style="margin-bottom:20px">‚öôÔ∏è Settings</h3><div class="form-row"><div class="form-group"><label>Risk Tolerance</label><select id="pref-risk"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></div><div class="form-group"><label>Unknown GC Default</label><select id="pref-gc-def"><option value="1">1‚≠ê</option><option value="2">2‚≠ê</option><option value="3" selected>3‚≠ê</option><option value="4">4‚≠ê</option><option value="5">5‚≠ê</option></select></div></div><div class="form-row"><div class="form-group"><label>Capacity</label><select id="pref-cap"><option value="hungry">üî• Hungry</option><option value="steady" selected>‚úÖ Steady</option><option value="maxed">‚è∏Ô∏è Maxed</option></select></div><div class="form-group"><label>Decision Time (hrs)</label><input type="number" id="pref-time" value="1.5" min="0.5" max="10" step="0.5"></div></div><div class="form-group"><label>Ghost Days</label><input type="number" id="pref-ghost" value="60" min="14" max="180"><p class="hint">Days until ghosted</p></div></div>
            <div class="card"><h3 style="margin-bottom:20px">‚öñÔ∏è Weights</h3><div class="weight-slider"><label>üìç Location</label><input type="range" id="w-loc" min="0" max="60" value="25" oninput="updateW()"><span class="value" id="w-loc-v">25%</span></div><div class="weight-slider"><label>üîë Keywords</label><input type="range" id="w-kw" min="0" max="60" value="30" oninput="updateW()"><span class="value" id="w-kw-v">30%</span></div><div class="weight-slider"><label>üè¢ GC</label><input type="range" id="w-gc" min="0" max="60" value="25" oninput="updateW()"><span class="value" id="w-gc-v">25%</span></div><div class="weight-slider"><label>üîß Trade</label><input type="range" id="w-tr" min="0" max="60" value="20" oninput="updateW()"><span class="value" id="w-tr-v">20%</span></div><div class="weight-total" id="w-total">Total: 100%</div></div>
            <button class="btn btn-primary" onclick="savePrefs()" style="width:100%">üíæ Save</button>
        </div>
        <div id="tab-keywords" class="tab-content">
            <h2 style="margin-bottom:24px">Keywords</h2>
            <div class="card"><h3 style="margin-bottom:12px">‚úÖ I WANT (+8)</h3><p class="hint" style="margin-bottom:16px">Preferred terms</p><div class="keywords-list" id="kw-want"></div><div style="display:flex;gap:8px;margin-top:12px"><input type="text" id="add-want" placeholder="Add..."><button class="btn btn-success btn-small" onclick="addKW('want')">+</button></div></div>
            <div class="card"><h3 style="margin-bottom:12px">‚ùå DON'T WANT (-5 to -15)</h3><p class="hint" style="margin-bottom:16px">Risk terms</p><div class="keywords-list" id="kw-dontwant"></div><div style="display:flex;gap:8px;margin-top:12px"><input type="text" id="add-dontwant" placeholder="Add..."><button class="btn btn-danger btn-small" onclick="addKW('dontwant')">+</button></div></div>
            <div class="card"><h3 style="margin-bottom:12px">‚≠ê MUST HAVE (-25 if missing)</h3><p class="hint" style="margin-bottom:16px">Required</p><div class="keywords-list" id="kw-musthave"></div><div style="display:flex;gap:8px;margin-top:12px"><input type="text" id="add-musthave" placeholder="Add..."><button class="btn btn-primary btn-small" onclick="addKW('musthave')">+</button></div></div>
        </div>
        <div id="tab-gcs" class="tab-content">
            <h2 style="margin-bottom:24px">GC Ratings</h2>
            <div class="card"><h3 style="margin-bottom:16px">Add GC</h3><div class="form-row"><div class="form-group"><label>Name - City</label><input type="text" id="new-gc-name" placeholder="Turner - KC"></div><div class="form-group"><label>Rating</label><select id="new-gc-rat"><option value="1">1‚≠ê</option><option value="2">2‚≠ê</option><option value="3" selected>3‚≠ê</option><option value="4">4‚≠ê</option><option value="5">5‚≠ê</option></select></div></div><button class="btn btn-primary" onclick="addGC()">+ Add</button></div>
            <div class="card"><h3 style="margin-bottom:16px">My GCs</h3><table><thead><tr><th>GC</th><th>Rating</th><th>Bids</th><th>Wins</th><th>Rate</th><th></th></tr></thead><tbody id="gc-table"><tr><td colspan="6" style="text-align:center;padding:40px;color:var(--gray-500)">No GCs</td></tr></tbody></table></div>
        </div>
    </div>
    <div class="modal-overlay" id="report-modal"><div class="modal"><div class="modal-header"><h2>üìä Report</h2><button class="modal-close" onclick="closeM('report-modal')">√ó</button></div><div class="modal-body" id="report-body"></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeM('report-modal')">Close</button></div></div></div>
    <div class="modal-overlay" id="outcome-modal"><div class="modal"><div class="modal-header"><h2>üìù Outcome</h2><button class="modal-close" onclick="closeM('outcome-modal')">√ó</button></div><div class="modal-body" id="outcome-body"></div></div></div>
    <div class="modal-overlay" id="newgc-modal"><div class="modal" style="max-width:400px"><div class="modal-header"><h2>Rate New GC</h2><button class="modal-close" onclick="closeM('newgc-modal')">√ó</button></div><div class="modal-body"><p style="margin-bottom:16px"><b id="newgc-name"></b> - Rate:</p><select id="newgc-rat" style="width:100%"><option value="1">1‚≠ê</option><option value="2">2‚≠ê</option><option value="3" selected>3‚≠ê</option><option value="4">4‚≠ê</option><option value="5">5‚≠ê</option></select></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeM('newgc-modal')">Cancel</button><button class="btn btn-primary" onclick="confirmNewGC()">Save</button></div></div></div>
    <script>
const API_KEY='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';
const CSI=[{n:'01',t:'General'},{n:'02',t:'Existing'},{n:'03',t:'Concrete'},{n:'04',t:'Masonry'},{n:'05',t:'Metals'},{n:'06',t:'Wood'},{n:'07',t:'Thermal'},{n:'08',t:'Openings'},{n:'09',t:'Finishes'},{n:'10',t:'Specialties'},{n:'11',t:'Equipment'},{n:'12',t:'Furnishings'},{n:'13',t:'Special'},{n:'14',t:'Conveying'},{n:'21',t:'Fire Supp'},{n:'22',t:'Plumbing'},{n:'23',t:'HVAC'},{n:'25',t:'Automation'},{n:'26',t:'Electrical'},{n:'27',t:'Comms'},{n:'28',t:'Security'},{n:'31',t:'Earthwork'},{n:'32',t:'Exterior'},{n:'33',t:'Utilities'}];
let selectedGCs=[],uploadedFiles=[],currentProjId=null,pendingGC=null;
document.addEventListener('DOMContentLoaded',()=>{initDivs();loadPrefs();loadKW();loadGCs();loadProjects();updateDash();initUpload();initGCSearch()});
function showTab(id){document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));document.querySelector(`[onclick="showTab('${id}')"]`).classList.add('active');document.getElementById('tab-'+id).classList.add('active')}
function closeM(id){document.getElementById(id).classList.remove('show')}
function getProjects(){return JSON.parse(localStorage.getItem('bidiq_projects')||'[]')}
function getPrefs(){return JSON.parse(localStorage.getItem('bidiq_prefs')||'{}')}
function getKW(){return JSON.parse(localStorage.getItem('bidiq_kw')||'{"want":[],"dontwant":[],"musthave":[]}')}
function getGCs(){return JSON.parse(localStorage.getItem('bidiq_gcs')||'[]')}
function initUpload(){const a=document.getElementById('file-area'),i=document.getElementById('pdf-input');a.ondragover=e=>{e.preventDefault();a.style.borderColor='var(--primary)'};a.ondragleave=()=>a.style.borderColor='var(--gray-300)';a.ondrop=e=>{e.preventDefault();a.style.borderColor='var(--gray-300)';handleFiles(e.dataTransfer.files)};i.onchange=e=>handleFiles(e.target.files)}
function handleFiles(files){for(let f of files)if(f.type==='application/pdf')uploadedFiles.push(f);renderFiles()}
function renderFiles(){document.getElementById('file-list').innerHTML=uploadedFiles.map((f,i)=>`<div class="file-item"><span>üìÑ ${f.name}</span><button class="btn btn-small btn-secondary" onclick="uploadedFiles.splice(${i},1);renderFiles()">√ó</button></div>`).join('')}
function initGCSearch(){const input=document.getElementById('gc-search'),sugg=document.getElementById('gc-suggestions');input.oninput=()=>{const q=input.value.toLowerCase().trim();if(q.length<2){sugg.classList.remove('show');return}const gcs=getGCs();let html=gcs.filter(g=>g.name.toLowerCase().includes(q)&&!selectedGCs.find(s=>s.name===g.name)).slice(0,5).map(g=>`<div class="gc-suggestion" onclick="selectGC('${g.name}',${g.rating})">${g.name} <span style="color:#f59e0b">${'‚≠ê'.repeat(g.rating)}</span></div>`).join('');if(q.length>=3)html+=`<div class="gc-suggestion" onclick="promptNewGC('${input.value}')" style="border-top:1px solid var(--gray-200)">+ Add "${input.value}"</div>`;sugg.innerHTML=html;sugg.classList.add('show')};input.onblur=()=>setTimeout(()=>sugg.classList.remove('show'),200)}
function selectGC(name,rating){if(!selectedGCs.find(g=>g.name===name))selectedGCs.push({name,rating});renderSelGCs();document.getElementById('gc-search').value='';document.getElementById('gc-suggestions').classList.remove('show')}
function promptNewGC(name){pendingGC=name.trim();document.getElementById('newgc-name').textContent=pendingGC;document.getElementById('newgc-modal').classList.add('show');document.getElementById('gc-search').value='';document.getElementById('gc-suggestions').classList.remove('show')}
function confirmNewGC(){const r=parseInt(document.getElementById('newgc-rat').value);const gcs=getGCs();gcs.push({name:pendingGC,rating:r,bids:0,wins:0});localStorage.setItem('bidiq_gcs',JSON.stringify(gcs));selectGC(pendingGC,r);closeM('newgc-modal');loadGCs()}
function renderSelGCs(){const el=document.getElementById('selected-gcs'),badge=document.getElementById('comp-badge');if(!selectedGCs.length){el.innerHTML='<span style="color:var(--gray-500)">None selected</span>';badge.innerHTML='';return}el.innerHTML=selectedGCs.map(g=>`<div class="selected-gc">${g.name} <span style="color:#f59e0b">${'‚≠ê'.repeat(g.rating)}</span><span class="remove" onclick="selectedGCs=selectedGCs.filter(x=>x.name!=='${g.name}');renderSelGCs()">√ó</span></div>`).join('');const n=selectedGCs.length;let cls='score-go',txt='Low (1-2)';if(n>2&&n<=5){cls='score-review';txt='Moderate (3-5)'}else if(n>5&&n<=10){cls='score-pass';txt='High (6-10)'}else if(n>10){cls='score-pass';txt='Very High (10+)'}badge.innerHTML=`<span class="score-badge ${cls}">${txt}</span>`}
async function extractPDFs(files,prog){pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';let pages=[],total=0;for(let i=0;i<files.length;i++){prog(`Reading ${files[i].name}...`,(i/files.length)*30);const buf=await files[i].arrayBuffer();const pdf=await pdfjsLib.getDocument({data:buf}).promise;for(let p=1;p<=pdf.numPages;p++){const page=await pdf.getPage(p);const tc=await page.getTextContent();pages.push({file:files[i].name,page:total+p,text:tc.items.map(x=>x.str).join(' ')})}total+=pdf.numPages}return pages}
function searchKW(pages,kw){const res={want:[],dontwant:[],musthave:[],contract:false};const cterms=['general conditions','liquidated damages','indemnification','pay-if-paid','retainage'];for(const pg of pages){const t=pg.text.toLowerCase();for(const ct of cterms)if(t.includes(ct)){res.contract=true;break}if(res.contract)break}for(const k of(kw.want||[])){const found=pages.filter(p=>p.text.toLowerCase().includes(k.toLowerCase())).map(p=>p.page);if(found.length)res.want.push({kw:k,pages:found})}for(const k of(kw.dontwant||[])){const found=pages.filter(p=>p.text.toLowerCase().includes(k.toLowerCase())).map(p=>p.page);if(found.length)res.dontwant.push({kw:k,pages:found})}for(const k of(kw.musthave||[])){const found=pages.filter(p=>p.text.toLowerCase().includes(k.toLowerCase())).map(p=>p.page);res.musthave.push({kw:k,pages:found,missing:!found.length})}return res}
function searchDivs(pages,userDivs){return userDivs.map(d=>{const pats=[new RegExp(`division\\s*${d}`,'i'),new RegExp(`section\\s*${d}`,'i'),new RegExp(`\\b${d}\\d{4}`,'i')];const found=[];for(const pg of pages)for(const pat of pats)if(pat.test(pg.text)&&!found.includes(pg.page))found.push(pg.page);const info=CSI.find(c=>c.n===d);return{div:d,name:info?info.t:`Div ${d}`,pages:found,found:found.length>0}})}
async function aiExtract(text,prog){prog('AI analyzing...',60);const prompt=`Extract from construction docs. CHECK TITLE BLOCKS for address. Return JSON only:{"project_name":"...","project_address":"...","project_city":"...","project_state":"...","bid_deadline":"YYYY-MM-DD","gc_name":"..."}\nText:${text.substring(0,30000)}`;try{const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':API_KEY,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,messages:[{role:'user',content:prompt}]})});const d=await r.json();const m=d.content[0].text.match(/\{[\s\S]*\}/);return m?JSON.parse(m[0]):null}catch(e){console.error(e);return null}}
async function geocode(addr){try{const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}&limit=1`,{headers:{'User-Agent':'BidIQ/3'}});const d=await r.json();return d.length?{lat:parseFloat(d[0].lat),lon:parseFloat(d[0].lon)}:null}catch(e){return null}}
function calcDist(lat1,lon1,lat2,lon2){const R=3959,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180;const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}
function calcScore(ext,kwRes,divRes,dist,prefs){const w=prefs.weights||{loc:25,kw:30,gc:25,tr:20};const locOn=prefs.locOn!==false;let ew={...w};if(!locOn){const other=ew.kw+ew.gc+ew.tr;if(other>0){ew.kw+=ew.loc*(ew.kw/other);ew.gc+=ew.loc*(ew.gc/other);ew.tr+=ew.loc*(ew.tr/other)}ew.loc=0}const total=ew.loc+ew.kw+ew.gc+ew.tr;const norm=v=>(v/total)*100;let locScore=50,locDetail='',locStatus='neutral';if(!locOn){locScore=0;locDetail='Location disabled'}else if(dist===null){locScore=50;locDetail='Could not determine location. Enter address below.'}else{const rad=parseInt(prefs.radius)||50;if(dist<=25)locScore=100;else if(dist<=50)locScore=85;else if(dist<=100)locScore=70;else if(dist<=150)locScore=50;else locScore=30;if(dist>rad)locScore=Math.max(20,locScore-20);locStatus=locScore>=70?'good':(locScore>=40?'caution':'poor');locDetail=`${Math.round(dist)} miles from office${dist<=rad?', within':' - outside'} ${rad}-mile radius.`}let kwScore=50,kwDetails=[],kwStatus='neutral';const penalty=prefs.risk==='low'?15:(prefs.risk==='high'?5:10);for(const i of kwRes.want){kwScore+=8;kwDetails.push({t:'found',k:i.kw,p:i.pages,e:'+8'})}if(kwRes.contract)for(const i of kwRes.dontwant){kwScore-=penalty;kwDetails.push({t:'risk',k:i.kw,p:i.pages,e:`-${penalty}`})}for(const i of kwRes.musthave){if(i.missing){kwScore-=25;kwDetails.push({t:'missing',k:i.kw,p:[],e:'-25'})}else kwDetails.push({t:'found',k:i.kw,p:i.pages,e:'required ‚úì'})}kwScore=Math.max(0,Math.min(100,kwScore));kwStatus=kwScore>=70?'good':(kwScore>=40?'caution':'poor');let gcScore=50,gcDetail='',gcStatus='neutral';const gcs=getGCs(),defRat=parseInt(prefs.gcDef)||3;if(!selectedGCs.length){gcScore=defRat*20;gcDetail='No GCs selected.'}else{let wSum=0,tBids=0,bestGC=null,bestRate=0;for(const sel of selectedGCs){const gc=gcs.find(g=>g.name===sel.name);if(gc&&gc.bids>0){const rate=(gc.wins/gc.bids)*100;wSum+=rate*gc.bids;tBids+=gc.bids;if(rate>bestRate){bestRate=rate;bestGC={name:gc.name,rate,bids:gc.bids}}}else{wSum+=(sel.rating||defRat)*20;tBids+=1}}gcScore=tBids>0?Math.round(wSum/tBids):defRat*20;const n=selectedGCs.length;let pen=0,comp='';if(n<=2){pen=0;comp='low'}else if(n<=5){pen=5;comp='moderate (-5)'}else if(n<=10){pen=10;comp='high (-10)'}else{pen=15;comp='very high (-15)'}gcScore=Math.max(0,gcScore-pen);gcDetail=`${n} GCs (${comp}).${bestGC?` Best: ${bestGC.name} (${Math.round(bestGC.rate)}%).`:''}`}gcStatus=gcScore>=70?'good':(gcScore>=40?'caution':'poor');let trScore=50,trDetail='',trStatus='neutral';const uDivs=prefs.divisions||[];if(!uDivs.length)trDetail='No trades selected.';else{const found=divRes.filter(d=>d.found);trScore=Math.round((found.length/uDivs.length)*100);if(!found.length){trDetail='Could not verify divisions.';trStatus='caution'}else if(found.length===uDivs.length){trDetail=`Found all ${found.length} divisions.`;trStatus='good'}else{trDetail=`Found ${found.length}/${uDivs.length}. Missing: ${divRes.filter(d=>!d.found).map(d=>d.name).join(', ')}.`;trStatus='caution'}}if(trScore>=70)trStatus='good';else if(trScore<40)trStatus='poor';const final=Math.round((locScore*norm(ew.loc)/100)+(kwScore*norm(ew.kw)/100)+(gcScore*norm(ew.gc)/100)+(trScore*norm(ew.tr)/100));let rec='PASS',cls='pass';if(final>=75){rec='GO';cls='go'}else if(final>=55){rec='REVIEW';cls='review'}const cap=prefs.cap||'steady';let capMsg='';if(cap==='hungry')capMsg=final>=75?'Strong fit.':final>=55?'You need work - consider it.':'Not worth it.';else if(cap==='maxed')capMsg=final>=75?'Good but at capacity.':final>=55?'You\'re busy - pass.':'Skip.';else capMsg=final>=75?'Strong fit.':final>=55?'Mixed signals.':'Poor fit.';return{final,rec,cls,capMsg,comp:{loc:{score:locScore,weight:ew.loc,detail:locDetail,status:locStatus,dist},kw:{score:kwScore,weight:ew.kw,details:kwDetails,status:kwStatus,contract:kwRes.contract},gc:{score:gcScore,weight:ew.gc,detail:gcDetail,status:gcStatus,gcs:selectedGCs.map(g=>g.name)},tr:{score:trScore,weight:ew.tr,detail:trDetail,status:trStatus,divs:divRes}}}}
async function analyzeBid(){if(!uploadedFiles.length)return alert('Upload PDFs');if(!selectedGCs.length)return alert('Select GCs');if(!API_KEY)return alert('Add API key');const prefs=getPrefs(),kw=getKW();const prog=document.getElementById('progress'),bar=document.getElementById('prog-bar'),txt=document.getElementById('prog-text'),res=document.getElementById('results');prog.style.display='block';res.style.display='none';const update=(t,p)=>{txt.textContent=t;bar.style.width=p+'%'};try{update('Reading...',10);const pages=await extractPDFs(uploadedFiles,update);update('Keywords...',40);const kwRes=searchKW(pages,kw);update('Divisions...',50);const divRes=searchDivs(pages,prefs.divisions||[]);const fullText=pages.map(p=>p.text).join('\n');const ext=await aiExtract(fullText,update);update('Distance...',80);let dist=null;if(ext&&prefs.coords){let addr='';if(ext.project_address&&ext.project_address!=='Not found')addr=ext.project_address;if(ext.project_city)addr+=(addr?', ':'')+ext.project_city;if(ext.project_state)addr+=', '+ext.project_state;if(addr){const c=await geocode(addr);if(c){dist=calcDist(prefs.coords.lat,prefs.coords.lon,c.lat,c.lon);ext.coords=c}}}update('Scoring...',90);const score=calcScore(ext,kwRes,divRes,dist,prefs);update('Saving...',95);const proj={id:Date.now().toString(),ext,kwRes,divRes,score,gcs:[...selectedGCs],files:uploadedFiles.map(f=>f.name),created:new Date().toISOString(),outcome:'pending'};const projs=getProjects();projs.unshift(proj);localStorage.setItem('bidiq_projects',JSON.stringify(projs));update('Done!',100);renderReport(proj,'results');res.style.display='block';selectedGCs=[];uploadedFiles=[];renderSelGCs();renderFiles();document.getElementById('comp-badge').innerHTML='';loadProjects();updateDash()}catch(e){alert('Error: '+e.message);console.error(e)}finally{setTimeout(()=>prog.style.display='none',1000)}}
function renderReport(proj,targetId){const{ext,score}=proj;const name=ext?.project_name||'Unknown';const loc=[ext?.project_city,ext?.project_state].filter(Boolean).join(', ')||'Unknown';const{final,rec,cls,capMsg,comp}=score;let html=`<div class="score-display ${cls}"><div class="score-number">${final}/100</div><div class="recommendation">${rec}</div><div class="summary">${capMsg}</div></div><h3 style="margin-bottom:16px">${name}</h3><p style="color:var(--gray-600);margin-bottom:24px">üìç ${loc}</p>`;html+=`<div class="score-component ${comp.loc.status}"><div class="score-component-header"><div class="score-component-title">üìç Location (${comp.loc.weight}%)</div><div class="score-component-score">${comp.loc.weight>0?comp.loc.score+'/100':'Off'}</div></div><div class="score-component-body"><p>${comp.loc.detail}</p>`;if(comp.loc.dist===null&&comp.loc.weight>0)html+=`<div class="address-prompt"><label>‚ö†Ô∏è Enter address:</label><div class="input-row"><input type="text" id="addr-${proj.id}" placeholder="123 Main St, City, ST"><button class="btn btn-primary btn-small" onclick="updateAddr('${proj.id}')">Calculate</button></div></div>`;html+=`<div class="why-matters"><b>Why:</b> Closer = less travel, lower cost.</div></div></div>`;html+=`<div class="score-component ${comp.kw.status}"><div class="score-component-header"><div class="score-component-title">üîë Keywords (${comp.kw.weight}%)</div><div class="score-component-score">${comp.kw.score}/100</div></div><div class="score-component-body">`;if(!comp.kw.details.length)html+='<p>No keywords configured.</p>';else{const found=comp.kw.details.filter(d=>d.t==='found'),risks=comp.kw.details.filter(d=>d.t==='risk'),missing=comp.kw.details.filter(d=>d.t==='missing');if(found.length){html+='<p><b>‚úÖ Found:</b></p><div style="margin:8px 0">';found.forEach(i=>html+=`<span class="keyword-tag found">${i.k} (${i.e})${i.p.length?` <span class="page-ref">p.${i.p.slice(0,3).join(',')}${i.p.length>3?'...':''}</span>`:''}</span>`);html+='</div>'}if(risks.length){html+='<p><b>‚ö†Ô∏è Risks:</b></p><div style="margin:8px 0">';risks.forEach(i=>html+=`<span class="keyword-tag risk">${i.k} (${i.e})${i.p.length?` <span class="page-ref">p.${i.p.slice(0,3).join(',')}</span>`:''}</span>`);html+='</div>'}if(missing.length){html+='<p><b>‚ùå Missing:</b></p><div style="margin:8px 0">';missing.forEach(i=>html+=`<span class="keyword-tag missing">${i.k} (${i.e})</span>`);html+='</div>'}}html+=`<p style="margin-top:12px"><b>Contract:</b> ${comp.kw.contract?'Found':'Not found - review if awarded'}</p><div class="why-matters"><b>Why:</b> Keywords show fit; risks signal problems.</div></div></div>`;html+=`<div class="score-component ${comp.gc.status}"><div class="score-component-header"><div class="score-component-title">üè¢ GC (${comp.gc.weight}%)</div><div class="score-component-score">${comp.gc.score}/100</div></div><div class="score-component-body"><p>${comp.gc.detail}</p><p style="margin-top:8px"><b>GCs:</b> ${comp.gc.gcs.join(', ')}</p><div class="why-matters"><b>Why:</b> History predicts success. More competition = price matters more.</div></div></div>`;html+=`<div class="score-component ${comp.tr.status}"><div class="score-component-header"><div class="score-component-title">üîß Trade (${comp.tr.weight}%)</div><div class="score-component-score">${comp.tr.score}/100</div></div><div class="score-component-body"><p>${comp.tr.detail}</p>`;if(comp.tr.divs?.length){const fd=comp.tr.divs.filter(d=>d.found),md=comp.tr.divs.filter(d=>!d.found);if(fd.length){html+='<div style="margin-top:8px">';fd.forEach(d=>html+=`<span class="keyword-tag found">Div ${d.div}: ${d.name}${d.pages.length?` <span class="page-ref">p.${d.pages.slice(0,3).join(',')}</span>`:''}</span>`);html+='</div>'}if(md.length){html+='<div style="margin-top:8px">';md.forEach(d=>html+=`<span class="keyword-tag missing">Div ${d.div}: ${d.name}</span>`);html+='</div>'}}html+=`<div class="why-matters"><b>Why:</b> If your trades aren't in specs, wrong scope.</div></div></div>`;html+=`<div style="display:flex;gap:12px;margin-top:24px"><button class="btn btn-primary" onclick="showTab('projects')">All Projects</button><button class="btn btn-secondary" onclick="showOutcome('${proj.id}')">Record Outcome</button></div>`;document.getElementById(targetId).innerHTML=html}
async function updateAddr(id){const input=document.getElementById('addr-'+id);const addr=input.value.trim();if(!addr)return alert('Enter address');const prefs=getPrefs();if(!prefs.coords)return alert('Set office location first');input.disabled=true;try{const c=await geocode(addr);if(!c){alert('Not found');input.disabled=false;return}const dist=calcDist(prefs.coords.lat,prefs.coords.lon,c.lat,c.lon);const projs=getProjects();const proj=projs.find(p=>p.id===id);if(proj){proj.ext=proj.ext||{};proj.ext.project_address=addr;proj.ext.coords=c;proj.score=calcScore(proj.ext,proj.kwRes,proj.divRes,dist,prefs);localStorage.setItem('bidiq_projects',JSON.stringify(projs));renderReport(proj,'results');loadProjects();updateDash();alert(`${Math.round(dist)} miles`)}}catch(e){alert('Error')}input.disabled=false}
function loadProjects(){const filter=document.getElementById('filter').value;let projs=getProjects();if(filter!=='all')projs=projs.filter(p=>p.outcome===filter);const tb=document.getElementById('proj-table');if(!projs.length){tb.innerHTML='<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--gray-500)">No projects</td></tr>';return}tb.innerHTML=projs.map(p=>{const name=p.ext?.project_name||'Unknown';const gcN=p.gcs?.length||0;const sc=p.score?.final||'--';const rec=p.score?.rec||'N/A';const cls=p.score?.cls||'neutral';const dl=p.ext?.bid_deadline||'--';const badges={pending:'<span class="score-badge" style="background:var(--gray-200)">Pending</span>',won:'<span class="score-badge score-go">Won</span>',lost:'<span class="score-badge score-pass">Lost</span>',ghost:'<span class="score-badge" style="background:#e5e7eb">Ghost</span>','didnt-bid':'<span class="score-badge" style="background:#f3f4f6">Didn\'t Bid</span>'};return`<tr><td><b>${name}</b><br><small style="color:var(--gray-500)">${p.ext?.project_city||''}</small></td><td>${gcN}</td><td><span class="score-badge score-${cls}">${sc}</span></td><td>${dl}</td><td>${badges[p.outcome]||badges.pending}</td><td><button class="btn btn-secondary btn-small" onclick="viewReport('${p.id}')">üìä</button><button class="btn btn-secondary btn-small" onclick="showOutcome('${p.id}')">üìù</button><button class="btn btn-danger btn-small" onclick="delProj('${p.id}')">üóëÔ∏è</button></td></tr>`}).join('')}
function viewReport(id){const p=getProjects().find(x=>x.id===id);if(!p)return;renderReport(p,'report-body');document.getElementById('report-modal').classList.add('show')}
function delProj(id){if(!confirm('Delete?'))return;localStorage.setItem('bidiq_projects',JSON.stringify(getProjects().filter(p=>p.id!==id)));loadProjects();updateDash()}
function showOutcome(id){currentProjId=id;const p=getProjects().find(x=>x.id===id);if(!p)return;document.getElementById('outcome-body').innerHTML=`<div class="form-group"><label>Outcome</label><select id="out-type" onchange="toggleOut()"><option value="pending">‚è≥ Pending</option><option value="won">‚úÖ Won</option><option value="lost">‚ùå Lost</option><option value="ghost">üëª Ghost</option><option value="didnt-bid">üö´ Didn't Bid</option></select></div><div id="out-won" style="display:none"><div class="form-group"><label>Amount ($)</label><input type="number" id="out-amt"></div><div class="form-group"><label>Margin (%)</label><input type="number" id="out-margin" step="0.5"></div><div class="form-group"><label>Alternates</label><input type="text" id="out-alt"></div></div><div id="out-lost" style="display:none"><div class="form-group"><label>How high?</label><select id="out-high"><option value="">?</option><option value="within-5">Within 5%</option><option value="5-10">5-10%</option><option value="10-20">10-20%</option><option value="over-20">20%+</option></select></div><div class="form-group"><label>Winner</label><input type="text" id="out-winner"></div><div class="form-group"><label>Feedback</label><textarea id="out-fb" rows="2"></textarea></div></div><div id="out-didnt" style="display:none"><label><input type="checkbox" id="r-busy"> Busy</label><label><input type="checkbox" id="r-size"> Size</label><label><input type="checkbox" id="r-gc"> GC</label><label><input type="checkbox" id="r-terms"> Terms</label><label><input type="checkbox" id="r-loc"> Location</label><label><input type="checkbox" id="r-scope"> Scope</label></div><div class="form-group"><label>Notes</label><textarea id="out-notes" rows="2"></textarea></div><div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px"><button class="btn btn-secondary" onclick="closeM('outcome-modal')">Cancel</button><button class="btn btn-primary" onclick="saveOutcome()">Save</button></div>`;document.getElementById('out-type').value=p.outcome||'pending';toggleOut();document.getElementById('outcome-modal').classList.add('show')}
function toggleOut(){const t=document.getElementById('out-type').value;document.getElementById('out-won').style.display=t==='won'?'block':'none';document.getElementById('out-lost').style.display=t==='lost'?'block':'none';document.getElementById('out-didnt').style.display=t==='didnt-bid'?'block':'none'}
function saveOutcome(){if(!currentProjId)return;const projs=getProjects();const p=projs.find(x=>x.id===currentProjId);if(!p)return;const t=document.getElementById('out-type').value;p.outcome=t;p.outcomeData={};if(t==='won'){p.outcomeData={amt:document.getElementById('out-amt').value,margin:document.getElementById('out-margin').value,alt:document.getElementById('out-alt').value};updateGCStats(p.gcs,'win')}else if(t==='lost'){p.outcomeData={high:document.getElementById('out-high').value,winner:document.getElementById('out-winner').value,fb:document.getElementById('out-fb').value};updateGCStats(p.gcs,'loss')}else if(t==='didnt-bid'){p.outcomeData={busy:document.getElementById('r-busy').checked,size:document.getElementById('r-size').checked,gc:document.getElementById('r-gc').checked,terms:document.getElementById('r-terms').checked,loc:document.getElementById('r-loc').checked,scope:document.getElementById('r-scope').checked}}p.outcomeData.notes=document.getElementById('out-notes').value;localStorage.setItem('bidiq_projects',JSON.stringify(projs));closeM('outcome-modal');loadProjects();updateDash();loadGCs()}
function updateGCStats(gcs,result){if(!gcs?.length)return;const all=getGCs();for(const sel of gcs){const gc=all.find(g=>g.name===sel.name);if(gc){gc.bids=(gc.bids||0)+1;if(result==='win')gc.wins=(gc.wins||0)+1}}localStorage.setItem('bidiq_gcs',JSON.stringify(all))}
function updateDash(){const projs=getProjects();const prefs=getPrefs();document.getElementById('stat-total').textContent=projs.length;const won=projs.filter(p=>p.outcome==='won').length,lost=projs.filter(p=>p.outcome==='lost').length;document.getElementById('stat-winrate').textContent=(won+lost)>0?Math.round(won/(won+lost)*100)+'%':'--%';document.getElementById('stat-pending').textContent=projs.filter(p=>p.outcome==='pending').length;const time=parseFloat(prefs.time)||1.5;document.getElementById('stat-hours').textContent=Math.round(projs.length*time*10)/10;document.getElementById('tip-time').textContent=time;const recent=document.getElementById('recent-activity');const last5=projs.slice(0,5);if(!last5.length)recent.innerHTML='<p style="color:var(--gray-500);text-align:center;padding:40px">No bids. <a href="#" onclick="showTab(\'analyze\');return false">Analyze ‚Üí</a></p>';else recent.innerHTML=`<table><thead><tr><th>Project</th><th>Score</th><th>Outcome</th></tr></thead><tbody>${last5.map(p=>`<tr onclick="viewReport('${p.id}')" style="cursor:pointer"><td>${p.ext?.project_name||'?'}</td><td><span class="score-badge score-${p.score?.cls||'neutral'}">${p.score?.final||'--'}</span></td><td>${p.outcome}</td></tr>`).join('')}</tbody></table>`;const topEl=document.getElementById('top-gcs');const gcs=getGCs().filter(g=>g.bids>0).sort((a,b)=>(b.wins/b.bids)-(a.wins/a.bids)).slice(0,5);if(!gcs.length)topEl.innerHTML='<p style="color:var(--gray-500);text-align:center;padding:40px">Track outcomes</p>';else topEl.innerHTML=`<table><thead><tr><th>GC</th><th>Rate</th><th>Bids</th></tr></thead><tbody>${gcs.map(g=>`<tr><td>${g.name}</td><td><b>${Math.round(g.wins/g.bids*100)}%</b></td><td>${g.bids}</td></tr>`).join('')}</tbody></table>`}
function initDivs(){document.getElementById('div-grid').innerHTML=CSI.map(d=>`<label class="division-item"><input type="checkbox" id="d-${d.n}" value="${d.n}"><span><b>${d.n}</b> ${d.t}</span></label>`).join('')}
function loadPrefs(){const p=getPrefs();document.getElementById('pref-loc').value=p.location||'';document.getElementById('pref-radius').value=p.radius||'50';document.getElementById('pref-loc-on').checked=p.locOn!==false;document.getElementById('pref-risk').value=p.risk||'medium';document.getElementById('pref-gc-def').value=p.gcDef||'3';document.getElementById('pref-cap').value=p.cap||'steady';document.getElementById('pref-time').value=p.time||'1.5';document.getElementById('pref-ghost').value=p.ghost||'60';document.getElementById('w-loc').value=p.weights?.loc||25;document.getElementById('w-kw').value=p.weights?.kw||30;document.getElementById('w-gc').value=p.weights?.gc||25;document.getElementById('w-tr').value=p.weights?.tr||20;updateW();(p.divisions||[]).forEach(d=>{const cb=document.getElementById('d-'+d);if(cb)cb.checked=true})}
async function savePrefs(){const loc=document.getElementById('pref-loc').value.trim();let coords=null;if(loc){coords=await geocode(loc);if(!coords)return alert('Location not found')}const divs=CSI.map(d=>d.n).filter(n=>document.getElementById('d-'+n)?.checked);const p={location:loc,coords,radius:document.getElementById('pref-radius').value,locOn:document.getElementById('pref-loc-on').checked,risk:document.getElementById('pref-risk').value,gcDef:document.getElementById('pref-gc-def').value,cap:document.getElementById('pref-cap').value,time:document.getElementById('pref-time').value,ghost:document.getElementById('pref-ghost').value,divisions:divs,weights:{loc:parseInt(document.getElementById('w-loc').value),kw:parseInt(document.getElementById('w-kw').value),gc:parseInt(document.getElementById('w-gc').value),tr:parseInt(document.getElementById('w-tr').value)}};localStorage.setItem('bidiq_prefs',JSON.stringify(p));alert('Saved!'+(coords?' Office: '+loc:''));updateDash()}
function updateW(){const l=parseInt(document.getElementById('w-loc').value),k=parseInt(document.getElementById('w-kw').value),g=parseInt(document.getElementById('w-gc').value),t=parseInt(document.getElementById('w-tr').value);document.getElementById('w-loc-v').textContent=l+'%';document.getElementById('w-kw-v').textContent=k+'%';document.getElementById('w-gc-v').textContent=g+'%';document.getElementById('w-tr-v').textContent=t+'%';const tot=l+k+g+t;const el=document.getElementById('w-total');el.textContent='Total: '+tot+'%';el.classList.toggle('error',tot!==100)}
function loadKW(){const kw=getKW();renderKWList('want',kw.want||[]);renderKWList('dontwant',kw.dontwant||[]);renderKWList('musthave',kw.musthave||[])}
function renderKWList(type,list){document.getElementById('kw-'+type).innerHTML=list.length?list.map(k=>`<span class="keyword-chip ${type}">${k}<span style="cursor:pointer;margin-left:6px" onclick="delKW('${type}','${k}')">√ó</span></span>`).join(''):'<span style="color:var(--gray-400)">None</span>'}
function addKW(type){const input=document.getElementById('add-'+type);const k=input.value.trim().toLowerCase();if(!k)return;const kw=getKW();if(!kw[type].includes(k)){kw[type].push(k);localStorage.setItem('bidiq_kw',JSON.stringify(kw));renderKWList(type,kw[type])}input.value=''}
function delKW(type,k){const kw=getKW();kw[type]=kw[type].filter(x=>x!==k);localStorage.setItem('bidiq_kw',JSON.stringify(kw));renderKWList(type,kw[type])}
function loadGCs(){const gcs=getGCs();const tb=document.getElementById('gc-table');if(!gcs.length){tb.innerHTML='<tr><td colspan="6" style="text-align:center;padding:40px;color:var(--gray-500)">No GCs</td></tr>';return}tb.innerHTML=gcs.map(g=>{const wr=g.bids>0?Math.round(g.wins/g.bids*100):'--';return`<tr><td><b>${g.name}</b></td><td style="color:#f59e0b">${'‚≠ê'.repeat(g.rating)}</td><td>${g.bids||0}</td><td>${g.wins||0}</td><td>${wr}%</td><td><button class="btn btn-secondary btn-small" onclick="editGC('${g.name}')">‚úèÔ∏è</button><button class="btn btn-danger btn-small" onclick="delGC('${g.name}')">üóëÔ∏è</button></td></tr>`}).join('')}
function addGC(){const name=document.getElementById('new-gc-name').value.trim();const rating=parseInt(document.getElementById('new-gc-rat').value);if(!name)return alert('Enter name');const gcs=getGCs();if(gcs.find(g=>g.name.toLowerCase()===name.toLowerCase()))return alert('Exists');gcs.push({name,rating,bids:0,wins:0});localStorage.setItem('bidiq_gcs',JSON.stringify(gcs));document.getElementById('new-gc-name').value='';loadGCs()}
function editGC(name){const gcs=getGCs();const gc=gcs.find(g=>g.name===name);if(!gc)return;const r=prompt('Rating (1-5):',gc.rating);if(r&&!isNaN(r)&&r>=1&&r<=5){gc.rating=parseInt(r);localStorage.setItem('bidiq_gcs',JSON.stringify(gcs));loadGCs()}}
function delGC(name){if(!confirm('Delete '+name+'?'))return;localStorage.setItem('bidiq_gcs',JSON.stringify(getGCs().filter(g=>g.name!==name)));loadGCs()}
function exportCSV(){const projs=getProjects();if(!projs.length)return alert('No projects');const rows=[['Project','City','State','Score','Rec','GCs','Deadline','Outcome']];projs.forEach(p=>rows.push([p.ext?.project_name||'',p.ext?.project_city||'',p.ext?.project_state||'',p.score?.final||'',p.score?.rec||'',p.gcs?.map(g=>g.name).join(';')||'',p.ext?.bid_deadline||'',p.outcome||'']));const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);a.download='bidiq_export.csv';a.click()}
    </script>
</body>
</html>
