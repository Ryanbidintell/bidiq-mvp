<!DOCTYPE html>
<html>
<head>
    <title>BidIQ - Bid Intelligence Platform</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; padding: 20px; max-width: 1400px; margin: auto; background: #f0f2f5; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: #1a1a2e; margin-top: 0; display: flex; align-items: center; gap: 10px; }
        h1 .logo { font-size: 32px; }
        h2 { color: #16213e; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; margin-top: 0; }
        h3 { color: #1a1a2e; margin-top: 0; }
        
        /* Tabs */
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; background: #e8e8e8; padding: 5px; border-radius: 10px; }
        .tab { padding: 12px 24px; background: transparent; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 500; color: #666; transition: all 0.2s; }
        .tab:hover { background: #d0d0d0; }
        .tab.active { background: #4CAF50; color: white; box-shadow: 0 2px 4px rgba(76,175,80,0.3); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Forms */
        label { display: block; margin: 12px 0 6px; font-weight: 600; color: #333; }
        input[type="text"], input[type="number"], select, textarea {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: #4CAF50; outline: none; }
        textarea { min-height: 100px; font-family: monospace; }
        .hint { font-size: 12px; color: #888; margin-top: 4px; }
        
        /* Weight sliders */
        .weight-row { display: flex; align-items: center; gap: 15px; margin: 12px 0; padding: 15px; background: #f8f9fa; border-radius: 10px; }
        .weight-label { width: 180px; font-weight: 600; }
        .weight-slider { flex: 1; }
        .weight-value { width: 55px; text-align: center; font-weight: bold; font-size: 16px; color: #4CAF50; }
        input[type="range"] { width: 100%; height: 6px; -webkit-appearance: none; background: #ddd; border-radius: 3px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: #4CAF50; border-radius: 50%; cursor: pointer; }
        
        /* Buttons */
        button {
            background: #4CAF50; color: white; padding: 14px 28px; border: none;
            border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; margin: 5px; transition: all 0.2s;
        }
        button:hover { background: #43a047; transform: translateY(-1px); }
        button:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-small { padding: 8px 16px; font-size: 13px; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        
        /* Dashboard */
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; text-align: center; }
        .stat-card.green { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .stat-card.orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-card.blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-number { font-size: 42px; font-weight: bold; }
        .stat-label { font-size: 14px; opacity: 0.9; margin-top: 5px; }
        
        /* Bid cards */
        .bid-list { display: flex; flex-direction: column; gap: 15px; }
        .bid-card { background: #fff; border: 2px solid #e8e8e8; border-radius: 12px; padding: 20px; transition: all 0.2s; }
        .bid-card:hover { border-color: #4CAF50; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .bid-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .bid-title { font-size: 18px; font-weight: 600; color: #1a1a2e; margin: 0; }
        .bid-gc { color: #666; font-size: 14px; margin-top: 4px; }
        .bid-score { font-size: 28px; font-weight: bold; padding: 8px 16px; border-radius: 8px; }
        .score-go { background: #d4edda; color: #155724; }
        .score-review { background: #fff3cd; color: #856404; }
        .score-pass { background: #f8d7da; color: #721c24; }
        .bid-meta { display: flex; gap: 20px; flex-wrap: wrap; font-size: 13px; color: #666; }
        .bid-meta span { display: flex; align-items: center; gap: 5px; }
        .bid-actions { display: flex; gap: 8px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
        .outcome-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .outcome-won { background: #d4edda; color: #155724; }
        .outcome-lost { background: #f8d7da; color: #721c24; }
        .outcome-ghost { background: #e2e3e5; color: #383d41; }
        .outcome-declined { background: #cce5ff; color: #004085; }
        .outcome-pending { background: #fff3cd; color: #856404; }
        
        /* Analysis results */
        .result-box { margin-top: 20px; }
        .score-display { font-size: 56px; font-weight: bold; text-align: center; padding: 40px; border-radius: 16px; margin: 20px 0; }
        .score-display.go { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; }
        .score-display.review { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .score-display.pass { background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); color: white; }
        .score-display small { display: block; font-size: 20px; font-weight: normal; margin-top: 5px; opacity: 0.9; }
        
        /* Score breakdown */
        .score-breakdown { background: #f8f9fa; padding: 25px; border-radius: 12px; margin: 20px 0; }
        .score-component { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #e0e0e0; }
        .score-component:last-child { border-bottom: none; }
        .component-icon { font-size: 24px; width: 45px; }
        .component-name { width: 160px; font-weight: 600; }
        .component-bar { flex: 1; height: 12px; background: #e0e0e0; border-radius: 6px; overflow: hidden; margin: 0 15px; }
        .component-fill { height: 100%; border-radius: 6px; transition: width 0.5s; }
        .fill-high { background: linear-gradient(90deg, #11998e, #38ef7d); }
        .fill-medium { background: linear-gradient(90deg, #f093fb, #f5576c); }
        .fill-low { background: linear-gradient(90deg, #eb3349, #f45c43); }
        .component-score { width: 50px; text-align: right; font-weight: bold; font-size: 16px; }
        .component-weight { width: 45px; text-align: right; color: #888; font-size: 12px; }
        .component-detail { font-size: 13px; color: #666; margin-left: 45px; padding: 8px 0; background: #fff; margin: 5px 0; padding: 10px; border-radius: 6px; }
        
        /* Details panel */
        .details { background: #f8f9fa; padding: 25px; border-radius: 12px; margin-top: 20px; }
        .detail-row { display: flex; padding: 12px 0; border-bottom: 1px solid #e8e8e8; }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { font-weight: 600; width: 180px; color: #555; }
        .detail-value { flex: 1; color: #1a1a2e; }
        
        /* Keywords display */
        .keyword-tag { display: inline-block; padding: 5px 12px; margin: 3px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .keyword-good { background: #d4edda; color: #155724; }
        .keyword-bad { background: #f8d7da; color: #721c24; }
        .keyword-missing { background: #fff3cd; color: #856404; }
        
        /* Grid layout */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
        
        /* Status messages */
        .status { padding: 15px 20px; border-radius: 10px; margin: 15px 0; }
        .status-info { background: #d1ecf1; color: #0c5460; }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        
        /* Progress bar */
        .progress-container { background: #e0e0e0; border-radius: 10px; height: 8px; margin: 15px 0; overflow: hidden; }
        .progress-bar { background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; transition: width 0.3s; border-radius: 10px; }
        .progress-text { text-align: center; font-size: 14px; color: #666; margin-top: 8px; }
        
        /* Quick stats in results */
        .quick-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
        .quick-stat { background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; }
        .quick-stat-number { font-size: 28px; font-weight: bold; color: #4CAF50; }
        .quick-stat-label { font-size: 12px; color: #666; margin-top: 5px; }
        
        /* Saved indicator */
        .saved-indicator { display: inline-block; padding: 6px 12px; background: #28a745; color: white; border-radius: 6px; font-size: 13px; margin-left: 10px; }
        
        /* Empty state */
        .empty-state { text-align: center; padding: 60px 20px; color: #888; }
        .empty-state-icon { font-size: 64px; margin-bottom: 20px; }
        .empty-state h3 { color: #555; margin-bottom: 10px; }
        
        /* Filter bar */
        .filter-bar { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .filter-bar select { width: auto; min-width: 150px; }
        .filter-bar input { width: auto; min-width: 250px; }
    </style>
</head>
<body>
    <div class="container">
        <h1><span class="logo">üéØ</span> BidIQ</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('analyze')">üìÑ Analyze Bid</button>
            <button class="tab" onclick="showTab('preferences')">‚öôÔ∏è Preferences</button>
            <button class="tab" onclick="showTab('keywords')">üîë Keywords</button>
            <button class="tab" onclick="showTab('gcs')">üè¢ GC Ratings</button>
        </div>
        
        <!-- DASHBOARD TAB -->
        <div id="tab-dashboard" class="tab-content active">
            <h2>Dashboard</h2>
            
            <div class="dashboard-stats" id="dashboard-stats">
                <!-- Populated by JS -->
            </div>
            
            <div class="filter-bar">
                <input type="text" id="filter-search" placeholder="üîç Search projects..." oninput="renderBidList()">
                <select id="filter-outcome" onchange="renderBidList()">
                    <option value="">All Outcomes</option>
                    <option value="pending">‚è≥ Pending</option>
                    <option value="won">‚úÖ Won</option>
                    <option value="lost">‚ùå Lost</option>
                    <option value="ghost">üëª Ghost</option>
                    <option value="declined">üö´ Declined</option>
                </select>
                <select id="filter-score" onchange="renderBidList()">
                    <option value="">All Scores</option>
                    <option value="go">GO (75+)</option>
                    <option value="review">REVIEW (55-74)</option>
                    <option value="pass">PASS (<55)</option>
                </select>
            </div>
            
            <div class="bid-list" id="bid-list">
                <!-- Populated by JS -->
            </div>
        </div>
        
        <!-- ANALYZE TAB -->
        <div id="tab-analyze" class="tab-content">
            <h2>Analyze New Bid</h2>
            <p>Upload your bid package. BidIQ reads <strong>all pages</strong> and scores based on YOUR preferences.</p>
            
            <input type="file" id="pdfFile" accept=".pdf" multiple style="margin: 15px 0;">
            <p class="hint">Select one or more PDF files (invite, specs, contract, etc.)</p>
            
            <button id="analyzeBtn" onclick="analyzeBid()">ü§ñ Analyze with AI</button>
            
            <div id="progress" style="display: none;">
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progress-text">Starting...</div>
            </div>
            
            <div id="result"></div>
        </div>
        
        <!-- PREFERENCES TAB -->
        <div id="tab-preferences" class="tab-content">
            <h2>My Preferences</h2>
            <p>Configure your business parameters. These affect how bids are scored FOR YOU.</p>
            
            <div class="grid-2">
                <div>
                    <label>Office Location (City, State)</label>
                    <input type="text" id="pref-location" placeholder="Kansas City, MO">
                    <p class="hint">Used to calculate distance to projects</p>
                </div>
                <div>
                    <label>Service Radius</label>
                    <select id="pref-radius">
                        <option value="25">25 miles - Local only</option>
                        <option value="50" selected>50 miles - Regional</option>
                        <option value="100">100 miles - Wide regional</option>
                        <option value="150">150+ miles - Will travel</option>
                    </select>
                </div>
            </div>
            
            <label>My Trades (CSI Divisions)</label>
            <div id="csi-checkboxes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 8px; margin: 15px 0;"></div>
            
            <div class="grid-2">
                <div>
                    <label>Risk Tolerance</label>
                    <select id="pref-risk">
                        <option value="low">Conservative - Flag all risky clauses</option>
                        <option value="medium" selected>Moderate - Standard terms acceptable</option>
                        <option value="high">Aggressive - Comfortable with risk</option>
                    </select>
                </div>
                <div>
                    <label>Unknown GC Treatment</label>
                    <select id="pref-unknown-gc">
                        <option value="2">Treat as negative (2 stars)</option>
                        <option value="3" selected>Treat as neutral (3 stars)</option>
                        <option value="4">Treat as positive (4 stars)</option>
                    </select>
                </div>
            </div>
            
            <h3 style="margin-top: 30px;">üìä Score Component Weights</h3>
            <p>Adjust how much each factor matters to YOUR business. Weights must total 100%.</p>
            
            <div id="weights-container">
                <div class="weight-row">
                    <span class="weight-label">üìç Location Fit</span>
                    <input type="range" class="weight-slider" id="weight-location" min="0" max="60" value="25" oninput="updateWeights()">
                    <span class="weight-value" id="weight-location-val">25%</span>
                </div>
                <div class="weight-row">
                    <span class="weight-label">üîß Trade Match</span>
                    <input type="range" class="weight-slider" id="weight-trade" min="0" max="60" value="25" oninput="updateWeights()">
                    <span class="weight-value" id="weight-trade-val">25%</span>
                </div>
                <div class="weight-row">
                    <span class="weight-label">üîë Keywords Found</span>
                    <input type="range" class="weight-slider" id="weight-keywords" min="0" max="60" value="25" oninput="updateWeights()">
                    <span class="weight-value" id="weight-keywords-val">25%</span>
                </div>
                <div class="weight-row">
                    <span class="weight-label">üè¢ GC Relationship</span>
                    <input type="range" class="weight-slider" id="weight-gc" min="0" max="60" value="25" oninput="updateWeights()">
                    <span class="weight-value" id="weight-gc-val">25%</span>
                </div>
                <div class="weight-row" style="background: #e8f5e9;">
                    <span class="weight-label"><strong>Total</strong></span>
                    <span style="flex:1"></span>
                    <span class="weight-value" id="weight-total" style="font-size: 20px;">100%</span>
                </div>
            </div>
            
            <button onclick="savePreferences()">üíæ Save Preferences</button>
            <button class="btn-secondary" onclick="resetWeights()">‚Ü∫ Reset Weights</button>
            <span id="save-indicator" style="display:none" class="saved-indicator">‚úì Saved</span>
        </div>
        
        <!-- KEYWORDS TAB -->
        <div id="tab-keywords" class="tab-content">
            <h2>My Keywords & Contract Terms</h2>
            <p>Tell BidIQ which products, specs, and contract terms matter to you. We scan every page for these.</p>
            
            <div class="grid-2">
                <div>
                    <h3>‚úÖ Products & Terms I WANT</h3>
                    <p class="hint" style="margin-bottom: 10px;">Brands, systems, or phrases that make a project attractive.</p>
                    <textarea id="kw-products-good" placeholder="Mecho shades&#10;fabric panel&#10;Lenel access control&#10;negotiated contract&#10;repeat client&#10;BIM coordination"></textarea>
                    <p class="hint">One per line. Found = +12 points each</p>
                </div>
                <div>
                    <h3>üö´ Products & Terms I DON'T Want</h3>
                    <p class="hint" style="margin-bottom: 10px;">Products or contract language you'd rather avoid.</p>
                    <textarea id="kw-products-bad" placeholder="Tandus&#10;Mannington&#10;pay if paid&#10;pay when paid&#10;liquidated damages&#10;no damages for delay"></textarea>
                    <p class="hint">One per line. Found = -15 points each</p>
                </div>
            </div>
            
            <div class="grid-2" style="margin-top: 25px;">
                <div>
                    <h3>üö® Must-Have Items</h3>
                    <p class="hint" style="margin-bottom: 10px;">Items that MUST be in specs for this to be a good fit.</p>
                    <textarea id="kw-products-musthave" placeholder="Lenel&#10;owner-furnished shades"></textarea>
                    <p class="hint">One per line. If NOT found = -30 points each</p>
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
                    <h3 style="margin-top: 0;">üí° How This Works</h3>
                    <p style="font-size: 14px;">BidIQ scans ALL pages for these items:</p>
                    <ul style="font-size: 14px; padding-left: 20px;">
                        <li><strong>"I WANT"</strong> ‚Üí +12 points when found</li>
                        <li><strong>"I DON'T want"</strong> ‚Üí -15 points when found</li>
                        <li><strong>"Must-Have"</strong> ‚Üí -30 if NOT found</li>
                    </ul>
                </div>
            </div>
            
            <div style="margin-top: 25px;">
                <button onclick="saveKeywords()">üíæ Save Keywords</button>
                <button class="btn-secondary" onclick="loadDefaultKeywords()">‚Ü∫ Load Defaults</button>
                <span id="kw-save-indicator" style="display:none" class="saved-indicator">‚úì Saved</span>
            </div>
        </div>
        
        <!-- GC RATINGS TAB -->
        <div id="tab-gcs" class="tab-content">
            <h2>My GC Relationships</h2>
            <p>Rate GCs you work with. Higher-rated GCs push their bids higher in your overall score.</p>
            
            <div id="gc-list"></div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                <input type="text" id="new-gc-name" placeholder="GC Company Name" style="flex: 1; min-width: 200px;">
                <select id="new-gc-rating" style="width: 200px;">
                    <option value="1">‚≠ê Avoid if possible</option>
                    <option value="2">‚≠ê‚≠ê Below average</option>
                    <option value="3" selected>‚≠ê‚≠ê‚≠ê Neutral / Unknown</option>
                    <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Good relationship</option>
                    <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Great - prefer them</option>
                </select>
                <button onclick="addGC()">+ Add GC</button>
            </div>
            
            <p class="hint" style="margin-top: 15px;">
                <strong>Think about:</strong> Trust, fairness on change orders, schedule pressure, and how often you actually make money with them.
            </p>
            
            <div style="background: #e8f4fd; padding: 15px; border-radius: 10px; margin-top: 20px; border-left: 4px solid #2196F3;">
                <strong>üîÆ Coming Soon:</strong> We'll track how ratings line up with your wins/losses to recommend which GCs are worth prioritizing.
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // API Key (move to backend in production!)
        const CLAUDE_API_KEY = "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";
        
        // CSI Divisions
        const CSI_DIVISIONS = [
            {num: 1, name: "General Requirements"}, {num: 2, name: "Existing Conditions"},
            {num: 3, name: "Concrete"}, {num: 4, name: "Masonry"}, {num: 5, name: "Metals"},
            {num: 6, name: "Wood/Plastics/Composites"}, {num: 7, name: "Thermal/Moisture"},
            {num: 8, name: "Openings"}, {num: 9, name: "Finishes"}, {num: 10, name: "Specialties"},
            {num: 11, name: "Equipment"}, {num: 12, name: "Furnishings"},
            {num: 13, name: "Special Construction"}, {num: 14, name: "Conveying Equipment"},
            {num: 21, name: "Fire Suppression"}, {num: 22, name: "Plumbing"}, {num: 23, name: "HVAC"},
            {num: 25, name: "Integrated Automation"}, {num: 26, name: "Electrical"},
            {num: 27, name: "Communications"}, {num: 28, name: "Electronic Safety/Security"},
            {num: 31, name: "Earthwork"}, {num: 32, name: "Exterior Improvements"}, {num: 33, name: "Utilities"}
        ];
        
        // Default keywords
        const DEFAULT_KEYWORDS = {
            productsGood: ["negotiated contract", "repeat client", "design-assist", "BIM coordination", "progress payments", "no retainage"],
            productsBad: ["pay if paid", "pay when paid", "liquidated damages", "no damages for delay", "termination for convenience", "broad form indemnity"],
            productsMustHave: []
        };
        
        // ==================== GEOCODING & DISTANCE ====================
        
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 3959;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }
        
        async function geocodeLocation(locationString) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationString)}&limit=1&countrycodes=us`,
                    { headers: { 'User-Agent': 'BidIQ-MVP/1.0' } }
                );
                const data = await response.json();
                if (data.length === 0) return null;
                return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
            } catch (err) {
                console.warn('Geocoding error:', err);
                return null;
            }
        }
        
        function calculateLocationScore(distance, radius) {
            if (distance <= radius) {
                return Math.round(100 - (distance / radius) * 25);
            } else {
                const overage = distance - radius;
                return Math.max(20, Math.round(75 - Math.min(overage / radius, 1) * 50));
            }
        }
        
        // ==================== BID STORAGE ====================
        
        function getBids() {
            return JSON.parse(localStorage.getItem('bidiq_bids') || '[]');
        }
        
        function saveBid(bid) {
            const bids = getBids();
            bid.id = Date.now().toString();
            bid.created_at = new Date().toISOString();
            bid.outcome = 'pending';
            bids.unshift(bid);
            localStorage.setItem('bidiq_bids', JSON.stringify(bids));
            return bid;
        }
        
        function updateBidOutcome(bidId, outcome) {
            const bids = getBids();
            const bid = bids.find(b => b.id === bidId);
            if (bid) {
                bid.outcome = outcome;
                bid.outcome_date = new Date().toISOString();
                localStorage.setItem('bidiq_bids', JSON.stringify(bids));
            }
            renderBidList();
            renderDashboardStats();
        }
        
        function deleteBid(bidId) {
            if (!confirm('Delete this bid? This cannot be undone.')) return;
            const bids = getBids().filter(b => b.id !== bidId);
            localStorage.setItem('bidiq_bids', JSON.stringify(bids));
            renderBidList();
            renderDashboardStats();
        }
        
        // ==================== DASHBOARD ====================
        
        function renderDashboardStats() {
            const bids = getBids();
            const total = bids.length;
            const won = bids.filter(b => b.outcome === 'won').length;
            const pending = bids.filter(b => b.outcome === 'pending').length;
            const avgScore = total > 0 ? Math.round(bids.reduce((sum, b) => sum + b.score, 0) / total) : 0;
            
            document.getElementById('dashboard-stats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${total}</div>
                    <div class="stat-label">Total Bids Analyzed</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-number">${won}</div>
                    <div class="stat-label">Bids Won</div>
                </div>
                <div class="stat-card orange">
                    <div class="stat-number">${pending}</div>
                    <div class="stat-label">Pending Outcome</div>
                </div>
                <div class="stat-card blue">
                    <div class="stat-number">${avgScore}</div>
                    <div class="stat-label">Average Score</div>
                </div>
            `;
        }
        
        function renderBidList() {
            let bids = getBids();
            
            // Apply filters
            const search = document.getElementById('filter-search').value.toLowerCase();
            const outcomeFilter = document.getElementById('filter-outcome').value;
            const scoreFilter = document.getElementById('filter-score').value;
            
            if (search) {
                bids = bids.filter(b => 
                    (b.project_name || '').toLowerCase().includes(search) ||
                    (b.gc_name || '').toLowerCase().includes(search) ||
                    (b.location || '').toLowerCase().includes(search)
                );
            }
            if (outcomeFilter) {
                bids = bids.filter(b => b.outcome === outcomeFilter);
            }
            if (scoreFilter) {
                if (scoreFilter === 'go') bids = bids.filter(b => b.score >= 75);
                else if (scoreFilter === 'review') bids = bids.filter(b => b.score >= 55 && b.score < 75);
                else if (scoreFilter === 'pass') bids = bids.filter(b => b.score < 55);
            }
            
            const container = document.getElementById('bid-list');
            
            if (bids.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <h3>No bids yet</h3>
                        <p>Upload your first bid document to get started.</p>
                        <button onclick="showTab('analyze')">üìÑ Analyze a Bid</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = bids.map(bid => {
                const scoreClass = bid.score >= 75 ? 'score-go' : bid.score >= 55 ? 'score-review' : 'score-pass';
                const recommendation = bid.score >= 75 ? 'GO' : bid.score >= 55 ? 'REVIEW' : 'PASS';
                const outcomeLabels = {
                    pending: '‚è≥ Pending',
                    won: '‚úÖ Won',
                    lost: '‚ùå Lost',
                    ghost: 'üëª Ghost',
                    declined: 'üö´ Declined'
                };
                const outcomeClass = `outcome-${bid.outcome}`;
                const date = new Date(bid.created_at).toLocaleDateString();
                
                return `
                    <div class="bid-card">
                        <div class="bid-header">
                            <div>
                                <h3 class="bid-title">${bid.project_name || 'Untitled Project'}</h3>
                                <div class="bid-gc">${bid.gc_name || 'Unknown GC'}</div>
                            </div>
                            <div class="bid-score ${scoreClass}">${bid.score} - ${recommendation}</div>
                        </div>
                        <div class="bid-meta">
                            <span>üìç ${bid.location || 'Unknown'}${bid.distance ? ` (${bid.distance} mi)` : ''}</span>
                            <span>üìÖ ${date}</span>
                            <span class="outcome-badge ${outcomeClass}">${outcomeLabels[bid.outcome]}</span>
                        </div>
                        <div class="bid-actions">
                            <select onchange="updateBidOutcome('${bid.id}', this.value)" style="padding: 8px; border-radius: 6px;">
                                <option value="pending" ${bid.outcome === 'pending' ? 'selected' : ''}>‚è≥ Pending</option>
                                <option value="won" ${bid.outcome === 'won' ? 'selected' : ''}>‚úÖ Won</option>
                                <option value="lost" ${bid.outcome === 'lost' ? 'selected' : ''}>‚ùå Lost</option>
                                <option value="ghost" ${bid.outcome === 'ghost' ? 'selected' : ''}>üëª Ghost</option>
                                <option value="declined" ${bid.outcome === 'declined' ? 'selected' : ''}>üö´ Declined to Bid</option>
                            </select>
                            <button class="btn-small btn-secondary" onclick="viewBidDetails('${bid.id}')">üëÅÔ∏è View Details</button>
                            <button class="btn-small btn-danger" onclick="deleteBid('${bid.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function viewBidDetails(bidId) {
            const bid = getBids().find(b => b.id === bidId);
            if (!bid) return;
            
            // Switch to analyze tab and display the saved results
            showTab('analyze');
            displaySavedResults(bid);
        }
        
        function displaySavedResults(bid) {
            const scoreClass = bid.score >= 75 ? 'go' : bid.score >= 55 ? 'review' : 'pass';
            const recommendation = bid.score >= 75 ? 'GO' : bid.score >= 55 ? 'REVIEW' : 'PASS';
            
            const getFillClass = (score) => score >= 70 ? 'fill-high' : score >= 40 ? 'fill-medium' : 'fill-low';
            
            document.getElementById('result').innerHTML = `
                <div class="result-box">
                    <div class="score-display ${scoreClass}">
                        ${bid.score}/100
                        <small>${recommendation}</small>
                    </div>
                    
                    <div class="quick-stats">
                        <div class="quick-stat">
                            <div class="quick-stat-number">${bid.distance || '?'}</div>
                            <div class="quick-stat-label">Miles Away</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-number">${bid.pages || '?'}</div>
                            <div class="quick-stat-label">Pages</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-number">${bid.files || '?'}</div>
                            <div class="quick-stat-label">Files</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-number">${bid.divisions || '?'}</div>
                            <div class="quick-stat-label">Divisions</div>
                        </div>
                    </div>
                    
                    <div class="score-breakdown">
                        <h3>üìä Score Breakdown</h3>
                        ${Object.entries(bid.components || {}).map(([key, comp]) => `
                            <div class="score-component">
                                <span class="component-icon">${key === 'location' ? 'üìç' : key === 'trade' ? 'üîß' : key === 'keywords' ? 'üîë' : 'üè¢'}</span>
                                <span class="component-name">${key.charAt(0).toUpperCase() + key.slice(1)}</span>
                                <div class="component-bar"><div class="component-fill ${getFillClass(comp.score)}" style="width: ${comp.score}%"></div></div>
                                <span class="component-score">${comp.score}</span>
                                <span class="component-weight">${comp.weight}%</span>
                            </div>
                            <div class="component-detail">${comp.detail || ''}</div>
                        `).join('')}
                    </div>
                    
                    <div class="details">
                        <h3>üìã Project Details</h3>
                        <div class="detail-row"><span class="detail-label">Project:</span><span class="detail-value">${bid.project_name || 'Unknown'}</span></div>
                        <div class="detail-row"><span class="detail-label">GC:</span><span class="detail-value">${bid.gc_name || 'Unknown'}</span></div>
                        <div class="detail-row"><span class="detail-label">Location:</span><span class="detail-value">${bid.location || 'Unknown'}</span></div>
                        <div class="detail-row"><span class="detail-label">Deadline:</span><span class="detail-value">${bid.deadline || 'Not specified'}</span></div>
                        <div class="detail-row"><span class="detail-label">Analyzed:</span><span class="detail-value">${new Date(bid.created_at).toLocaleString()}</span></div>
                    </div>
                </div>
            `;
        }
        
        // ==================== PREFERENCES ====================
        
        function loadPreferences() {
            const prefs = JSON.parse(localStorage.getItem('bidiq_preferences') || '{}');
            document.getElementById('pref-location').value = prefs.location || '';
            document.getElementById('pref-radius').value = prefs.radius || '50';
            document.getElementById('pref-risk').value = prefs.riskTolerance || 'medium';
            document.getElementById('pref-unknown-gc').value = prefs.unknownGC || '3';
            
            document.getElementById('weight-location').value = prefs.weights?.location || 25;
            document.getElementById('weight-trade').value = prefs.weights?.trade || 25;
            document.getElementById('weight-keywords').value = prefs.weights?.keywords || 25;
            document.getElementById('weight-gc').value = prefs.weights?.gc || 25;
            updateWeights();
            
            (prefs.divisions || []).forEach(num => {
                const cb = document.getElementById('csi-' + num);
                if (cb) cb.checked = true;
            });
        }
        
        async function savePreferences() {
            const locationInput = document.getElementById('pref-location').value;
            const indicator = document.getElementById('save-indicator');
            
            const prefs = {
                location: locationInput,
                radius: parseInt(document.getElementById('pref-radius').value),
                riskTolerance: document.getElementById('pref-risk').value,
                unknownGC: document.getElementById('pref-unknown-gc').value,
                weights: {
                    location: parseInt(document.getElementById('weight-location').value),
                    trade: parseInt(document.getElementById('weight-trade').value),
                    keywords: parseInt(document.getElementById('weight-keywords').value),
                    gc: parseInt(document.getElementById('weight-gc').value)
                },
                divisions: getSelectedDivisions(),
                coordinates: null
            };
            
            if (locationInput && locationInput.trim().length > 0) {
                indicator.style.display = 'inline-block';
                indicator.textContent = 'üìç Geocoding...';
                indicator.style.background = '#ffc107';
                
                const coords = await geocodeLocation(locationInput);
                if (coords) {
                    prefs.coordinates = coords;
                    indicator.textContent = '‚úì Saved & Geocoded';
                    indicator.style.background = '#28a745';
                } else {
                    indicator.textContent = '‚ö†Ô∏è Saved (location not found)';
                    indicator.style.background = '#fd7e14';
                }
            } else {
                indicator.style.display = 'inline-block';
                indicator.textContent = '‚úì Saved';
                indicator.style.background = '#28a745';
            }
            
            localStorage.setItem('bidiq_preferences', JSON.stringify(prefs));
            setTimeout(() => indicator.style.display = 'none', 2500);
        }
        
        function getSelectedDivisions() {
            return CSI_DIVISIONS.filter(d => document.getElementById('csi-' + d.num)?.checked).map(d => d.num);
        }
        
        function updateWeights() {
            let total = 0;
            ['location', 'trade', 'keywords', 'gc'].forEach(w => {
                const val = parseInt(document.getElementById('weight-' + w).value);
                document.getElementById('weight-' + w + '-val').textContent = val + '%';
                total += val;
            });
            const el = document.getElementById('weight-total');
            el.textContent = total + '%';
            el.style.color = total === 100 ? '#28a745' : '#dc3545';
        }
        
        function resetWeights() {
            ['location', 'trade', 'keywords', 'gc'].forEach(w => {
                document.getElementById('weight-' + w).value = 25;
            });
            updateWeights();
        }
        
        // ==================== KEYWORDS ====================
        
        function loadKeywords() {
            const kw = JSON.parse(localStorage.getItem('bidiq_keywords') || 'null') || DEFAULT_KEYWORDS;
            document.getElementById('kw-products-good').value = (kw.productsGood || []).join('\n');
            document.getElementById('kw-products-bad').value = (kw.productsBad || []).join('\n');
            document.getElementById('kw-products-musthave').value = (kw.productsMustHave || []).join('\n');
        }
        
        function saveKeywords() {
            const kw = {
                productsGood: document.getElementById('kw-products-good').value.split('\n').map(k => k.trim()).filter(k => k),
                productsBad: document.getElementById('kw-products-bad').value.split('\n').map(k => k.trim()).filter(k => k),
                productsMustHave: document.getElementById('kw-products-musthave').value.split('\n').map(k => k.trim()).filter(k => k)
            };
            localStorage.setItem('bidiq_keywords', JSON.stringify(kw));
            const indicator = document.getElementById('kw-save-indicator');
            indicator.style.display = 'inline-block';
            setTimeout(() => indicator.style.display = 'none', 2000);
        }
        
        function loadDefaultKeywords() {
            localStorage.removeItem('bidiq_keywords');
            loadKeywords();
        }
        
        // ==================== GC RATINGS ====================
        
        function loadGCRatings() {
            renderGCList(JSON.parse(localStorage.getItem('bidiq_gc_ratings') || '[]'));
        }
        
        function renderGCList(ratings) {
            const container = document.getElementById('gc-list');
            if (ratings.length === 0) {
                container.innerHTML = '<p style="color: #888;">No GCs added yet.</p>';
                return;
            }
            container.innerHTML = ratings.map((gc, i) => `
                <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f8f9fa; margin: 8px 0; border-radius: 8px;">
                    <span style="flex: 1; font-weight: 600;">${gc.name}</span>
                    <span>${'‚≠ê'.repeat(gc.rating)}</span>
                    <button class="btn-small btn-danger" onclick="removeGC(${i})">‚úï</button>
                </div>
            `).join('');
        }
        
        function addGC() {
            const name = document.getElementById('new-gc-name').value.trim();
            const rating = parseInt(document.getElementById('new-gc-rating').value);
            if (!name) return alert('Enter a GC name');
            
            const ratings = JSON.parse(localStorage.getItem('bidiq_gc_ratings') || '[]');
            ratings.push({ name, rating, normalized: name.toLowerCase() });
            localStorage.setItem('bidiq_gc_ratings', JSON.stringify(ratings));
            renderGCList(ratings);
            document.getElementById('new-gc-name').value = '';
        }
        
        function removeGC(index) {
            const ratings = JSON.parse(localStorage.getItem('bidiq_gc_ratings') || '[]');
            ratings.splice(index, 1);
            localStorage.setItem('bidiq_gc_ratings', JSON.stringify(ratings));
            renderGCList(ratings);
        }
        
        // ==================== TAB NAVIGATION ====================
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
            
            if (tabName === 'dashboard') {
                renderDashboardStats();
                renderBidList();
            }
        }
        
        function initCSICheckboxes() {
            document.getElementById('csi-checkboxes').innerHTML = CSI_DIVISIONS.map(div => `
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 6px; border-radius: 6px; transition: background 0.2s;">
                    <input type="checkbox" id="csi-${div.num}" value="${div.num}">
                    <span>Div ${div.num.toString().padStart(2, '0')} - ${div.name}</span>
                </label>
            `).join('');
        }
        
        function updateProgress(percent, text) {
            document.getElementById('progress').style.display = 'block';
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-text').textContent = text;
        }
        
        // ==================== MAIN ANALYSIS ====================
        
        async function analyzeBid() {
            const files = document.getElementById('pdfFile').files;
            const result = document.getElementById('result');
            const btn = document.getElementById('analyzeBtn');
            
            if (files.length === 0) {
                result.innerHTML = '<div class="status status-error">‚ùå Please select at least one PDF file!</div>';
                return;
            }
            
            const prefs = JSON.parse(localStorage.getItem('bidiq_preferences') || '{}');
            if (!prefs.location || !prefs.divisions?.length) {
                result.innerHTML = '<div class="status status-error">‚ùå Please configure your preferences first (location and trades)!</div>';
                showTab('preferences');
                return;
            }
            
            btn.disabled = true;
            result.innerHTML = '';
            
            try {
                // Step 1: Extract text from all PDFs
                updateProgress(5, 'Starting PDF extraction...');
                let allText = '';
                let totalPages = 0;
                let fileStats = [];
                
                for (let f = 0; f < files.length; f++) {
                    updateProgress(10 + (f / files.length) * 30, `Reading ${files[f].name}...`);
                    const { text, pageCount } = await extractAllTextFromPDF(files[f]);
                    allText += `\n\n=== ${files[f].name} ===\n\n${text}`;
                    totalPages += pageCount;
                    fileStats.push({ name: files[f].name, pages: pageCount });
                }
                
                if (allText.length < 100) throw new Error('Could not extract enough text from PDFs.');
                
                const keywords = JSON.parse(localStorage.getItem('bidiq_keywords') || 'null') || DEFAULT_KEYWORDS;
                
                // Step 2: Local keyword search
                updateProgress(45, 'Searching for keywords...');
                const keywordResults = searchKeywordsLocally(allText, keywords);
                
                // Step 3: Detect CSI divisions
                updateProgress(55, 'Detecting spec divisions...');
                const divisionsFound = detectCSIDivisions(allText);
                
                // Step 4: Claude extracts basic info
                updateProgress(65, 'AI extracting project details...');
                const basicInfo = await extractBasicInfoWithClaude(allText.substring(0, 12000));
                
                // Step 5: Geocode project location
                updateProgress(75, 'Calculating distance...');
                let projectCoords = null;
                let distanceMiles = null;
                
                if (basicInfo.project_city && basicInfo.project_state) {
                    projectCoords = await geocodeLocation(`${basicInfo.project_city}, ${basicInfo.project_state}`);
                    if (prefs.coordinates && projectCoords) {
                        distanceMiles = haversineDistance(
                            prefs.coordinates.lat, prefs.coordinates.lon,
                            projectCoords.lat, projectCoords.lon
                        );
                    }
                }
                
                // Step 6: Calculate score
                updateProgress(85, 'Calculating score...');
                const extraction = {
                    ...basicInfo,
                    spec_divisions: divisionsFound,
                    want_found: keywordResults.wantFound,
                    dont_want_found: keywordResults.dontWantFound,
                    must_have_found: keywordResults.mustHaveFound,
                    must_have_missing: keywordResults.mustHaveMissing,
                    distance_miles: distanceMiles
                };
                
                const scoreResult = calculateScore(extraction, prefs);
                
                // Step 7: Save bid to storage
                const savedBid = saveBid({
                    project_name: basicInfo.project_name,
                    gc_name: basicInfo.gc_name,
                    location: basicInfo.project_city && basicInfo.project_state ? `${basicInfo.project_city}, ${basicInfo.project_state}` : null,
                    deadline: basicInfo.bid_deadline,
                    score: scoreResult.finalScore,
                    distance: distanceMiles,
                    pages: totalPages,
                    files: fileStats.length,
                    divisions: divisionsFound.length,
                    components: scoreResult.components,
                    extraction: extraction
                });
                
                updateProgress(100, 'Done!');
                
                // Step 8: Display results
                setTimeout(() => {
                    document.getElementById('progress').style.display = 'none';
                    displayResults(extraction, scoreResult, totalPages, fileStats.length, divisionsFound.length);
                }, 500);
                
            } catch (err) {
                document.getElementById('progress').style.display = 'none';
                result.innerHTML = `<div class="status status-error">‚ùå Error: ${err.message}</div>`;
                console.error(err);
            }
            
            btn.disabled = false;
            btn.innerHTML = 'ü§ñ Analyze with AI';
        }
        
        async function extractAllTextFromPDF(file) {
            const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                try {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(item => item.str).join(' ') + '\n';
                } catch (e) { console.warn(`Page ${i} failed`); }
            }
            return { text, pageCount: pdf.numPages };
        }
        
        function searchKeywordsLocally(text, keywords) {
            const lower = text.toLowerCase();
            return {
                wantFound: (keywords.productsGood || []).filter(k => lower.includes(k.toLowerCase())),
                dontWantFound: (keywords.productsBad || []).filter(k => lower.includes(k.toLowerCase())),
                mustHaveFound: (keywords.productsMustHave || []).filter(k => lower.includes(k.toLowerCase())),
                mustHaveMissing: (keywords.productsMustHave || []).filter(k => !lower.includes(k.toLowerCase()))
            };
        }
        
        function detectCSIDivisions(text) {
            const upper = text.toUpperCase();
            const found = [];
            CSI_DIVISIONS.forEach(div => {
                const patterns = [`DIVISION ${div.num}`, `DIV ${div.num}`, `SECTION ${div.num}`, 
                    `${div.num.toString().padStart(2, '0')} 00 00`, `${div.num.toString().padStart(2, '0')}0000`];
                if (patterns.some(p => upper.includes(p))) found.push(div.num);
            });
            return [...new Set(found)].sort((a, b) => a - b);
        }
        
        async function extractBasicInfoWithClaude(text) {
            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': CLAUDE_API_KEY,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1024,
                    messages: [{ role: 'user', content: `Extract from this bid document. Return ONLY JSON:\n\n${text}\n\nReturn: {"project_name":"","gc_name":"","project_city":"","project_state":"","bid_deadline":"YYYY-MM-DD or null"}` }]
                })
            });
            
            const data = await response.json();
            let jsonText = data.content[0].text.replace(/```json|```/g, '').trim();
            const start = jsonText.indexOf('{'), end = jsonText.lastIndexOf('}');
            if (start !== -1 && end !== -1) jsonText = jsonText.substring(start, end + 1);
            return JSON.parse(jsonText);
        }
        
        function calculateScore(extraction, prefs) {
            const weights = prefs.weights || { location: 25, trade: 25, keywords: 25, gc: 25 };
            const gcRatings = JSON.parse(localStorage.getItem('bidiq_gc_ratings') || '[]');
            const total = weights.location + weights.trade + weights.keywords + weights.gc;
            const norm = w => (w / total) * 100;
            
            // Location
            let locScore = 50, locDetail = "Location unknown";
            const radius = parseInt(prefs.radius) || 50;
            if (extraction.distance_miles !== null) {
                locScore = calculateLocationScore(extraction.distance_miles, radius);
                locDetail = extraction.distance_miles <= radius 
                    ? `${extraction.project_city}, ${extraction.project_state} - ${extraction.distance_miles} miles ‚úì`
                    : `${extraction.project_city}, ${extraction.project_state} - ${extraction.distance_miles} miles (outside ${radius}mi radius)`;
            } else if (extraction.project_city) {
                locDetail = `${extraction.project_city}, ${extraction.project_state || '?'} - distance unknown`;
            }
            
            // Trade
            let tradeScore = 50, tradeDetail = "No divisions found";
            const userDivs = prefs.divisions || [];
            const projDivs = extraction.spec_divisions || [];
            if (projDivs.length && userDivs.length) {
                const match = userDivs.filter(d => projDivs.includes(d));
                tradeScore = Math.round((match.length / userDivs.length) * 100) || 20;
                tradeDetail = match.length ? `Found Div ${match.join(', ')}` : `None of your trades found`;
            }
            
            // Keywords
            let kwScore = 70, kwDetails = [];
            (extraction.want_found || []).forEach(k => { kwScore += 12; kwDetails.push({ text: k, type: 'good', effect: '+12' }); });
            (extraction.dont_want_found || []).forEach(k => { 
                const pen = prefs.riskTolerance === 'low' ? 20 : prefs.riskTolerance === 'high' ? 10 : 15;
                kwScore -= pen; 
                kwDetails.push({ text: k, type: 'bad', effect: `-${pen}` }); 
            });
            (extraction.must_have_found || []).forEach(k => { kwScore += 15; kwDetails.push({ text: k, type: 'good', effect: '+15' }); });
            (extraction.must_have_missing || []).forEach(k => { kwScore -= 30; kwDetails.push({ text: k + ' (MISSING)', type: 'missing', effect: '-30' }); });
            kwScore = Math.max(0, Math.min(100, kwScore));
            
            // GC
            let gcScore = parseInt(prefs.unknownGC || 3) * 20, gcDetail = "Unknown GC";
            if (extraction.gc_name) {
                const gcLower = extraction.gc_name.toLowerCase();
                const found = gcRatings.find(g => gcLower.includes(g.normalized) || g.normalized.includes(gcLower));
                if (found) {
                    gcScore = found.rating * 20;
                    gcDetail = `${extraction.gc_name} - ${'‚≠ê'.repeat(found.rating)}`;
                } else {
                    gcDetail = `${extraction.gc_name} - Not in your list`;
                }
            }
            
            const finalScore = Math.round(
                (locScore * norm(weights.location) / 100) +
                (tradeScore * norm(weights.trade) / 100) +
                (kwScore * norm(weights.keywords) / 100) +
                (gcScore * norm(weights.gc) / 100)
            );
            
            return {
                finalScore,
                recommendation: finalScore >= 75 ? 'GO' : finalScore >= 55 ? 'REVIEW' : 'PASS',
                components: {
                    location: { score: locScore, weight: weights.location, detail: locDetail },
                    trade: { score: tradeScore, weight: weights.trade, detail: tradeDetail },
                    keywords: { score: kwScore, weight: weights.keywords, detail: kwDetails.map(d => `<span class="keyword-tag keyword-${d.type}">${d.text} (${d.effect})</span>`).join(' ') || 'No keywords found' },
                    gc: { score: gcScore, weight: weights.gc, detail: gcDetail }
                }
            };
        }
        
        function displayResults(extraction, scoreResult, totalPages, fileCount, divisionCount) {
            const { finalScore, recommendation, components } = scoreResult;
            const scoreClass = finalScore >= 75 ? 'go' : finalScore >= 55 ? 'review' : 'pass';
            const getFillClass = s => s >= 70 ? 'fill-high' : s >= 40 ? 'fill-medium' : 'fill-low';
            
            document.getElementById('result').innerHTML = `
                <div class="result-box">
                    <div class="score-display ${scoreClass}">
                        ${finalScore}/100
                        <small>${recommendation}</small>
                    </div>
                    
                    <div class="quick-stats">
                        <div class="quick-stat">
                            <div class="quick-stat-number">${extraction.distance_miles || '?'}</div>
                            <div class="quick-stat-label">Miles Away</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-number">${totalPages}</div>
                            <div class="quick-stat-label">Pages Analyzed</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-number">${fileCount}</div>
                            <div class="quick-stat-label">Files</div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-number">${divisionCount}</div>
                            <div class="quick-stat-label">Divisions Found</div>
                        </div>
                    </div>
                    
                    <div class="score-breakdown">
                        <h3>üìä Score Breakdown (Your Weights)</h3>
                        ${['location', 'trade', 'keywords', 'gc'].map(key => {
                            const comp = components[key];
                            const icons = { location: 'üìç', trade: 'üîß', keywords: 'üîë', gc: 'üè¢' };
                            const names = { location: 'Location Fit', trade: 'Trade Match', keywords: 'Keywords Found', gc: 'GC Relationship' };
                            return `
                                <div class="score-component">
                                    <span class="component-icon">${icons[key]}</span>
                                    <span class="component-name">${names[key]}</span>
                                    <div class="component-bar"><div class="component-fill ${getFillClass(comp.score)}" style="width: ${comp.score}%"></div></div>
                                    <span class="component-score">${comp.score}</span>
                                    <span class="component-weight">${comp.weight}%</span>
                                </div>
                                <div class="component-detail">${comp.detail}</div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="details">
                        <h3>üìã Extracted Project Details</h3>
                        <div class="detail-row"><span class="detail-label">Project:</span><span class="detail-value">${extraction.project_name || 'Not found'}</span></div>
                        <div class="detail-row"><span class="detail-label">GC:</span><span class="detail-value">${extraction.gc_name || 'Not found'}</span></div>
                        <div class="detail-row"><span class="detail-label">Location:</span><span class="detail-value">${extraction.project_city || '?'}, ${extraction.project_state || '?'}${extraction.distance_miles ? ` (${extraction.distance_miles} miles)` : ''}</span></div>
                        <div class="detail-row"><span class="detail-label">Deadline:</span><span class="detail-value">${extraction.bid_deadline || 'Not specified'}</span></div>
                        <div class="detail-row"><span class="detail-label">Spec Divisions:</span><span class="detail-value">${(extraction.spec_divisions || []).map(d => 'Div ' + d).join(', ') || 'None detected'}</span></div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 25px;">
                        <button onclick="showTab('dashboard')">üìä View in Dashboard</button>
                    </div>
                </div>
            `;
        }
        
        // ==================== INIT ====================
        
        document.addEventListener('DOMContentLoaded', function() {
            initCSICheckboxes();
            loadPreferences();
            loadKeywords();
            loadGCRatings();
            renderDashboardStats();
            renderBidList();
        });
    </script>
</body>
</html>
