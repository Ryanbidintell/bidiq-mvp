<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BidIQ - Bid Smarter, Not Harder</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,400;9..40,500;9..40,600;9..40,700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0f1a;
            --bg-secondary: #111827;
            --bg-card: #1a2234;
            --bg-card-hover: #1f2937;
            --border: #2d3748;
            --border-light: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --text-muted: #6b7280;
            --accent: #f59e0b;
            --accent-hover: #fbbf24;
            --accent-glow: rgba(245, 158, 11, 0.15);
            --success: #10b981;
            --success-bg: rgba(16, 185, 129, 0.1);
            --warning: #f59e0b;
            --warning-bg: rgba(245, 158, 11, 0.1);
            --danger: #ef4444;
            --danger-bg: rgba(239, 68, 68, 0.1);
            --info: #3b82f6;
            --info-bg: rgba(59, 130, 246, 0.1);
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        .app { display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: var(--bg-secondary); border-right: 1px solid var(--border); position: fixed; height: 100vh; display: flex; flex-direction: column; }
        .logo { padding: 24px; border-bottom: 1px solid var(--border); }
        .logo h1 { font-family: 'Space Mono', monospace; font-size: 24px; color: var(--accent); }
        .logo h1 span { color: var(--text-primary); }
        .logo p { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }
        .nav { flex: 1; padding: 16px 12px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: var(--radius-md); color: var(--text-secondary); cursor: pointer; margin-bottom: 4px; font-weight: 500; transition: all 0.2s; }
        .nav-item:hover { background: var(--bg-card); color: var(--text-primary); }
        .nav-item.active { background: var(--accent-glow); color: var(--accent); border: 1px solid rgba(245, 158, 11, 0.2); }
        .nav-item svg { width: 20px; height: 20px; }
        .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); }
        .capacity-box { background: var(--bg-card); border-radius: var(--radius-md); padding: 12px; }
        .capacity-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); margin-bottom: 8px; }
        .capacity-value { font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .capacity-dot { width: 8px; height: 8px; border-radius: 50%; }
        .capacity-hungry .capacity-dot { background: var(--danger); }
        .capacity-steady .capacity-dot { background: var(--success); }
        .capacity-maxed .capacity-dot { background: var(--warning); }
        
        /* Main */
        .main { flex: 1; margin-left: 260px; }
        .page-header { padding: 24px 32px; border-bottom: 1px solid var(--border); background: var(--bg-secondary); position: sticky; top: 0; z-index: 50; }
        .page-title { font-size: 24px; font-weight: 700; }
        .page-subtitle { color: var(--text-muted); font-size: 14px; margin-top: 4px; }
        .page-content { padding: 32px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; position: relative; overflow: hidden; transition: all 0.2s; }
        .stat-card:hover { border-color: var(--border-light); transform: translateY(-2px); }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
        .stat-card.accent::before { background: var(--accent); }
        .stat-card.success::before { background: var(--success); }
        .stat-card.info::before { background: var(--info); }
        .stat-card.warning::before { background: var(--warning); }
        .stat-icon { width: 40px; height: 40px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin-bottom: 12px; }
        .stat-card.accent .stat-icon { background: var(--accent-glow); color: var(--accent); }
        .stat-card.success .stat-icon { background: var(--success-bg); color: var(--success); }
        .stat-card.info .stat-icon { background: var(--info-bg); color: var(--info); }
        .stat-card.warning .stat-icon { background: var(--warning-bg); color: var(--warning); }
        .stat-label { font-size: 13px; color: var(--text-muted); margin-bottom: 4px; }
        .stat-value { font-size: 28px; font-weight: 700; font-family: 'Space Mono', monospace; }
        
        /* Tooltip */
        [data-tooltip] { position: relative; cursor: help; }
        [data-tooltip]::after { content: attr(data-tooltip); position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%); background: var(--bg-primary); border: 1px solid var(--border); color: var(--text-secondary); padding: 8px 12px; border-radius: var(--radius-sm); font-size: 12px; opacity: 0; visibility: hidden; transition: all 0.2s; z-index: 1000; white-space: normal; max-width: 200px; text-align: center; }
        [data-tooltip]:hover::after { opacity: 1; visibility: visible; }
        
        /* Cards */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; }
        .card-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-weight: 600; font-size: 16px; }
        .card-body { padding: 20px; }
        
        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 18px; border-radius: var(--radius-md); font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; border: none; font-family: inherit; }
        .btn-primary { background: var(--accent); color: var(--bg-primary); }
        .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--bg-card-hover); border-color: var(--border-light); }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Forms */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; }
        .form-input, .form-select { width: 100%; padding: 12px 14px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-md); color: var(--text-primary); font-size: 14px; font-family: inherit; transition: all 0.2s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        .form-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
        
        /* Upload */
        .upload-zone { border: 2px dashed var(--border); border-radius: var(--radius-lg); padding: 48px; text-align: center; cursor: pointer; transition: all 0.2s; background: var(--bg-secondary); }
        .upload-zone:hover, .upload-zone.dragover { border-color: var(--accent); background: var(--accent-glow); }
        .upload-zone svg { width: 48px; height: 48px; color: var(--text-muted); margin-bottom: 16px; }
        .upload-zone h3 { color: var(--text-primary); margin-bottom: 8px; }
        .upload-zone p { color: var(--text-muted); font-size: 14px; }
        .file-list { margin-top: 16px; }
        .file-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-card); border-radius: var(--radius-md); margin-bottom: 8px; }
        .file-icon { width: 36px; height: 36px; background: var(--danger-bg); color: var(--danger); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; }
        .file-info { flex: 1; }
        .file-name { font-weight: 500; font-size: 14px; }
        .file-size { font-size: 12px; color: var(--text-muted); }
        .file-remove { color: var(--text-muted); cursor: pointer; padding: 4px; }
        .file-remove:hover { color: var(--danger); }
        
        /* Score badges */
        .score-badge { display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 14px; font-family: 'Space Mono', monospace; }
        .score-badge.go { background: var(--success-bg); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.3); }
        .score-badge.review { background: var(--warning-bg); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.3); }
        .score-badge.pass { background: var(--danger-bg); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }
        
        .outcome-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .outcome-badge.won { background: var(--success-bg); color: var(--success); }
        .outcome-badge.lost { background: var(--danger-bg); color: var(--danger); }
        .outcome-badge.ghost { background: var(--bg-card); color: var(--text-muted); }
        .outcome-badge.pending { background: var(--info-bg); color: var(--info); }
        .outcome-badge.declined { background: var(--bg-card); color: var(--text-secondary); }
        
        /* GC tags */
        .gc-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        .gc-tag { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; background: var(--bg-secondary); border-radius: var(--radius-sm); font-size: 12px; color: var(--text-secondary); }
        .gc-tag .stars { color: var(--accent); font-size: 10px; }
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-lg); width: 100%; max-width: 700px; max-height: 90vh; overflow: auto; animation: modalIn 0.3s ease; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--bg-secondary); }
        .modal-title { font-size: 18px; font-weight: 700; }
        .modal-close { width: 32px; height: 32px; border-radius: var(--radius-sm); border: none; background: transparent; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .modal-close:hover { background: var(--bg-card); color: var(--text-primary); }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }
        
        /* Score report */
        .score-report { background: var(--bg-card); border-radius: var(--radius-lg); overflow: hidden; }
        .score-report-header { padding: 24px; text-align: center; border-bottom: 1px solid var(--border); }
        .score-report-value { font-size: 64px; font-weight: 700; font-family: 'Space Mono', monospace; line-height: 1; }
        .score-report-value.go { color: var(--success); }
        .score-report-value.review { color: var(--warning); }
        .score-report-value.pass { color: var(--danger); }
        .score-report-rec { font-size: 18px; font-weight: 600; margin-top: 8px; }
        .score-component { padding: 20px 24px; border-bottom: 1px solid var(--border); }
        .score-component:last-child { border-bottom: none; }
        .score-component-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .score-component-title { display: flex; align-items: center; gap: 10px; font-weight: 600; }
        .score-component-icon { width: 32px; height: 32px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .score-component-value { font-family: 'Space Mono', monospace; font-weight: 700; font-size: 18px; }
        .score-component-bar { height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden; margin-bottom: 12px; }
        .score-component-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        .score-component-fill.high { background: var(--success); }
        .score-component-fill.medium { background: var(--warning); }
        .score-component-fill.low { background: var(--danger); }
        .score-component-reason { font-size: 14px; color: var(--text-secondary); line-height: 1.6; }
        .score-component-details { margin-top: 12px; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md); font-size: 13px; }
        
        .keyword-tag { display: inline-flex; align-items: center; gap: 4px; padding: 3px 8px; border-radius: var(--radius-sm); font-size: 12px; margin: 2px; }
        .keyword-tag.good { background: var(--success-bg); color: var(--success); }
        .keyword-tag.bad { background: var(--danger-bg); color: var(--danger); }
        .keyword-tag .page-ref { color: var(--text-muted); font-size: 10px; }
        
        /* GC selector */
        .gc-selector { border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden; }
        .gc-selector-search { display: flex; border-bottom: 1px solid var(--border); }
        .gc-selector-search input { flex: 1; padding: 12px 14px; background: transparent; border: none; color: var(--text-primary); font-size: 14px; }
        .gc-selector-search input:focus { outline: none; }
        .gc-selector-list { max-height: 200px; overflow-y: auto; }
        .gc-selector-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; cursor: pointer; transition: all 0.2s; }
        .gc-selector-item:hover { background: var(--bg-card); }
        .gc-selector-item.selected { background: var(--accent-glow); }
        .gc-selected-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
        .gc-selected-tag { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); font-size: 13px; }
        .gc-selected-tag .remove { cursor: pointer; color: var(--text-muted); }
        .gc-selected-tag .remove:hover { color: var(--danger); }
        
        /* Competition */
        .competition-indicator { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: var(--radius-md); font-size: 13px; font-weight: 500; margin-top: 12px; }
        .competition-indicator.low { background: var(--success-bg); color: var(--success); }
        .competition-indicator.moderate { background: var(--info-bg); color: var(--info); }
        .competition-indicator.high { background: var(--warning-bg); color: var(--warning); }
        .competition-indicator.very-high { background: var(--danger-bg); color: var(--danger); }
        
        /* Settings */
        .settings-section { margin-bottom: 32px; }
        .settings-section-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .weight-slider { margin-bottom: 20px; }
        .weight-slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .weight-slider-label { font-weight: 500; font-size: 14px; }
        .weight-slider-value { font-family: 'Space Mono', monospace; font-weight: 600; color: var(--accent); }
        .weight-slider input[type="range"] { width: 100%; height: 6px; border-radius: 3px; background: var(--bg-secondary); appearance: none; cursor: pointer; }
        .weight-slider input[type="range"]::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--accent); cursor: pointer; border: 2px solid var(--bg-primary); }
        
        .toggle { display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .toggle-switch { width: 44px; height: 24px; background: var(--bg-secondary); border-radius: 12px; position: relative; transition: all 0.2s; }
        .toggle-switch::after { content: ''; position: absolute; top: 3px; left: 3px; width: 18px; height: 18px; background: var(--text-muted); border-radius: 50%; transition: all 0.2s; }
        .toggle input { display: none; }
        .toggle input:checked + .toggle-switch { background: var(--accent); }
        .toggle input:checked + .toggle-switch::after { left: 23px; background: var(--bg-primary); }
        
        .checkbox-group { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; font-size: 13px; }
        .checkbox-item:hover { border-color: var(--border-light); }
        .checkbox-item.selected { background: var(--accent-glow); border-color: var(--accent); }
        .checkbox-item input { display: none; }
        
        .keywords-config { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .keywords-section { background: var(--bg-secondary); border-radius: var(--radius-md); padding: 16px; }
        .keywords-section h4 { font-size: 14px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        .keywords-section.good h4 { color: var(--success); }
        .keywords-section.bad h4 { color: var(--danger); }
        .keywords-list { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; min-height: 40px; }
        .keywords-input { display: flex; gap: 8px; }
        .keywords-input input { flex: 1; padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 13px; }
        
        .gc-list { display: grid; gap: 12px; }
        .gc-item { display: flex; align-items: center; gap: 16px; padding: 16px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: var(--radius-md); }
        .gc-item-info { flex: 1; }
        .gc-item-name { font-weight: 600; margin-bottom: 4px; }
        .gc-item-stats { font-size: 13px; color: var(--text-muted); }
        .gc-item-rating { display: flex; gap: 4px; }
        .star { font-size: 18px; cursor: pointer; color: var(--border); transition: all 0.2s; }
        .star.filled { color: var(--accent); }
        .star:hover { color: var(--accent-hover); }
        
        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-state svg { width: 64px; height: 64px; color: var(--text-muted); margin-bottom: 16px; }
        .empty-state h3 { font-size: 18px; margin-bottom: 8px; }
        .empty-state p { color: var(--text-muted); margin-bottom: 20px; }
        
        .loading { display: flex; align-items: center; justify-content: center; padding: 40px; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .address-prompt { background: var(--warning-bg); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: var(--radius-md); padding: 16px; margin-top: 16px; }
        .address-prompt-title { font-weight: 600; color: var(--warning); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .address-prompt-row { display: flex; gap: 8px; margin-top: 12px; }
        .address-prompt-row input { flex: 1; }
        
        /* Table */
        .projects-table { width: 100%; border-collapse: collapse; }
        .projects-table th { text-align: left; padding: 12px 16px; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); }
        .projects-table td { padding: 16px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        .projects-table tr:hover td { background: var(--bg-card-hover); }
        .project-name { font-weight: 600; }
        .project-location { font-size: 13px; color: var(--text-muted); }
        
        @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .sidebar { transform: translateX(-100%); } .main { margin-left: 0; } .stats-grid { grid-template-columns: 1fr; } .form-row { grid-template-columns: 1fr; } .keywords-config { grid-template-columns: 1fr; } .checkbox-group { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h1>Bid<span>IQ</span></h1>
                <p>Bid Smarter, Not Harder</p>
            </div>
            <nav class="nav">
                <div class="nav-item active" data-tab="dashboard">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                    Dashboard
                </div>
                <div class="nav-item" data-tab="analyze">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>
                    Analyze Bid
                </div>
                <div class="nav-item" data-tab="projects">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                    Projects
                </div>
                <div class="nav-item" data-tab="gcs">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                    GC Database
                </div>
                <div class="nav-item" data-tab="keywords">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" /></svg>
                    Keywords
                </div>
                <div class="nav-item" data-tab="settings">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                    Settings
                </div>
            </nav>
            <div class="sidebar-footer">
                <div class="capacity-box capacity-steady" id="capacityIndicator">
                    <div class="capacity-label">Current Capacity</div>
                    <div class="capacity-value"><span class="capacity-dot"></span><span id="capacityText">Steady</span></div>
                </div>
            </div>
        </aside>

        <main class="main">
            <!-- Dashboard -->
            <div class="tab-content active" id="tab-dashboard">
                <header class="page-header"><h2 class="page-title">Dashboard</h2><p class="page-subtitle">Your bid intelligence at a glance</p></header>
                <div class="page-content">
                    <div class="stats-grid">
                        <div class="stat-card accent" data-tooltip="Total bids analyzed with BidIQ">
                            <div class="stat-icon"><svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg></div>
                            <div class="stat-label">Bids Analyzed</div>
                            <div class="stat-value" id="statBids">0</div>
                        </div>
                        <div class="stat-card success" data-tooltip="Won / (Won + Lost). Excludes pending, ghosted, declined.">
                            <div class="stat-icon"><svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                            <div class="stat-label">Win Rate</div>
                            <div class="stat-value" id="statWinRate">--</div>
                        </div>
                        <div class="stat-card info" data-tooltip="Bids submitted but no outcome recorded yet">
                            <div class="stat-icon"><svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                            <div class="stat-label">Pending Outcomes</div>
                            <div class="stat-value" id="statPending">0</div>
                        </div>
                        <div class="stat-card warning" data-tooltip="Based on your avg decision time √ó bids analyzed">
                            <div class="stat-icon"><svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg></div>
                            <div class="stat-label">Hours Saved</div>
                            <div class="stat-value" id="statHours">0</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Recent Activity</h3>
                            <button class="btn btn-primary btn-sm" onclick="switchTab('analyze')"><svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>Analyze New Bid</button>
                        </div>
                        <div class="card-body" id="recentActivity">
                            <div class="empty-state">
                                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                                <h3>No bids analyzed yet</h3>
                                <p>Upload your first bid documents to get started</p>
                                <button class="btn btn-primary" onclick="switchTab('analyze')">Analyze Your First Bid</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analyze Tab -->
            <div class="tab-content" id="tab-analyze">
                <header class="page-header"><h2 class="page-title">Analyze Bid</h2><p class="page-subtitle">Upload documents and get your personalized score</p></header>
                <div class="page-content">
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-header"><h3 class="card-title">Step 1: Upload Documents</h3></div>
                        <div class="card-body">
                            <div class="upload-zone" id="uploadZone">
                                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                                <h3>Drop files here or click to browse</h3>
                                <p>PDF files: Bid invite, specifications, drawings</p>
                            </div>
                            <input type="file" id="fileInput" accept=".pdf" multiple style="display: none;">
                            <div class="file-list" id="fileList"></div>
                        </div>
                    </div>
                    <div class="card" style="margin-bottom: 24px;">
                        <div class="card-header"><h3 class="card-title">Step 2: Select GCs Bidding</h3></div>
                        <div class="card-body">
                            <p style="color: var(--text-muted); margin-bottom: 16px;">Which general contractors are bidding on this project?</p>
                            <div class="gc-selector">
                                <div class="gc-selector-search">
                                    <input type="text" id="gcSearchInput" placeholder="Search or add new GC...">
                                    <button class="btn btn-secondary btn-sm" onclick="addNewGC()">+ Add</button>
                                </div>
                                <div class="gc-selector-list" id="gcSelectorList"></div>
                            </div>
                            <div class="gc-selected-list" id="selectedGCsList"></div>
                            <div id="competitionIndicator"></div>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="analyzeBtn" onclick="analyzeBid()" disabled style="width: 100%; padding: 16px; font-size: 16px;">
                        <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                        Analyze Bid
                    </button>
                    <div id="analysisResult" style="margin-top: 24px;"></div>
                </div>
            </div>

            <!-- Projects Tab -->
            <div class="tab-content" id="tab-projects">
                <header class="page-header"><h2 class="page-title">Projects</h2><p class="page-subtitle">All your analyzed bids in one place</p></header>
                <div class="page-content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">All Projects</h3>
                            <button class="btn btn-secondary btn-sm" onclick="exportCSV()"><svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>Export CSV</button>
                        </div>
                        <div class="card-body" style="padding: 0;" id="projectsList"></div>
                    </div>
                </div>
            </div>

            <!-- GC Database Tab -->
            <div class="tab-content" id="tab-gcs">
                <header class="page-header"><h2 class="page-title">GC Database</h2><p class="page-subtitle">Track your relationships with general contractors</p></header>
                <div class="page-content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Your GCs</h3>
                            <button class="btn btn-primary btn-sm" onclick="showAddGCModal()"><svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>Add GC</button>
                        </div>
                        <div class="card-body"><div id="gcDatabaseList" class="gc-list"></div></div>
                    </div>
                </div>
            </div>

            <!-- Keywords Tab -->
            <div class="tab-content" id="tab-keywords">
                <header class="page-header"><h2 class="page-title">Keywords</h2><p class="page-subtitle">Configure terms to look for in bid documents</p></header>
                <div class="page-content">
                    <div class="keywords-config">
                        <div class="keywords-section good">
                            <h4><svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>Good Terms (+8 points each)</h4>
                            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">Terms that indicate a good fit for your business</p>
                            <div class="keywords-list" id="goodKeywordsList"></div>
                            <div class="keywords-input"><input type="text" id="goodKeywordInput" placeholder="Add keyword..."><button class="btn btn-sm btn-secondary" onclick="addKeyword('good')">Add</button></div>
                        </div>
                        <div class="keywords-section bad">
                            <h4><svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>Risk Terms (penalty varies)</h4>
                            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">Contract terms that may indicate risk</p>
                            <div class="keywords-list" id="badKeywordsList"></div>
                            <div class="keywords-input"><input type="text" id="badKeywordInput" placeholder="Add keyword..."><button class="btn btn-sm btn-secondary" onclick="addKeyword('bad')">Add</button></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div class="tab-content" id="tab-settings">
                <header class="page-header"><h2 class="page-title">Settings</h2><p class="page-subtitle">Configure your business preferences</p></header>
                <div class="page-content">
                    <div class="settings-section">
                        <h3 class="settings-section-title">Business Location</h3>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Office City</label><input type="text" class="form-input" id="settingCity" placeholder="Kansas City"></div>
                            <div class="form-group"><label class="form-label">Office State</label><input type="text" class="form-input" id="settingState" placeholder="MO"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Service Radius (miles)</label><select class="form-select" id="settingRadius"><option value="25">25 miles</option><option value="50" selected>50 miles</option><option value="100">100 miles</option><option value="150">150 miles</option><option value="200">200+ miles</option></select></div>
                            <div class="form-group"><label class="form-label">Does location matter to you?</label><label class="toggle"><input type="checkbox" id="settingLocationMatters" checked><span class="toggle-switch"></span><span>Yes, include in scoring</span></label></div>
                        </div>
                    </div>
                    <div class="settings-section">
                        <h3 class="settings-section-title">Your Trades (CSI Divisions)</h3>
                        <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 14px;">Select the divisions you work in.</p>
                        <div class="checkbox-group" id="tradesCheckboxes"></div>
                    </div>
                    <div class="settings-section">
                        <h3 class="settings-section-title">Risk Tolerance</h3>
                        <div class="form-group"><select class="form-select" id="settingRiskTolerance"><option value="low">Low - Avoid risky contract terms (-15 points each)</option><option value="medium" selected>Medium - Accept standard risks (-10 points each)</option><option value="high">High - Comfortable with aggressive terms (-5 points each)</option></select></div>
                    </div>
                    <div class="settings-section">
                        <h3 class="settings-section-title">Current Capacity</h3>
                        <div class="form-group"><select class="form-select" id="settingCapacity"><option value="hungry">üî¥ Hungry - Need work</option><option value="steady" selected>üü¢ Steady - Normal pipeline</option><option value="maxed">üü° Maxed - At capacity</option></select></div>
                    </div>
                    <div class="settings-section">
                        <h3 class="settings-section-title">Score Weights</h3>
                        <p style="color: var(--text-muted); margin-bottom: 16px; font-size: 14px;">Adjust how much each component affects your final score.</p>
                        <div class="weight-slider" id="weightLocation"><div class="weight-slider-header"><span class="weight-slider-label">üìç Location Fit</span><span class="weight-slider-value">25%</span></div><input type="range" min="0" max="60" value="25"></div>
                        <div class="weight-slider" id="weightKeywords"><div class="weight-slider-header"><span class="weight-slider-label">üîë Keywords & Contract</span><span class="weight-slider-value">30%</span></div><input type="range" min="0" max="60" value="30"></div>
                        <div class="weight-slider" id="weightGC"><div class="weight-slider-header"><span class="weight-slider-label">üè¢ GC & Competition</span><span class="weight-slider-value">25%</span></div><input type="range" min="0" max="60" value="25"></div>
                        <div class="weight-slider" id="weightTrade"><div class="weight-slider-header"><span class="weight-slider-label">üîß Trade Match</span><span class="weight-slider-value">20%</span></div><input type="range" min="0" max="60" value="20"></div>
                        <div style="text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: var(--radius-md); margin-top: 16px;"><span style="color: var(--text-muted);">Total:</span><span id="weightTotal" style="font-family: 'Space Mono', monospace; font-weight: 700; margin-left: 8px;">100%</span></div>
                    </div>
                    <div class="settings-section">
                        <h3 class="settings-section-title">Other Settings</h3>
                        <div class="form-row">
                            <div class="form-group"><label class="form-label">Avg time to decide on a bid (minutes)</label><input type="number" class="form-input" id="settingDecisionTime" value="45" min="5" max="480"></div>
                            <div class="form-group"><label class="form-label">Ghost timeline (days)</label><input type="number" class="form-input" id="settingGhostDays" value="60" min="14" max="180"></div>
                        </div>
                        <div class="form-group"><label class="form-label">Default star rating for new GCs</label><select class="form-select" id="settingDefaultStars"><option value="1">1 Star</option><option value="2">2 Stars</option><option value="3" selected>3 Stars</option><option value="4">4 Stars</option><option value="5">5 Stars</option></select></div>
                    </div>
                    <div class="settings-section">
                        <h3 class="settings-section-title">API Configuration</h3>
                        <div class="form-group"><label class="form-label">Anthropic API Key</label><input type="password" class="form-input" id="settingApiKey" placeholder="sk-ant-..."><p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Your API key is stored locally and never sent to our servers.</p></div>
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()" style="width: 100%;">Save Settings</button>
                </div>
            </div>
        </main>
    </div>
-info"><div class="file-name">${f.name}</div><div class="file-size">${(f.size/1024/1024).toFixed(2)} MB</div></div><span class="file-remove" onclick="removeFile(${i})"><svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></span></div>`).join('');
        }
        function removeFile(i) { uploadedFiles.splice(i,1); renderFileList(); updateAnalyzeButton(); }

        // GC Selector
        function renderGCSelector() {
            const gcs = getGCs();
            const search = document.getElementById('gcSearchInput').value.toLowerCase();
            const filtered = gcs.filter(g=>g.name.toLowerCase().includes(search));
            document.getElementById('gcSelectorList').innerHTML = filtered.length===0 ? '<div style="padding:16px;text-align:center;color:var(--text-muted);">No GCs found. Type name and click Add.</div>' : filtered.map(gc=>`<div class="gc-selector-item ${selectedGCs.find(s=>s.name===gc.name)?'selected':''}" onclick="toggleGCSelection('${gc.name.replace(/'/g,"\\'")}')"><span>${gc.name}</span><span style="color:var(--accent);">${'‚òÖ'.repeat(gc.rating)}${'‚òÜ'.repeat(5-gc.rating)}</span></div>`).join('');
            renderSelectedGCs();
        }
        function toggleGCSelection(name) {
            const gcs = getGCs();
            const gc = gcs.find(g=>g.name===name);
            if(!gc) return;
            const idx = selectedGCs.findIndex(s=>s.name===name);
            if(idx>=0) selectedGCs.splice(idx,1); else selectedGCs.push(gc);
            renderGCSelector(); updateCompetitionIndicator(); updateAnalyzeButton();
        }
        function renderSelectedGCs() {
            document.getElementById('selectedGCsList').innerHTML = selectedGCs.map(gc=>`<div class="gc-selected-tag"><span>${gc.name}</span><span style="color:var(--accent);font-size:11px;">${'‚òÖ'.repeat(gc.rating)}</span><span class="remove" onclick="toggleGCSelection('${gc.name.replace(/'/g,"\\'")}')">√ó</span></div>`).join('');
        }
        function updateCompetitionIndicator() {
            const n = selectedGCs.length;
            if(n===0) { document.getElementById('competitionIndicator').innerHTML=''; return; }
            let level,cls,penalty;
            if(n<=2){level='Low';cls='low';penalty=0;} else if(n<=5){level='Moderate';cls='moderate';penalty=5;} else if(n<=10){level='High';cls='high';penalty=10;} else{level='Very High';cls='very-high';penalty=15;}
            document.getElementById('competitionIndicator').innerHTML=`<div class="competition-indicator ${cls}"><span>${n} GC${n>1?'s':''} bidding</span><span>‚Ä¢</span><span>${level} competition${penalty>0?` (-${penalty} penalty)`:''}</span></div>`;
        }
        function addNewGC() {
            const input = document.getElementById('gcSearchInput');
            const name = input.value.trim();
            if(!name) return;
            const gcs = getGCs();
            if(gcs.find(g=>g.name.toLowerCase()===name.toLowerCase())) { alert('GC already exists'); return; }
            const settings = getSettings();
            const newGC = {name,rating:settings.defaultStars,bids:0,wins:0};
            gcs.push(newGC); saveGCsToStorage(gcs);
            selectedGCs.push(newGC);
            input.value=''; renderGCSelector(); updateCompetitionIndicator(); updateAnalyzeButton();
        }
        document.getElementById('gcSearchInput').addEventListener('input',renderGCSelector);
        document.getElementById('gcSearchInput').addEventListener('keypress',e=>{if(e.key==='Enter')addNewGC();});

        function updateAnalyzeButton() { document.getElementById('analyzeBtn').disabled = uploadedFiles.length===0||selectedGCs.length===0; }

        // PDF Text Extraction
        async function extractTextFromPDF(file) {
            const ab = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data:ab}).promise;
            const pages = [];
            for(let i=1;i<=pdf.numPages;i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                pages.push({pageNum:i,text:content.items.map(x=>x.str).join(' ')});
            }
            return pages;
        }

        // Geocoding
        async function geocode(address) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`,{headers:{'User-Agent':'BidIQ/1.0'}});
                const data = await res.json();
                if(data.length>0) return {lat:parseFloat(data[0].lat),lon:parseFloat(data[0].lon)};
            } catch(e) { console.error('Geocoding error:',e); }
            return null;
        }
        function haversineDistance(lat1,lon1,lat2,lon2) {
            const R=3959,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180;
            const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
        }

        // Keyword Search
        function searchKeywords(pages, keywords) {
            const results = [];
            for(const kw of keywords) {
                const found = [];
                const regex = new RegExp(kw.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi');
                for(const p of pages) if(regex.test(p.text)) found.push(p.pageNum);
                if(found.length>0) results.push({keyword:kw,pages:found});
            }
            return results;
        }

        // Main Analysis
        async function analyzeBid() {
            const settings = getSettings();
            if(!settings.apiKey) { alert('Please add your Anthropic API key in Settings'); switchTab('settings'); return; }
            const btn = document.getElementById('analyzeBtn');
            const resultDiv = document.getElementById('analysisResult');
            btn.disabled=true; btn.innerHTML='<span class="spinner" style="width:20px;height:20px;border-width:2px;"></span> Analyzing...';
            resultDiv.innerHTML='<div class="loading"><span class="spinner"></span></div>';

            try {
                let allPages = [];
                for(const f of uploadedFiles) { const pages = await extractTextFromPDF(f); allPages=allPages.concat(pages); }
                const fullText = allPages.map(p=>p.text).join('\n\n');

                const extractionPrompt = `Extract from this bid document. Return ONLY valid JSON:
{"project_name":"string or null","project_city":"string or null","project_state":"string or null","project_address":"string or null","bid_deadline":"string or null","project_sf":"number or null","has_contract_language":true/false}

Document (first 15000 chars):
${fullText.substring(0,15000)}`;

                const response = await fetch('https://api.anthropic.com/v1/messages',{
                    method:'POST',
                    headers:{'Content-Type':'application/json','x-api-key':settings.apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
                    body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,messages:[{role:'user',content:extractionPrompt}]})
                });
                const data = await response.json();
                let extracted = {};
                try { const content=data.content[0].text; const jsonMatch=content.match(/\{[\s\S]*\}/); if(jsonMatch)extracted=JSON.parse(jsonMatch[0]); } catch(e) { console.error('Parse error:',e); }

                const keywords = getKeywords();
                const goodFound = searchKeywords(allPages, keywords.good);
                const badFound = searchKeywords(allPages, keywords.bad);

                const tradesFound = [];
                for(const div of settings.trades) {
                    const patterns = [new RegExp(`Division\\s*${div}`,'gi'),new RegExp(`Section\\s*${div}`,'gi'),new RegExp(`\\b${div}\\s*\\d{2}\\s*\\d{2}`,'gi')];
                    for(const pattern of patterns) { for(const page of allPages) { if(pattern.test(page.text)) { if(!tradesFound.includes(div))tradesFound.push(div); break; } } }
                }

                const scores = await calculateScores(extracted, settings, goodFound, badFound, tradesFound);
                currentAnalysis = {id:Date.now().toString(),extracted,scores,gcs:[...selectedGCs],files:uploadedFiles.map(f=>f.name),goodFound,badFound,tradesFound,createdAt:new Date().toISOString()};
                renderAnalysisResult(currentAnalysis);
            } catch(error) {
                console.error('Analysis error:',error);
                resultDiv.innerHTML=`<div class="card" style="border-color:var(--danger);"><div class="card-body" style="text-align:center;"><h3 style="color:var(--danger);">Analysis Failed</h3><p style="color:var(--text-muted);">${error.message}</p><button class="btn btn-secondary" onclick="analyzeBid()">Try Again</button></div></div>`;
            }
            btn.disabled=false; btn.innerHTML='<svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg> Analyze Bid';
        }

        async function calculateScores(extracted, settings, goodFound, badFound, tradesFound) {
            const components = {};
            let weights = {...settings.weights};
            if(!settings.locationMatters) {
                const lw=weights.location,other=weights.keywords+weights.gc+weights.trade;
                weights.keywords=Math.round(weights.keywords+lw*weights.keywords/other);
                weights.gc=Math.round(weights.gc+lw*weights.gc/other);
                weights.trade=Math.round(weights.trade+lw*weights.trade/other);
                weights.location=0;
            }

            // Location
            components.location={score:50,weight:weights.location,reason:'',details:{}};
            if(settings.locationMatters&&settings.city&&settings.state) {
                const userCoords = await geocode(`${settings.city}, ${settings.state}`);
                let projectAddress = extracted.project_address||(extracted.project_city&&extracted.project_state?`${extracted.project_city}, ${extracted.project_state}`:null);
                if(userCoords&&projectAddress) {
                    const projectCoords = await geocode(projectAddress);
                    if(projectCoords) {
                        const distance = Math.round(haversineDistance(userCoords.lat,userCoords.lon,projectCoords.lat,projectCoords.lon));
                        let score; if(distance<=25)score=100; else if(distance<=50)score=85; else if(distance<=100)score=70; else if(distance<=150)score=50; else score=30;
                        if(distance>settings.radius) score=Math.max(10,score-20);
                        components.location={score,weight:weights.location,reason:`${distance} miles from your office${distance>settings.radius?' (outside service area)':''}`,details:{distance,inRadius:distance<=settings.radius}};
                    } else { components.location.reason='Could not calculate distance'; components.location.needsAddress=true; }
                } else if(!projectAddress) { components.location.reason='Project address not found'; components.location.needsAddress=true; }
            } else if(!settings.locationMatters) { components.location.reason='Location scoring disabled'; components.location.score=0; }
            else { components.location.reason='Set your office location in Settings'; }

            // Keywords
            let keywordScore=50;
            const keywordDetails=[];
            for(const item of goodFound) { keywordScore+=8; keywordDetails.push({keyword:item.keyword,type:'good',effect:'+8',pages:item.pages}); }
            const riskPenalty = settings.riskTolerance==='low'?15:settings.riskTolerance==='medium'?10:5;
            if(extracted.has_contract_language) { for(const item of badFound) { keywordScore-=riskPenalty; keywordDetails.push({keyword:item.keyword,type:'bad',effect:`-${riskPenalty}`,pages:item.pages}); } }
            keywordScore=Math.max(0,Math.min(100,keywordScore));
            components.keywords={score:keywordScore,weight:weights.keywords,reason:extracted.has_contract_language?`Found ${goodFound.length} good, ${badFound.length} risk terms`:`Found ${goodFound.length} good terms. No contract detected.`,details:keywordDetails,hasContract:extracted.has_contract_language};

            // GC
            let gcScore=50;
            const gcCount=selectedGCs.length;
            let competitionPenalty=0; if(gcCount<=2)competitionPenalty=0; else if(gcCount<=5)competitionPenalty=5; else if(gcCount<=10)competitionPenalty=10; else competitionPenalty=15;
            let totalWeight=0,weightedSum=0,bestGC=null,bestRate=0;
            for(const gc of selectedGCs) {
                if(gc.bids>0) { const winRate=(gc.wins/gc.bids)*100; weightedSum+=winRate*gc.bids; totalWeight+=gc.bids; if(winRate>bestRate||!bestGC){bestRate=winRate;bestGC=gc;} }
                else { const starScore=gc.rating*20; weightedSum+=starScore; totalWeight+=1; if(starScore>bestRate||!bestGC){bestRate=starScore;bestGC=gc;} }
            }
            if(totalWeight>0) gcScore=Math.round(weightedSum/totalWeight);
            gcScore=Math.max(0,gcScore-competitionPenalty);
            components.gc={score:gcScore,weight:weights.gc,reason:`${gcCount} GC${gcCount>1?'s':''} bidding${competitionPenalty>0?` (-${competitionPenalty} penalty)`:''}`,details:{gcCount,competitionPenalty,bestGC:bestGC?{name:bestGC.name,rate:bestGC.bids>0?Math.round(bestGC.wins/bestGC.bids*100):null,rating:bestGC.rating}:null}};

            // Trade
            let tradeScore=0; if(settings.trades.length>0) tradeScore=Math.round((tradesFound.length/settings.trades.length)*100);
            components.trade={score:tradeScore,weight:weights.trade,reason:`Found ${tradesFound.length} of ${settings.trades.length} divisions`,details:{found:tradesFound,total:settings.trades.length}};

            // Final
            let finalScore=0;
            for(const key of ['location','keywords','gc','trade']) { if(components[key].weight>0) finalScore+=components[key].score*(components[key].weight/100); }
            finalScore=Math.round(finalScore);
            let recommendation; if(finalScore>=80)recommendation='GO'; else if(finalScore>=60)recommendation='REVIEW'; else recommendation='PASS';
            return {final:finalScore,recommendation,components,weights};
        }

        function renderAnalysisResult(analysis) {
            const resultDiv = document.getElementById('analysisResult');
            const settings = getSettings();
            const recClass = analysis.scores.recommendation.toLowerCase();
            const recText = {'GO':'Strong fit for your business','REVIEW':'Mixed signals - review carefully','PASS':'Poor fit based on your criteria'}[analysis.scores.recommendation];
            let capacityMessage = '';
            if(settings.capacity==='hungry'&&analysis.scores.recommendation==='REVIEW') capacityMessage=`<p style="margin-top:16px;padding:12px;background:var(--warning-bg);border-radius:var(--radius-md);font-size:14px;"><strong>You're hungry for work.</strong> This might be worth pursuing despite mixed signals.</p>`;
            else if(settings.capacity==='maxed'&&analysis.scores.recommendation!=='GO') capacityMessage=`<p style="margin-top:16px;padding:12px;background:var(--info-bg);border-radius:var(--radius-md);font-size:14px;"><strong>You're at capacity.</strong> You can probably pass on this one.</p>`;

            resultDiv.innerHTML=`<div class="score-report"><div class="score-report-header"><div class="score-report-value ${recClass}">${analysis.scores.final}</div><div class="score-report-rec">${analysis.scores.recommendation} - ${recText}</div>${analysis.extracted.project_name?`<p style="color:var(--text-muted);margin-top:8px;">${analysis.extracted.project_name}</p>`:''}${capacityMessage}</div>${renderScoreComponent('üìç','Location Fit',analysis.scores.components.location)}${renderScoreComponent('üîë','Keywords & Contract',analysis.scores.components.keywords)}${renderScoreComponent('üè¢','GC & Competition',analysis.scores.components.gc)}${renderScoreComponent('üîß','Trade Match',analysis.scores.components.trade)}</div><div style="display:flex;gap:12px;margin-top:24px;"><button class="btn btn-primary" style="flex:1;" onclick="saveProject()"><svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>Save to Projects</button><button class="btn btn-secondary" onclick="resetAnalysis()">Start Over</button></div>`;

            if(analysis.scores.components.location.needsAddress) {
                const locationSection = resultDiv.querySelector('.score-component');
                locationSection.innerHTML+=`<div class="address-prompt"><div class="address-prompt-title"><svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>Project location not found</div><p style="font-size:13px;color:var(--text-secondary);">Enter the project address to calculate distance:</p><div class="address-prompt-row"><input type="text" class="form-input" id="manualAddress" placeholder="123 Main St, City, State"><button class="btn btn-primary btn-sm" onclick="recalculateWithAddress()">Calculate</button></div></div>`;
            }
        }

        function renderScoreComponent(icon,title,component) {
            const fillClass = component.score>=70?'high':component.score>=50?'medium':'low';
            let detailsHtml='';
            if(title==='Keywords & Contract'&&component.details.length>0) {
                const goodItems=component.details.filter(d=>d.type==='good'),badItems=component.details.filter(d=>d.type==='bad');
                detailsHtml='<div class="score-component-details">';
                if(goodItems.length>0) { detailsHtml+=`<div style="margin-bottom:8px;"><strong style="color:var(--success);">‚úì Found (good):</strong></div>`; detailsHtml+=goodItems.map(d=>`<span class="keyword-tag good">${d.keyword} (${d.effect}) <span class="page-ref">p.${d.pages.slice(0,3).join(',')}</span></span>`).join(''); }
                if(badItems.length>0) { detailsHtml+=`<div style="margin:8px 0;"><strong style="color:var(--danger);">‚ö† Found (risk):</strong></div>`; detailsHtml+=badItems.map(d=>`<span class="keyword-tag bad">${d.keyword} (${d.effect}) <span class="page-ref">p.${d.pages.slice(0,3).join(',')}</span></span>`).join(''); }
                if(!component.hasContract) detailsHtml+=`<p style="margin-top:12px;font-size:12px;color:var(--text-muted);">‚ÑπÔ∏è No contract language detected. Risk terms not scored.</p>`;
                detailsHtml+='</div>';
            }
            if(title==='GC & Competition'&&component.details.bestGC) {
                const best=component.details.bestGC;
                detailsHtml=`<div class="score-component-details"><p><strong>Best relationship:</strong> ${best.name}</p><p>${best.rate!==null?`Win rate: ${best.rate}%`:`Rating: ${'‚òÖ'.repeat(best.rating)}${'‚òÜ'.repeat(5-best.rating)}`}</p>${component.details.competitionPenalty>0?`<p style="color:var(--warning);">Competition penalty: -${component.details.competitionPenalty} points</p>`:''}</div>`;
            }
            if(title==='Trade Match'&&component.details.found) {
                const foundDivs=component.details.found.map(d=>`Div ${d}: ${CSI_DIVISIONS[d]||'Unknown'}`);
                detailsHtml=`<div class="score-component-details"><p><strong>Found:</strong> ${foundDivs.length>0?foundDivs.join(', '):'None'}</p></div>`;
            }
            return `<div class="score-component"><div class="score-component-header"><div class="score-component-title"><span class="score-component-icon">${icon}</span><span>${title}</span><span style="color:var(--text-muted);font-size:12px;font-weight:normal;">(${component.weight}%)</span></div><div class="score-component-value">${component.score}/100</div></div><div class="score-component-bar"><div class="score-component-fill ${fillClass}" style="width:${component.score}%"></div></div><div class="score-component-reason">${component.reason}</div>${detailsHtml}</div>`;
        }

        async function recalculateWithAddress() {
            const address = document.getElementById('manualAddress').value.trim();
            if(!address) return;
            const settings = getSettings();
            const userCoords = await geocode(`${settings.city}, ${settings.state}`);
            const projectCoords = await geocode(address);
            if(userCoords&&projectCoords) {
                const distance = Math.round(haversineDistance(userCoords.lat,userCoords.lon,projectCoords.lat,projectCoords.lon));
                let score; if(distance<=25)score=100; else if(distance<=50)score=85; else if(distance<=100)score=70; else if(distance<=150)score=50; else score=30;
                if(distance>settings.radius) score=Math.max(10,score-20);
                currentAnalysis.scores.components.location={score,weight:currentAnalysis.scores.components.location.weight,reason:`${distance} miles from your office${distance>settings.radius?' (outside service area)':''}`,details:{distance,inRadius:distance<=settings.radius}};
                let finalScore=0;
                for(const key of ['location','keywords','gc','trade']) { const comp=currentAnalysis.scores.components[key]; if(comp.weight>0) finalScore+=comp.score*(comp.weight/100); }
                currentAnalysis.scores.final=Math.round(finalScore);
                if(finalScore>=80)currentAnalysis.scores.recommendation='GO'; else if(finalScore>=60)currentAnalysis.scores.recommendation='REVIEW'; else currentAnalysis.scores.recommendation='PASS';
                currentAnalysis.extracted.project_address=address;
                renderAnalysisResult(currentAnalysis);
            } else { alert('Could not geocode that address. Try a different format.'); }
        }

        function saveProject() {
            if(!currentAnalysis) return;
            const projects = getProjects();
            projects.unshift({id:currentAnalysis.id,extracted:currentAnalysis.extracted,scores:currentAnalysis.scores,gcs:currentAnalysis.gcs,files:currentAnalysis.files,goodFound:currentAnalysis.goodFound,badFound:currentAnalysis.badFound,tradesFound:currentAnalysis.tradesFound,outcome:'pending',createdAt:currentAnalysis.createdAt});
            saveProjects(projects);
            const gcs = getGCs();
            for(const sg of currentAnalysis.gcs) { const gc=gcs.find(g=>g.name===sg.name); if(gc)gc.bids=(gc.bids||0)+1; }
            saveGCsToStorage(gcs);
            resetAnalysis(); switchTab('projects'); loadDashboard(); loadProjects();
        }

        function resetAnalysis() {
            uploadedFiles=[]; selectedGCs=[]; currentAnalysis=null;
            document.getElementById('fileList').innerHTML='';
            document.getElementById('selectedGCsList').innerHTML='';
            document.getElementById('competitionIndicator').innerHTML='';
            document.getElementById('analysisResult').innerHTML='';
            document.getElementById('gcSearchInput').value='';
            updateAnalyzeButton(); renderGCSelector();
        }

        // Dashboard
        function loadDashboard() {
            const projects = getProjects();
            const settings = getSettings();
            document.getElementById('statBids').textContent = projects.length;
            const won = projects.filter(p=>p.outcome==='won').length;
            const lost = projects.filter(p=>p.outcome==='lost').length;
            document.getElementById('statWinRate').textContent = (won+lost)>0?Math.round(won/(won+lost)*100)+'%':'--';
            document.getElementById('statPending').textContent = projects.filter(p=>p.outcome==='pending').length;
            document.getElementById('statHours').textContent = Math.round(projects.length*settings.decisionTime/60);

            // Recent activity
            const recent = projects.slice(0,5);
            if(recent.length===0) {
                document.getElementById('recentActivity').innerHTML=`<div class="empty-state"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg><h3>No bids analyzed yet</h3><p>Upload your first bid documents to get started</p><button class="btn btn-primary" onclick="switchTab('analyze')">Analyze Your First Bid</button></div>`;
            } else {
                document.getElementById('recentActivity').innerHTML=`<table class="projects-table"><thead><tr><th>Project</th><th>Score</th><th>Outcome</th><th>Date</th></tr></thead><tbody>${recent.map(p=>`<tr onclick="viewReport('${p.id}')" style="cursor:pointer;"><td><div class="project-name">${p.extracted.project_name||'Untitled'}</div><div class="project-location">${p.extracted.project_city||''} ${p.extracted.project_state||''}</div></td><td><span class="score-badge ${p.scores.recommendation.toLowerCase()}">${p.scores.final}</span></td><td><span class="outcome-badge ${p.outcome}">${p.outcome}</span></td><td style="color:var(--text-muted);font-size:13px;">${new Date(p.createdAt).toLocaleDateString()}</td></tr>`).join('')}</tbody></table>`;
            }
            // Capacity indicator
            const cap = document.getElementById('capacityIndicator');
            cap.className = `capacity-box capacity-${settings.capacity}`;
            document.getElementById('capacityText').textContent = {hungry:'Hungry',steady:'Steady',maxed:'Maxed'}[settings.capacity];
        }

        // Projects List
        function loadProjects() {
            const projects = getProjects();
            if(projects.length===0) {
                document.getElementById('projectsList').innerHTML=`<div class="empty-state"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg><h3>No projects yet</h3><p>Analyze your first bid to see it here</p><button class="btn btn-primary" onclick="switchTab('analyze')">Analyze Bid</button></div>`;
            } else {
                document.getElementById('projectsList').innerHTML=`<table class="projects-table"><thead><tr><th>Project</th><th>GCs</th><th>Score</th><th>Deadline</th><th>Outcome</th><th>Actions</th></tr></thead><tbody>${projects.map(p=>`<tr><td><div class="project-name">${p.extracted.project_name||'Untitled'}</div><div class="project-location">${p.extracted.project_city||''} ${p.extracted.project_state||''}</div></td><td><div class="gc-tags">${p.gcs.slice(0,2).map(g=>`<span class="gc-tag">${g.name.split(' ')[0]}</span>`).join('')}${p.gcs.length>2?`<span class="gc-tag">+${p.gcs.length-2}</span>`:''}</div></td><td><span class="score-badge ${p.scores.recommendation.toLowerCase()}">${p.scores.final}</span></td><td style="color:var(--text-muted);font-size:13px;">${p.extracted.bid_deadline||'--'}</td><td><span class="outcome-badge ${p.outcome}">${p.outcome}</span></td><td><button class="btn btn-sm btn-secondary" onclick="viewReport('${p.id}')">View</button> <button class="btn btn-sm btn-secondary" onclick="showOutcomeModal('${p.id}')">Outcome</button> <button class="btn btn-sm btn-secondary" onclick="deleteProject('${p.id}')" style="color:var(--danger);">√ó</button></td></tr>`).join('')}</tbody></table>`;
            }
        }

        function viewReport(id) {
            const projects = getProjects();
            const p = projects.find(x=>x.id===id);
            if(!p) return;
            document.getElementById('reportModalTitle').textContent = p.extracted.project_name||'Bid Analysis Report';
            const recClass = p.scores.recommendation.toLowerCase();
            const recText = {'GO':'Strong fit','REVIEW':'Mixed signals','PASS':'Poor fit'}[p.scores.recommendation];
            document.getElementById('reportModalBody').innerHTML=`<div class="score-report"><div class="score-report-header"><div class="score-report-value ${recClass}">${p.scores.final}</div><div class="score-report-rec">${p.scores.recommendation} - ${recText}</div></div>${renderScoreComponent('üìç','Location Fit',p.scores.components.location)}${renderScoreComponent('üîë','Keywords & Contract',p.scores.components.keywords)}${renderScoreComponent('üè¢','GC & Competition',p.scores.components.gc)}${renderScoreComponent('üîß','Trade Match',p.scores.components.trade)}</div>`;
            openModal('reportModal');
        }

        function showOutcomeModal(id) {
            document.getElementById('outcomeProjectId').value=id;
            document.getElementById('outcomeType').value='';
            document.getElementById('outcomeFields').innerHTML='';
            openModal('outcomeModal');
        }

        function updateOutcomeFields() {
            const type = document.getElementById('outcomeType').value;
            let html='';
            if(type==='won') html=`<div class="form-group"><label class="form-label">Contract Amount ($)</label><input type="number" class="form-input" id="outcomeAmount" placeholder="3200000"></div><div class="form-group"><label class="form-label">Final Margin (%)</label><input type="number" class="form-input" id="outcomeMargin" placeholder="12" step="0.1"></div><div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="outcomeNotes" placeholder="Any learnings..."></textarea></div>`;
            else if(type==='lost') html=`<div class="form-group"><label class="form-label">How high were you?</label><select class="form-select" id="outcomeHowHigh"><option value="">Select...</option><option value="within5">Within 5%</option><option value="5to10">5-10% high</option><option value="10to20">10-20% high</option><option value="over20">Over 20% high</option><option value="unknown">Don't know</option></select></div><div class="form-group"><label class="form-label">Winner (if known)</label><input type="text" class="form-input" id="outcomeWinner" placeholder="Competitor name"></div><div class="form-group"><label class="form-label">GC Feedback</label><textarea class="form-input" id="outcomeNotes" placeholder="Any feedback received..."></textarea></div>`;
            else if(type==='declined') html=`<div class="form-group"><label class="form-label">Why didn't you bid?</label><select class="form-select" id="outcomeReason"><option value="">Select...</option><option value="busy">Too busy</option><option value="size">Wrong project size</option><option value="gc">Bad GC relationship</option><option value="location">Too far away</option><option value="scope">Not my scope</option><option value="risk">Too risky</option><option value="other">Other</option></select></div><div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="outcomeNotes" placeholder="Any notes..."></textarea></div>`;
            document.getElementById('outcomeFields').innerHTML=html;
        }

        function saveOutcome() {
            const id = document.getElementById('outcomeProjectId').value;
            const type = document.getElementById('outcomeType').value;
            if(!type) { alert('Please select an outcome'); return; }
            const projects = getProjects();
            const p = projects.find(x=>x.id===id);
            if(!p) return;
            p.outcome=type;
            p.outcomeData={};
            if(type==='won') { p.outcomeData.amount=document.getElementById('outcomeAmount')?.value; p.outcomeData.margin=document.getElementById('outcomeMargin')?.value; p.outcomeData.notes=document.getElementById('outcomeNotes')?.value; }
            else if(type==='lost') { p.outcomeData.howHigh=document.getElementById('outcomeHowHigh')?.value; p.outcomeData.winner=document.getElementById('outcomeWinner')?.value; p.outcomeData.notes=document.getElementById('outcomeNotes')?.value; }
            else if(type==='declined') { p.outcomeData.reason=document.getElementById('outcomeReason')?.value; p.outcomeData.notes=document.getElementById('outcomeNotes')?.value; }
            saveProjects(projects);
            // Update GC win counts if won
            if(type==='won') {
                const gcs = getGCs();
                for(const pg of p.gcs) { const gc=gcs.find(g=>g.name===pg.name); if(gc)gc.wins=(gc.wins||0)+1; }
                saveGCsToStorage(gcs);
            }
            closeModal('outcomeModal'); loadDashboard(); loadProjects(); loadGCDatabase();
        }

        function deleteProject(id) {
            if(!confirm('Delete this project?')) return;
            const projects = getProjects().filter(p=>p.id!==id);
            saveProjects(projects);
            loadDashboard(); loadProjects();
        }

        function exportCSV() {
            const projects = getProjects();
            if(projects.length===0) { alert('No projects to export'); return; }
            const rows = [['Project','City','State','Score','Recommendation','GCs','Deadline','Outcome','Created']];
            projects.forEach(p=>rows.push([p.extracted.project_name||'',p.extracted.project_city||'',p.extracted.project_state||'',p.scores.final,p.scores.recommendation,p.gcs.map(g=>g.name).join(';'),p.extracted.bid_deadline||'',p.outcome,p.createdAt]));
            const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
            const a = document.createElement('a');
            a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
            a.download='bidiq_export.csv';
            a.click();
        }

        // GC Database
        function loadGCDatabase() {
            const gcs = getGCs();
            if(gcs.length===0) {
                document.getElementById('gcDatabaseList').innerHTML=`<div class="empty-state"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg><h3>No GCs added yet</h3><p>Add GCs during bid analysis or click Add GC above</p></div>`;
            } else {
                document.getElementById('gcDatabaseList').innerHTML = gcs.map(gc=>`<div class="gc-item"><div class="gc-item-info"><div class="gc-item-name">${gc.name}</div><div class="gc-item-stats">${gc.bids||0} bids ‚Ä¢ ${gc.wins||0} wins ‚Ä¢ ${gc.bids>0?Math.round((gc.wins||0)/gc.bids*100):0}% win rate</div></div><div class="gc-item-rating">${[1,2,3,4,5].map(i=>`<span class="star ${i<=gc.rating?'filled':''}" onclick="updateGCRating('${gc.name.replace(/'/g,"\\'")}',${i})">‚òÖ</span>`).join('')}</div><button class="btn btn-sm btn-secondary" onclick="deleteGC('${gc.name.replace(/'/g,"\\'")}')" style="color:var(--danger);">√ó</button></div>`).join('');
            }
        }

        function showAddGCModal() {
            document.getElementById('newGCName').value='';
            document.getElementById('newGCLocation').value='';
            newGCRatingValue=3;
            renderNewGCRating();
            openModal('addGCModal');
        }

        function renderNewGCRating() {
            document.getElementById('newGCRating').innerHTML=[1,2,3,4,5].map(i=>`<span class="star ${i<=newGCRatingValue?'filled':''}" onclick="setNewGCRating(${i})">‚òÖ</span>`).join('');
        }

        function setNewGCRating(r) { newGCRatingValue=r; renderNewGCRating(); }

        function saveNewGC() {
            const name = document.getElementById('newGCName').value.trim();
            const location = document.getElementById('newGCLocation').value.trim();
            if(!name) { alert('Please enter a GC name'); return; }
            const gcs = getGCs();
            const fullName = location?`${name} - ${location}`:name;
            if(gcs.find(g=>g.name.toLowerCase()===fullName.toLowerCase())) { alert('This GC already exists'); return; }
            gcs.push({name:fullName,rating:newGCRatingValue,bids:0,wins:0});
            saveGCsToStorage(gcs);
            closeModal('addGCModal');
            loadGCDatabase();
            renderGCSelector();
        }

        function updateGCRating(name,rating) {
            const gcs = getGCs();
            const gc = gcs.find(g=>g.name===name);
            if(gc) { gc.rating=rating; saveGCsToStorage(gcs); loadGCDatabase(); }
        }

        function deleteGC(name) {
            if(!confirm(`Delete ${name}?`)) return;
            const gcs = getGCs().filter(g=>g.name!==name);
            saveGCsToStorage(gcs);
            loadGCDatabase();
            renderGCSelector();
        }

        // Keywords
        function loadKeywords() {
            const kw = getKeywords();
            document.getElementById('goodKeywordsList').innerHTML = kw.good.map(k=>`<span class="keyword-tag good">${k} <span style="cursor:pointer;" onclick="removeKeyword('good','${k.replace(/'/g,"\\'")}')">√ó</span></span>`).join('');
            document.getElementById('badKeywordsList').innerHTML = kw.bad.map(k=>`<span class="keyword-tag bad">${k} <span style="cursor:pointer;" onclick="removeKeyword('bad','${k.replace(/'/g,"\\'")}')">√ó</span></span>`).join('');
        }

        function addKeyword(type) {
            const input = document.getElementById(type+'KeywordInput');
            const kw = input.value.trim().toLowerCase();
            if(!kw) return;
            const keywords = getKeywords();
            if(!keywords[type].includes(kw)) { keywords[type].push(kw); saveKeywordsToStorage(keywords); }
            input.value='';
            loadKeywords();
        }

        function removeKeyword(type,kw) {
            const keywords = getKeywords();
            keywords[type] = keywords[type].filter(k=>k!==kw);
            saveKeywordsToStorage(keywords);
            loadKeywords();
        }

        document.getElementById('goodKeywordInput').addEventListener('keypress',e=>{if(e.key==='Enter')addKeyword('good');});
        document.getElementById('badKeywordInput').addEventListener('keypress',e=>{if(e.key==='Enter')addKeyword('bad');});

        // Settings
        function loadSettings() {
            const s = getSettings();
            document.getElementById('settingCity').value=s.city;
            document.getElementById('settingState').value=s.state;
            document.getElementById('settingRadius').value=s.radius;
            document.getElementById('settingLocationMatters').checked=s.locationMatters;
            document.getElementById('settingRiskTolerance').value=s.riskTolerance;
            document.getElementById('settingCapacity').value=s.capacity;
            document.getElementById('settingDecisionTime').value=s.decisionTime;
            document.getElementById('settingGhostDays').value=s.ghostDays;
            document.getElementById('settingDefaultStars').value=s.defaultStars;
            document.getElementById('settingApiKey').value=s.apiKey;

            // Weights
            document.querySelector('#weightLocation input').value=s.weights.location;
            document.querySelector('#weightLocation .weight-slider-value').textContent=s.weights.location+'%';
            document.querySelector('#weightKeywords input').value=s.weights.keywords;
            document.querySelector('#weightKeywords .weight-slider-value').textContent=s.weights.keywords+'%';
            document.querySelector('#weightGC input').value=s.weights.gc;
            document.querySelector('#weightGC .weight-slider-value').textContent=s.weights.gc+'%';
            document.querySelector('#weightTrade input').value=s.weights.trade;
            document.querySelector('#weightTrade .weight-slider-value').textContent=s.weights.trade+'%';
            updateWeightTotal();

            // Trades
            const tradesDiv = document.getElementById('tradesCheckboxes');
            tradesDiv.innerHTML = Object.entries(CSI_DIVISIONS).map(([code,name])=>`<label class="checkbox-item ${s.trades.includes(code)?'selected':''}"><input type="checkbox" value="${code}" ${s.trades.includes(code)?'checked':''}><span>${code}: ${name}</span></label>`).join('');
            tradesDiv.querySelectorAll('input').forEach(cb=>cb.addEventListener('change',e=>{e.target.parentElement.classList.toggle('selected',e.target.checked);}));
        }

        function updateWeightTotal() {
            const total = parseInt(document.querySelector('#weightLocation input').value)+parseInt(document.querySelector('#weightKeywords input').value)+parseInt(document.querySelector('#weightGC input').value)+parseInt(document.querySelector('#weightTrade input').value);
            document.getElementById('weightTotal').textContent=total+'%';
            document.getElementById('weightTotal').style.color=total===100?'var(--success)':'var(--danger)';
        }

        document.querySelectorAll('.weight-slider input').forEach(slider=>{
            slider.addEventListener('input',e=>{
                e.target.parentElement.querySelector('.weight-slider-value').textContent=e.target.value+'%';
                updateWeightTotal();
            });
        });

        function saveSettings() {
            const total = parseInt(document.querySelector('#weightLocation input').value)+parseInt(document.querySelector('#weightKeywords input').value)+parseInt(document.querySelector('#weightGC input').value)+parseInt(document.querySelector('#weightTrade input').value);
            if(total!==100) { alert('Weights must total 100%'); return; }
            const settings = {
                city:document.getElementById('settingCity').value.trim(),
                state:document.getElementById('settingState').value.trim(),
                radius:parseInt(document.getElementById('settingRadius').value),
                locationMatters:document.getElementById('settingLocationMatters').checked,
                trades:Array.from(document.querySelectorAll('#tradesCheckboxes input:checked')).map(cb=>cb.value),
                riskTolerance:document.getElementById('settingRiskTolerance').value,
                capacity:document.getElementById('settingCapacity').value,
                weights:{location:parseInt(document.querySelector('#weightLocation input').value),keywords:parseInt(document.querySelector('#weightKeywords input').value),gc:parseInt(document.querySelector('#weightGC input').value),trade:parseInt(document.querySelector('#weightTrade input').value)},
                decisionTime:parseInt(document.getElementById('settingDecisionTime').value),
                ghostDays:parseInt(document.getElementById('settingGhostDays').value),
                defaultStars:parseInt(document.getElementById('settingDefaultStars').value),
                apiKey:document.getElementById('settingApiKey').value.trim()
            };
            saveSettingsToStorage(settings);
            loadDashboard();
            alert('Settings saved!');
        }

        // Init
        document.addEventListener('DOMContentLoaded',()=>{
            loadSettings();
            loadKeywords();
            loadGCDatabase();
            loadDashboard();
            loadProjects();
            renderGCSelector();
        });
    </script>
</body>
</html>
-info"><div class="file-name">${f.name}</div><div class="file-size">${(f.size/1024/1024).toFixed(2)} MB</div></div><span class="file-remove" onclick="removeFile(${i})">√ó</span></div>`).join('');
        }
        function removeFile(i) { uploadedFiles.splice(i,1); renderFileList(); updateAnalyzeButton(); }
        function updateAnalyzeButton() { document.getElementById('analyzeBtn').disabled = uploadedFiles.length===0||selectedGCs.length===0; }

        // GC Selector
        function renderGCSelector() {
            const gcs = getGCs();
            const search = document.getElementById('gcSearchInput').value.toLowerCase();
            const filtered = gcs.filter(g=>g.name.toLowerCase().includes(search));
            document.getElementById('gcSelectorList').innerHTML = filtered.length===0 ? '<div style="padding:16px;text-align:center;color:var(--text-muted)">No GCs found. Type name and click Add.</div>' : filtered.map(gc=>`<div class="gc-selector-item ${selectedGCs.find(s=>s.name===gc.name)?'selected':''}" onclick="toggleGC('${gc.name.replace(/'/g,"\\'")}')">${gc.name}<span style="color:var(--accent)">${'‚òÖ'.repeat(gc.rating)}${'‚òÜ'.repeat(5-gc.rating)}</span></div>`).join('');
            renderSelectedGCs();
        }
        function toggleGC(name) {
            const gcs = getGCs();
            const gc = gcs.find(g=>g.name===name);
            if(!gc) return;
            const idx = selectedGCs.findIndex(s=>s.name===name);
            if(idx>=0) selectedGCs.splice(idx,1); else selectedGCs.push(gc);
            renderGCSelector(); updateCompetition(); updateAnalyzeButton();
        }
        function renderSelectedGCs() {
            document.getElementById('selectedGCsList').innerHTML = selectedGCs.map(gc=>`<div class="gc-selected-tag">${gc.name}<span style="color:var(--accent);font-size:11px">${'‚òÖ'.repeat(gc.rating)}</span><span class="remove" onclick="toggleGC('${gc.name.replace(/'/g,"\\'")}')">√ó</span></div>`).join('');
        }
        function updateCompetition() {
            const n = selectedGCs.length;
            if(n===0) { document.getElementById('competitionIndicator').innerHTML=''; return; }
            let lvl,cls,pen;
            if(n<=2){lvl='Low';cls='low';pen=0;} else if(n<=5){lvl='Moderate';cls='moderate';pen=5;} else if(n<=10){lvl='High';cls='high';pen=10;} else{lvl='Very High';cls='very-high';pen=15;}
            document.getElementById('competitionIndicator').innerHTML=`<div class="competition-indicator ${cls}">${n} GC${n>1?'s':''} bidding ‚Ä¢ ${lvl} competition${pen>0?' (-'+pen+' penalty)':''}</div>`;
        }
        function addNewGC() {
            const input = document.getElementById('gcSearchInput');
            const name = input.value.trim();
            if(!name) return;
            const gcs = getGCs();
            if(gcs.find(g=>g.name.toLowerCase()===name.toLowerCase())) { alert('GC already exists'); return; }
            const settings = getSettings();
            const newGC = {name,rating:settings.defaultStars,bids:0,wins:0};
            gcs.push(newGC); saveGCsToStorage(gcs);
            selectedGCs.push(newGC); input.value='';
            renderGCSelector(); updateCompetition(); updateAnalyzeButton();
        }
        document.getElementById('gcSearchInput').addEventListener('input',renderGCSelector);
        document.getElementById('gcSearchInput').addEventListener('keypress',e=>{if(e.key==='Enter')addNewGC();});

        // PDF Text Extraction
        async function extractText(file) {
            const ab = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data:ab}).promise;
            const pages = [];
            for(let i=1;i<=pdf.numPages;i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                pages.push({num:i,text:content.items.map(x=>x.str).join(' ')});
            }
            return pages;
        }

        // Geocoding
        async function geocode(addr) {
            try {
                const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}&limit=1`,{headers:{'User-Agent':'BidIQ/1.0'}});
                const d = await r.json();
                if(d.length>0) return {lat:parseFloat(d[0].lat),lon:parseFloat(d[0].lon)};
            } catch(e){console.error(e);}
            return null;
        }
        function haversine(lat1,lon1,lat2,lon2) {
            const R=3959,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180;
            const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
            return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
        }

        // Keyword Search
        function searchKeywords(pages,keywords) {
            const results = [];
            for(const kw of keywords) {
                const found = [];
                const rx = new RegExp(kw.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi');
                for(const p of pages) if(rx.test(p.text)) found.push(p.num);
                if(found.length>0) results.push({keyword:kw,pages:found});
            }
            return results;
        }

        // Main Analysis
        async function analyzeBid() {
            const settings = getSettings();
            if(!settings.apiKey) { alert('Please add your Anthropic API key in Settings'); switchTab('settings'); return; }
            const btn = document.getElementById('analyzeBtn');
            const resultDiv = document.getElementById('analysisResult');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="width:20px;height:20px;border-width:2px"></span> Analyzing...';
            resultDiv.innerHTML = '<div class="loading"><span class="spinner"></span></div>';

            try {
                let allPages = [];
                for(const f of uploadedFiles) { const p = await extractText(f); allPages = allPages.concat(p); }
                const fullText = allPages.map(p=>p.text).join('\n\n');

                const prompt = `Extract from this bid document. Return ONLY valid JSON:
{"project_name":"string or null","project_city":"string or null","project_state":"string or null (2-letter)","project_address":"string or null","bid_deadline":"string or null (YYYY-MM-DD)","project_sf":"number or null","has_contract_language":true/false}

Document (first 15000 chars):
${fullText.substring(0,15000)}`;

                const response = await fetch('https://api.anthropic.com/v1/messages',{
                    method:'POST',
                    headers:{'Content-Type':'application/json','x-api-key':settings.apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
                    body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,messages:[{role:'user',content:prompt}]})
                });
                const data = await response.json();
                let extracted = {};
                try { const c=data.content[0].text; const m=c.match(/\{[\s\S]*\}/); if(m) extracted=JSON.parse(m[0]); } catch(e){console.error(e);}

                const keywords = getKeywords();
                const goodFound = searchKeywords(allPages,keywords.good);
                const badFound = searchKeywords(allPages,keywords.bad);

                const tradesFound = [];
                for(const div of settings.trades) {
                    const patterns = [new RegExp(`Division\\s*${div}`,'gi'),new RegExp(`Section\\s*${div}`,'gi'),new RegExp(`\\b${div}\\s*\\d{2}\\s*\\d{2}`,'gi')];
                    for(const pat of patterns) for(const pg of allPages) if(pat.test(pg.text)&&!tradesFound.includes(div)) tradesFound.push(div);
                }

                const scores = await calculateScores(extracted,settings,goodFound,badFound,tradesFound);
                currentAnalysis = {id:Date.now().toString(),extracted,scores,gcs:[...selectedGCs],files:uploadedFiles.map(f=>f.name),goodFound,badFound,tradesFound,createdAt:new Date().toISOString()};
                renderAnalysisResult(currentAnalysis);
            } catch(error) {
                console.error(error);
                resultDiv.innerHTML = `<div class="card" style="border-color:var(--danger)"><div class="card-body" style="text-align:center"><h3 style="color:var(--danger)">Analysis Failed</h3><p style="color:var(--text-muted)">${error.message}</p><button class="btn btn-secondary" onclick="analyzeBid()">Try Again</button></div></div>`;
            }
            btn.disabled = false;
            btn.innerHTML = '<svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>Analyze Bid';
        }

        async function calculateScores(extracted,settings,goodFound,badFound,tradesFound) {
            const components = {};
            let weights = {...settings.weights};
            if(!settings.locationMatters) {
                const lw = weights.location;
                const ot = weights.keywords+weights.gc+weights.trade;
                weights.keywords = Math.round(weights.keywords+(lw*weights.keywords/ot));
                weights.gc = Math.round(weights.gc+(lw*weights.gc/ot));
                weights.trade = Math.round(weights.trade+(lw*weights.trade/ot));
                weights.location = 0;
            }

            // Location
            components.location = {score:50,weight:weights.location,reason:'',details:{},needsAddress:false};
            if(settings.locationMatters&&settings.city&&settings.state) {
                const userAddr = `${settings.city}, ${settings.state}`;
                const userCoords = await geocode(userAddr);
                let projAddr = extracted.project_address||(extracted.project_city&&extracted.project_state?`${extracted.project_city}, ${extracted.project_state}`:null);
                if(userCoords&&projAddr) {
                    const projCoords = await geocode(projAddr);
                    if(projCoords) {
                        const dist = Math.round(haversine(userCoords.lat,userCoords.lon,projCoords.lat,projCoords.lon));
                        let score = dist<=25?100:dist<=50?85:dist<=100?70:dist<=150?50:30;
                        if(dist>settings.radius) score = Math.max(10,score-20);
                        components.location = {score,weight:weights.location,reason:`${dist} miles from your office${dist>settings.radius?' (outside service area)':''}`,details:{distance:dist,inRadius:dist<=settings.radius}};
                    } else { components.location.reason='Could not geocode project location'; components.location.needsAddress=true; }
                } else if(!projAddr) { components.location.reason='Project address not found in documents'; components.location.needsAddress=true; }
            } else if(!settings.locationMatters) { components.location.reason='Location scoring disabled'; components.location.score=0; }
            else { components.location.reason='Set your office location in Settings'; }

            // Keywords
            let kwScore = 50;
            const kwDetails = [];
            for(const item of goodFound) { kwScore+=8; kwDetails.push({keyword:item.keyword,type:'good',effect:'+8',pages:item.pages}); }
            const riskPen = settings.riskTolerance==='low'?15:settings.riskTolerance==='medium'?10:5;
            if(extracted.has_contract_language) for(const item of badFound) { kwScore-=riskPen; kwDetails.push({keyword:item.keyword,type:'bad',effect:`-${riskPen}`,pages:item.pages}); }
            kwScore = Math.max(0,Math.min(100,kwScore));
            components.keywords = {score:kwScore,weight:weights.keywords,reason:extracted.has_contract_language?`Found ${goodFound.length} good, ${badFound.length} risk terms`:`Found ${goodFound.length} good terms. No contract language detected.`,details:kwDetails,hasContract:extracted.has_contract_language};

            // GC
            let gcScore = 50;
            const gcCount = selectedGCs.length;
            let compPen = gcCount<=2?0:gcCount<=5?5:gcCount<=10?10:15;
            let totalW=0,weightedSum=0,bestGC=null,bestRate=0;
            for(const gc of selectedGCs) {
                if(gc.bids>0) { const wr=(gc.wins/gc.bids)*100; weightedSum+=wr*gc.bids; totalW+=gc.bids; if(wr>bestRate||!bestGC){bestRate=wr;bestGC=gc;} }
                else { const ss=gc.rating*20; weightedSum+=ss; totalW+=1; if(ss>bestRate||!bestGC){bestRate=ss;bestGC=gc;} }
            }
            if(totalW>0) gcScore = Math.round(weightedSum/totalW);
            gcScore = Math.max(0,gcScore-compPen);
            components.gc = {score:gcScore,weight:weights.gc,reason:`${gcCount} GC${gcCount>1?'s':''} bidding${compPen>0?' (-'+compPen+' penalty)':''}`,details:{gcCount,competitionPenalty:compPen,bestGC:bestGC?{name:bestGC.name,rate:bestGC.bids>0?Math.round(bestGC.wins/bestGC.bids*100):null,rating:bestGC.rating}:null}};

            // Trade
            let tradeScore = settings.trades.length>0?Math.round((tradesFound.length/settings.trades.length)*100):0;
            components.trade = {score:tradeScore,weight:weights.trade,reason:`Found ${tradesFound.length} of ${settings.trades.length} divisions in specs`,details:{found:tradesFound,total:settings.trades.length}};

            // Final
            let final = 0;
            for(const k of ['location','keywords','gc','trade']) if(components[k].weight>0) final += components[k].score*(components[k].weight/100);
            final = Math.round(final);
            let rec = final>=80?'GO':final>=60?'REVIEW':'PASS';
            return {final,recommendation:rec,components,weights};
        }

        function renderAnalysisResult(analysis) {
            const resultDiv = document.getElementById('analysisResult');
            const settings = getSettings();
            const recClass = analysis.scores.recommendation.toLowerCase();
            const recText = {'GO':'Strong fit for your business','REVIEW':'Mixed signals - review carefully','PASS':'Poor fit based on your criteria'}[analysis.scores.recommendation];
            let capMsg = '';
            if(settings.capacity==='hungry'&&analysis.scores.recommendation==='REVIEW') capMsg=`<p style="margin-top:16px;padding:12px;background:var(--warning-bg);border-radius:var(--radius-md);font-size:14px"><strong>You're hungry for work.</strong> This might be worth pursuing despite the mixed signals.</p>`;
            else if(settings.capacity==='maxed'&&analysis.scores.recommendation!=='GO') capMsg=`<p style="margin-top:16px;padding:12px;background:var(--info-bg);border-radius:var(--radius-md);font-size:14px"><strong>You're at capacity.</strong> You can probably pass on this one.</p>`;

            resultDiv.innerHTML = `<div class="score-report">
                <div class="score-report-header">
                    <div class="score-report-value ${recClass}">${analysis.scores.final}</div>
                    <div class="score-report-rec">${analysis.scores.recommendation} - ${recText}</div>
                    ${analysis.extracted.project_name?`<p style="color:var(--text-muted);margin-top:8px">${analysis.extracted.project_name}</p>`:''}
                    ${capMsg}
                </div>
                ${renderScoreComponent('üìç','Location Fit',analysis.scores.components.location)}
                ${renderScoreComponent('üîë','Keywords & Contract',analysis.scores.components.keywords)}
                ${renderScoreComponent('üè¢','GC & Competition',analysis.scores.components.gc)}
                ${renderScoreComponent('üîß','Trade Match',analysis.scores.components.trade)}
            </div>
            <div style="display:flex;gap:12px;margin-top:24px">
                <button class="btn btn-primary" style="flex:1" onclick="saveProject()"><svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>Save to Projects</button>
                <button class="btn btn-secondary" onclick="resetAnalysis()">Start Over</button>
            </div>`;

            if(analysis.scores.components.location.needsAddress) {
                const locSection = resultDiv.querySelector('.score-component');
                locSection.innerHTML += `<div class="address-prompt"><div class="address-prompt-title"><svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>Project location not found</div><p style="font-size:13px;color:var(--text-secondary)">Enter the project address to calculate distance:</p><div class="address-prompt-row"><input type="text" class="form-input" id="manualAddress" placeholder="123 Main St, City, State"><button class="btn btn-primary btn-sm" onclick="recalcWithAddress()">Calculate</button></div></div>`;
            }
        }

        function renderScoreComponent(icon,title,comp) {
            const fillClass = comp.score>=70?'high':comp.score>=50?'medium':'low';
            let details = '';
            if(title==='Keywords & Contract'&&comp.details.length>0) {
                const good = comp.details.filter(d=>d.type==='good');
                const bad = comp.details.filter(d=>d.type==='bad');
                details = '<div class="score-component-details">';
                if(good.length>0) { details += '<div style="margin-bottom:8px"><strong style="color:var(--success)">‚úì Found (good):</strong></div>'; details += good.map(d=>`<span class="keyword-tag good">${d.keyword} (${d.effect}) <span class="page-ref">p.${d.pages.slice(0,3).join(',')}</span></span>`).join(''); }
                if(bad.length>0) { details += '<div style="margin:8px 0"><strong style="color:var(--danger)">‚ö† Found (risk):</strong></div>'; details += bad.map(d=>`<span class="keyword-tag bad">${d.keyword} (${d.effect}) <span class="page-ref">p.${d.pages.slice(0,3).join(',')}</span></span>`).join(''); }
                if(!comp.hasContract) details += '<p style="margin-top:12px;font-size:12px;color:var(--text-muted)">‚ÑπÔ∏è No contract language detected. Risk terms not scored.</p>';
                details += '</div>';
            }
            if(title==='GC & Competition'&&comp.details.bestGC) {
                const b = comp.details.bestGC;
                details = `<div class="score-component-details"><p><strong>Best relationship:</strong> ${b.name}</p><p>${b.rate!==null?'Win rate: '+b.rate+'%':'Rating: '+'‚òÖ'.repeat(b.rating)+'‚òÜ'.repeat(5-b.rating)}</p>${comp.details.competitionPenalty>0?'<p style="color:var(--warning)">Competition penalty: -'+comp.details.competitionPenalty+' points</p>':''}</div>`;
            }
            if(title==='Trade Match'&&comp.details.found) {
                const found = comp.details.found.map(d=>`Div ${d}: ${CSI_DIVISIONS[d]||'Unknown'}`);
                details = `<div class="score-component-details"><p><strong>Found:</strong> ${found.length>0?found.join(', '):'None'}</p></div>`;
            }
            return `<div class="score-component"><div class="score-component-header"><div class="score-component-title"><span class="score-component-icon">${icon}</span><span>${title}</span><span style="color:var(--text-muted);font-size:12px;font-weight:normal">(${comp.weight}%)</span></div><div class="score-component-value">${comp.score}/100</div></div><div class="score-component-bar"><div class="score-component-fill ${fillClass}" style="width:${comp.score}%"></div></div><div class="score-component-reason">${comp.reason}</div>${details}</div>`;
        }

        async function recalcWithAddress() {
            const addr = document.getElementById('manualAddress').value.trim();
            if(!addr) return;
            const settings = getSettings();
            const userCoords = await geocode(`${settings.city}, ${settings.state}`);
            const projCoords = await geocode(addr);
            if(userCoords&&projCoords) {
                const dist = Math.round(haversine(userCoords.lat,userCoords.lon,projCoords.lat,projCoords.lon));
                let score = dist<=25?100:dist<=50?85:dist<=100?70:dist<=150?50:30;
                if(dist>settings.radius) score = Math.max(10,score-20);
                currentAnalysis.scores.components.location = {score,weight:currentAnalysis.scores.components.location.weight,reason:`${dist} miles from your office${dist>settings.radius?' (outside service area)':''}`,details:{distance:dist,inRadius:dist<=settings.radius}};
                let final = 0;
                for(const k of ['location','keywords','gc','trade']) { const c=currentAnalysis.scores.components[k]; if(c.weight>0) final+=c.score*(c.weight/100); }
                currentAnalysis.scores.final = Math.round(final);
                currentAnalysis.scores.recommendation = final>=80?'GO':final>=60?'REVIEW':'PASS';
                currentAnalysis.extracted.project_address = addr;
                renderAnalysisResult(currentAnalysis);
            } else alert('Could not geocode that address. Try different format.');
        }

        function saveProject() {
            if(!currentAnalysis) return;
            const projects = getProjects();
            projects.unshift({id:currentAnalysis.id,extracted:currentAnalysis.extracted,scores:currentAnalysis.scores,gcs:currentAnalysis.gcs,files:currentAnalysis.files,goodFound:currentAnalysis.goodFound,badFound:currentAnalysis.badFound,tradesFound:currentAnalysis.tradesFound,outcome:'pending',createdAt:currentAnalysis.createdAt});
            saveProjects(projects);
            const gcs = getGCs();
            for(const sg of currentAnalysis.gcs) { const gc = gcs.find(g=>g.name===sg.name); if(gc) gc.bids = (gc.bids||0)+1; }
            saveGCsToStorage(gcs);
            resetAnalysis(); switchTab('projects'); loadDashboard(); loadProjects();
        }

        function resetAnalysis() {
            uploadedFiles = []; selectedGCs = []; currentAnalysis = null;
            document.getElementById('fileList').innerHTML = '';
            document.getElementById('selectedGCsList').innerHTML = '';
            document.getElementById('competitionIndicator').innerHTML = '';
            document.getElementById('analysisResult').innerHTML = '';
            document.getElementById('gcSearchInput').value = '';
            updateAnalyzeButton(); renderGCSelector();
        }

        // Dashboard
        function loadDashboard() {
            const projects = getProjects();
            const settings = getSettings();
            document.getElementById('statBids').textContent = projects.length;
            const won = projects.filter(p=>p.outcome==='won').length;
            const lost = projects.filter(p=>p.outcome==='lost').length;
            document.getElementById('statWinRate').textContent = (won+lost)>0?Math.round(won/(won+lost)*100)+'%':'--';
            document.getElementById('statPending').textContent = projects.filter(p=>p.outcome==='pending').length;
            document.getElementById('statHours').textContent = Math.round(projects.length*settings.decisionTime/60);

            const recent = projects.slice(0,5);
            if(recent.length===0) {
                document.getElementById('recentActivity').innerHTML = '<div class="empty-state"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg><h3>No bids analyzed yet</h3><p>Upload your first bid documents to get started</p><button class="btn btn-primary" onclick="switchTab(\'analyze\')">Analyze Your First Bid</button></div>';
            } else {
                document.getElementById('recentActivity').innerHTML = `<table class="projects-table"><thead><tr><th>Project</th><th>Score</th><th>Outcome</th><th></th></tr></thead><tbody>${recent.map(p=>{
                    const recClass = p.scores.recommendation.toLowerCase();
                    const outcomeClass = p.outcome;
                    return `<tr><td><div class="project-name">${p.extracted.project_name||'Untitled Project'}</div><div class="project-location">${p.extracted.project_city||''}${p.extracted.project_city&&p.extracted.project_state?', ':''}${p.extracted.project_state||''}</div></td><td><span class="score-badge ${recClass}">${p.scores.final} ${p.scores.recommendation}</span></td><td><span class="outcome-badge ${outcomeClass}">${p.outcome}</span></td><td><button class="btn btn-sm btn-secondary" onclick="viewReport('${p.id}')">View</button></td></tr>`;
                }).join('')}</tbody></table>`;
            }
            updateCapacityIndicator();
        }

        function updateCapacityIndicator() {
            const settings = getSettings();
            const el = document.getElementById('capacityIndicator');
            el.className = 'capacity-box capacity-'+settings.capacity;
            document.getElementById('capacityText').textContent = settings.capacity.charAt(0).toUpperCase()+settings.capacity.slice(1);
        }

        // Projects
        function loadProjects() {
            const projects = getProjects();
            if(projects.length===0) {
                document.getElementById('projectsList').innerHTML = '<div class="empty-state" style="padding:40px"><h3>No projects yet</h3><p>Analyze your first bid to see it here</p></div>';
                return;
            }
            document.getElementById('projectsList').innerHTML = `<table class="projects-table"><thead><tr><th>Project</th><th>GCs</th><th>Score</th><th>Deadline</th><th>Outcome</th><th></th></tr></thead><tbody>${projects.map(p=>{
                const recClass = p.scores.recommendation.toLowerCase();
                return `<tr><td><div class="project-name">${p.extracted.project_name||'Untitled'}</div><div class="project-location">${p.extracted.project_city||''}${p.extracted.project_city&&p.extracted.project_state?', ':''}${p.extracted.project_state||''}</div></td><td><div class="gc-tags">${p.gcs.slice(0,2).map(g=>`<span class="gc-tag">${g.name.split(' ')[0]}</span>`).join('')}${p.gcs.length>2?`<span class="gc-tag">+${p.gcs.length-2}</span>`:''}</div></td><td><span class="score-badge ${recClass}">${p.scores.final}</span></td><td>${p.extracted.bid_deadline||'--'}</td><td><span class="outcome-badge ${p.outcome}">${p.outcome}</span></td><td style="white-space:nowrap"><button class="btn btn-sm btn-secondary" onclick="viewReport('${p.id}')" style="margin-right:4px">View</button><button class="btn btn-sm btn-secondary" onclick="showOutcomeModal('${p.id}')" style="margin-right:4px">Outcome</button><button class="btn btn-sm btn-secondary" onclick="deleteProject('${p.id}')" style="color:var(--danger)">√ó</button></td></tr>`;
            }).join('')}</tbody></table>`;
        }

        function viewReport(id) {
            const projects = getProjects();
            const p = projects.find(x=>x.id===id);
            if(!p) return;
            document.getElementById('reportModalTitle').textContent = p.extracted.project_name||'Bid Analysis Report';
            const recClass = p.scores.recommendation.toLowerCase();
            const recText = {'GO':'Strong fit','REVIEW':'Mixed signals','PASS':'Poor fit'}[p.scores.recommendation];
            document.getElementById('reportModalBody').innerHTML = `<div class="score-report"><div class="score-report-header"><div class="score-report-value ${recClass}">${p.scores.final}</div><div class="score-report-rec">${p.scores.recommendation} - ${recText}</div></div>${renderScoreComponent('üìç','Location Fit',p.scores.components.location)}${renderScoreComponent('üîë','Keywords & Contract',p.scores.components.keywords)}${renderScoreComponent('üè¢','GC & Competition',p.scores.components.gc)}${renderScoreComponent('üîß','Trade Match',p.scores.components.trade)}</div>`;
            openModal('reportModal');
        }

        function showOutcomeModal(id) {
            document.getElementById('outcomeProjectId').value = id;
            document.getElementById('outcomeType').value = '';
            document.getElementById('outcomeFields').innerHTML = '';
            openModal('outcomeModal');
        }

        function updateOutcomeFields() {
            const type = document.getElementById('outcomeType').value;
            let html = '';
            if(type==='won') html = '<div class="form-group"><label class="form-label">Contract Amount ($)</label><input type="number" class="form-input" id="outcomeAmount"></div><div class="form-group"><label class="form-label">Final Margin (%)</label><input type="number" class="form-input" id="outcomeMargin" step="0.1"></div><div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="outcomeNotes" rows="2"></textarea></div>';
            else if(type==='lost') html = '<div class="form-group"><label class="form-label">How high were you?</label><select class="form-select" id="outcomeHowHigh"><option value="">Unknown</option><option value="within5">Within 5%</option><option value="5-10">5-10% high</option><option value="10-20">10-20% high</option><option value="over20">Over 20% high</option></select></div><div class="form-group"><label class="form-label">Winner (if known)</label><input type="text" class="form-input" id="outcomeWinner"></div><div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="outcomeNotes" rows="2"></textarea></div>';
            else if(type==='declined') html = '<div class="form-group"><label class="form-label">Reason</label><select class="form-select" id="outcomeDeclineReason"><option value="too_busy">Too busy</option><option value="wrong_size">Wrong size</option><option value="bad_gc">Bad GC relationship</option><option value="location">Location</option><option value="other">Other</option></select></div><div class="form-group"><label class="form-label">Notes</label><textarea class="form-input" id="outcomeNotes" rows="2"></textarea></div>';
            document.getElementById('outcomeFields').innerHTML = html;
        }

        function saveOutcome() {
            const id = document.getElementById('outcomeProjectId').value;
            const type = document.getElementById('outcomeType').value;
            if(!type) { alert('Please select an outcome'); return; }
            const projects = getProjects();
            const p = projects.find(x=>x.id===id);
            if(!p) return;
            p.outcome = type;
            p.outcomeData = {};
            if(type==='won') {
                p.outcomeData.amount = document.getElementById('outcomeAmount')?.value;
                p.outcomeData.margin = document.getElementById('outcomeMargin')?.value;
                const gcs = getGCs();
                for(const sg of p.gcs) { const gc = gcs.find(g=>g.name===sg.name); if(gc) gc.wins = (gc.wins||0)+1; }
                saveGCsToStorage(gcs);
            } else if(type==='lost') {
                p.outcomeData.howHigh = document.getElementById('outcomeHowHigh')?.value;
                p.outcomeData.winner = document.getElementById('outcomeWinner')?.value;
            } else if(type==='declined') {
                p.outcomeData.reason = document.getElementById('outcomeDeclineReason')?.value;
            }
            p.outcomeData.notes = document.getElementById('outcomeNotes')?.value;
            p.outcomeData.recordedAt = new Date().toISOString();
            saveProjects(projects);
            closeModal('outcomeModal');
            loadDashboard(); loadProjects();
        }

        function deleteProject(id) {
            if(!confirm('Delete this project?')) return;
            const projects = getProjects().filter(p=>p.id!==id);
            saveProjects(projects);
            loadDashboard(); loadProjects();
        }

        function exportCSV() {
            const projects = getProjects();
            if(projects.length===0) { alert('No projects to export'); return; }
            const rows = [['Project','City','State','Score','Recommendation','GCs','Deadline','Outcome']];
            for(const p of projects) rows.push([p.extracted.project_name||'',p.extracted.project_city||'',p.extracted.project_state||'',p.scores.final,p.scores.recommendation,p.gcs.map(g=>g.name).join('; '),p.extracted.bid_deadline||'',p.outcome]);
            const csv = rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
            const a = document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download='bidiq_export.csv'; a.click();
        }

        // GC Database
        function loadGCDatabase() {
            const gcs = getGCs();
            if(gcs.length===0) {
                document.getElementById('gcDatabaseList').innerHTML = '<div class="empty-state" style="padding:40px"><h3>No GCs yet</h3><p>Add your first general contractor</p></div>';
                return;
            }
            document.getElementById('gcDatabaseList').innerHTML = gcs.map(gc=>{
                const winRate = gc.bids>0?Math.round(gc.wins/gc.bids*100):null;
                return `<div class="gc-item"><div class="gc-item-info"><div class="gc-item-name">${gc.name}</div><div class="gc-item-stats">${gc.bids||0} bids${winRate!==null?' ‚Ä¢ '+winRate+'% win rate':''}</div></div><div class="gc-item-rating">${[1,2,3,4,5].map(i=>`<span class="star ${i<=gc.rating?'filled':''}" onclick="rateGC('${gc.name.replace(/'/g,"\\'")}',${i})">‚òÖ</span>`).join('')}</div><button class="btn btn-sm btn-secondary" onclick="deleteGC('${gc.name.replace(/'/g,"\\'")}')" style="color:var(--danger);margin-left:12px">√ó</button></div>`;
            }).join('');
        }

        function showAddGCModal() {
            document.getElementById('newGCName').value = '';
            document.getElementById('newGCLocation').value = '';
            newGCRatingValue = 3;
            renderNewGCRating();
            openModal('addGCModal');
        }

        function renderNewGCRating() {
            document.getElementById('newGCRating').innerHTML = [1,2,3,4,5].map(i=>`<span class="star ${i<=newGCRatingValue?'filled':''}" onclick="setNewGCRating(${i})">‚òÖ</span>`).join('');
        }

        function setNewGCRating(r) { newGCRatingValue = r; renderNewGCRating(); }

        function saveNewGC() {
            const name = document.getElementById('newGCName').value.trim();
            const location = document.getElementById('newGCLocation').value.trim();
            if(!name) { alert('Please enter GC name'); return; }
            const fullName = location?`${name} - ${location}`:name;
            const gcs = getGCs();
            if(gcs.find(g=>g.name.toLowerCase()===fullName.toLowerCase())) { alert('GC already exists'); return; }
            gcs.push({name:fullName,rating:newGCRatingValue,bids:0,wins:0});
            saveGCsToStorage(gcs);
            closeModal('addGCModal');
            loadGCDatabase(); renderGCSelector();
        }

        function rateGC(name,rating) {
            const gcs = getGCs();
            const gc = gcs.find(g=>g.name===name);
            if(gc) { gc.rating = rating; saveGCsToStorage(gcs); loadGCDatabase(); }
        }

        function deleteGC(name) {
            if(!confirm('Delete '+name+'?')) return;
            const gcs = getGCs().filter(g=>g.name!==name);
            saveGCsToStorage(gcs);
            loadGCDatabase(); renderGCSelector();
        }

        // Keywords
        function loadKeywords() {
            const kw = getKeywords();
            document.getElementById('goodKeywordsList').innerHTML = kw.good.map(k=>`<span class="keyword-tag good">${k}<span style="margin-left:6px;cursor:pointer" onclick="removeKeyword('good','${k.replace(/'/g,"\\'")}')">√ó</span></span>`).join('');
            document.getElementById('badKeywordsList').innerHTML = kw.bad.map(k=>`<span class="keyword-tag bad">${k}<span style="margin-left:6px;cursor:pointer" onclick="removeKeyword('bad','${k.replace(/'/g,"\\'")}')">√ó</span></span>`).join('');
        }

        function addKeyword(type) {
            const input = document.getElementById(type+'KeywordInput');
            const val = input.value.trim().toLowerCase();
            if(!val) return;
            const kw = getKeywords();
            if(!kw[type].includes(val)) { kw[type].push(val); saveKeywordsToStorage(kw); }
            input.value = '';
            loadKeywords();
        }

        function removeKeyword(type,val) {
            const kw = getKeywords();
            kw[type] = kw[type].filter(k=>k!==val);
            saveKeywordsToStorage(kw);
            loadKeywords();
        }

        document.getElementById('goodKeywordInput').addEventListener('keypress',e=>{if(e.key==='Enter')addKeyword('good');});
        document.getElementById('badKeywordInput').addEventListener('keypress',e=>{if(e.key==='Enter')addKeyword('bad');});

        // Settings
        function loadSettings() {
            const s = getSettings();
            document.getElementById('settingCity').value = s.city;
            document.getElementById('settingState').value = s.state;
            document.getElementById('settingRadius').value = s.radius;
            document.getElementById('settingLocationMatters').checked = s.locationMatters;
            document.getElementById('settingRiskTolerance').value = s.riskTolerance;
            document.getElementById('settingCapacity').value = s.capacity;
            document.getElementById('settingDecisionTime').value = s.decisionTime;
            document.getElementById('settingGhostDays').value = s.ghostDays;
            document.getElementById('settingDefaultStars').value = s.defaultStars;
            document.getElementById('settingApiKey').value = s.apiKey;

            // Weights
            document.querySelector('#weightLocation input').value = s.weights.location;
            document.querySelector('#weightLocation .weight-slider-value').textContent = s.weights.location+'%';
            document.querySelector('#weightKeywords input').value = s.weights.keywords;
            document.querySelector('#weightKeywords .weight-slider-value').textContent = s.weights.keywords+'%';
            document.querySelector('#weightGC input').value = s.weights.gc;
            document.querySelector('#weightGC .weight-slider-value').textContent = s.weights.gc+'%';
            document.querySelector('#weightTrade input').value = s.weights.trade;
            document.querySelector('#weightTrade .weight-slider-value').textContent = s.weights.trade+'%';
            updateWeightTotal();

            // Trades
            const tradesHtml = Object.entries(CSI_DIVISIONS).map(([code,name])=>`<label class="checkbox-item ${s.trades.includes(code)?'selected':''}"><input type="checkbox" value="${code}" ${s.trades.includes(code)?'checked':''}>${code}: ${name}</label>`).join('');
            document.getElementById('tradesCheckboxes').innerHTML = tradesHtml;
            document.querySelectorAll('#tradesCheckboxes .checkbox-item').forEach(el=>{
                el.addEventListener('click',()=>{
                    const cb = el.querySelector('input');
                    cb.checked = !cb.checked;
                    el.classList.toggle('selected',cb.checked);
                });
            });
        }

        function updateWeightTotal() {
            const l = parseInt(document.querySelector('#weightLocation input').value);
            const k = parseInt(document.querySelector('#weightKeywords input').value);
            const g = parseInt(document.querySelector('#weightGC input').value);
            const t = parseInt(document.querySelector('#weightTrade input').value);
            const total = l+k+g+t;
            const el = document.getElementById('weightTotal');
            el.textContent = total+'%';
            el.style.color = total===100?'var(--success)':'var(--danger)';
        }

        document.querySelectorAll('.weight-slider input').forEach(input=>{
            input.addEventListener('input',()=>{
                input.parentElement.querySelector('.weight-slider-value').textContent = input.value+'%';
                updateWeightTotal();
            });
        });

        function saveSettings() {
            const s = {
                city: document.getElementById('settingCity').value.trim(),
                state: document.getElementById('settingState').value.trim(),
                radius: parseInt(document.getElementById('settingRadius').value),
                locationMatters: document.getElementById('settingLocationMatters').checked,
                riskTolerance: document.getElementById('settingRiskTolerance').value,
                capacity: document.getElementById('settingCapacity').value,
                decisionTime: parseInt(document.getElementById('settingDecisionTime').value)||45,
                ghostDays: parseInt(document.getElementById('settingGhostDays').value)||60,
                defaultStars: parseInt(document.getElementById('settingDefaultStars').value),
                apiKey: document.getElementById('settingApiKey').value.trim(),
                weights: {
                    location: parseInt(document.querySelector('#weightLocation input').value),
                    keywords: parseInt(document.querySelector('#weightKeywords input').value),
                    gc: parseInt(document.querySelector('#weightGC input').value),
                    trade: parseInt(document.querySelector('#weightTrade input').value)
                },
                trades: Array.from(document.querySelectorAll('#tradesCheckboxes input:checked')).map(cb=>cb.value)
            };
            const total = s.weights.location+s.weights.keywords+s.weights.gc+s.weights.trade;
            if(total!==100) { alert('Weights must total 100%. Currently: '+total+'%'); return; }
            saveSettingsToStorage(s);
            updateCapacityIndicator();
            alert('Settings saved!');
        }

        // Init
        function init() {
            loadSettings();
            loadKeywords();
            loadGCDatabase();
            loadDashboard();
            loadProjects();
            renderGCSelector();
        }
        init();
    </script>
</body>
</html>
