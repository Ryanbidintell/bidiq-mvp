<!DOCTYPE html>
<html>
<head>
    <title>BidIQ v2 - Bid Intelligence Platform</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1400px; margin: auto; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { color: #333; margin-top: 0; }
        h2 { color: #555; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
        h3 { color: #666; margin-top: 20px; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 12px 24px; background: #e0e0e0; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 16px; }
        .tab.active { background: #4CAF50; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        label { display: block; margin: 10px 0 5px; font-weight: bold; color: #555; }
        input[type="text"], input[type="number"], select, textarea {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;
        }
        textarea { min-height: 80px; }
        .hint { font-size: 12px; color: #888; margin-top: 3px; }
        
        button { background: #4CAF50; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin: 5px; }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .btn-secondary { background: #6c757d; }
        .btn-small { padding: 6px 12px; font-size: 12px; }
        .btn-danger { background: #dc3545; }
        .btn-info { background: #17a2b8; }
        
        .weight-row { display: flex; align-items: center; gap: 15px; margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .weight-label { width: 200px; font-weight: bold; }
        .weight-value { width: 60px; text-align: center; font-weight: bold; font-size: 18px; color: #4CAF50; }
        input[type="range"] { flex: 1; }
        
        .score-box { font-size: 48px; font-weight: bold; text-align: center; padding: 30px; border-radius: 8px; margin: 20px 0; }
        .score-go { background: #28a745; color: white; }
        .score-review { background: #ffc107; color: black; }
        .score-pass { background: #dc3545; color: white; }
        
        .reasoning-box { background: #fff; border: 2px solid #4CAF50; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .reasoning-section { margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; }
        .reasoning-good { border-left: 4px solid #28a745; }
        .reasoning-caution { border-left: 4px solid #ffc107; }
        .reasoning-bad { border-left: 4px solid #dc3545; }
        
        .capacity-banner { padding: 15px; border-radius: 8px; margin: 15px 0; font-weight: bold; }
        .capacity-hungry { background: #fff3cd; border: 1px solid #ffc107; }
        .capacity-maxed { background: #f8d7da; border: 1px solid #dc3545; }
        
        .details { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 20px; }
        
        .tag { display: inline-block; padding: 4px 10px; margin: 2px; border-radius: 15px; font-size: 12px; }
        .tag-good { background: #d4edda; color: #155724; }
        .tag-bad { background: #f8d7da; color: #721c24; }
        .tag-neutral { background: #e2e3e5; color: #383d41; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
        
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .dashboard-stat { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; cursor: pointer; }
        .dashboard-stat-number { font-size: 42px; font-weight: bold; color: #4CAF50; }
        .dashboard-stat-label { font-size: 14px; color: #666; margin-top: 5px; }
        
        .tooltip { position: relative; }
        .tooltip .tooltip-text { visibility: hidden; width: 250px; background: #333; color: white; padding: 10px; border-radius: 6px; font-size: 12px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -125px; }
        .tooltip:hover .tooltip-text { visibility: visible; }
        
        .projects-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .projects-table th, .projects-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        .projects-table th { background: #f8f9fa; font-weight: bold; }
        .projects-table tr:hover { background: #f5f5f5; }
        
        .score-badge { display: inline-block; padding: 4px 12px; border-radius: 15px; font-weight: bold; font-size: 14px; }
        .score-badge.go { background: #d4edda; color: #155724; }
        .score-badge.review { background: #fff3cd; color: #856404; }
        .score-badge.pass { background: #f8d7da; color: #721c24; }
        
        .outcome-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .outcome-badge.won { background: #28a745; color: white; }
        .outcome-badge.lost { background: #dc3545; color: white; }
        .outcome-badge.ghost { background: #6c757d; color: white; }
        .outcome-badge.didnt-bid { background: #17a2b8; color: white; }
        .outcome-badge.pending { background: #e0e0e0; color: #555; }
        
        .gc-selector { margin: 20px 0; padding: 20px; background: #e8f4fd; border-radius: 8px; }
        .gc-chip { display: inline-block; padding: 8px 15px; margin: 5px; background: #4CAF50; color: white; border-radius: 20px; font-size: 14px; }
        .gc-chip .remove { margin-left: 10px; cursor: pointer; font-weight: bold; }
        .gc-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 100; }
        .gc-suggestion { padding: 10px; cursor: pointer; }
        .gc-suggestion:hover { background: #f0f0f0; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; padding: 30px; border-radius: 8px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; }
        
        .progress-container { background: #e0e0e0; border-radius: 10px; height: 20px; margin: 10px 0; overflow: hidden; }
        .progress-bar { background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ BidIQ v2 - Bid Intelligence Platform</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('analyze')">üìÑ Analyze Bid</button>
            <button class="tab" onclick="showTab('projects')">üìÅ My Projects</button>
            <button class="tab" onclick="showTab('preferences')">‚öôÔ∏è Preferences</button>
            <button class="tab" onclick="showTab('keywords')">üîë Keywords</button>
            <button class="tab" onclick="showTab('gcs')">üè¢ GC Ratings</button>
        </div>
        
        <!-- DASHBOARD -->
        <div id="tab-dashboard" class="tab-content active">
            <h2>üìä Dashboard</h2>
            <div class="dashboard-stats">
                <div class="dashboard-stat"><div class="dashboard-stat-number" id="stat-total">0</div><div class="dashboard-stat-label">Total Bids</div></div>
                <div class="dashboard-stat tooltip"><div class="dashboard-stat-number" id="stat-winrate">--%</div><div class="dashboard-stat-label">Win Rate</div><span class="tooltip-text">Won √∑ (Won + Lost). Excludes pending, ghost, didn't bid.</span></div>
                <div class="dashboard-stat"><div class="dashboard-stat-number" id="stat-pending">0</div><div class="dashboard-stat-label">Pending</div></div>
                <div class="dashboard-stat tooltip"><div class="dashboard-stat-number" id="stat-hours">0</div><div class="dashboard-stat-label">Hours Saved</div><span class="tooltip-text" id="hours-tooltip">Total bids √ó avg decision time</span></div>
            </div>
            <div class="grid-2">
                <div class="details"><h3>üìà Recent Activity</h3><div id="recent-activity"><p style="color:#888;">No bids yet.</p></div></div>
                <div class="details"><h3>üèÜ Top GCs by Win Rate</h3><div id="top-gcs"><p style="color:#888;">Track outcomes to see stats.</p></div></div>
            </div>
            <div style="margin-top:20px;text-align:center;"><button onclick="showTab('analyze')" style="font-size:18px;padding:15px 40px;">üìÑ Analyze New Bid</button></div>
        </div>
        
        <!-- ANALYZE -->
        <div id="tab-analyze" class="tab-content">
            <h2>üìÑ Analyze Bid</h2>
            
            <div id="step1">
                <h3>Step 1: Upload Documents</h3>
                <input type="file" id="pdfFiles" accept=".pdf" multiple>
                <p class="hint">Select all bid documents (invite, specs, drawings).</p>
                <button onclick="goToStep2()">Next: Select GCs ‚Üí</button>
            </div>
            
            <div id="step2" style="display:none;">
                <h3>Step 2: Which GCs Are Bidding?</h3>
                <p>Select all GCs receiving bids. More GCs = more price pressure.</p>
                
                <div class="gc-selector">
                    <div id="selected-gcs"></div>
                    <div style="position:relative;margin-top:10px;">
                        <input type="text" id="gc-search" placeholder="Type GC name..." oninput="searchGCs()" onkeydown="if(event.key==='Enter')addSearchedGC()">
                        <div id="gc-suggestions" class="gc-suggestions" style="display:none;"></div>
                    </div>
                    <p class="hint" style="margin-top:15px;"><strong>Impact:</strong> 1-2 GCs: relationships matter | 3-5: moderate competition | 6+: price war (-10 to -15)</p>
                </div>
                
                <div id="new-gc-prompt" style="display:none;margin:20px 0;padding:15px;background:#fff3cd;border-radius:8px;">
                    <label>Rate new GC: <strong id="new-gc-name"></strong></label>
                    <select id="new-gc-rating-input"><option value="1">‚≠ê</option><option value="2">‚≠ê‚≠ê</option><option value="3" selected>‚≠ê‚≠ê‚≠ê</option><option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option><option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option></select>
                    <button onclick="confirmNewGC()">Add</button>
                </div>
                
                <button class="btn-secondary" onclick="goToStep1()">‚Üê Back</button>
                <button id="analyzeBtn" onclick="analyzeBid()">ü§ñ Analyze</button>
            </div>
            
            <div id="progress" style="display:none;">
                <div class="progress-container"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>
                <div id="progressText" style="text-align:center;">Starting...</div>
            </div>
            
            <div id="result"></div>
        </div>
        
        <!-- PROJECTS -->
        <div id="tab-projects" class="tab-content">
            <h2>üìÅ My Projects</h2>
            <select id="project-filter" onchange="renderProjects()"><option value="all">All</option><option value="pending">Pending</option><option value="won">Won</option><option value="lost">Lost</option><option value="ghost">Ghosted</option><option value="didnt_bid">Didn't Bid</option></select>
            <button class="btn-secondary btn-small" onclick="exportCSV()">üì• Export</button>
            <table class="projects-table"><thead><tr><th>Project</th><th>GCs</th><th>Score</th><th>Deadline</th><th>Outcome</th><th>Actions</th></tr></thead><tbody id="projects-tbody"><tr><td colspan="6" style="text-align:center;color:#888;">No projects.</td></tr></tbody></table>
        </div>
        
        <!-- PREFERENCES -->
        <div id="tab-preferences" class="tab-content">
            <h2>‚öôÔ∏è Preferences</h2>
            <div class="grid-2">
                <div><label>Office Location</label><input type="text" id="pref-location" placeholder="Kansas City, MO"></div>
                <div><label>Service Radius</label><select id="pref-radius"><option value="25">25 mi</option><option value="50" selected>50 mi</option><option value="100">100 mi</option><option value="150">150+ mi</option></select></div>
            </div>
            <div class="grid-2">
                <div><label>Location Matters?</label><select id="pref-location-matters"><option value="yes">Yes - score by distance</option><option value="no">No - I travel for work</option></select></div>
                <div><label>Avg Decision Time</label><select id="pref-decision-time"><option value="0.5">&lt;30 min</option><option value="0.75">30-60 min</option><option value="1.5" selected>1-2 hrs</option><option value="3">2-4 hrs</option><option value="5">4+ hrs</option></select></div>
            </div>
            <div class="grid-2">
                <div><label>Current Capacity</label><select id="pref-capacity"><option value="hungry">üü° Hungry</option><option value="steady" selected>üü¢ Steady</option><option value="maxed">üî¥ Maxed</option></select></div>
                <div><label>Risk Tolerance</label><select id="pref-risk"><option value="low">Conservative</option><option value="medium" selected>Moderate</option><option value="high">Aggressive</option></select></div>
            </div>
            <div class="grid-2">
                <div><label>Unknown GC Default</label><select id="pref-unknown-gc"><option value="2">2‚≠ê Skeptical</option><option value="3" selected>3‚≠ê Neutral</option><option value="4">4‚≠ê Optimistic</option></select></div>
                <div><label>Ghost Timeline (days)</label><input type="number" id="pref-ghost-days" value="60" min="14" max="180"></div>
            </div>
            <label>My Trades (CSI Divisions)</label>
            <div id="csi-boxes" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:5px;margin:10px 0;"></div>
            
            <h3>Score Weights (must = 100%)</h3>
            <div class="weight-row"><span class="weight-label">üìç Location</span><input type="range" id="w-location" min="0" max="60" value="25" oninput="updateWeights()"><span class="weight-value" id="w-location-val">25%</span></div>
            <div class="weight-row"><span class="weight-label">üîë Keywords</span><input type="range" id="w-keywords" min="0" max="60" value="30" oninput="updateWeights()"><span class="weight-value" id="w-keywords-val">30%</span></div>
            <div class="weight-row"><span class="weight-label">üè¢ GC & Competition</span><input type="range" id="w-gc" min="0" max="60" value="25" oninput="updateWeights()"><span class="weight-value" id="w-gc-val">25%</span></div>
            <div class="weight-row"><span class="weight-label">üîß Trade Match</span><input type="range" id="w-trade" min="0" max="60" value="20" oninput="updateWeights()"><span class="weight-value" id="w-trade-val">20%</span></div>
            <div class="weight-row" style="background:#e8f5e9;"><span class="weight-label"><strong>Total</strong></span><span style="flex:1"></span><span class="weight-value" id="w-total" style="font-size:24px;">100%</span></div>
            
            <button onclick="savePrefs()">üíæ Save</button><span id="save-msg" style="display:none;background:#28a745;color:white;padding:5px 10px;border-radius:4px;margin-left:10px;">‚úì Saved</span>
        </div>
        
        <!-- KEYWORDS -->
        <div id="tab-keywords" class="tab-content">
            <h2>üîë Keywords</h2>
            <div style="background:#f0fff4;border:1px solid #28a745;border-radius:8px;padding:20px;margin:20px 0;">
                <h3 style="margin-top:0;color:#28a745;">‚úÖ I WANT (one per line)</h3>
                <textarea id="kw-good" placeholder="design-assist&#10;repeat client&#10;BIM coordination"></textarea>
                <p class="hint">+8 points each</p>
            </div>
            <div style="background:#fff5f5;border:1px solid #dc3545;border-radius:8px;padding:20px;margin:20px 0;">
                <h3 style="margin-top:0;color:#dc3545;">üö© I DON'T WANT</h3>
                <textarea id="kw-bad" placeholder="pay if paid&#10;liquidated damages&#10;no damages for delay"></textarea>
                <p class="hint">-5 to -15 each (per risk tolerance)</p>
            </div>
            <div style="background:#fff8e6;border:1px solid #ffc107;border-radius:8px;padding:20px;margin:20px 0;">
                <h3 style="margin-top:0;color:#856404;">‚ö†Ô∏è MUST HAVE (deal-breakers)</h3>
                <textarea id="kw-must" placeholder="owner-furnished"></textarea>
                <p class="hint">-25 if NOT found</p>
            </div>
            <button onclick="saveKeywords()">üíæ Save</button>
        </div>
        
        <!-- GC RATINGS -->
        <div id="tab-gcs" class="tab-content">
            <h2>üè¢ GC Ratings</h2>
            <p>Format: "Company Name - City" for multi-office GCs.</p>
            <div id="gc-list"></div>
            <div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap;">
                <input type="text" id="add-gc-name" placeholder="Turner Construction - Kansas City" style="flex:1;min-width:250px;">
                <select id="add-gc-rating" style="width:150px;"><option value="1">‚≠ê</option><option value="2">‚≠ê‚≠ê</option><option value="3" selected>‚≠ê‚≠ê‚≠ê</option><option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option><option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option></select>
                <button onclick="addGC()">+ Add</button>
            </div>
        </div>
    </div>
    
    <!-- MODALS -->
    <div class="modal-overlay" id="report-modal"><div class="modal"><div id="report-content"></div><button onclick="closeModal('report-modal')">Close</button></div></div>
    <div class="modal-overlay" id="outcome-modal"><div class="modal">
        <h2>üìù Record Outcome</h2>
        <input type="hidden" id="outcome-pid">
        <p><strong id="outcome-pname"></strong></p>
        <label>Outcome</label>
        <select id="outcome-type" onchange="toggleOutcomeFields()"><option value="">--Select--</option><option value="won">üèÜ Won</option><option value="lost">‚ùå Lost</option><option value="ghost">üëª Ghosted</option><option value="didnt_bid">üö´ Didn't Bid</option></select>
        <div id="won-fields" style="display:none;"><label>Contract Amount ($)</label><input type="number" id="won-amount"><label>Margin (%)</label><input type="number" id="won-margin" step="0.1"><label>Alternates</label><textarea id="won-alternates"></textarea></div>
        <div id="lost-fields" style="display:none;"><label>How high?</label><select id="lost-how-high"><option value="">--</option><option value="within-5">Within 5%</option><option value="5-10">5-10%</option><option value="10-15">10-15%</option><option value="15-20">15-20%</option><option value="20-plus">20%+</option><option value="unknown">Unknown</option></select><label>Winner</label><input type="text" id="lost-winner"><label>Feedback</label><textarea id="lost-feedback"></textarea></div>
        <div id="didnt-fields" style="display:none;"><label>Reasons:</label><div style="display:grid;gap:5px;"><label style="font-weight:normal;"><input type="checkbox" class="didnt-reason" value="busy">Too busy</label><label style="font-weight:normal;"><input type="checkbox" class="didnt-reason" value="size">Wrong size</label><label style="font-weight:normal;"><input type="checkbox" class="didnt-reason" value="location">Wrong location</label><label style="font-weight:normal;"><input type="checkbox" class="didnt-reason" value="gc">Bad GC</label><label style="font-weight:normal;"><input type="checkbox" class="didnt-reason" value="schedule">Schedule</label><label style="font-weight:normal;"><input type="checkbox" class="didnt-reason" value="terms">Contract terms</label><label style="font-weight:normal;"><input type="checkbox" class="didnt-reason" value="scope">Not our scope</label></div></div>
        <div style="margin-top:20px;"><button onclick="saveOutcome()">üíæ Save</button><button class="btn-secondary" onclick="closeModal('outcome-modal')">Cancel</button></div>
    </div></div>
    <div class="modal-overlay" id="submit-modal"><div class="modal">
        <h2>üì§ Record Submission</h2>
        <input type="hidden" id="submit-pid">
        <p><strong id="submit-pname"></strong></p>
        <label>Bid Amount ($)</label><input type="number" id="submit-amount">
        <label>Internal Estimator (optional)</label><input type="text" id="submit-estimator">
        <label>Notes</label><textarea id="submit-notes"></textarea>
        <div style="margin-top:20px;"><button onclick="saveSubmission()">üíæ Save</button><button class="btn-secondary" onclick="closeModal('submit-modal')">Cancel</button></div>
    </div></div>
    <div class="modal-overlay" id="gc-detail-modal"><div class="modal"><h2>üè¢ <span id="gc-detail-name"></span></h2><div id="gc-detail-content"></div><button onclick="closeModal('gc-detail-modal')">Close</button></div></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const API_KEY = "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";
        
        const CSI = [{n:1,t:"General"},{n:2,t:"Existing"},{n:3,t:"Concrete"},{n:4,t:"Masonry"},{n:5,t:"Metals"},{n:6,t:"Wood"},{n:7,t:"Thermal"},{n:8,t:"Openings"},{n:9,t:"Finishes"},{n:10,t:"Specialties"},{n:11,t:"Equipment"},{n:12,t:"Furnishings"},{n:21,t:"Fire Suppression"},{n:22,t:"Plumbing"},{n:23,t:"HVAC"},{n:25,t:"Automation"},{n:26,t:"Electrical"},{n:27,t:"Communications"},{n:28,t:"Security"}];
        
        let selectedGCs = [];
        let pendingGC = null;
        
        // Storage
        const getProjects = () => JSON.parse(localStorage.getItem('bidiq_projects') || '[]');
        const getGCs = () => JSON.parse(localStorage.getItem('bidiq_gcs') || '[]');
        const getPrefs = () => JSON.parse(localStorage.getItem('bidiq_prefs') || '{}');
        const getKW = () => JSON.parse(localStorage.getItem('bidiq_kw') || '{}');
        
        // Tab navigation
        function showTab(name) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + name).classList.add('active');
            document.querySelector(`.tab[onclick="showTab('${name}')"]`).classList.add('active');
            if (name === 'dashboard') updateDashboard();
            if (name === 'projects') renderProjects();
            if (name === 'gcs') loadGCs();
        }
        
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        // Dashboard
        function updateDashboard() {
            const P = getProjects(), prefs = getPrefs();
            const total = P.length;
            const won = P.filter(p => p.outcome === 'won').length;
            const lost = P.filter(p => p.outcome === 'lost').length;
            const pending = P.filter(p => !p.outcome).length;
            const winrate = (won + lost) > 0 ? Math.round((won / (won + lost)) * 100) : '--';
            const avgTime = parseFloat(prefs.decisionTime) || 1.5;
            const hours = Math.round(total * avgTime);
            
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-winrate').textContent = winrate + '%';
            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-hours').textContent = hours;
            document.getElementById('hours-tooltip').textContent = `${total} bids √ó ${avgTime} hrs = ${hours} hrs saved`;
            
            // Recent
            document.getElementById('recent-activity').innerHTML = P.slice(0, 5).length > 0
                ? P.slice(0, 5).map(p => `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;"><span>${p.projectName || 'Unknown'}</span><span class="score-badge ${(p.rec || 'review').toLowerCase()}">${p.score || '--'}</span></div>`).join('')
                : '<p style="color:#888;">No bids yet.</p>';
            
            // Top GCs
            const gcStats = {};
            P.filter(p => p.outcome && p.gcs).forEach(p => {
                p.gcs.forEach(g => {
                    if (!gcStats[g]) gcStats[g] = { w: 0, t: 0 };
                    gcStats[g].t++;
                    if (p.outcome === 'won') gcStats[g].w++;
                });
            });
            const topGCs = Object.entries(gcStats).map(([n, s]) => ({ n, wr: s.t > 0 ? Math.round((s.w / s.t) * 100) : 0, t: s.t })).filter(g => g.t >= 1).sort((a, b) => b.wr - a.wr).slice(0, 5);
            document.getElementById('top-gcs').innerHTML = topGCs.length > 0
                ? topGCs.map(g => `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;cursor:pointer;" onclick="showGCDetail('${g.n}')">${g.n} <span>${g.wr}% (${g.t})</span></div>`).join('')
                : '<p style="color:#888;">Track outcomes to see stats.</p>';
        }
        
        function showGCDetail(name) {
            const P = getProjects().filter(p => p.gcs?.includes(name));
            const gc = getGCs().find(g => g.name === name);
            const w = P.filter(p => p.outcome === 'won').length, l = P.filter(p => p.outcome === 'lost').length;
            document.getElementById('gc-detail-name').textContent = name;
            document.getElementById('gc-detail-content').innerHTML = `
                <p><strong>Rating:</strong> ${'‚≠ê'.repeat(gc?.rating || 3)}</p>
                <p><strong>Bids:</strong> ${P.length} | <strong>Won:</strong> ${w} | <strong>Lost:</strong> ${l}</p>
                <p><strong>Win Rate:</strong> ${(w + l) > 0 ? Math.round((w / (w + l)) * 100) : '--'}%</p>
                <h4>Recent:</h4>${P.slice(0, 5).map(p => `<div style="padding:5px 0;">${p.projectName} - ${p.outcome || 'pending'}</div>`).join('')}
            `;
            document.getElementById('gc-detail-modal').classList.add('active');
        }
        
        // Analyze steps
        function goToStep1() { document.getElementById('step1').style.display = 'block'; document.getElementById('step2').style.display = 'none'; }
        function goToStep2() {
            if (document.getElementById('pdfFiles').files.length === 0) return alert('Select PDF files first.');
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
            selectedGCs = [];
            renderSelectedGCs();
        }
        
        // GC selection
        function searchGCs() {
            const q = document.getElementById('gc-search').value.toLowerCase();
            const sug = document.getElementById('gc-suggestions');
            if (q.length < 2) { sug.style.display = 'none'; return; }
            const gcs = getGCs();
            const matches = gcs.filter(g => g.name.toLowerCase().includes(q) && !selectedGCs.includes(g.name)).slice(0, 5);
            const addNew = !gcs.some(g => g.name.toLowerCase() === q);
            sug.innerHTML = matches.map(g => `<div class="gc-suggestion" onclick="selectGC('${g.name}')">${g.name} ${'‚≠ê'.repeat(g.rating)}</div>`).join('') +
                (addNew && q.length > 2 ? `<div class="gc-suggestion" style="background:#fff3cd;" onclick="promptNewGC('${document.getElementById('gc-search').value}')">+ Add: "${document.getElementById('gc-search').value}"</div>` : '');
            sug.style.display = (matches.length > 0 || addNew) ? 'block' : 'none';
        }
        
        function addSearchedGC() {
            const q = document.getElementById('gc-search').value;
            const gcs = getGCs();
            const exact = gcs.find(g => g.name.toLowerCase() === q.toLowerCase());
            if (exact) selectGC(exact.name);
            else if (q.length > 2) promptNewGC(q);
        }
        
        function selectGC(name) {
            if (!selectedGCs.includes(name)) { selectedGCs.push(name); renderSelectedGCs(); }
            document.getElementById('gc-search').value = '';
            document.getElementById('gc-suggestions').style.display = 'none';
        }
        
        function removeGC(name) { selectedGCs = selectedGCs.filter(g => g !== name); renderSelectedGCs(); }
        
        function renderSelectedGCs() {
            document.getElementById('selected-gcs').innerHTML = selectedGCs.length > 0
                ? selectedGCs.map(n => `<span class="gc-chip">${n}<span class="remove" onclick="removeGC('${n}')">√ó</span></span>`).join('')
                : '<p style="color:#888;margin:10px 0;">No GCs selected. Search above.</p>';
        }
        
        function promptNewGC(name) {
            pendingGC = name;
            document.getElementById('new-gc-name').textContent = name;
            document.getElementById('new-gc-prompt').style.display = 'block';
            document.getElementById('gc-suggestions').style.display = 'none';
        }
        
        function confirmNewGC() {
            if (!pendingGC) return;
            const rating = parseInt(document.getElementById('new-gc-rating-input').value);
            const gcs = getGCs();
            gcs.push({ name: pendingGC, rating });
            localStorage.setItem('bidiq_gcs', JSON.stringify(gcs));
            selectGC(pendingGC);
            pendingGC = null;
            document.getElementById('new-gc-prompt').style.display = 'none';
            document.getElementById('gc-search').value = '';
        }
        
        // Main analyze
        async function analyzeBid() {
            if (selectedGCs.length === 0) return alert('Select at least one GC.');
            const files = document.getElementById('pdfFiles').files;
            const prog = document.getElementById('progress');
            const bar = document.getElementById('progressBar');
            const txt = document.getElementById('progressText');
            
            prog.style.display = 'block';
            document.getElementById('analyzeBtn').disabled = true;
            
            try {
                txt.textContent = 'Extracting text...'; bar.style.width = '20%';
                let allText = '';
                for (const file of files) {
                    const r = await extractPDF(file);
                    allText += r + '\n';
                }
                
                txt.textContent = 'AI analyzing...'; bar.style.width = '50%';
                const ext = await callClaude(allText.substring(0, 50000));
                
                txt.textContent = 'Searching keywords...'; bar.style.width = '70%';
                const kw = getKW();
                const kwRes = searchKW(allText, kw);
                
                txt.textContent = 'Calculating score...'; bar.style.width = '85%';
                const prefs = getPrefs();
                const gcsData = getGCs();
                
                let dist = null;
                if (prefs.location && ext.city && ext.state) {
                    const uc = await geocode(prefs.location);
                    const pc = await geocode(`${ext.city}, ${ext.state}`);
                    if (uc && pc) dist = haversine(uc.lat, uc.lon, pc.lat, pc.lon);
                }
                
                const score = calcScore(ext, kwRes, dist, selectedGCs, prefs, gcsData);
                
                const project = {
                    id: Date.now().toString(),
                    createdAt: new Date().toISOString(),
                    projectName: ext.name,
                    projectCity: ext.city,
                    projectState: ext.state,
                    bidDeadline: ext.deadline,
                    gcs: [...selectedGCs],
                    gcCount: selectedGCs.length,
                    score: score.final,
                    rec: score.rec,
                    capacityNote: score.capacityNote,
                    components: score.components,
                    kwRes,
                    dist,
                    contractFound: ext.contractFound,
                    divisions: ext.divisions
                };
                
                const P = getProjects();
                P.unshift(project);
                localStorage.setItem('bidiq_projects', JSON.stringify(P));
                
                bar.style.width = '100%'; txt.textContent = 'Done!';
                displayResult(project);
                
            } catch (e) {
                console.error(e);
                document.getElementById('result').innerHTML = `<div style="background:#f8d7da;color:#721c24;padding:15px;border-radius:8px;">Error: ${e.message}</div>`;
            } finally {
                document.getElementById('analyzeBtn').disabled = false;
            }
        }
        
        async function extractPDF(file) {
            const ab = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: ab }).promise;
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(it => it.str).join(' ') + '\n';
            }
            return text;
        }
        
        async function callClaude(text) {
            const res = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-api-key': API_KEY, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1000,
                    messages: [{ role: 'user', content: `Extract info. Return ONLY JSON:\n{"name":"project name","city":"city","state":"XX","deadline":"date or null","divisions":[numbers],"contractFound":true/false}\n\nText:\n${text}` }]
                })
            });
            if (!res.ok) throw new Error('API failed');
            const data = await res.json();
            const m = data.content[0].text.match(/\{[\s\S]*\}/);
            return m ? JSON.parse(m[0]) : {};
        }
        
        function searchKW(text, kw) {
            const lower = text.toLowerCase();
            const good = (kw.good || []).filter(k => lower.includes(k.toLowerCase()));
            const bad = (kw.bad || []).filter(k => lower.includes(k.toLowerCase()));
            const must = (kw.must || []).filter(k => lower.includes(k.toLowerCase()));
            const mustMissing = (kw.must || []).filter(k => !lower.includes(k.toLowerCase()));
            return { good, bad, must, mustMissing };
        }
        
        async function geocode(loc) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(loc)}&limit=1&countrycodes=us`, { headers: { 'User-Agent': 'BidIQ/2.0' } });
                const data = await res.json();
                return data[0] ? { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) } : null;
            } catch { return null; }
        }
        
        function haversine(lat1, lon1, lat2, lon2) {
            const R = 3959;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
            return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }
        
        function calcScore(ext, kwRes, dist, selGCs, prefs, gcsData) {
            let w = { loc: parseInt(prefs.wLoc) || 25, kw: parseInt(prefs.wKw) || 30, gc: parseInt(prefs.wGc) || 25, tr: parseInt(prefs.wTr) || 20 };
            const locMatters = prefs.locationMatters !== 'no';
            if (!locMatters) { const ex = w.loc; w.loc = 0; w.kw += Math.round(ex * 0.4); w.gc += Math.round(ex * 0.4); w.tr += Math.round(ex * 0.2); }
            
            // Location
            let locScore = 50, locDetail = '';
            if (locMatters && dist !== null) {
                const rad = parseInt(prefs.radius) || 50;
                if (dist <= 25) locScore = 100;
                else if (dist <= 50) locScore = 85;
                else if (dist <= 100) locScore = 70;
                else if (dist <= 150) locScore = 50;
                else locScore = 30;
                if (dist > rad) locScore = Math.max(0, locScore - 20);
                locDetail = `${dist} miles from office. ${dist <= rad ? 'Within' : 'Outside'} ${rad}-mile radius.`;
            } else if (!locMatters) {
                locScore = 0;
                locDetail = 'Location disabled - you travel for work.';
            } else {
                locDetail = 'Could not determine location.';
            }
            
            // Keywords
            let kwScore = 50;
            const riskPen = prefs.risk === 'low' ? 15 : prefs.risk === 'high' ? 5 : 10;
            kwScore += kwRes.good.length * 8;
            let kwDetail = `Found ${kwRes.good.length} preferred terms (+${kwRes.good.length * 8}). `;
            if (ext.contractFound) {
                kwScore -= kwRes.bad.length * riskPen;
                if (kwRes.bad.length > 0) kwDetail += `${kwRes.bad.length} risk terms (-${kwRes.bad.length * riskPen}). Contract in docs.`;
            } else {
                kwDetail += 'Contract not in docs - review if awarded.';
            }
            kwScore -= kwRes.mustMissing.length * 25;
            if (kwRes.mustMissing.length > 0) kwDetail += ` Missing: ${kwRes.mustMissing.join(', ')} (-${kwRes.mustMissing.length * 25}).`;
            kwScore = Math.max(0, Math.min(100, kwScore));
            
            // GC + Competition
            const P = getProjects();
            let gcScore = 50, totalW = 0, weightedSum = 0;
            const gcDetails = [];
            selGCs.forEach(gn => {
                const gcRec = gcsData.find(g => g.name === gn);
                const gcProj = P.filter(p => p.gcs?.includes(gn) && p.outcome);
                const wins = gcProj.filter(p => p.outcome === 'won').length;
                const losses = gcProj.filter(p => p.outcome === 'lost').length;
                const bids = wins + losses;
                if (bids > 0) {
                    const wr = (wins / bids) * 100;
                    weightedSum += wr * bids;
                    totalW += bids;
                    gcDetails.push(`${gn}: ${Math.round(wr)}% (${bids})`);
                } else {
                    const rating = gcRec?.rating || parseInt(prefs.unknownGC) || 3;
                    weightedSum += rating * 20;
                    totalW += 1;
                    gcDetails.push(`${gn}: ${'‚≠ê'.repeat(rating)} (new)`);
                }
            });
            gcScore = totalW > 0 ? Math.round(weightedSum / totalW) : 50;
            
            let compPen = 0, compNote = '';
            if (selGCs.length <= 2) { compNote = 'Low competition.'; }
            else if (selGCs.length <= 5) { compPen = 5; compNote = 'Moderate competition (-5).'; }
            else if (selGCs.length <= 10) { compPen = 10; compNote = 'High competition (-10).'; }
            else { compPen = 15; compNote = 'Commodity bid (-15).'; }
            gcScore = Math.max(0, gcScore - compPen);
            const gcDetail = `${selGCs.length} GCs. ${compNote} Best: ${gcDetails[0] || 'N/A'}`;
            
            // Trade
            let trScore = 50, trDetail = '';
            const userDiv = prefs.divisions || [];
            const foundDiv = ext.divisions || [];
            if (userDiv.length > 0 && foundDiv.length > 0) {
                const matches = userDiv.filter(d => foundDiv.includes(d));
                trScore = Math.round((matches.length / userDiv.length) * 100);
                trDetail = `Found ${matches.length}/${userDiv.length} of your divisions.`;
            } else {
                trDetail = 'Could not verify divisions.';
            }
            
            // Final
            const final = Math.round((locScore * w.loc / 100) + (kwScore * w.kw / 100) + (gcScore * w.gc / 100) + (trScore * w.tr / 100));
            let rec = final >= 80 ? 'GO' : final >= 60 ? 'REVIEW' : 'PASS';
            const cap = prefs.capacity || 'steady';
            let capNote = '';
            if (cap === 'hungry') {
                if (rec === 'REVIEW') capNote = "You need work - consider pursuing.";
                else if (rec === 'PASS') capNote = "Even hungry, this isn't a fit.";
            } else if (cap === 'maxed') {
                if (rec === 'GO') capNote = "Strong fit, but you're at capacity.";
                else if (rec === 'REVIEW') capNote = "You're busy - probably pass.";
            }
            
            return {
                final,
                rec,
                capacityNote: capNote,
                components: {
                    loc: { score: locScore, weight: w.loc, detail: locDetail },
                    kw: { score: kwScore, weight: w.kw, detail: kwDetail },
                    gc: { score: gcScore, weight: w.gc, detail: gcDetail },
                    tr: { score: trScore, weight: w.tr, detail: trDetail }
                }
            };
        }
        
        function displayResult(p) {
            const scoreClass = p.rec === 'GO' ? 'score-go' : p.rec === 'PASS' ? 'score-pass' : 'score-review';
            const getR = s => s >= 70 ? 'reasoning-good' : s >= 40 ? 'reasoning-caution' : 'reasoning-bad';
            const prefs = getPrefs();
            let capBanner = '';
            if (p.capacityNote) {
                const capClass = prefs.capacity === 'hungry' ? 'capacity-hungry' : 'capacity-maxed';
                capBanner = `<div class="capacity-banner ${capClass}">üí° ${p.capacityNote}</div>`;
            }
            
            document.getElementById('result').innerHTML = `
                <div style="border:1px solid #ddd;border-radius:8px;padding:30px;margin:20px 0;">
                    <div style="text-align:center;border-bottom:2px solid #4CAF50;padding-bottom:20px;">
                        <h2>${p.projectName || 'Unknown Project'}</h2>
                        <p>${p.projectCity || '?'}, ${p.projectState || '?'} | ${p.gcCount} GC(s)</p>
                    </div>
                    <div class="score-box ${scoreClass}">${p.score}/100 - ${p.rec}</div>
                    ${capBanner}
                    <div class="reasoning-box">
                        <h3>üìã Why This Score</h3>
                        <div class="reasoning-section ${getR(p.components.loc.score)}"><strong>üìç Location: ${p.components.loc.score}/100</strong><p>${p.components.loc.detail}</p></div>
                        <div class="reasoning-section ${getR(p.components.kw.score)}"><strong>üîë Keywords: ${p.components.kw.score}/100</strong><p>${p.components.kw.detail}</p>
                            <div style="margin-top:10px;">${p.kwRes.good.map(k => `<span class="tag tag-good">‚úì ${k}</span>`).join('')}${p.kwRes.bad.map(k => `<span class="tag tag-bad">‚úó ${k}</span>`).join('')}${p.kwRes.mustMissing.map(k => `<span class="tag tag-bad">Missing: ${k}</span>`).join('')}</div>
                        </div>
                        <div class="reasoning-section ${getR(p.components.gc.score)}"><strong>üè¢ GC & Competition: ${p.components.gc.score}/100</strong><p>${p.components.gc.detail}</p>
                            <div style="margin-top:10px;">${p.gcs.map(g => `<span class="tag tag-neutral">${g}</span>`).join('')}</div>
                        </div>
                        <div class="reasoning-section ${getR(p.components.tr.score)}"><strong>üîß Trade Match: ${p.components.tr.score}/100</strong><p>${p.components.tr.detail}</p></div>
                    </div>
                    <div style="text-align:center;margin-top:20px;">
                        <button onclick="showTab('projects')">üìÅ View Projects</button>
                        <button class="btn-secondary" onclick="resetAnalyze()">Analyze Another</button>
                    </div>
                </div>
            `;
        }
        
        function resetAnalyze() {
            document.getElementById('pdfFiles').value = '';
            document.getElementById('result').innerHTML = '';
            document.getElementById('progress').style.display = 'none';
            selectedGCs = [];
            renderSelectedGCs();
            goToStep1();
        }
        
        // Projects
        function renderProjects() {
            const P = getProjects();
            const filter = document.getElementById('project-filter').value;
            const filtered = filter === 'all' ? P : P.filter(p => filter === 'pending' ? !p.outcome : p.outcome === filter);
            
            if (filtered.length === 0) {
                document.getElementById('projects-tbody').innerHTML = '<tr><td colspan="6" style="text-align:center;color:#888;">No projects.</td></tr>';
                return;
            }
            
            document.getElementById('projects-tbody').innerHTML = filtered.map(p => {
                const sc = (p.rec || 'review').toLowerCase();
                const oc = p.outcome ? p.outcome.replace('_', '-') : 'pending';
                const ot = p.outcome ? p.outcome.replace('_', ' ') : 'Pending';
                return `<tr>
                    <td><strong>${p.projectName || 'Unknown'}</strong><br><small>${p.projectCity || '?'}, ${p.projectState || '?'}</small></td>
                    <td>${p.gcCount || '?'} GCs</td>
                    <td><span class="score-badge ${sc}">${p.score || '--'}</span></td>
                    <td>${p.bidDeadline || '-'}</td>
                    <td><span class="outcome-badge ${oc}">${ot}</span></td>
                    <td>
                        <button class="btn-small btn-info" onclick="viewReport('${p.id}')">üìã</button>
                        ${!p.submission ? `<button class="btn-small" onclick="openSubmit('${p.id}')">üì§</button>` : ''}
                        ${!p.outcome ? `<button class="btn-small btn-secondary" onclick="openOutcome('${p.id}')">üìù</button>` : ''}
                        <button class="btn-small btn-danger" onclick="deleteProject('${p.id}')">üóë</button>
                    </td>
                </tr>`;
            }).join('');
        }
        
        function viewReport(id) {
            const p = getProjects().find(x => x.id === id);
            if (!p) return;
            const scoreClass = (p.rec || 'review').toLowerCase();
            const getR = s => s >= 70 ? 'reasoning-good' : s >= 40 ? 'reasoning-caution' : 'reasoning-bad';
            
            document.getElementById('report-content').innerHTML = `
                <div style="text-align:center;border-bottom:2px solid #4CAF50;padding-bottom:15px;margin-bottom:15px;">
                    <h2>${p.projectName || 'Unknown'}</h2>
                    <p>${p.projectCity || '?'}, ${p.projectState || '?'}</p>
                </div>
                <div class="score-box score-${scoreClass}" style="padding:20px;">${p.score}/100 - ${p.rec}</div>
                ${p.capacityNote ? `<div class="capacity-banner capacity-${getPrefs().capacity === 'hungry' ? 'hungry' : 'maxed'}">üí° ${p.capacityNote}</div>` : ''}
                <div class="reasoning-section ${getR(p.components?.loc?.score || 50)}"><strong>üìç Location: ${p.components?.loc?.score || '--'}/100</strong><p>${p.components?.loc?.detail || ''}</p></div>
                <div class="reasoning-section ${getR(p.components?.kw?.score || 50)}"><strong>üîë Keywords: ${p.components?.kw?.score || '--'}/100</strong><p>${p.components?.kw?.detail || ''}</p></div>
                <div class="reasoning-section ${getR(p.components?.gc?.score || 50)}"><strong>üè¢ GC: ${p.components?.gc?.score || '--'}/100</strong><p>${p.components?.gc?.detail || ''}</p></div>
                <div class="reasoning-section ${getR(p.components?.tr?.score || 50)}"><strong>üîß Trade: ${p.components?.tr?.score || '--'}/100</strong><p>${p.components?.tr?.detail || ''}</p></div>
            `;
            document.getElementById('report-modal').classList.add('active');
        }
        
        function deleteProject(id) {
            if (!confirm('Delete?')) return;
            const P = getProjects().filter(p => p.id !== id);
            localStorage.setItem('bidiq_projects', JSON.stringify(P));
            renderProjects();
            updateDashboard();
        }
        
        function openOutcome(id) {
            const p = getProjects().find(x => x.id === id);
            document.getElementById('outcome-pid').value = id;
            document.getElementById('outcome-pname').textContent = p?.projectName || 'Unknown';
            document.getElementById('outcome-type').value = '';
            toggleOutcomeFields();
            document.getElementById('outcome-modal').classList.add('active');
        }
        
        function toggleOutcomeFields() {
            const t = document.getElementById('outcome-type').value;
            document.getElementById('won-fields').style.display = t === 'won' ? 'block' : 'none';
            document.getElementById('lost-fields').style.display = t === 'lost' ? 'block' : 'none';
            document.getElementById('didnt-fields').style.display = t === 'didnt_bid' ? 'block' : 'none';
        }
        
        function saveOutcome() {
            const id = document.getElementById('outcome-pid').value;
            const t = document.getElementById('outcome-type').value;
            if (!t) return alert('Select outcome.');
            
            const P = getProjects();
            const idx = P.findIndex(p => p.id === id);
            if (idx === -1) return;
            
            P[idx].outcome = t;
            P[idx].outcomeDate = new Date().toISOString();
            
            if (t === 'won') {
                P[idx].contractAmount = document.getElementById('won-amount').value || null;
                P[idx].margin = document.getElementById('won-margin').value || null;
                P[idx].alternates = document.getElementById('won-alternates').value || null;
            } else if (t === 'lost') {
                P[idx].howHigh = document.getElementById('lost-how-high').value || null;
                P[idx].winner = document.getElementById('lost-winner').value || null;
                P[idx].feedback = document.getElementById('lost-feedback').value || null;
            } else if (t === 'didnt_bid') {
                P[idx].didntReasons = Array.from(document.querySelectorAll('.didnt-reason:checked')).map(cb => cb.value);
            }
            
            localStorage.setItem('bidiq_projects', JSON.stringify(P));
            closeModal('outcome-modal');
            renderProjects();
            updateDashboard();
        }
        
        function openSubmit(id) {
            const p = getProjects().find(x => x.id === id);
            document.getElementById('submit-pid').value = id;
            document.getElementById('submit-pname').textContent = p?.projectName || 'Unknown';
            document.getElementById('submit-modal').classList.add('active');
        }
        
        function saveSubmission() {
            const id = document.getElementById('submit-pid').value;
            const P = getProjects();
            const idx = P.findIndex(p => p.id === id);
            if (idx === -1) return;
            
            P[idx].submission = {
                amount: document.getElementById('submit-amount').value || null,
                estimator: document.getElementById('submit-estimator').value || null,
                notes: document.getElementById('submit-notes').value || null,
                date: new Date().toISOString()
            };
            
            localStorage.setItem('bidiq_projects', JSON.stringify(P));
            closeModal('submit-modal');
            renderProjects();
        }
        
        function exportCSV() {
            const P = getProjects();
            if (P.length === 0) return alert('No projects.');
            const headers = ['Project', 'City', 'State', 'GCs', 'Score', 'Recommendation', 'Deadline', 'Outcome', 'Bid Amount', 'Margin'];
            const rows = P.map(p => [p.projectName, p.projectCity, p.projectState, p.gcCount, p.score, p.rec, p.bidDeadline, p.outcome, p.submission?.amount, p.margin].map(v => `"${v || ''}"`).join(','));
            const csv = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'bidiq_projects.csv';
            a.click();
        }
        
        // Preferences
        function updateWeights() {
            const l = parseInt(document.getElementById('w-location').value);
            const k = parseInt(document.getElementById('w-keywords').value);
            const g = parseInt(document.getElementById('w-gc').value);
            const t = parseInt(document.getElementById('w-trade').value);
            document.getElementById('w-location-val').textContent = l + '%';
            document.getElementById('w-keywords-val').textContent = k + '%';
            document.getElementById('w-gc-val').textContent = g + '%';
            document.getElementById('w-trade-val').textContent = t + '%';
            const total = l + k + g + t;
            document.getElementById('w-total').textContent = total + '%';
            document.getElementById('w-total').style.color = total === 100 ? '#28a745' : '#dc3545';
        }
        
        function savePrefs() {
            const total = parseInt(document.getElementById('w-location').value) + parseInt(document.getElementById('w-keywords').value) + parseInt(document.getElementById('w-gc').value) + parseInt(document.getElementById('w-trade').value);
            if (total !== 100) return alert('Weights must = 100%');
            
            const divs = [];
            document.querySelectorAll('.csi-cb:checked').forEach(cb => divs.push(parseInt(cb.value)));
            
            const prefs = {
                location: document.getElementById('pref-location').value,
                radius: document.getElementById('pref-radius').value,
                locationMatters: document.getElementById('pref-location-matters').value,
                decisionTime: document.getElementById('pref-decision-time').value,
                capacity: document.getElementById('pref-capacity').value,
                risk: document.getElementById('pref-risk').value,
                unknownGC: document.getElementById('pref-unknown-gc').value,
                ghostDays: document.getElementById('pref-ghost-days').value,
                divisions: divs,
                wLoc: document.getElementById('w-location').value,
                wKw: document.getElementById('w-keywords').value,
                wGc: document.getElementById('w-gc').value,
                wTr: document.getElementById('w-trade').value
            };
            localStorage.setItem('bidiq_prefs', JSON.stringify(prefs));
            document.getElementById('save-msg').style.display = 'inline';
            setTimeout(() => document.getElementById('save-msg').style.display = 'none', 2000);
        }
        
        function loadPrefs() {
            const p = getPrefs();
            if (p.location) document.getElementById('pref-location').value = p.location;
            if (p.radius) document.getElementById('pref-radius').value = p.radius;
            if (p.locationMatters) document.getElementById('pref-location-matters').value = p.locationMatters;
            if (p.decisionTime) document.getElementById('pref-decision-time').value = p.decisionTime;
            if (p.capacity) document.getElementById('pref-capacity').value = p.capacity;
            if (p.risk) document.getElementById('pref-risk').value = p.risk;
            if (p.unknownGC) document.getElementById('pref-unknown-gc').value = p.unknownGC;
            if (p.ghostDays) document.getElementById('pref-ghost-days').value = p.ghostDays;
            if (p.wLoc) document.getElementById('w-location').value = p.wLoc;
            if (p.wKw) document.getElementById('w-keywords').value = p.wKw;
            if (p.wGc) document.getElementById('w-gc').value = p.wGc;
            if (p.wTr) document.getElementById('w-trade').value = p.wTr;
            updateWeights();
            
            document.getElementById('csi-boxes').innerHTML = CSI.map(c => `<label style="font-weight:normal;"><input type="checkbox" class="csi-cb" value="${c.n}" ${(p.divisions || []).includes(c.n) ? 'checked' : ''}> Div ${c.n}: ${c.t}</label>`).join('');
        }
        
        // Keywords
        function saveKeywords() {
            const parse = id => document.getElementById(id).value.split('\n').map(s => s.trim()).filter(s => s);
            localStorage.setItem('bidiq_kw', JSON.stringify({ good: parse('kw-good'), bad: parse('kw-bad'), must: parse('kw-must') }));
            alert('Saved!');
        }
        
        function loadKeywords() {
            const kw = getKW();
            document.getElementById('kw-good').value = (kw.good || []).join('\n');
            document.getElementById('kw-bad').value = (kw.bad || []).join('\n');
            document.getElementById('kw-must').value = (kw.must || []).join('\n');
        }
        
        // GC Ratings
        function loadGCs() {
            const gcs = getGCs();
            document.getElementById('gc-list').innerHTML = gcs.length > 0
                ? gcs.map(g => `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #eee;">
                    <span><strong>${g.name}</strong></span>
                    <span>${'‚≠ê'.repeat(g.rating)} <button class="btn-small btn-danger" onclick="deleteGC('${g.name}')">√ó</button></span>
                </div>`).join('')
                : '<p style="color:#888;">No GCs added yet.</p>';
        }
        
        function addGC() {
            const name = document.getElementById('add-gc-name').value.trim();
            const rating = parseInt(document.getElementById('add-gc-rating').value);
            if (!name) return alert('Enter GC name.');
            const gcs = getGCs();
            if (gcs.some(g => g.name.toLowerCase() === name.toLowerCase())) return alert('GC exists.');
            gcs.push({ name, rating });
            localStorage.setItem('bidiq_gcs', JSON.stringify(gcs));
            document.getElementById('add-gc-name').value = '';
            loadGCs();
        }
        
        function deleteGC(name) {
            if (!confirm('Delete ' + name + '?')) return;
            const gcs = getGCs().filter(g => g.name !== name);
            localStorage.setItem('bidiq_gcs', JSON.stringify(gcs));
            loadGCs();
        }
        
        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadPrefs();
            loadKeywords();
            loadGCs();
            updateDashboard();
        });
    </script>
</body>
</html>
